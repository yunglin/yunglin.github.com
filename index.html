
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>碎碎唸</title>
  <meta name="author" content="">

  
  <meta name="description" content="Last week, I was working on importing a large input file into the system. Part of the process involved with
reading a large file (~10GB) from remote &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.yunglinho.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/yunglinho" rel="alternate" title="碎碎唸" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11857878-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">碎碎唸</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/yunglinho" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.yunglinho.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/19/parallel-external-merge-sort/">Parallel External Merge Sort</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-19T21:43:00-07:00" pubdate data-updated="true">Mar 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week, I was working on importing a large input file into the system. Part of the process involved with
reading a large file (~10GB) from remote server and them sort the inputs locally.</p>
<p>At that moment, I decided to give Scala&#8217;s new <a class="reference external" href="http://docs.scala-lang.org/sips/pending/futures-promises.html">Future API</a> a try. Within one day, I wrote a parallel external
merge sort that can</p>
<blockquote>
<ol class="arabic simple">
<li>Read the file from remote server and split it into smaller chunks.</li>
<li>Use in-memory quicksort to sort each chunk and then save chunks into files.</li>
<li>Perform merge sort on the files generated in the previous step.</li>
</ol>
</blockquote>
<p>The most amazing thing is that multiple threads could work on these tasks simultanously. While one thread is busy
reading bytes from remote server, other threads would perform quicksort on the part that has already been read. Once,
all of the data has been written to file system. Another thread will start to merge sort these files.</p>
<p>Here is how I do it.</p>
<div class="section" id="read-lines-from-inputstream">
<h2>Read Lines From InputStream</h2>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">soure</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">).</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure><p>The above code will turn a <strong>InputStream</strong> into a <strong>Stream[Int]</strong> , and then allow us to perform operation on it
without having to fully read it into memory first. But still, this is a huge Stream. Because we are going to use
in-memory sort, I need to split it into smaller pieces first.</p>
<p>The following code will <strong>lift</strong> a Stream into a Stream of Stream. Again, this operation does not require read the whole
original stream into memory. All the operation only happens logically.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Lift a Stream into a Stream of Stream. The size of each sub-stream is specified by the chunkSize</span>
</span><span class="line"><span class="cm"> * @param stream        the origin stream.</span>
</span><span class="line"><span class="cm"> * @param chunkSize     the size of each substream</span>
</span><span class="line"><span class="cm"> * @tparam A</span>
</span><span class="line"><span class="cm"> * @return              chunked stream of the original stream.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">def</span> <span class="n">lift</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">stream</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">remaining</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">remaining</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Stream</span><span class="o">.</span><span class="n">empty</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="k">=</span> <span class="n">remaining</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">      <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">val</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="k">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">  <span class="k">return</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="perform-quick-sort">
<h2>Perform Quick Sort</h2>
<p>After we have split <strong>InputStream</strong> into <strong>Streams</strong>, we can start to read each sub-stream into memory and perform
quicksort on them.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">linesStream</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">lift</span><span class="o">(</span><span class="n">soure</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line"><span class="k">val</span> <span class="n">chunkCounter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">sortedFileDir</span> <span class="k">=</span> <span class="nc">Files</span><span class="o">.</span><span class="n">createTempDir</span><span class="o">()</span>
</span><span class="line"><span class="n">sortedFileDir</span><span class="o">.</span><span class="n">deleteOnExit</span><span class="o">()</span>
</span><span class="line">
</span><span class="line"><span class="c1">// read source stream, read n entries into memory and save it to file in parallel.</span>
</span><span class="line"><span class="k">val</span> <span class="n">fileFutures</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Future</span><span class="o">[</span><span class="kt">File</span><span class="o">]]</span> <span class="k">=</span> <span class="n">linesStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span>
</span><span class="line">  <span class="n">s</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">chunk</span> <span class="k">=</span> <span class="n">chunkCounter</span><span class="o">.</span><span class="n">getAndIncrement</span>
</span><span class="line">    <span class="nc">Future</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">sorted</span> <span class="k">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sorted</span>
</span><span class="line">      <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">sortedFileDir</span><span class="o">,</span> <span class="s">&quot;%d&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">chunk</span> <span class="o">*</span> <span class="n">chunkSize</span><span class="o">))</span>
</span><span class="line">      <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">ret</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">      <span class="k">try</span> <span class="o">{</span>
</span><span class="line">        <span class="n">sorted</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">ret</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}).</span><span class="n">toList</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="perform-merge-sort">
<h2>Perform Merge Sort</h2>
<p>Because I want to perform mergesort on all of results, I have to turn <strong>List[Future[File]]</strong> into <strong>Future[List[File]]</strong>
first. So that I can instruct the <strong>Future</strong> to do merge sort once it has all the pieces.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">saveTmpFiles</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">File</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">sequence</span><span class="o">(</span><span class="n">fileFutures</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">ret</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">File</span><span class="o">]</span> <span class="k">=</span> <span class="n">saveTmpFiles</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">    <span class="n">files</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">  <span class="k">var</span> <span class="n">merged</span> <span class="k">=</span> <span class="n">files</span>
</span><span class="line">
</span><span class="line">  <span class="k">while</span> <span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">splited</span> <span class="k">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">tuple</span> <span class="k">=</span> <span class="n">splited</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">splited</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">m2</span> <span class="k">=</span> <span class="n">tuple</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="o">(</span><span class="n">f1</span><span class="o">,</span> <span class="n">f2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">        <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">sortedFileDir</span><span class="o">,</span> <span class="n">f1</span><span class="o">.</span><span class="n">getName</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">f2</span><span class="o">.</span><span class="n">getName</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">val</span> <span class="n">source1</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromFile</span><span class="o">(</span><span class="n">f1</span><span class="o">)</span>
</span><span class="line">        <span class="k">val</span> <span class="n">source2</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromFile</span><span class="o">(</span><span class="n">f2</span><span class="o">)</span>
</span><span class="line">        <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">ret</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">try</span> <span class="o">{</span>
</span><span class="line">          <span class="k">val</span> <span class="n">stream1</span> <span class="k">=</span> <span class="n">source1</span><span class="o">.</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">          <span class="k">val</span> <span class="n">stream2</span> <span class="k">=</span> <span class="n">source2</span><span class="o">.</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">          <span class="n">merge</span><span class="o">(</span><span class="n">stream1</span><span class="o">,</span> <span class="n">stream2</span><span class="o">).</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">          <span class="n">ret</span>
</span><span class="line">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">          <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">          <span class="n">source1</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">          <span class="n">source2</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">          <span class="nc">FileUtils</span><span class="o">.</span><span class="n">deleteQuietly</span><span class="o">(</span><span class="n">f1</span><span class="o">)</span>
</span><span class="line">          <span class="nc">FileUtils</span><span class="o">.</span><span class="n">deleteQuietly</span><span class="o">(</span><span class="n">f2</span><span class="o">)</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">merged</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">m2</span> <span class="o">:+</span> <span class="n">merged</span><span class="o">.</span><span class="n">last</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="n">m2</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="n">merged</span><span class="o">.</span><span class="n">head</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Merge two streams into one stream.</span>
</span><span class="line"><span class="cm"> * @param streamA</span>
</span><span class="line"><span class="cm"> * @param streamB</span>
</span><span class="line"><span class="cm"> * @return</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">def</span> <span class="n">merge</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">streamA</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">streamB</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ord</span><span class="k">:</span> <span class="kt">Ordering</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="o">(</span><span class="n">streamA</span><span class="o">,</span> <span class="n">streamB</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">b</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">streamA</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">      <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="n">streamB</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">ord</span><span class="o">.</span><span class="n">compare</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">merge</span><span class="o">(</span><span class="n">streamA</span><span class="o">.</span><span class="n">tail</span><span class="o">,</span> <span class="n">streamB</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">merge</span><span class="o">(</span><span class="n">streamA</span><span class="o">,</span> <span class="n">streamB</span><span class="o">.</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="give-this-method-a-pretty-face">
<h2>Give this Method a Pretty Face.</h2>
<p>So how does the method signature of this parallel external merge sort look like?</p>
<p>In fact, it is quite simple. It takes an <strong>InputStream</strong> and returns a <strong>Future[File]</strong>. So that, everything
happens asynchronously, nothing blocks the main thread. You can send an inputStream to this method, go to do other
things first and then come back to wait for the result.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">sort</span><span class="o">(</span><span class="n">inputStream</span><span class="k">:</span> <span class="kt">InputStream</span><span class="o">,</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2000000</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">File</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="limits-number-of-threads-running-at-the-same-time">
<h2>Limits Number of Threads Running at the Same Time.</h2>
<p>Because this parallel external mergesort is an IO and memory intense operations, we can not run too many of it
simultaneously. We must put a constraint on the number of threads it can use at a time. Otherwise, we may receive
OutOfMemoryError or having many threads writing to disk simultaneously.</p>
<p>Also, this constraint must be a global constraint. No matter how many requests has been sent to this method at the
same time, it should only use up-to <em>N</em> threads.</p>
<p>Luckly, this is quite easy to do with Scala&#8217;s Future API. All we need to do is to provide a fixed size thread pool
for this method. So that it won&#8217;t spawn new thread by itself, instead, it uses threads provided by this global thread
pool.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * limits number of reading and sorting can be executed simultaneously. Because this is an IO</span>
</span><span class="line"><span class="cm"> * bound operation, unless the inputstream is coming from a slow http connection, otherwise, 5</span>
</span><span class="line"><span class="cm"> * is more than enough.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">val</span> <span class="nc">GLOBAL_THREAD_LIMIT</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="o">.</span><span class="n">availableProcessors</span><span class="o">()</span> <span class="o">/</span> <span class="mi">2</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="mi">5</span>
</span><span class="line">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">    <span class="n">ret</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">private</span> <span class="k">lazy</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">executionContext</span> <span class="k">=</span>
</span><span class="line">  <span class="nc">ExecutionContext</span><span class="o">.</span><span class="n">fromExecutorService</span><span class="o">(</span><span class="nc">Executors</span><span class="o">.</span><span class="n">newFixedThreadPool</span><span class="o">(</span><span class="nc">GLOBAL_THREAD_LIMIT</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="put-everything-alltogether">
<h2>Put Everything Alltogether</h2>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
<span class="line-number">120</span>
<span class="line-number">121</span>
<span class="line-number">122</span>
<span class="line-number">123</span>
<span class="line-number">124</span>
<span class="line-number">125</span>
<span class="line-number">126</span>
<span class="line-number">127</span>
<span class="line-number">128</span>
<span class="line-number">129</span>
<span class="line-number">130</span>
<span class="line-number">131</span>
<span class="line-number">132</span>
<span class="line-number">133</span>
<span class="line-number">134</span>
<span class="line-number">135</span>
<span class="line-number">136</span>
<span class="line-number">137</span>
<span class="line-number">138</span>
<span class="line-number">139</span>
<span class="line-number">140</span>
<span class="line-number">141</span>
<span class="line-number">142</span>
<span class="line-number">143</span>
<span class="line-number">144</span>
<span class="line-number">145</span>
<span class="line-number">146</span>
<span class="line-number">147</span>
<span class="line-number">148</span>
<span class="line-number">149</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">import</span> <span class="nn">com.google.common.io.Files</span>
</span><span class="line"><span class="k">import</span> <span class="nn">java.io.</span><span class="o">{</span><span class="nc">PrintWriter</span><span class="o">,</span> <span class="nc">File</span><span class="o">,</span> <span class="nc">InputStream</span><span class="o">}</span>
</span><span class="line"><span class="k">import</span> <span class="nn">java.util.concurrent.Executors</span>
</span><span class="line"><span class="k">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span>
</span><span class="line">
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.commons.io.FileUtils</span>
</span><span class="line">
</span><span class="line"><span class="k">import</span> <span class="nn">scala.concurrent.</span><span class="o">{</span><span class="nc">ExecutionContext</span><span class="o">,</span> <span class="nc">Future</span><span class="o">}</span>
</span><span class="line"><span class="k">import</span> <span class="nn">scala.io.Source</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">InputStreams</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * limits number of reading and sorting can be executed simultaneously. Because</span>
</span><span class="line"><span class="cm"> * this is an IO bound operation, unless the inputstream is coming from a slow</span>
</span><span class="line"><span class="cm"> * http connection, otherwise, 5 is more than enough.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">val</span> <span class="nc">GLOBAL_THREAD_LIMIT</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="o">.</span><span class="n">availableProcessors</span><span class="o">()</span> <span class="o">/</span> <span class="mi">2</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="mi">5</span>
</span><span class="line">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">    <span class="n">ret</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">private</span> <span class="k">lazy</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">executionContext</span> <span class="k">=</span>
</span><span class="line">  <span class="nc">ExecutionContext</span><span class="o">.</span><span class="n">fromExecutorService</span><span class="o">(</span><span class="nc">Executors</span><span class="o">.</span><span class="n">newFixedThreadPool</span><span class="o">(</span><span class="nc">GLOBAL_THREAD_LIMIT</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">sort</span><span class="o">(</span><span class="n">inputStream</span><span class="k">:</span> <span class="kt">InputStream</span><span class="o">,</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2000000</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">File</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// open source stream</span>
</span><span class="line">  <span class="k">val</span> <span class="n">soure</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">).</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">linesStream</span> <span class="k">=</span> <span class="n">lift</span><span class="o">(</span><span class="n">soure</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">chunkCounter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">sortedFileDir</span> <span class="k">=</span> <span class="nc">Files</span><span class="o">.</span><span class="n">createTempDir</span><span class="o">()</span>
</span><span class="line">  <span class="n">sortedFileDir</span><span class="o">.</span><span class="n">deleteOnExit</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// read source stream, read n entries into memory and save it to file in parallel.</span>
</span><span class="line">  <span class="k">val</span> <span class="n">saveTmpFiles</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">File</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">sequence</span><span class="o">(</span>
</span><span class="line">    <span class="n">linesStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">chunk</span> <span class="k">=</span> <span class="n">chunkCounter</span><span class="o">.</span><span class="n">getAndIncrement</span>
</span><span class="line">      <span class="nc">Future</span> <span class="o">{</span>
</span><span class="line">        <span class="k">val</span> <span class="n">sorted</span> <span class="k">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sorted</span>
</span><span class="line">        <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">sortedFileDir</span><span class="o">,</span> <span class="s">&quot;%d&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">chunk</span> <span class="o">*</span> <span class="n">chunkSize</span><span class="o">))</span>
</span><span class="line">        <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">ret</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">try</span> <span class="o">{</span>
</span><span class="line">          <span class="n">sorted</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">          <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">        <span class="n">ret</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}).</span><span class="n">toList</span>
</span><span class="line">  <span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// perform merge sort.</span>
</span><span class="line">  <span class="n">saveTmpFiles</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">    <span class="n">files</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="k">var</span> <span class="n">merged</span> <span class="k">=</span> <span class="n">files</span>
</span><span class="line">      <span class="k">while</span> <span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="k">val</span> <span class="n">splited</span> <span class="k">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span>
</span><span class="line">        <span class="k">val</span> <span class="n">tuple</span> <span class="k">=</span> <span class="n">splited</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">splited</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">val</span> <span class="n">m2</span> <span class="k">=</span> <span class="n">tuple</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">          <span class="k">case</span> <span class="o">(</span><span class="n">f1</span><span class="o">,</span> <span class="n">f2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">            <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">sortedFileDir</span><span class="o">,</span> <span class="n">f1</span><span class="o">.</span><span class="n">getName</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">f2</span><span class="o">.</span><span class="n">getName</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">            <span class="k">val</span> <span class="n">source1</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromFile</span><span class="o">(</span><span class="n">f1</span><span class="o">)</span>
</span><span class="line">            <span class="k">val</span> <span class="n">source2</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromFile</span><span class="o">(</span><span class="n">f2</span><span class="o">)</span>
</span><span class="line">            <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">ret</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">            <span class="k">try</span> <span class="o">{</span>
</span><span class="line">              <span class="k">val</span> <span class="n">stream1</span> <span class="k">=</span> <span class="n">source1</span><span class="o">.</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">              <span class="k">val</span> <span class="n">stream2</span> <span class="k">=</span> <span class="n">source2</span><span class="o">.</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">              <span class="n">merge</span><span class="o">(</span><span class="n">stream1</span><span class="o">,</span> <span class="n">stream2</span><span class="o">).</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">              <span class="n">ret</span>
</span><span class="line">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">              <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">              <span class="n">source1</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">              <span class="n">source2</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">              <span class="nc">FileUtils</span><span class="o">.</span><span class="n">deleteQuietly</span><span class="o">(</span><span class="n">f1</span><span class="o">)</span>
</span><span class="line">              <span class="nc">FileUtils</span><span class="o">.</span><span class="n">deleteQuietly</span><span class="o">(</span><span class="n">f2</span><span class="o">)</span>
</span><span class="line">            <span class="o">}</span>
</span><span class="line">
</span><span class="line">          <span class="o">}</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">        <span class="n">merged</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">          <span class="n">m2</span> <span class="o">:+</span> <span class="n">merged</span><span class="o">.</span><span class="n">last</span>
</span><span class="line">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">          <span class="n">m2</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">merged</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Lift a Stream into a Stream of Stream. The size of each sub-stream is specified</span>
</span><span class="line"><span class="cm"> * by the chunkSize.</span>
</span><span class="line"><span class="cm"> *</span>
</span><span class="line"><span class="cm"> * @param stream        the origin stream.</span>
</span><span class="line"><span class="cm"> * @param chunkSize     the size of each substream</span>
</span><span class="line"><span class="cm"> * @tparam A</span>
</span><span class="line"><span class="cm"> * @return              chunked stream of the original stream.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">def</span> <span class="n">lift</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">stream</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">remaining</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">remaining</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Stream</span><span class="o">.</span><span class="n">empty</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="k">=</span> <span class="n">remaining</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">      <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">val</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="k">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">  <span class="k">return</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Merge two streams into one stream.</span>
</span><span class="line"><span class="cm"> * @param streamA</span>
</span><span class="line"><span class="cm"> * @param streamB</span>
</span><span class="line"><span class="cm"> * @return</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">def</span> <span class="n">merge</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">streamA</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">streamB</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ord</span><span class="k">:</span> <span class="kt">Ordering</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="o">(</span><span class="n">streamA</span><span class="o">,</span> <span class="n">streamB</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">b</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">streamA</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">      <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="n">streamB</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">ord</span><span class="o">.</span><span class="n">compare</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">merge</span><span class="o">(</span><span class="n">streamA</span><span class="o">.</span><span class="n">tail</span><span class="o">,</span> <span class="n">streamB</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">merge</span><span class="o">(</span><span class="n">streamA</span><span class="o">,</span> <span class="n">streamB</span><span class="o">.</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/19/clean-future-api-design-sort.rst/">Clean Future API Design</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-19T21:43:00-07:00" pubdate data-updated="true">Mar 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content">The Review
===========================================================================

歡迎來到 2013 Java Developer Day ，一年又過去了，在去年這個時間，我跟大家介紹了我們這一代程式
設計師面對的挑戰是什麼？同時也介紹了 Actor Model 這個用來面對多核心挑戰的工具之一。

在今年的議程裡，我將會介紹在 Scala 中，另一個用來做非同步處理（asynchronous programming)的工具。

Why Asynchronous is Valuable
============================================================================

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/04/why-kimdotcom-can-offer-free-broadband/">為什麼 Kim DotCom/Mega 能夠提供免費的網路</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-04T19:21:00-08:00" pubdate data-updated="true">Feb 4<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a class="reference external" href="http://www.nownews.com/2012/11/20/11814-2874727.htm">NOWNews 為紐西蘭提供免費光纖！盜版之王Kim Dotcom發豪語</a></p>
<pre class="literal-block">
現在，這位『網路頑童』再次放出讓人驚歎的承諾：為紐西蘭的每個人提供免費光纖服務。

引用 Dotcom 在 Twitter 上 的話就是：『The new Mega company will be based in
NZ &amp; become it's most valuable IT biz. I will relaunch Pacific Fibre. Free
broadband for all Kiwi's
</pre>
<p>為什麼 Kim DotCom/Mega 能夠提供免費的網路呢？這要先從國際專線的拆帳機制講起；所謂拆帳就是，從甲地到乙地的線路
，如果是甲地往乙地的流量佔四成，乙地往甲地的佔六成，那麼，這條專線的流量費用，就是六四分，甲付六成乙付四成。</p>
<p>所以說，如果 Kim Dotcom 可以在紐西蘭建立起一個超大的 ICP ，這條專線，百分之九十九的流量都是流出紐西蘭的，那麼
他就有機會只要付出 1% 的費用就可，當然要怎樣說服對連的電信商，接受這個條件，那就是 KD 的功力了。</p>
<p>反觀中XX電信，由於台灣的對外頻寬，由於多數是外往內，國內沒有好的 ICP ，造成這些專線的費用，都是台灣買單的。</p>
<p>小時候學的那些，台灣是東南亞重要戰略樞紐都是狗屁，過境的專線一堆，但是都沒留下實質的好處</p>
<p>之前同事有問我，為什麼國外的 Hosting 公司可以免錢的，我說，就是因為養 ICP 對 ISP 有好處，所以國外的公司養一堆當談判條件用。</p>
<p>台灣這邊，除了 <a class="reference external" href="http://wp.xdite.net/?p=122">「無名」被Giga當成談判條件</a> 過之外，就沒有聽過有人拿 ICP 當談判條件了，話說回來，大部份的 ICP 都被中華給拉過去後，也 <a class="reference external" href="http://blog.urdada.net/2009/03/24/197/">沒人有條件跟中華談了</a> 。</p>
<p>但是，在國際專線這塊，台灣應該也來養幾個這種免費空間，這樣子才不會在國際專線費用這塊，被人家吃透透</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/03/move-erp-to-cloud/">中小企業ERP系統上雲端？</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-03T17:11:00-08:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><pre class="literal-block">
※ 引述《NightWind (gin and tonic)》之銘言：
: 我們是一家中小企業
: 大約三年前才把古早的DOS系統
: 換裝成鼎新的ERP
: 現在當初買的伺服器主機保固也要到了
: 老闆突發奇想把ERP系統裝在中華HiCloud那樣的雲端虛擬主機上
: 節省定期維護主機與擔心主機突然掛掉的費用
: 請問真的有人會這樣做的嗎？
: 又如果有的話，台北地區有沒有規劃的廠商？
</pre>
<p>HiCloud 沒用過，所以用 <a class="reference external" href="http://aws.amazon.com">AWS</a> 的例子來解釋要這麼做會碰上那些例子。</p>
<p>第一個問題是 VM 的可靠度是比你自己買伺服器等級的機器還來的低的， AWS EC2 的
合約是說 99.95% Available ，但是這不包括你 VM 被 AWS會有隨機關掉的機會。當
被關掉後，你是要自己手動或自動重啟才有 99.95%</p>
<p>第二個問題是，台灣多數的 ERP是2-tier的架構而非 3 tier 的，若是用 2-tier 的
軟體，使用者端要從本機連到 AWS去，一個來回的時間從 &lt;10ms跳到 100ms 以上，如
果程式寫的不好，本來一個流程的轉換要跑兩個 SQL command，原來是 (10ms*2 + SQL execution time) * 2，
還有機會是小於 100ms看起來很即時就可以反應，一搬到雲端，時間就跳昇到 100ms * 4，變的超級鈍。</p>
<p>再來，放到 AWS 去，還要考慮台美專線速度的問題，過去幾年來，台灣對外的海纜，幾乎
每兩年都會斷線超過一天。所以放在雲端你的架構能提供的，就只剩不到 99.5%</p>
<p>在 EC2 上，如果要用 EBS讓 VM 當機後資料還在的話， EBS的效能是有口皆呸的
，但是如果不用 EBS，那 VM 一死，上面的資料又全消失了，變成你自己要做 Data Replication</p>
<p>最後，如果要用台灣的雲端，不用要 HiCloud，比較建議的環境會是開發資源及支援較多
的 <a class="reference external" href="http://www.microsoft.com/taiwan/windowsazure/">MS Azure</a> 或是使用 <a class="reference external" href="http://joyent.com/">joynet</a> 技術的 <a class="reference external" href="http://micloud.tw/">MiCloud</a> 會比較妥當。</p>
<p>縱觀來講，搬到雲端有其它新的挑戰要處理，第一個看軟體要先 3tier 化，再來是要
做DB online replication 保護資料，最後，是公司對外的專線要能跟的上資料量。</p>
<p>如果前述問題都能解決的話，貴公司得到的會是</p>
<ol class="arabic simple">
<li>更短的錯誤迴復時間：伺服器一死，跟廠商搬機器來迴復也要一個工作天以上，用雲端可以降到一兩小時</li>
<li>更敏捷的硬體效能：如果硬體效能不夠，使用雲端系統，是直接選更高等級的VM重開，當下就可以昇級。
不用等採買硬體所需的數星期到數個月的時間，也不必擔心折舊週期還沒到就又要昇級。</li>
</ol>
<p>在是否該選用雲端方案的話，就看你們目前的 ERP是否是 3-tier 的，另外就是找顧問來來編
寫相關的工具及作業流程。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/23/cloud-computing-and-rocket-science/">為什麼雲端產業在台灣行不通</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-23T11:26:00-07:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>很想寫這個主題很久了，雖然可能永遠也無法把道理完整的解釋清楚，不過，有個開頭總是好的。</p>
<p>首先，先寫個嘴炮給非軟體業的人看，台灣名嘴大喊：「台灣現在要找到能殺出血路的產業，雲端計算是很
好的機會」、「打造雲端大國，再造兆元產業」，政客名嘴喊喊口號就好，問題是，我們在這產業有什麼利
機，能夠在 <a class="reference external" href="http://www.books.com.tw/exep/prod/booksfile.php?item=0010090268">落後歐美社會四百年</a> 的狀況下，在不懂數字管理下，一次追趕過這些差距，超英趕美？</p>
<p>如果沒有確實的利基及施行方案， <strong>「打造雲端大國，再造兆元產業」</strong> 同樣也可以改寫成 「打造月球
基地，開採外星綠能」、「打造火星計劃，一統太陽系」，後兩者講起來不是更威嗎？</p>
<p>台灣有許多硬體公司在喊，雲端是未來的機會，問題是，雲端的目標是共享資源、是消減 IT 的支出，對硬
體廠來說，是個產業危機，也是個大洗牌的機會，但是，對台灣整體來說，絕對是個不利的未來。至於某些
公司開始喊，雲端業務已經佔公司營業而多少，我的看法是，把伺服器部門改個招牌，雲端營業額就大增了
啊，問題是， <a class="reference external" href="http://www.wretch.cc/blog/JaguarCSIA/16236603">公司的總營收有成長嗎？</a></p>
<p>講完了這些後，再講個小故事， 2010 年我回台灣前，公司同事問我，回台灣要做雲端嗎？我回，我不會
在一個有 <strong>颱風、地震、洪水、土石流、及戰爭危機</strong> 的地方建資料中心。另外，台灣雖然是美國
對亞洲網路的樞紐，但是台灣的網路流量費過高，就是另一個要面對的問題。已上幾點，就是台灣要做雲端
資料中心地理環境上的外部問題。</p>
<p>再來講到台灣軟體業自己內部的問題，做網路服務，同時能服務 <strong>十萬個用戶</strong> 是一個門坎， <strong>一百萬個用戶</strong>
、 <strong>一千萬個用戶</strong> 、 <strong>一億個用戶</strong> 、 <strong>十億個用戶</strong> 都是不同的門坎，每跨過一階，整個
系統架構跟考量的點都完全不同，十萬個用戶用 <a class="reference external" href="http://en.wikipedia.org/wiki/LAMP_(software_bundle)">LAMP</a> 一台就夠了，一百萬用戶，那就要開始做 server farm, cache 等，到了
一千萬用戶，連 DB 都受不了用量，要找其它的解決方案( ex: <a class="reference external" href="http://en.wikipedia.org/wiki/Shard_(database_architecture)">shard</a> )，到上億用戶，你的客戶已
經不會都是居住在同一地了，光解決 data locality 都是個大問題了，更不用講怎麼 deploy service</p>
<p>台灣目前有超過百萬用戶的服務，大概就是 Yahoo、無名、痞客幫、PCHome，這四間了，除了這四間外，
很少公司會有經營百萬人服務的經驗，問題是，台灣喊著要做雲端運算的，都不是這四間，而是剩下來沒有
經營網路服務經驗的公司。</p>
<p>為什麼這經驗很重要呢？因為，一個新架構的好壞，只有經過實際的流量摧殘才能知道，在這之前，一切只
是工程師們用腦補的假設而已，腦補的假設越多，系統上線後要修改的地方越多，至於沒做過百萬人服務的
工程師要怎麼用腦補來假設上億人服務的狀況，那就不是我能想像的了。</p>
<p>美國最大的 Hosting Company <a class="reference external" href="http://dreamhost.com">DreamHost</a> 的創辦人 Sage Weil，在幾年前回去念博士，發展了
<a class="reference external" href="http://www.ssrc.ucsc.edu/Papers/weil-osdi06.pdf">Ceph</a> 這套 distributed file system ，人家想要研究資料時，只要回 DreamHost 回去挖一挖 log 就
有用不完的資料了，至於要驗證就更簡單了，只要把 5% 的用戶放到新架構上，就有用不完的資料可以用來
發掘新架構的缺陷。</p>
<p>這一點，是美國現有網路公司在跨足雲端服務的極大優勢；台灣的雲端廠商，如XX電信、XX研院、XX勢，跟本無
法彌補這中間的差距，記得在某場 CloudTW 的會議中，某家台廠在展視他們的雲端 OS 時， <a class="reference external" href="http://pingyeh.blogspot.com/">葉博士</a> 問了一
個問題就把這個雲端OS擊沉了，該雲端平台只能該台廠所提供的客制化OS，所有的系統 library 都是經過修改
，不能自行更換的，於是 <a class="reference external" href="http://pingyeh.blogspot.com/">葉博士</a> 就問，「要是今天 PHP X.Y.Z 有個 security hole 那麼，他能不能
自行補洞，還是要等台廠把整個環境更新才可把洞補上？」</p>
<p>現實( physical) 的環境沒有優勢，在經營網路服務上，更是落後國外數十年，沒有人材、經驗上的優勢，
這也就是為什麼 <strong>雲端產業在台灣行不通</strong> 的原因。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/23/corrupted-software-company/">關於遊戲公司裁員的感想</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-23T00:44:00-07:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>看到 <a class="reference external" href="https://www.facebook.com/MonkeyPotion?ref=stream">半路</a> <a class="reference external" href="https://www.facebook.com/MonkeyPotion/posts/445760425469302">分享</a> 最近 <a class="reference external" href="http://news.17173.com/content/2012-08-22/20120822114550361.shtml">幾間遊戲公司裁員</a> 的新聞，不經讓我想到過去在矽谷流浪歲月所認知到
的黑暗面，底下就是一個我親身看過的一個例子。</p>
<p>許多年前，AE用三億美金買了一家flash game公司，當時我上 linkedin 看一下 CEO 的背景，一看，
不得了了，我竟然在 linkedin 上跟他是有直接聯結，原來我認識大人物自己都不知道。</p>
<p>後來一查才知道，他們是我工作公司，在三年前買的一間英國公司，我們把他們買下來後，兩年閉鎖期一到
，他們一群六七個人就離職開新公司去了，這間公司後來就又被AE買過去。</p>
<p>當時，我不懂的是，為什麼AE要買這間公司呢？因為一個遊戲的生命週期就是六個月而已，一間遊戲公司的
價值是在於有一個團隊可以持續生產出賣座的遊戲，然而這間flash game的團隊，已經證明了他們兩年一到
就會走人，那為什麼AE公司要買這個公司呢？</p>
<p>後來問一問做金融的朋友，答案跟我猜想的不遠，AE就是買一天的新聞就好 <strong>「AE買下flash game公司，跨足FB市場，未來營收將有爆發性成長」</strong></p>
<p>上市公司們，他們想的，跟你我想的不一樣；靠股票換鈔票的公司，新聞效果過了，股價漲了，執行長選擇權
生效後，就是可以把買進的公司全裁了，反正當初就是買新聞效應而已。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/19/introduction-to-actor-model/">[未完] Introduction to Actor Model</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-19T14:42:00-07:00" pubdate data-updated="true">Jul 19<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="section" id="the-challenge">
<h2>The Challenge</h2>
<p>在今天的講題開始前，我要先花一點時間講一下，我們這一代程式設計師面對的挑戰是什麼，為什麼我們需要一個新的程式架構？</p>
<p>大家應該都很熟悉摩爾定律，摩爾定律是指：一個尺寸相同的晶片上，所容納的電晶體數量，約每隔18個月便會增加一倍，性能也將提升一倍。
在Dr. Moore於1965年提出摩爾而後的40年間，摩爾定律準確的預測電晶體的發展，每18月就有更快一倍的處理器出來，每18個月記憶體的就倍
增。對於軟體工程師來說，摩爾定律讓我們的程式，不用更新軟體，每隔一段時間，效能就自動增加。</p>
<p>然而這一切，在 2005 年左右開始崩壞，那年，我在 ACM Queue 九月號讀到 &quot;The Future of Microprocessors&quot;,
&quot;The Free Lunch Is Over: A Fundamental Turn Toward Concurrency in Software.&quot;等文章，提到，軟體工程師的免費午餐
已經結束了，未來，處理器的時脈將不會隨著電晶體數而增長，只有處理器的核心數依然跟隨著摩爾定律，每18個月增加一倍，而後，類似的
文章開始大量的出現在各樣的軟體雜誌之中。 Intel於 2006 年一月發表了個人電腦用的雙核處理器 - Core Duo， 2007 年四核的Core 2 Quad
發表，我想現在在場的聽眾中，有不少的是用 Intel i7 八核的處理器。</p>
<p>對軟體工程師來說，新的現實是 Amdahl&#8217;s Law ，一個程式能被多核心處理器加速的程度，不會高於程式中不可平行處理的部份的倒數。
也就是說，如果程式中只有50%的部份是可平行處理的，那麼，多核心的處理器最多只能幫你加速兩倍，不管你有雙核，四核，還是六十四
核等。如果程式中有 95% 的部份是可平行處理的，縱使你有兩千核的處理器，還是只能幫你加速 20 倍。</p>
<p>不管你是寫單機版程式，或者是多人用的網路系統，如何善用多核心的處理器，是現在不得不開始面對的問題。</p>
</div>
<div class="section" id="concurrency-and-parallelism">
<h2>Concurrency and Parallelism</h2>
<p>接下來我們要先定義一下名詞，我們中文中講的平行處理，代表了兩個不同的涵意，一個是 Concurrency ， 另一個是 Parallelism</p>
<p>Parallelism 講的是，程式中有兩個以上的部份，可以同時間被處理，而不會互相干擾。</p>
<p>Concurrency 指的是，程式中的兩個以上的部份，可以同時間被處理，或者透過分時分享資源，同時間被處理器處理。</p>
<p>然而，對軟體工程師來說，這兩者都是很困難的，因為我們的程式不免會用到共享的資源，在 Parallelism 中，如何找出共享的資源
將這些模組分離出來最小化，是一種挑戰，在 Concurrency 中，如何確保共享的資源不變成程式中的瓶頸，又是另一個挑戰。</p>
<p>在 Java 6 Concurrency API 就提供了不少工具來協助處理 Concurrency 的問題，如 Executor, CountDownLatch, Semaphore
, DelayQueue 等工具。</p>
</div>
<div class="section" id="issue-shared-memory-concurrency">
<h2>Issue: Shared Memory Concurrency</h2>
<p>那 Shared Memory Concurrency 的問題在那呢？我記得我在學寫網頁時，第一次寫 Web Counter 時就學到了，原來小
到一個 counter++ ，都會因為 thread 存取的順序，而發生 race condition 造成結果與預測的不同。Shared Memory
Concurrency的難點就在於，如何正確的使用 Lock 及 Lock 的不可預測性。</p>
<p>由於作業系統設計時，為了效能，不會將 Lock 設計成完全的公平，當有三個 Thread 依序去要一個 Lock 時，你執行三次，
可能三次都是不同的 Thread 第一個拿到這個 Lock ，這個特性，造成了測試時及執行時的不可決定性，無法在測試時，模擬可
能發生的所有狀況。</p>
<p>此外 Lock 並不是容易去使用的，如果你在程式中使用了大量的 Lock ，將會造成程式中可被併行處理的部份減少，在 Java6
之前，若是你在沒有需要用 lock 的地方使用了 lock ， jvm 仍然會去要這個 lock ，在 Java6 Mustang Release中， HotSpot JVM
的實作引入了 lock elision 的觀念， HotSpot VM 將會透過執行階段的分析，去忽略掉這些多餘的 lock。</p>
<p>然而， Lock 仍帶入了許多問題，如 lock starvation ，當許多 thread 大量、重覆的取用同一個 lock 時，由於取得 lock
的機制並不是公平的，所以有可能會有 thread 一直取不到 lock 的狀況發生。</p>
<p>另外，若是多個 Thread 都要存取相同的數個 lock ，則會造成互相卡位的狀況，形成 live lock。</p>
<p>當然，你也可以說，用 Lock 太麻煩，而減少 Lock 的使用，那麼你的程式就會變得不 Thread-Safe ，在處理量大時，會發生
Race Condition造成不可預期的結果產生。</p>
<p>而用 Lock 最讓人絕望的是，若是 Lock 的順序弄錯了，會造成 Dead Lock ，變成，程式在設計的初期就要把各物件呼叫的順序
先定出來，才可以避免 Dead Lock 的產生，但是你能保證你的程式 1.0版、1.1版、2.0版的呼叫順序都不變嗎？</p>
<div class="section" id="false-sharing-cache-line-issue">
<h3>False sharing: Cache Line Issue</h3>
<p>如果說 Lock 的問題就夠讓人頭大了，那麼底下這個我最近讀到的問題，則會讓你更吃驚。在電腦的架構中，我們有主記憶體、處理器
上有L1 L2 L3快取，處理器存取資料時，會把資料放在快取中，在適當的時機 在把修改寫回主記憶體；這點，大家應該不難去想像。</p>
<p>然而，處理器在從主記憶體存取資料至快取時，是一個區塊一個區塊的去存取，所以在取用資料時，不只會拿回所需的資料，同時也會
取用到相鄰的資料，這在多核心的機器上造成，若是core A 及 core B會去存取相鄰的資料，那麼他鍆將互相 invalidate 對方的
L1快取，造成要從下層的快取或主計憶體上重新讀取資料。</p>
<p>在一篇測試報告中，在一台八核的機器上的測式結果，有False Sharing問題的程式將比沒有False Sharing問題的程式慢12倍，這
數字差不多就是L1及L2讀取速度的差異。依此推測，若是要從主記億體重讀的話，則會慢上200倍！</p>
</div>
</div>
<div class="section" id="the-solution">
<h2>The Solution</h2>
<div class="section" id="a-new-high-level-programming-model">
<h3>A new high level programming model</h3>
<p>講完了問題，當然之後，當然要開始講解決方案了；許多大神、大師們覺得我們須要一個不同的 Programming Model
來解決這問題，他們覺的，這個新的解決方案要有底下幾個特性</p>
<ul class="simple">
<li>要容易被理解，跟容易被測試。</li>
<li>換言之，也就是要deterministic，如果程式流程是輸入 A 產出 B ，那麼不管執行多少次，這個結果仍是要
一樣的。</li>
<li>既然 shared mutable state 是問題的根源，我們就把這問題給移除。</li>
<li>能夠善用多核心所帶來的優點。</li>
</ul>
</div>
<div class="section" id="possible-solutions">
<h3>Possible Solutions</h3>
<p>有個不同的解決方案被提出來，首先是 Functional Programming ，完全的把 Mutable State 移除，程式變
成如同數學函式一般可以被堆疊，程式函式的本身不帶有狀態，所有的狀態都是由外部傳入的，如此一來，程式本身
的運算處理就變的 deterministic</p>
<p>而既然函式本身不帶有狀態，那麼他們便可以平行的被處理，例如在 scala 中，就引如了 parallel collection
，讓軟體工程師可以很簡單的就會一群資料做平行的運算</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="n">par</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">2</span><span class="o">)</span>
</span><span class="line"><span class="n">res</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure><p>Functional Programming所需的 Lambda expression 將會在 Java8 時被實作出來，而 Parallel Collection
也有機會在 Java8 時出現。</p>
<p>在此順便打個廣告，台灣目前有個 functional programming user group 在運作中，若是各位有性去，可以上網
找 fpug.tw</p>
<p>而另一個可能的解決方案是 Actor Model ， Actor Model 將狀態封裝在Actor內部，Actor及Actor間，則是透過
非同步的機制去傳遞訊息。</p>
</div>
</div>
<div class="section" id="a-brief-history-of-the-actor-model">
<h2>A Brief History of the Actor Model</h2>
<p>在開始介紹 Actor Model 前，先簡單介紹一下 Actor Model 的歷史。 Actor Model 是於 1973 年 Carl Hewitt
命名的，而由 Gul Agha 這位先生於 1985 年左右更精確的描述 Actor Model 。</p>
<p>第一個大型的商業應用，則是由 Ericsson 於 1980 年代中期所完成的一個電信系統，這個系統非常的容錯，當大家在介
紹 Actor Model 時，多會提到這個例子，因為這個系統達到了 99.9999999% 九個九的 uptime ，也就是說
一整年下來，他停機的時間只有 31 ms ，非常的匪疑所思，因為，一般我們在寫的系統，能有兩個九，就已經是很了不
起的成就了。</p>
<p>這個專案另一個有名的產品是 erlang 這程式語言， erlang 在 1990 年代被 opensource ，後來被大量運用在
message queue 跟 Concurrency 的程式之中。例如大家常用的 RabbitMQ 就是利用 erlang 寫成的，據說他的核
心只有 5000 行 erlang 的程式碼。</p>
</div>
<div class="section" id="actor">
<h2>Actor</h2>
<p>那什麼是 Actor 呢， Actor 是一個非常輕量化的元件，在 Akka 的實作中，每一個 Actor 只占了約400 bytes
的記憶體空間，每一個 Actor 擁有自己的狀態以及行為，將些狀態及行為都被封裝在 Actor 裡面。</p>
<p>其他的 Actor 只能夠透過送訊息的方式，來與這個 Actor 來溝通，存取 Actor 的狀態及觸發行為；當 Actor 收
到外部的訊息時，這些訊息會被放在信箱裡，依照順序來被這個 Actor 來處理。</p>
<p>這個送訊息的及處理訊息的機制，是非同步的，你不能假設這個訊息一定會立刻被同一個 thread 處理，甚至，你不能
假設說，你一定會收到一個回應。</p>
<p>當 Actor 處理訊息時，他會被放在系統中預先配制好的 Thread 上執行、處理訊息。</p>
<p>很有趣的是，當你這樣設計一個系統時，你的系統便會變得非常的 scalable 及非常的輕量化。因為使用 Actor Model
你的 call stack 會變的很小，在我們用 imperative programming ，我們的 call stack 是從系統最外部，透過
一層層的 method call 累加上來起來，當 CPU 在 Context Switching ，在從一個 Thread 跳到另一個 Thread 去
執行時，需要讀入該 Thread 的 Call Stack ，當 Call Stack 越大時，Context Switch的成本就愈高。</p>
<p>在Actor Model 中，兩個 Actor 在傳遞訊息時，其實只有把這個訊息的 reference 丟到另一個 Actor 的信箱中，訊
息傳遞的成本非常的小，而 Actor 在被喚起處理訊息時，他的 call stack 是從他的信箱開始，而非整串的呼叫流程，因
此， context switch 的成本變的很小。</p>
<p>在 Actor Model 中，一個工作的處理，會變得很像我們在辦公室內做業的方法，當我們從系統外部收到一個訊息時，我們
會把這個工作連同這個工作的寄送者先記錄下來，放到信箱中延後處理，當前一手完成工作後，運行中的 Actor 會把處理
好的資料轉發給下一手，就這樣一層層轉發，最後在將完成的工作結果，送還給原始的寄送者。</p>
</div>
<div class="section" id="introduce-akka">
<h2>Introduce Akka</h2>
<p>接下來的部份，我們要介紹 Akka 這個 JVM 上 Actor Model 的實作。</p>
<p>Akka 是由 Jonas Boner 於 2009 年所發起的，在開發 Akka 之前， Jonas 是在 Terracotta 做 JVM Clustering 以及在 BEA
做 JRockit VM 的，具有多年食作 distributed system 的經驗。目前 Akka 背後的商業公司是 typesafe ， typesafe
同時也是開發 Scala 這個 JVM 上最盛行 JAVA.NEXT 語言的公司。</p>
<p>這個實作是跑在 JVM 上，提供了 Java 及 Scala 的 API ，在接下來的簡報中，我會用 Java API 為主 Scala API 為輔
來介紹怎麼使用 Akka。</p>
<p>Akka另外也引入了 remote actor 這個觀念，既然，我們所有的訊息傳遞都是非同步的，透過訊息的傳遞來呼叫，而這訊息本
身，又是不帶狀態，可以被 serialize 的，狀態的本身是存在 Actor 中的，那麼，為什麼我們自然有可能的將工作放到別台
機器上來處理。</p>
<p>除了 Actor Model 外，Akka還提供了許多 module 來跟外部的系統整合，如 akka-camel ，能讓 akka 串接上 camel 這
個 enterprise service bus ，便程它的一個 endpoint ，讓 Actor 能處理 camel 送來的訊息然後再將訊息轉發回 camel 中。</p>
</div>
<div class="section" id="define-actor">
<h2>Define Actor</h2>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kn">import</span> <span class="nn">akka.actor.UntypedActor</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Counter</span> <span class="kd">extends</span> <span class="n">UntypedActor</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">   <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">     <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;increase&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">       <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;get&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">getSender</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="n">count</span><span class="o">));</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="n">unhandled</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="fault-tolerance-in-akka">
<h2>Fault Tolerance in Akka</h2>
<p>接下來我們要談的就是為什麼 ericsson 的系統能夠達到那麼高可靠度的原因以及 Akka 容錯的機制。</p>
<p>當一個系統在運作時，不免因為一些設計外的因素、或不可預期的輸入，造成系統產生錯誤的狀態，有時，這個錯
誤的狀態只是丟出一個 exception 就結束，但是在某些情況下，系統會處於一個混亂的狀態之中，無法再繼續處
理任何的訊息。</p>
<p>這個狀況，我相信大多數的 Windows 用戶都有碰上過，也非常清楚這個問題的解決方案，也就是 &#8211; 重開機</p>
<p>在 Akka 中，Actor們如同現實生活中公司的組織，可以有低層的員工以及高層的 Supervisor ，當一個員工
在處理訊息時，若是有發生無法自己無法排解的錯誤狀況的話，他將會把這錯誤狀況，回報給他的上級，由上級來
決定如何處理。</p>
<p>如果說，一個 supervisor 管理的 workers 都是獨立的個體，沒有交互影響的問題，那麼， supervisor 可以
選擇將有問題的 worker 單獨重開機，當一個 actor 被重啟時，他的 actor reference 將保持不變，外面的 actor
仍可以透過原有舊的 actor reference 跟這個重啟後的 actor 溝通。而被重啟的 actor 的信箱，仍會保存的
尚未被處理的訊息在信箱內，而造成錯誤的訊息，則是在重啟時可以決定是否要保留重新處理。</p>
<p>若是一個 supervisor 下的 workers 有相互依賴的情況的話，那麼， supervisor 可以在某一個 worker 發
生錯誤時，重新啟動所有的 workers。</p>
<p>這個錯誤排解的機制不止是可以串上一層而以，而是可以一層層的堆疊起來，位在最上端的，則是前面所看過的 ActorSystem
；當一個錯誤是直屬主管無法排除的錯誤，那麼，這個錯誤訊息可以再轉發給更高層的主管，由他來解決。同樣的，重啟的觀
念也可以套用在這邊。當一個系統的子系統發生錯誤時，我們可以重新啟動整個環境</p>
</div>
<div class="section" id="remote-actor">
<h2>Remote Actor</h2>
<p>在 Akka 的實作中 Actor 預設就是可以被 Remote 化的， Actor 在設計時，就已經是設計成 location transparent 及
可被配置在本機或是遠端的，一個原本設計成本機用的 Actor ，可以不經任何的程式變化，直接修改設定檔，變成在啟動一個
Actor時，自動就是啟動在遠端的。</p>
<p>而傳遞訊息給 Remote Actor 跟傳給本機的 Actor 是沒有差別的，同樣是透過 tell 及 ask 這兩個 API ，在底層實作上
Actor Reference 會帶有 Remote Actor 實際所在機器的位址，若是一個 Actor 是 Remote Actor 的話，被傳送的訊息
就會透過 Java Serialization, Protocol Buffer Serializer 或者是自定的 Serializer 來將訊息寫入到遠方。</p>
<p>而要使用那一種 Serializer ，是可以透過設定檔做切換的。</p>
<p>Remote Actor 的配置，也是可以透過程式來控製，下圖便是一個例子。</p>
</div>
<div class="section" id="routing-clustering">
<h2>Routing &amp; Clustering</h2>
<p>對於 Cluster 的設計，目前 Akka 的團隊還在重新設計中，目標將會是在下一個 release 時，將 cluster 的功能
加入到 Akka 中。</p>
<p>目前，Akka 則是只支援 Routing 而已。 Routing 的機制是說，你有一群一樣的 actor，他們可以處理同樣類型的訊息
，但是由誰來處理訊息，則是由 Router 來決定。</p>
<p>你可能會問，什麼時候需要這樣做呢？會有 Routing 的需求時，多是因為有處理量限制的問題，例如，我想要最多不超過五個
這類型的工作可以同時間被處理，或者是從使用者A來的需求，最多只讓它同時跑五個，但是從使用者B來的需求，最多可以跑十
個，而且兩個人的程序不能混用。</p>
<p>Akka 目前支援的 Routing 機制有</p>
<ul class="simple">
<li>RoundRobinRouter： 在一群 actor 中，依序將工作配發給他們。</li>
<li>RandomRouter: 在一群 actor 中，隨意的將工作配發給他們。</li>
<li>SmallestMailboxRouter: 在一群 actor 中，將工作配發給目前沒有在工作的，或者是待辦工作最少的 actor</li>
<li>BroadcastRouter: 將工作配發給所有的 Actor</li>
<li>ScatterGatherFirstCompletedRouter:  將工作配發給所有的 Actor，然後等待第一個回應，其餘的回應則是會被忽略捨棄掉。</li>
</ul>
<p>Routing 的機制也可以跟 Remote Actor 混用，將 Remote Actor 配發在多台機器上，然後透過 Router 將訊息配
發給他們。</p>
</div>
<div class="section" id="performance">
<h2>Performance</h2>
<p>下圖的是 Akka 官方，於一台48核的 AMD 機器上，做簡單訊息傳送的 Performance Test 的測試結果。</p>
<p>在一開始的實作中，Akka是使用 java.util.concurrent.ThreadPoolExecutor 控制最多有多少個 Actor 能同
時被執行，然而在這 48核 的機器上，Akka Team發現，Akka無法 scale 超過 12 個併行的 actor ，不管你增加
多少個 actor ，同時間內被處理的最大量卡在每秒一百四十萬個訊息這個數字。然而，同時間 CPU 的 Load 並沒
有超過 10%</p>
<p>Akka Team猜想是因為 ThreadPoolExecutor 底層的 task queue, LinkedBlockingQueue 有一個共用的 lock，
最後造成擁塞，才會造成效率的不佳。</p>
<p>後來在經過了 Doug Lea 的協助，使用 Fork-Join 重新實作 task executor ，於是效能就拉高到每秒兩千萬個訊息
這數字。</p>
</div>
<div class="section" id="use-case">
<h2>Use Case</h2>
<p>那 Akka 可以被用在那些地方呢？目前 Akka 被應用在下面幾個地方。</p>
<ul class="simple">
<li>messaging system: 例如國內的 Cubie 就有用到 Akka 來處理訊息。</li>
<li>Data Analysis: klout.com 例用 akka 來分析社群網站上如 facebook twitter 上訊息轉發的熱門程度
以及誰是意見領袖等資料。</li>
<li>股票交易系統： Akka 的一大客戶群是倫敦的金融公司，Akka的幾個特性很適合用來做股市交易用。像是用 Actor
來追蹤一個股票的現貨股價變化以及產生各種線型圖；又或者是說，結合 Rule Based Engine 可以做風險控管的
模組。例如說交易員要下單買一支股票時，Akka可以幫你同時檢查，這個交易員他目前手上可用資金的是多少，
交易員目前股票組合的風險是多少，公司目前整體股票組合的風險是多少。
數十至數百個不同規則的檢查是可以透過 remote actor 分散在許多機器上併行處理的，一個交易的風險評估，並不
會隨著檢查的數量而線性增長。</li>
<li>另外一個 Akka 被大量使用的環境是線上遊戲，過去有許多遊戲公司選擇用 MySQL 當後台，然後透過 cache 及 db
sharding的方式，來增加 throughput ，後來他們發現，與其把 server 寫成 stateless 然後把狀態放在後台
的 db 讓 db 變成效能的頻頸，不如把 state 放在 Actor 中，讓每個 Actor 代表一個遊戲中的角色，獨立維護
它的狀態，這樣才能更 scalable.</li>
</ul>
</div>
<div class="section" id="case-study">
<h2>Case Study</h2>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/11/spatial-search-with-lucene/">Spatial Search With Lucene</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-11T16:06:00-07:00" pubdate data-updated="true">Jul 11<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="section" id="before-we-start">
<h2>Before We Start</h2>
<p>As some of my blog readers may know, my previous startup project was an online location based search service. Thing
does not go well and I am going to open source some of the related work.</p>
<p>In this post, I will show you how to use Lucene to do spatial search as well as how it works internally.</p>
</div>
<div class="section" id="spatial-search">
<h2>Spatial Search</h2>
<div class="section" id="spatial-search-and-geo-tagging">
<h3>Spatial Search and Geo Tagging</h3>
<p>Geo-tagging is a popular way to do spatial search. Instead of using the actual location to tag a POI, the geo-tagging
uses geotag to group items within a predefined range as a whole. When performing a search, it is simply pull out all
items with the same tag.</p>
<dl class="docutils">
<dt>There are few popular ways to do geo-tagging, including</dt>
<dd><ul class="first last simple">
<li>GeoHash</li>
<li>QuadTree</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="geohash">
<h3>GeoHash</h3>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Geohash">GeoHash</a> is way to encode latitude and longitude using base32 code. There is a fundamental flaw that makes it hard to
do spatial search. The problem is the geo hash generated is not continuous. The neighbor of a particular block may not
share the same prefix with its nearest eight neighbors. When using geohash to do spatial search, we need to calculate
the hash value of nearby neighbors by ourselves.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">+-------+-------+-------+
</span><span class="line">| ezefr | ezs48 | ezs49 |
</span><span class="line">+-------+-------+-------+
</span><span class="line">| ezefr | ezs42 | ezs43 |
</span><span class="line">+-------+-------+-------+
</span><span class="line">| ezefp | ezs40 | ezs41 |
</span><span class="line">+-------+-------+-------+
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="quad-tree">
<h3>Quad-Tree</h3>
<p>Quad-Tree addresses the issue in geohash and adapt a better way to do geo-tagging. This example gives us a
great example on how Quad-Tree does geo-tagging.</p>
<img alt="http://i.msdn.microsoft.com/dynimg/IC96238.jpg" src="http://i.msdn.microsoft.com/dynimg/IC96238.jpg" />
<dl class="docutils">
<dt>The Quad-Tree has the following advantage when doing spatial search</dt>
<dd><ul class="first last simple">
<li>it can be really fast if you stores data as a tri. Such as, Lucene, internally, it uses indexed tri to store
NumericField.</li>
<li>the neighbors of a block share the longest common prefix.</li>
</ul>
</dd>
</dl>
<p>For more extensive information regarding geo-tagging, you should check
<a class="reference external" href="http://msdn.microsoft.com/en-us/library/bb259689.aspx">here</a>,
<a class="reference external" href="http://www.maptiler.org/google-maps-coordinates-tile-bounds-projection/]">here</a> and
<a class="reference external" href="http://gist.github.com/1193577">here</a>.</p>
</div>
</div>
<div class="section" id="our-custom-approach">
<h2>Our Custom Approach</h2>
<p>Lucene&#8217;s <a class="reference external" href="http://lucene.apache.org/core/old_versioned_docs/versions/2_9_1/api/contrib-spatial/index.html">contrib-spatial</a> uses geo-tagging to implements spatial search and only support searching for
features near a point.</p>
<p>A pair of latitude and longitude gives us a quickstart for your location based application. However, not every
single feature in a LBS application can be described as a point. Let us take school district as an example.
The School A may be closer to your house than School B is, but your house is belong to school district for school B.
Another example is bike trails, bike trail is a line not a single point.</p>
<p>A full feature spatial search must support complicated geometric operations. This is why we create our own Lucene
spatial search implementation.</p>
<p>In the GIS area, Geometry are used to describe shape of features. The common geometries are:</p>
<div class="section" id="geometry-primitives-2d">
<h3>Geometry primitives(2D)</h3>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="56%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Type</th>
<th class="head">Text Format</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Point</td>
<td>POINT (30 10)</td>
<td><img alt="PointExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/SFA_Point.svg/51px-SFA_Point.svg.png" /></td>
</tr>
<tr><td>LineString</td>
<td>LINESTRING (30 10, 10 30, 40 40)</td>
<td><img alt="LineStringExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/b/b9/SFA_LineString.svg/51px-SFA_LineString.svg.png" /></td>
</tr>
<tr><td rowspan="2">Polygon</td>
<td>POLYGON ((30 10, 10 20, 20 40, 40 40, 30 10))</td>
<td><img alt="PolygonExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/SFA_Polygon.svg/51px-SFA_Polygon.svg.png" /></td>
</tr>
<tr><td>POLYGON ((35 10, 10 20, 15 40, 45 45, 35 10),
(20 30, 35 35, 30 20, 20 30))|</td>
<td><img alt="PolygonExample2" src="http://upload.wikimedia.org/wikipedia/commons/thumb/5/55/SFA_Polygon_with_hole.svg/51px-SFA_Polygon_with_hole.svg.png" /></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="multipart-geometries-2d">
<h3>Multipart geometries (2D)</h3>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="53%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Type</th>
<th class="head">Text Format</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>MultiPoint</td>
<td>MULTIPOINT ((10 40), (40 30), (20 20), (30 10))</td>
<td><img alt="MultiPointExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/SFA_MultiPoint.svg/51px-SFA_MultiPoint.svg.png" /></td>
</tr>
<tr><td>MultiLineString</td>
<td>MULTILINESTRING ((10 10, 20 20, 10 40)
(40 40, 30 30, 40 20, 30 10))</td>
<td><img alt="MultiLineStringExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/8/86/SFA_MultiLineString.svg/51px-SFA_MultiLineString.svg.png" /></td>
</tr>
<tr><td>MultiPolygon</td>
<td>MULTIPOLYGON (((30 20, 10 40, 45 40, 30 20)),
((15 5, 40 10, 10 20, 5 10, 15 5)))</td>
<td><img alt="MultiPolygonExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/d/dc/SFA_MultiPolygon.svg/51px-SFA_MultiPolygon.svg.png" /></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="how-to-calculate-quadtree-value-for-geometries">
<h3>How to Calculate QuadTree value for Geometries</h3>
<p>When hashing a <tt class="docutils literal">Geometry primitive</tt>, we will calculate the minimum bounding rectangle(MBR) of this geometry. For
example, the minumum bouding box for <img alt="PolygonExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/SFA_Polygon.svg/51px-SFA_Polygon.svg.png" /> is the grid made up of (1, 1), (1, 4), (4, 4), (4, 1).</p>
<p>We will calculate the quadtree hashcode for the MBR, the quadtree hashcode for the MBR is the longest common prefix of
quadtree values for the four corners.</p>
<dl class="docutils">
<dt>When indexing this geometry with Lucene, we will store these fields in lucene</dt>
<dd><ul class="first last simple">
<li>geometry: POLYGON ((3 1, 1 2, 2 4, 4 4, 3 1))</li>
<li>geometry__quadtree: QuadTree value of the polygon.</li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="implementation-detail">
<h2>Implementation Detail</h2>
<p>The number of digits we used in the quad-tree implementation is 17 digits. This allows us to lay items on an 600 x 600
meter block. This number comes from 40075000 / 2 ^16 (Earth Circumference / level of details). The 17 digits number
will be stored as a long value. The digits we used are 1(upper left), 2(upper right), 3(lower left), 4(lower right),
and 0 (whole block in the given detail).</p>
<p>When encoding a coordinate, we will stores the quadtree value as a NumericField in Lucene. Internally, Lucene will use
indexed trie to store NumericField. The &quot;Indexed Trie&quot; uses buckets to group terms. We will use the default
precisionStep(4) for now.</p>
<div class="section" id="index-phase">
<h3>Index Phase</h3>
<p>During the index phase, we will store the geometry in its text form and in quadtree value. Each of them has their own
use during search phase.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">point</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="mf">24.123</span><span class="o">,</span> <span class="mf">18.921</span><span class="o">)</span>
</span><span class="line"><span class="k">val</span> <span class="n">code</span> <span class="k">=</span> <span class="n">point</span><span class="o">.</span><span class="n">quadtree</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">raw</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Field</span><span class="o">(</span><span class="s">&quot;location&quot;</span><span class="o">,</span> <span class="n">point</span><span class="o">.</span><span class="n">wkt</span><span class="o">,</span> <span class="nc">Field</span><span class="o">.</span><span class="nc">Store</span><span class="o">.</span><span class="nc">YES</span><span class="o">,</span> <span class="nc">Field</span><span class="o">.</span><span class="nc">Index</span><span class="o">.</span><span class="nc">NOT_ANALYZED</span><span class="o">)</span>
</span><span class="line"><span class="k">val</span> <span class="n">field</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">NumericField</span><span class="o">(</span><span class="s">&quot;location&quot;</span> <span class="o">+</span> <span class="s">&quot;__quadtree&quot;</span><span class="o">)</span>
</span><span class="line"><span class="n">field</span><span class="o">.</span><span class="n">setLongValue</span><span class="o">(</span><span class="n">code</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="n">doc</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">raw</span><span class="o">)</span>
</span><span class="line"><span class="n">doc</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">field</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="search-phase">
<h3>Search Phase</h3>
<dl class="docutils">
<dt>The search phase has two parts</dt>
<dd><ul class="first last simple">
<li>filter: fetches all possible features that may contains the geometry X by using Lucene&#8217;s range query against the
quadtree field.</li>
<li>select: for each possible results, run geometric operation to see if result Y contains geometry X.</li>
</ul>
</dd>
</dl>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">field</span> <span class="k">=</span> <span class="s">&quot;location&quot;</span>
</span><span class="line"><span class="c1">// create a point.</span>
</span><span class="line"><span class="k">val</span> <span class="n">point</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">makeShape</span><span class="o">(</span><span class="nc">Point</span><span class="o">(</span><span class="mi">24</span><span class="o">,</span> <span class="mi">18</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// turn point into search range.</span>
</span><span class="line"><span class="k">val</span> <span class="n">circle</span> <span class="k">=</span> <span class="n">point</span><span class="o">.</span><span class="n">buffer</span><span class="o">(</span><span class="nc">Distance</span><span class="o">(</span><span class="s">&quot;500m&quot;</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a query container for complex queries.</span>
</span><span class="line"><span class="k">val</span> <span class="n">query</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">BooleanQuery</span><span class="o">()</span>
</span><span class="line">
</span><span class="line"><span class="c1">// filtering: search for items in this range</span>
</span><span class="line"><span class="n">query</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">QuadTreeRangeQueryFactory</span><span class="o">.</span><span class="n">buildLocalQuery</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">circle</span><span class="o">.</span><span class="n">quadtree</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// selecting and scoring: the value source will return the distance between</span>
</span><span class="line"><span class="c1">// the point and each feature.</span>
</span><span class="line"><span class="n">query</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ValueSourceQuery</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="n">makeValueSource</span><span class="o">(</span><span class="s">&quot;location&quot;</span><span class="o">,</span> <span class="n">point</span><span class="o">));</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">founds</span> <span class="k">=</span> <span class="n">indexSearcher</span><span class="o">.</span><span class="n">search</span><span class="o">(</span><span class="n">query</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
<div class="section" id="open-source-projects">
<h2>Open Source Projects</h2>
<div class="section" id="scala-shapely">
<h3>Scala Shapely</h3>
<p><a class="reference external" href="https://bitbucket.org/bluetang/common-shapely/">Shapely</a> is Scala binding for JTS Topology Suite. The goal of Shapely is to provide an easy to use factory to
create JTS geometry class instances. It allows us to create various geometry shape with easy to use factory methods.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="c1">// create a point</span>
</span><span class="line"><span class="nc">Point</span><span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a line string</span>
</span><span class="line"><span class="nc">LineString</span><span class="o">((</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">40</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a polygon</span>
</span><span class="line"><span class="nc">Polygon</span><span class="o">((</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a polygon with a hole in it.</span>
</span><span class="line"><span class="nc">Polygon</span><span class="o">(</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">((</span><span class="mi">35</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">45</span><span class="o">,</span> <span class="mi">45</span><span class="o">),</span> <span class="o">(</span><span class="mi">35</span><span class="o">,</span> <span class="mi">10</span><span class="o">)),</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">((</span><span class="mi">20</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span> <span class="o">(</span><span class="mi">35</span><span class="o">,</span> <span class="mi">35</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">30</span><span class="o">)))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a multi-point</span>
</span><span class="line"><span class="nc">MultiPoint</span><span class="o">((</span><span class="mi">10</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span> <span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a multi line-string.</span>
</span><span class="line"><span class="nc">MultiLineString</span><span class="o">(</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">((</span><span class="mi">10</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">40</span><span class="o">)),</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">((</span><span class="mi">40</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
</span><span class="line"><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a multi-polygon.</span>
</span><span class="line"><span class="nc">MultiPolygon</span><span class="o">(</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">(</span>
</span><span class="line">        <span class="nc">Seq</span><span class="o">((</span><span class="mi">30</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">45</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">20</span><span class="o">))</span>
</span><span class="line">        <span class="o">),</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">(</span>
</span><span class="line">        <span class="nc">Seq</span><span class="o">((</span><span class="mi">15</span><span class="o">,</span> <span class="mi">5</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="mi">5</span><span class="o">))</span>
</span><span class="line">        <span class="o">)</span>
</span><span class="line">    <span class="o">)</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="lucene-spatial">
<h3>Lucene Spatial</h3>
<p><a class="reference external" href="https://bitbucket.org/bluetang/lucene-spatial/">Lucene Spatial</a> is the geo-spatial module for lucene built on the top of shapely. The
lucene-spatial modules uses a SpatialContext instance to encode location fields and to
create location queries.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="c1">// create a context.</span>
</span><span class="line"><span class="k">val</span> <span class="n">context</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SpatialContext</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a shape from the representation of a geometry.</span>
</span><span class="line"><span class="k">val</span> <span class="n">shape</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">makeShape</span><span class="o">(</span><span class="s">&quot;Point(0 10)&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create lucene fieldables for a location field.</span>
</span><span class="line"><span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">makeFieldables</span><span class="o">(</span><span class="s">&quot;field&quot;</span><span class="o">,</span> <span class="n">shape</span><span class="o">).</span><span class="n">toList</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a location query to look for features within 5KM radius.</span>
</span><span class="line"><span class="k">val</span> <span class="n">query</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">makeQuery</span><span class="o">(</span><span class="s">&quot;field&quot;</span><span class="o">,</span> <span class="n">shape</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Distance</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Distance</span><span class="o">.</span><span class="nc">Unit</span><span class="o">.</span><span class="nc">KM</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/27/pricing-error/">那些系統整合教我的事 &#8211; 資料錯誤</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-27T18:52:00-07:00" pubdate data-updated="true">Jun 27<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>首先，今天要恭喜 iTunes Stores 台灣版總算上線了，恭喜蘋果搞定眾多台灣商家搞不定的
數位資料授權的問題；既然 iTunes Store 幫忙打通了關節，接下來許多的台灣的小 start-up 可以
透過串接 iTunes Store 的方式來賺取介紹費，又多了許多新的 business idea 可以在台
灣實作的可能。</p>
<p>iTunes Store 上線， <a class="reference external" href="http://briian.com/?p=8426">許多人發現</a> 許多專輯的費用只有 20 元，這讓我想到，當年我在
某音樂公司的經驗，當時是美國幾大音樂公司開放開始賣 non-DRM 音樂的年代，我們公司在線
上串流服務上做到全美最大，有三百萬的訂戶，音樂資料庫中，有超過一百萬首歌曲的資料，隨
著 non-DRM 的熱潮，我們也非得開賣 non-DRM 的音樂。</p>
<p>當時我是主管 QA 工程師的，問了再上頭的主管，問說除了網站的功能外，需要再做資料測試嗎
，因為跟據我當時的經驗，許多的音樂專籍的資料是有缺或有錯的；但是主管的說法是有其它的
單位會保證資料無誤，所以我這邊只要擔心功能性的問題就好。</p>
<p>當時產品的訂價方式是，一首歌的成本是 0.6 美金，我們賣 0.99 美金，每一張專輯我們則是
賣 9.99 ，等於是專輯如果超過 10 首歌，我們就開始吸收中間的價差。</p>
<p>然而一上線的隔天我們就知道錯了，上線的當晚就有人發現，有許多張精選輯，一張精選輯有數
張CD我們仍是只賣 9.99 每元，當晚，這些專輯就賣掉四千套，一晚就幫公司賠掉了五十萬美金
以上。由於這些音樂都是 DRM Free 的，所以賣出去就是賣出去了，沒有辦法收回，我們仍是要
依照賣掉的數量付錢原始授權的擁有者。</p>
<p>其實，這些歌曲的資料庫我們是跟外部另一家公司買的，並不是自建的；我(們)在這邊學到的一課
是，不管資料是內部還是外部建的，要用時，還是要自己全部檢查一遍才可用。</p>
<p>至於給台灣 iTunes Store 消費者的建議是 <strong>快買</strong> 等美國那邊睡起來後，產品就會下架再
改回原價了</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/23/runtime-quality-metrics-series-3/">軟體品質指標系列(三)：軟體品質如何測量</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-23T14:45:00-07:00" pubdate data-updated="true">May 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在這一系列的第一回我們談到，我們是軟體工程師，不談虛幻的概念，只講能夠量化追蹤的數值指標，那麼，
我們要怎麼把品質轉換程數值指標呢？</p>
<div class="section" id="id1">
<h2>軟體品質如何測量</h2>
<div class="section" id="id2">
<h3>幾個故事</h3>
<p>在開始講怎麼做前，我想先講兩個我親身的經驗，在我第一份工作時，前雇主是做手機遊戲的，整間公
司有兩百個員工，但是只有三個是做Server端的，在 2005 年時，多數遊戲都是單機板的，那時公司
簽下 World Series Of Poker 要做多人的線上遊戲，需要開發一個簡易的配對及遊戲訊息交換的伺
服器，當然，大家當年都沒有經驗，所以說，要怎麼樣確保在上線時，不會被用戶衝垮就變成我的工作。</p>
<p>而在我第二份工作時，也有相似的經驗，我們本來已有一個運作中的音樂平台，讓公司內外超過40個Partner使用；
當時，公司又簽下一個合約，說是在三個月後的 6/1 ，會新增 200萬用戶！如何不讓大水衝垮我們的
應用程式，又變成我那幾個月的工作重點。</p>
<img alt="/images/2012-05-23/troops.jpg" src="/images/2012-05-23/troops.jpg" style="width: 800px;" />
</div>
</div>
<div class="section" id="load-test">
<h2>Load Test</h2>
<p>寫到這邊，大部份的讀者應該都知道接下來要講的是 Load Test 了，Load Test是個很大的議題，通
常我們在講 Load Test 時，常講的其實是三件不同的事</p>
<ul class="simple">
<li>Performance Test</li>
<li>Stress Test</li>
<li>Longevity Test</li>
</ul>
<p>這三個測試，用的工具雖然一樣，但是要找個指標跟目的卻是大不相同。</p>
<div class="section" id="performance-test">
<h3>Performance Test</h3>
<p>Performance Test 的目地是在找出應用程式的 baseline performance ，做為未來績效評估及設計變
革時的依據。</p>
<p>被 Performance Test 的標的物，通常是已經 feature complete 的模組，然後我們將對模組的每
一個功能，一個一個進行黑箱及白箱測試；然後再用腳本的型態，模擬實際上線的流量，再來測試看看
各功能間對效能的互相影響程度；最後，是找到測試標的物的 Turning Point 及 Scale Factor。</p>
<div class="section" id="best-case-performance">
<h4>尋找 Best Case Performance</h4>
<p>尋找應用程式的 best case performance  大概是最常被忽略的事了， best case performance 指的是你
一個功能的最佳效率，不管怎樣測試，對單一功能來說，怎麼樣你的效率都不可能會再比這個數字
好了；這個數字的第一個用處就在這，如果你的最佳效率比目標效率還糟，剩下來的就不用測了，
因為怎樣都會比這個數字還糟，只能先停下來，回去修改程式碼增進效能。</p>
<p>Best Case Performance 的測法是：</p>
<ol class="arabic simple">
<li>將應用程式啟動</li>
<li>先用幾個 request 替應用程式暖身(warm up)，以 Java VM 來說，這樣可以讓 Hotspot VM 幫 bytecode 最
佳化，有些需要被啟動的內部原件也會被啟動。</li>
<li>接著是一個一個的慢慢送一百個 requests ，然後取平均值及標準差。</li>
</ol>
<p>若是標準差的值過高，或者是反應時間有增長的現像，那麼這個狀況應該記錄下來，然後使用白箱
測試的工具(如 <a class="reference external" href="http://www.yourkit.com/">yourkit profiler</a> 去找問題的根源。</p>
<p>除了平均數及標準差外，常用的數字還有</p>
<ul class="simple">
<li>mean</li>
<li>standard deviation</li>
<li>minimum</li>
<li>maximum</li>
<li>96   percentile</li>
<li>99   percentile</li>
<li>99.9 percentile</li>
<li>5 minutes moving average</li>
<li>throughput</li>
<li>error rate</li>
</ul>
<p>另外，圖表也是常用的工具，因為相較於數字，圖表更容易看出來趨勢的走向；以下圖為例，藍線的
平均反應時間是1.354秒，但跑load test二十分鐘後，每一個 request 都已經超過了平均數，因
此將數字用圖像來呈現是有助於判別數字的。</p>
<img alt="/images/2012-05-23/chart-1.png" src="/images/2012-05-23/chart-1.png" style="width: 480px;" />
</div>
<div class="section" id="performance-baseline">
<h4>建立 Performance Baseline</h4>
<p>接下來的工作，是定出比較的基礎，建立一個你覺得合理的流量，然後就這個比較基礎去找出來不同
狀況下的平均反應時間及處理量的變化。</p>
<p>基礎效能的建立，我們要先控制兩個變數 <strong>requests per minutes</strong> 及 <strong>number of concurrent requests</strong> ；
透過調整這兩個變數，先找出反應時間較 best case 的流量，然後就此數字開始調整到一個你覺
得合理的值，開始進行 Load Test。</p>
<p>劉接下來我們開始把 <strong>requests per minutes(RPM) 倍增</strong> 但 <strong>number of concurrent requests(CR) 不變</strong> 來看，當流量
增加時應用程式的反應時間會如何增長，接著是 RPM 及 CR 同時都倍增，看反應時間如何增長，
依此規則，就二的次方(2^N)開始往上增加，直到 response 開始嚴重衰退，或者 throughput 開
始衰退。</p>
<p>接著，如果你的應用程式支援 Scale-Out ，那麼，我們依此規則，就 RPM, CR, Machines 三
個變數再次就二的次方(2^N)開始調整流量來做測試。</p>
<p>前面這個過程，可以幫我們了解以下幾件事</p>
<ul class="simple">
<li>應用程式對壓力的反應是如何，當流量被增時，反應時間成長的幅度是線性還是成等比級數成長。</li>
<li>處理量 throughput 是否會隨著 request 數增加而增加，是否在超過某個轉折點時，會開始
反轉下降</li>
<li>上述的轉折點，便可當做未來評估是否需要增加機器或者是昇級機器的基準值。當實既須求接近這
個點，或有事件會造成流量超過這個點，那麼，我們就可以在事前進行反應。或者，在監控應用程
式中加入警告，當線上程式逼近這個值的時候，主動告知我們該加機器了</li>
<li>當我們增加機器時，如果應用程式不是寫成完全 stateless 的，而是有共享資料資源時，那麼
，scale factor便會小於 2，那麼，我們需要關查 scale factor 到底是隨著機器的增加而
不變、還是緩慢成長、或者是快速成長。即使因為某些因素讓我們不能夠準備有實際上線時的機器
數，但是透過分析 scale factor ，我們可以預估上線該使用多少機器。</li>
</ul>
</div>
</div>
<div class="section" id="stress-test">
<h3>Stress Test</h3>
<p>與 Performance Test 不同的是， Stress Test 是看，應用程式在極度的狀況下，是怎麼樣反
應的，是全面性的停止服務，還是仍能正常處理部份的 request ，其餘未能處理的部份是被堆到排
程中等待處理、還是直接收到錯誤訊息告知服務暫時不可用。而當這極端的狀況停下來後，應用程式
是否會自行回復正常，還是需要
重新啟動才能回復正常。</p>
<p>Stress Test 的方式是直接把 performance test 中 <strong>處理量</strong> 開始反轉的那個點的流量再
次倍增，看處理量及反應時間會如何的變化。</p>
</div>
<div class="section" id="longevity-test">
<h3>Longevity Test</h3>
<p>Longevity Test 跟前述兩者不同的是， Longevity Test 是在看，應用程式對長時間、持續性、
平緩的流量是如何反應的，是否在某個時間點會有不良的反應，或者是說會有處理量越來越少或反應時
間越來越長的跡象。</p>
<p>透過 Longevity Test 我們可以發覺
- 應用服務是否有 memory leak
- 是否有背景的排程工作，造成某個時間點系統資源會被大量耗用</p>
</div>
</div>
<div class="section" id="monitoring">
<h2>Monitoring</h2>
<p>除了從應用程式的外部去觀查應用程式的執行效能，我們還可以更進一步的</p>
<ul class="simple">
<li>從作業系統了解CPU, Memory, Disc I/O, and Network Usage</li>
<li>從JVM 了解 Memory Usage, Object counts, GC Cycles.</li>
<li>從應用程式自訂的 metrics 來觀察 request count, method call time, size of queue,
cache hit/miss ratio, etc&#8230;</li>
</ul>
<p>透過截取、記錄、追縱這些數據，搭配上 Performance Test 產生的圖表，我們可以再進一步的了解
應用程式耗用了多少的資源，應用程式的 bottleneck 在那，是 cpu bound, memory bound,
disc io bound or network bound.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">不要小看了這些監控的細節，我的某個程式，有少量用到 ActiveMQ, ZooKeeper 做溝通，照理說
應該是 cpu or memory bound的應用，但是經過幾次 load test ，發覺不管加多少機器，總處
理量還是不變。後來翻了翻OS來的數據才發現，整個環境的網路頻寬被限制在 250M bps ，再進一
步了解到原來 Amazon EC2 的 Load Balancer 把流量限制在這個數字。</p>
</div>
<p>監控的工具有很多種，不過脫不了兩大類
- <strong>監控系統用量</strong> 如: Munin, Graphite, RRDTools
- <strong>監控系統異常</strong> 如: Nagios</p>
<p>這些監控工具，我們不只是可以套用在 Load Test 時使用，更該被大量的佈建在監控線上的應用程
式及外部的服務上，透過長期的追縱，我們可以了解到應用程式及外部的服務的可用度及可靠度。</p>
</div>
<div class="section" id="id3">
<h2>(全文完)</h2>
</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/19/parallel-external-merge-sort/">parallel external merge sort</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/19/clean-future-api-design-sort.rst/">Clean Future API Design</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/04/why-kimdotcom-can-offer-free-broadband/">為什麼 Kim DotCom/Mega 能夠提供免費的網路</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/03/move-erp-to-cloud/">中小企業ERP系統上雲端？</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/23/cloud-computing-and-rocket-science/">為什麼雲端產業在台灣行不通</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("yunglinho", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/yunglinho" class="twitter-follow-button" data-show-count="false">Follow @yunglinho</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/101164690243066571931?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
<a title="tumblr stats"
href="http://statcounter.com/tumblr/" target="_blank"><img
src="http://c.statcounter.com/8085210/0/5c96ca74/0/"
alt="tumblr stats" style="border:none;"></a></section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 -  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yunglin';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
