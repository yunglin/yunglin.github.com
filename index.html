
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>碎碎唸</title>
  <meta name="author" content="">

  
  <meta name="description" content="在這一系列的第一回我們談到，我們是軟體工程師，不談虛幻的概念，只講能夠量化追蹤的數值指標，那麼，
我們要怎麼把品質轉換程數值指標呢？ 軟體品質如何測量 幾個故事
在開始講怎麼做前，我想先講兩個我親身的經驗，在我第一份工作時，前雇主是做手機遊戲的，整間公
司有兩百個員工， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.yunglinho.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/yunglinho" rel="alternate" title="碎碎唸" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11857878-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">碎碎唸</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/yunglinho" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.yunglinho.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/23/slash-runtime-quality-metrics-series-3/">軟體品質指標系列(三)：軟體品質如何測量</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-23T14:45:00+08:00" pubdate data-updated="true">May 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在這一系列的第一回我們談到，我們是軟體工程師，不談虛幻的概念，只講能夠量化追蹤的數值指標，那麼，
我們要怎麼把品質轉換程數值指標呢？</p>
<div class="section" id="id1">
<h2>軟體品質如何測量</h2>
<div class="section" id="id2">
<h3>幾個故事</h3>
<p>在開始講怎麼做前，我想先講兩個我親身的經驗，在我第一份工作時，前雇主是做手機遊戲的，整間公
司有兩百個員工，但是只有三個是做Server端的，在 2005 年時，多數遊戲都是單機板的，那時公司
簽下 World Series Of Poker 要做多人的線上遊戲，需要開發一個簡易的配對及遊戲訊息交換的伺
服器，當然，大家當年都沒有經驗，所以說，要怎麼樣確保在上線時，不會被用戶衝垮就變成我的工作。</p>
<p>而在我第二份工作時，也有相似的經驗，我們本來已有一個運作中的音樂平台，讓公司內外超過40個Partner使用；
當時，公司又簽下一個合約，說是在三個月後的 6/1 ，會新增 200萬用戶！如何不讓大水衝垮我們的
應用程式，又變成我那幾個月的工作重點。</p>
<img alt="/images/2012-05-23/troops.jpg" src="/images/2012-05-23/troops.jpg" style="width: 800px;" />
</div>
</div>
<div class="section" id="load-test">
<h2>Load Test</h2>
<p>寫到這邊，大部份的讀者應該都知道接下來要講的是 Load Test 了，Load Test是個很大的議題，通
常我們在講 Load Test 時，常講的其實是三件不同的事</p>
<ul class="simple">
<li>Performance Test</li>
<li>Stress Test</li>
<li>Longevity Test</li>
</ul>
<p>這三個測試，用的工具雖然一樣，但是要找個指標跟目的卻是大不相同。</p>
<div class="section" id="performance-test">
<h3>Performance Test</h3>
<p>Performance Test 的目地是在找出應用程式的 baseline performance ，做為未來績效評估及設計變
隔時的準則。</p>
<p>被 Performance Test 的標的物，通常是已經 feature complete 的模組，然後我們將對模組的每
一個功能，一個一個進行黑箱及白箱測試；然後再用腳本的型態，模擬實際上線的流量，再來測試看看
各功能間對效能的互相影響程度；最後，是找到測試標的物的 Break Point 及 Branching Factor。</p>
<div class="section" id="best-case-performance">
<h4>尋找 Best Case Performance</h4>
<p>尋找應用程式的 best case performance  大概是最常被忽略的事了， best case performance 指的是你
一個功能的最佳效率，不管怎樣測試，對單一功能來說，怎麼樣你的效率都不可能會再比這個數字好了；這
個數字的第一個用處就在這，如果你的最佳效率比目標效率還糟，剩下來的就不用測了，因為怎樣都會
比這個數字還糟，只能先停下來，回去修改程式碼增進效能。</p>
<p>Best Case Performance 的測法是：</p>
<ol class="arabic simple">
<li>將應用程式啟動</li>
<li>先用幾個 request 替應用程式暖身(warm up)，以 Java VM 來說，這樣可以讓 Hotspot VM 幫 bytecode 最
佳化，有些需要被啟動的內部原件也會被啟動。</li>
<li>接著是一個一個的慢慢送一百個 requests ，然後取平均值及標準差。</li>
</ol>
<p>若是標準差的值過高，或者是反應時間有增長的現像，那麼這個狀況應該記錄下來，然後使用白箱測試的工具(如 <a class="reference external" href="http://www.yourkit.com/">yourkit profiler</a> 去
找問題的根源。</p>
<p>除了平均數及標準差外，常用的數字還有</p>
<ul class="simple">
<li>mean</li>
<li>standard deviation</li>
<li>minimum</li>
<li>maximum</li>
<li>96   percentile</li>
<li>99   percentile</li>
<li>99.9 percentile</li>
<li>5 minutes moving average</li>
<li>throughput</li>
<li>error rate</li>
</ul>
<p>另外，圖表也是常用的工具，因為相較於數字，圖表更容易看出來趨勢的走向；以下圖為例，藍線的平均反應時間是1.354秒，但跑load test二
時分鐘後，每一個 request 都已經超過了平均數，因此將數字用圖像來呈現是有助於判別數字的。</p>
<img alt="/images/2012-05-23/chart-1.png" src="/images/2012-05-23/chart-1.png" style="width: 480px;" />
</div>
<div class="section" id="performance-baseline">
<h4>建立 Performance Baseline</h4>
<p>接下來的工作，是定出比較的基礎，建立一個你覺得合理的流量，然後就這個比較基礎去找出來不同狀況下的平均反應時間及處理量的變化。</p>
<p>基礎效能的建立，我們要先控制兩個變數 <strong>requests per minutes</strong> 及 <strong>number of concurrent requests</strong> ；
透過調整這兩個變數，先找出反應時間較 best case 的流量，然後就此數字開始調整到一個你覺得合理的值，開始進行 Load Test。</p>
<p>劉接下來我們開始把 <strong>requests per minutes(RPM) 倍增</strong> 但 <strong>number of concurrent requests(CR) 不變</strong> 來看，當流量
增加時應用程式的反應時間會如何增長，接著是 RPM 及 CR 同時都倍增，看反應時間如何增長，依此規則，就二的次方(2^N)開始往
上增加，直到 response 開始嚴重衰退，或者 throughput 開始衰退。</p>
<p>接著，如果你的應用程式支援 Scale-Out ，那麼，我們依此規則，就 RPM, CR, Machines 三個變數再次就二的
次方(2^N)開始條整流量來做測試。</p>
<p>前面這個過程，可以幫我們了解以下幾件事</p>
<ul class="simple">
<li>應用程式對壓力的反應是如何，當流量被增時，反應時間成長的幅度是線性還是成等比級數成長。</li>
<li>處理量 throughput 是否會隨著 request 數增加而增加，是否在超過某個轉折點時，會開始反轉下降</li>
<li>上述的轉折點，便可當做未來評估是否需要增加機器或者是昇級機器的基準值。當實既須求接近這個點，或有事
件會造成流量超過這個點，那麼，我們就可以在事前進行反應。或者，在監控應用程式中加入警告，當線上程式逼近
這個值的時候，主動告知我們該加機器了</li>
<li>當我們增加機器時，如果應用程式不是寫成完全 stateless 的，而是有共享資料資源時，那麼，scale factor便
會小於 2，那麼，我們需要關查 scale factor 到底是隨著機器的增加而不變、還是緩慢成長、或者是快速成
長。即使因為某些因素讓我們不能夠準備有實際上線時的機器數，但是透過分析 scale factor ，我們可以預
估上線該使用多少機器。</li>
</ul>
</div>
</div>
<div class="section" id="stress-test">
<h3>Stress Test</h3>
<p>與 Performance Test 不同的是， Stress Test 是看，應用程式在極度的狀況下，是怎麼樣反應的，是全
面性的停止服務，還是仍能正常處理部份的 request ，其餘未能處理的部份是被堆到排程中等待處理、還是
直接收到錯誤訊息告知服務暫時不可用。而當這極端的狀況停下來後，應用程式是否會自行回復正常，還是需要
重新啟動才能回復正常。</p>
<p>Stress Test 的方式是直接把 performance test 中`處理量`開始反轉的那個點的流量再次倍增，
看處理量及反應時間會如何的變化。</p>
</div>
<div class="section" id="longevity-test">
<h3>Longevity Test</h3>
<p>Longevity Test 跟前述兩者不同的是， Longevity Test 是在看，應用程式對長時間、持續性、平緩的流
量是如何反應的，是否在某個時間點會有不良的反應，或者是說會有處理量越來越少或反應時間越來越長的跡象。</p>
<p>透過 Longevity Test 我們可以發覺
- 應用服務是否有 memory leak
- 是否有背景的排程工作，造成某個時間點系統資源會被大量耗用</p>
</div>
</div>
<div class="section" id="monitoring">
<h2>Monitoring</h2>
</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/22/runtime-quality-metrics-series-2/">軟體品質指標系列(二)：軟體品質指標有那些</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-22T17:49:00+08:00" pubdate data-updated="true">May 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>接下來，我們就來探討，軟體品質指標有那些種類</p>
<div class="section" id="availability">
<h2>可用度 Availability</h2>
<p>一個服務的可用度，是由很多環節組合起來的，某些環節是掌控在開發者手中，某些環節則是
在使用者手中的；對使用者來說，一個服務的可用度，是由底下幾個環節的總合：</p>
<ul class="simple">
<li>軟體本身的可用度</li>
<li>IT/Cloud 架構本身的可用度</li>
<li>服務提供者端的網路環境</li>
<li>外部服務的可用度</li>
<li>使用者端的網路環境</li>
</ul>
<p>在計算 Availability 時，是把上面幾個因素相乘起來，便是你服務的可用度，假設你的IT架構
本身只能提供 99.99% 的可用度，那你的服務本身的可用度將會小於 99.99% 。當然，你可以透
過 Multi-Host 的方式，將服務布建在多個不同 Data Center，此時你的服務可用度，將可超
過單一平台可以提供的可用度。</p>
<blockquote>
假設 Cloud A 可以提供的可用度是 99% ， Cloud B 可以提供的可用度是 98% ，而你將服
務同部布建在兩者之上，那麼兩者一起停機的機會是 (1-99%)*(1-98%) = 0.02% ，因此可靠
度提昇為 99.98% 。</blockquote>
<p>然而，為了提高可靠到而佈建到 Multi-Host 時，不只要把 Presentation Layer / Frontend 放
到多個平台上面去，同時，使用者的資料也要同步到多個平台去，這樣，才能夠必免單一IT平台停機的
問題。但是這麼一來，當停機的平台再次上線時，如何處理資料的不一致問題，便成了另一難題。因此
，多數的服務提供者只會把服務佈建在單一平台上。</p>
<div class="section" id="id1">
<h3>服務提供者端的網路環境</h3>
<p>目前，多數的雲端服務商仍是把主機設立在海外，在台灣沒有 Data Center ，因此，當台灣對外的海
纜出了問題時，雖然服務本身在海外仍是可用的，但是在台灣就連不上線，這一點，也是台灣的開發者
在選用雲端平台時需要考慮進去的。</p>
<p>過去幾年來，台灣對外的海纜，幾乎每兩年都會斷線超過一天。</p>
<blockquote>
<ul class="simple">
<li>2001/02/09 中美海纜遭魚船勾破，數據傳輸容量遽減至原來的四成。HiNet, SeedNet, TaNet 均受影響</li>
<li>2003/10/02 中美海纜遭魚船勾破</li>
<li>2006/12/26 恆春地震造成四條國際海纜中美海纜、法新歐亞三號、亞太光纜一號二號網絡斷線，影響到台灣對中國、香港、新加坡等東南亞國家和地區，以及上述地區對外的國際通信。耗時三週修複。</li>
<li>2009/08/13 莫拉克颱風造成對外海纜斷線，影響台灣往中國大陸汕頭及東南亞地區，包括新加坡、菲律賓及香港等地之通信。影響時間超過一週</li>
<li>2010/03/04 高雄甲仙地震造成中美海纜斷線，影響時間超過一個月</li>
<li>2011/11/14 ~ 2012/21/26 海纜進行維修，將造成HiNet連線中國之部份連網服務傳輸延遲時間變長。</li>
</ul>
</blockquote>
<p>若是你服務的對像是以亞洲為主，還是建議放在台灣或日本，若是服務對像以全球為目標，建議還是就放在美國吧。</p>
</div>
<div class="section" id="soa-in-reality">
<h3>外部服務的可用度 / SOA in Reality</h3>
<img alt="/images/2012-05-22/cloud-farm.jpg" src="/images/2012-05-22/cloud-farm.jpg" style="width: 400px;" />
<p>在幾年前，流行的系統架構是 SOA ，讓每一個團隊專注在單一面向功能的服務，將服務透過SOAP/Restful API供
內部及外部的使用者來使用。這樣的好處是，可以增快服務更新的速度減少測試的範圍，在組織上，也可讓組織將重點
放在核心服務上，而將其它的需求委由外部服務處理。</p>
<p>如此一來，對使用者來說，多重 SOA 子服務組合而成的服務，看起來就像是在雲端運行的一台大電腦，跟舊式的服務
並沒有差異。</p>
<img alt="/images/2012-05-22/cloud-server.png" src="/images/2012-05-22/cloud-server.png" style="width: 400px;" />
<p>然而經過幾年的經驗後，大家發現實際上的經驗並不是那麼的美好；如同開頭所說的，服務的可用度，是所有子服務的
總合，單一服務的問題，將會把整體的可用度都拉低。</p>
<p>在我的實務經驗上， SOA 架構，反而變成無止境的 finger pointing ，最後變成，需要對所有外部服務的可用度做
長期的追縱，評估他實際上的可用度。另外，在委外給外部服務時，只會把可以離線處理的服務委外給外部服務，需要線
上即時處理的，還是自行開發較好。</p>
<img alt="/images/2012-05-22/finger-pointing.png" src="/images/2012-05-22/finger-pointing.png" style="width: 400px;" />
</div>
<div class="section" id="service-level-agreement-term-of-service">
<h3>Service Level Agreement / Term of Service</h3>
<p>TBD</p>
</div>
</div>
<div class="section" id="manageability">
<h2>可維護性 Manageability</h2>
<p>可維護性指的是，一個服務在運行時，留下了多少的資料，供 admin 做為判斷服務狀況的依據。一個線上的服務，除了
基本的 log 檔外，還需提供底下的特性</p>
<ul class="simple">
<li>Configurability: 提供設定檔，讓 admin / tester 能夠在不修改程式碼本身，而對軟體的功能做條整。</li>
<li>Monitorability : 提供開放性的介面，讓 admin 可以很容易的去追縱服務本身的建康狀態及用量，供 admin 來判斷，是否需要增加硬體的來分散線上伺服器的負擔。</li>
</ul>
<div class="section" id="monitoring-is-must">
<h3>Monitoring is Must</h3>
<p>在提供一個服務時，我們一定要監控服務本身的狀況，並且要把這份資料與外部分享，減少本身溝通的成本及增加客戶對
服務的信任。</p>
<p>不管是設計多麼精良的服務，各個軟體平台商仍免不了會發生大型的災難，如：</p>
<ul class="simple">
<li>Amazon AWS 於 2008, 2010, 2011 各發生過數小時的問題，造成 EBS 使用上的問題，導制 reddit, zynga 等下遊廠商的服務問題</li>
<li>Google Gamil 於 2009 年發生過大形的停機，耖造成拳體用戶無法使用 Gmail 兩個半小時。</li>
<li>Azure 於 2012/02/29 ，由於時間同步的問題，造成用戶無法開啟新的 VM instance.</li>
</ul>
</div>
</div>
<div class="section" id="performance">
<h2>Performance</h2>
<p>效能，算是個最常用的品質指標了，在講效能時我們通常會分成兩塊來講，一塊是反應時間(Response Time)，
另一塊是處理量(throughput)，前者只的是服務單一需求所要花的時間，後者則是單位時間內，可同時服務的
總需求數量。</p>
<p>影響效能的因素有很多，在多數的系統中，往往處理量增加的結果就是反應時間也一起增加，因此在系統設計
的初期，這些就要納入規格中，變成設計的一環；那麼，什麼是好的效能呢？在反應時間這邊有個很好的指標
，就是跟人互動的UI程式，如果反應時間能壓在 100ms 以下，那麼人們的認知就會覺的這個程式是即時使用
的，如果反應時間拉到 200ms 以上，就會開始覺得頓頓的。</p>
<p>對於網頁程式來說，反應時間不只是從 Web Server 這一端出去的時間，還要算上網路傳輸的時間以及流覽
器繪製畫面的時間，因此能留給網站主機的反應時間只剩下 50ms 上下；如果你的程式還有呼叫其於的外部
程式，那麼每多一層，反應時間至少增加 20ms ，或者是說少 20ms 給你的程式使用。</p>
</div>
<div class="section" id="reliability">
<h2>Reliability</h2>
<p>可靠度(Reliability)跟可用度(Availability)是兩個常被弄混的名詞，Availability講的是，在一段長的時間內，系統可被使用的時間(Up Time)，
Reliability則講的是在單位時間內，系統出錯的次數。一個線上服務，可能是可用的(Available)但是他的輸出結果是有問題的(Unreliable)</p>
<p>Reliability 的評量指標有</p>
<ul class="simple">
<li>單位時間內，回傳錯誤訊息或者是無回應的次數。</li>
<li>單位時間內，輸出結果是錯誤的次數。</li>
</ul>
<p>Reliability的問題，往往是系統內的 Bug ，只是在使用量大時，才會凸顯他的存在，因此軟體開發者不可忽略這微小的訊號。</p>
</div>
<div class="section" id="scalability">
<h2>Scalability</h2>
<p>Scalability 講的是你的服務能不能夠隨著用戶數的增長，而跟著成長，服務的可延展性可以分為， <strong>直向擴充 Scale Up</strong> 及
<strong>橫向擴充 Scale Out</strong> ，兩者都可以幫你增加可同時服務的線上用戶數，但是後者的可擴充的程度，仍是遠高過前者的。</p>
<p>Scalability 讓我們動態的依事件配置不同數量的伺服器數量，以防止 Slashdot Effect 的發生，如總統大選或報稅截止日等事件
，往往會在一日內擁入超過平日百倍的用戶數，如何讓服務正常運做，是軟體品質極重要的一環。</p>
<p>而 Scalability 對 Application Service Provider 更是重要，因為 Cloud Based ERP or CRM 系統，較一般的網頁更有黏
著性，一個有數萬個用戶的中型網站，同時間上線的用戶可能只有數百個，而於他們的 Session 中存的資料也只有數 kilo bytes。
然而對企業用戶來說 Cloud Based ERP, CRM ，在上班時間，可是一直在使用的，一間 200 人公司用的 ERP 系統，可能就會有
200 active sessions ，每個 Session 又存了許多正在處理中的表格資料。</p>
<p>如何 scale up/out database intensive application 變成 ASP 提供者不得不面對的難題。</p>
</div>
<div class="section" id="security">
<h2>Security</h2>
<p>網路服務的安全性問題，常常是個被誤會且忽略的問題，台灣許多主流的 Hosting Company 及 Billing Provider 的網站都出
過問題；他們的問題是，某本常用的軟體手冊的程式碼，在教導如何實作使用者認證時，只有在首頁有檢查帳號，等帳號檢查過了，
就會被導到內部的網頁去，然而，在內部網頁這邊，卻沒有檢查使用者有沒有登入。</p>
<p>變成，只要得知內部網業的網址(form target)就可以直接存取內部的資料，因此，許多網站就被 Search Engine Crawler 長驅
直入，把所有的使用者資料都放在搜尋結果中公開了。至於實既的例子我就不多舉了。</p>
<p>另外我有寫過一篇 <a class="reference external" href="/blog/2012/01/03/how-to-protect-a-webservice/">專文</a> 討論，該如合保護一個 WebService ，台灣的政府及民間網站，常常用一些沒有被認可的電子簽證來做 https 的
安全通訊，然而 https 的金鑰交換，在第一次是不安全的，因此，若是你的金鑰是沒有經過第三方簽核的，那麼再交換金鑰時可能
會受到 <a class="reference external" href="http://en.wikipedia.org/wiki/Man-in-the-middle_attack">Man in the middle attack</a> 直接把金鑰換掉。</p>
<p>使用 https 時，必需遵守幾個使用規範，這樣子通訊才會是安全的。</p>
<p>回到正題，服務的安全性可以分為幾塊</p>
<ul class="simple">
<li>通訊的安全性。</li>
<li>身份的認可查核</li>
<li>資料的安全性及使用權限</li>
<li>資料的使用及變更的計錄追蹤</li>
</ul>
</div>
<div class="section" id="id3">
<h2>待續</h2>
<p>在下一篇，我將講述，如何把這些概念，轉換成實際的數值指標。</p>
</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/17/runtime-quality-metrics-series-1/">軟體品質指標系列(一)：為什麼軟體開發者需要在意軟體品質指標</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-17T11:01:00+08:00" pubdate data-updated="true">May 17<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>下個月受軟協的邀請，要跟國內發展雲端服務的廠商講一場演講，原本想講的是 Coda Hale 的 <a class="reference external" href="http://metrics.codahale.com/">metrics library</a> 的使用
不過跟軟協的詹副秘書長聊了一聊後，決定把主題改成 <em>軟體品質</em> ，畢竟，太偏實作的東西，拿來給
中高階主管聽，可能會睡著吧 XD</p>
<div class="section" id="id1">
<h2>軟體品質指標</h2>
<p>一般我們在談軟體績效指標時，多講的是 <em>Lines Of Code</em>, <em>Number of Functions</em>, <em>Number of Classes</em>
, <em>Cohesion and Coupling</em>, <em>Test Coverage</em> 等，但是，我今天想講的不是這些靜態分析所使
用的指標，而是在程式運行時的評量指標 Production/Runtime Quality Metrics。</p>
<p>這些執行階段的品質指標，讓我們了解程式在運行時的效率(performance),可靠度(reliability),可
用度(availability),維護性(maintainability)等重要問題。</p>
</div>
<div class="section" id="id2">
<h2>為什麼我們要在意這些指標</h2>
<p>在台灣的許多軟體公司可能會問，為什麼我們需要在意這些指標？這些指標又不能拿來賣，客戶在意的是功
能及價錢，開發客戶所需要的功能及尋找客戶，比做這些沒辦法拿來賣錢的東西重要多了。部份中小企業主
認為，找案子跟找錢，才是軟體公司生存之道，軟體品質，是可以在案子簽下來後甚至結案時在去關心就好。</p>
<img alt="/images/2012-05-17/busy_1.png" src="/images/2012-05-17/busy_1.png" />
<img alt="/images/2012-05-17/busy_2.png" src="/images/2012-05-17/busy_2.png" />
<p>但是，如果我們換一個角度來看，這些執行階段的指標，也可以是軟體功能的一環，可以當做銷售時期
的功能及策略性武器來看；試想，若是有兩家小公司來賣你雲端服務，一間滿口都是功能可以做到OOXX
，我們的服務是一條龍，什麼都做的到。另一間則是把功能的項目清楚的定意出來，同時也告訴你，他們
的服務同時可以服務多少客戶、過去的停機維修週期是多少、他們可以保障的可靠度是多少；身為專案採
購人員的你，會比較 <strong>信任</strong> 那一家的說法呢？</p>
</div>
<div class="section" id="id3">
<h2>軟體賣的就是信任</h2>
<p>軟體賣的就是信任，信任你的軟體，不會出問題把客戶的重要商業資料、商業流程、及客戶關係都一起毀掉。</p>
<dl class="docutils">
<dt>在過去單機板的軟體環境下，軟體賣的是</dt>
<dd><ul class="first last simple">
<li>信任軟體的功能有達到預期目標</li>
<li>信任軟體不管跑多少次，都有一致性的輸出</li>
<li>信任軟體的資料儲存是可靠的</li>
<li>信任軟體的資料可以轉換到另一個昇級版本或其它軟體</li>
</ul>
</dd>
</dl>
<p>許多單機版或 2-Tier 的程式，經過時間的證明，他們的生命週期，甚至超過了開發者的生命週期，許多
國內百貨零售業用的進銷存系統，目前仍是在用20年前的 DOS 系統就是一例。對客戶來說，他們對這些DOS版
軟體的信任，超越了新科技所帶來的新功能需求。只要更新硬體，他們就可以繼續使用這些軟體，甚至是享受新
硬體所帶來的更高效能。</p>
<p><strong>信任</strong> 在雲端服務上，更是重要；在享受雲端服務的便利的另一方面，雲端服務的使用者更是需要放更多
的信任在服務提供商上，除了上述的信任外，客戶還要信任你的服務可以隨著他的服務及你的服務一起增長。</p>
<div class="section" id="slashdot-effect">
<h3>Slashdot Effect</h3>
<p>在談服務的可靠度時，我常用 <a class="reference external" href="http://en.wikipedia.org/wiki/Slashdot_effect">slashdot effect</a> 來當例子，換成中文就是「爆紅效應」，slashdot 是
國外一個很大的科技網站，一登上 slashdot 的首頁，在短短的一天內，就可以帶來數十萬的訪問數及數萬的註
冊會員，然而，爆紅後帶來的往往是個災難，許多的軟體在設計、佈建(deployment)時，並沒有考量到會有這麼
大量的用戶，因此一爆紅後往往就是停機收場。</p>
<p>overnight success turns into overnight disaster. 爆紅後，留下的是一些不滿意的負面記錄，
讓客戶及潛在客戶，喪失了對服務的信任；在這個有 Google 等搜尋引擎的年代，過去的不良記錄將永久留
存在網路上，因此，服務的 <a class="reference external" href="http://horicky.blogspot.com/2009/07/between-elasticity-and-scalability.html">可延展性(Scalability &amp; Elasticity)</a> 變的格外重要。</p>
</div>
</div>
<div class="section" id="id5">
<h2>如何建立信任</h2>
<p>信任是個很抽象的名詞，你摸不到看不到，但是卻在人與人的往來，無形中慢慢的形成；信任就如宗教信仰一樣，
你無法買到，無法強迫別人去接受、也無法一促即成，只能一步步的去建立。</p>
<p>但是，我們是軟體工程師，我們信仰的是科學、是工程技術、是數字管理，我們善長的是透過科學的研究手法，
一步步的去拆解問題，弄清楚什麼是已知的事實，什麼是未知的問題，面對問題，解決問題。</p>
<p>販賣口號，不是軟體工程師所善長及該做的。</p>
<img alt="/images/2012-05-17/we-can-do-it.jpg" src="/images/2012-05-17/we-can-do-it.jpg" />
</div>
<div class="section" id="id6">
<h2>可量化的軟體品質就是信任的來源</h2>
<p>對於中小企業及新進入雲端服務的公司，「可量化的軟體品質指標」就是可以最快取得客戶信任的方式；我希望
在未來的某一天，我可以聽見台灣的軟體公司是這麼介紹自己的產品</p>
<blockquote>
我們的網路服務，能夠同時服務兩百萬上線用戶，提供 50ms 以下的即時性的反應，我們的服務，整合了超過
40個內部及外部的開發商客戶，在過去的兩年內，我們提供了 99% availability ； Agile 的開發流程，
讓我們有一致的服務更新週期，面對軟體 Bug 我們能夠提供客戶一個預計的修正時間，並準時將補丁上線。</blockquote>
<p>待續&#8230;</p>
</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/17/ridiculous-rule-change/">鬼島之鬼交通法規變革</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-17T00:35:00+08:00" pubdate data-updated="true">May 17<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近脾氣好像大爆發，對鬼島的很多事情很不爽。覺得真的沒救了，核四當然是最大問題，另一塊大問題就是台灣的法規。</p>
<p>台灣的法規許多就是官員我說了算，沒什麼科學根據的；不像美國法律，很多(交通)法規，你細看下去，其實滿滿的是學理，而不是中國人的想當然爾。</p>
<p>今天又看到個鬼島的鬼例子，原來CRV2上市前，被國內車商整，推動交通部去改法規，
<a class="reference external" href="http://www.mobile01.com/topicdetail.php?f=261&amp;t=1881390&amp;p=2#24145485">讓CRV2不適用小客貨車的15%稅率，而要用35%的稅率，讓CRV一台要多繳12萬的稅</a> ，喪失產品競爭力。</p>
<p>民國91年五月前的原本的條文是:</p>
<pre class="literal-block">
 三、客貨兩用車：
（一）大客貨兩用車：總重量逾三、五ＯＯ公斤，並核定載人
     座位，或全部座位在一Ｏ座以上，並核定載重量之汽車。
（二）小客貨兩用車：總重量逾三、五ＯＯ公斤以下，並核定
     載人座位及載重量，或全部座位在九座以下，而又核定
     載人座位及載重量之汽車。
</pre>
<p><strong>91年五月後被改成</strong>:</p>
<pre class="literal-block">
 三、客貨兩用車：
（一）大客貨兩用車：總重量逾三千五百公斤，並核定載人座位，或全部
     座位在十座以上，並核定載重量之汽車。
（二）小客貨兩用車：總重量在三千五百公斤以下，或全部座位在九座以
     下，並核定載人座位及載重量，其最後一排座椅固定後，後方實際
     之載貨空間達一立方公尺以上之汽車。
</pre>
<p>不知道當年立法單位，跟據什麼原則理由，做出這樣的變革的？原本後排座椅可前後移動，車輛使用更有彈性，不知為何要走倒退路呢</p>
<p>看來，答案可能就如同 <a class="reference external" href="http://www.mobile01.com/topicdetail.php?f=444&amp;t=2737205&amp;p=4#35905978">01 上 爆料</a> 的一樣，是被國慘車王子整了</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/08/shall-patent-apply-to-business-model/">Shall Patent Apply to Business Model</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-08T14:27:00+08:00" pubdate data-updated="true">May 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>看到 Oracle 告 Google 被判定 API 也可享有著作權，讓我想到我非常多年
前授教於劉靜怡教授底下，集各家大成(抄襲)而成的一篇期末報告。</p>
<p>至於到底什麼該被 Patent 保護，什麼不該被 Patent 保護，What is patent worth，日
後，受教於 <a class="reference external" href="http://econ.arizona.edu/faculty/pingry.asp">Dr. David E. Pingry</a> 時，他用了一個 <a class="reference external" href="http://www.sciencedirect.com/science/article/pii/S0167923604002374">方程式</a> ，回達了我的問題。</p>
<p>數學模型之美，差點讓我改念 Econ PhD. 還好我太愛玩英文寫作又太差，所以沒有繼續念博士。</p>
<p>時光飛逝，我的年紀已比初識劉教授，教授當時的年紀還大了，十多年過去，我從那個長髮怪變怪叔叔了，
在專業上還是一事無成阿&#8230;</p>
<div class="section" id="shall-business-model-apply-to-patent">
<h2>Shall Business Model Apply to patent?</h2>
<p>前言：</p>
<p>1999年10月21日，全美第一大網路書籍、音樂零售商亞馬遜書店（Amazon）於西雅圖地方法院提出告訴，主張美國第一大書店Barnes &amp; Noble所設立的網路
書店barnesandnoble.com侵害其於同年9月28日獲准享有專利權之「1-Click technoloby」（Patent No. 5,960,411）；掀起了全球對商業模式是否適用
於專利權的重視。而國內經濟部智慧財產局與中華民國發明協會於2000年04月11日在台北國際會議中心舉辦的一場「新電子商務教戰守策國際研討會」，更
是讓這個話題在國內變的熱門起來。</p>
<dl class="docutils">
<dt>到底是否商業模式是否適用於專利權保障，本文將就下列幾個論點進行討論：</dt>
<dd><ul class="first last simple">
<li>一、商業模式適用於專利權的法源基礎</li>
<li>二、商業模式適用於專利權造成的影響</li>
<li>三、各國對於商業模式適用於專利權造成紛爭的回應</li>
<li>四、專利法在人類社會到底該辦演的是何種角色？又專利法該適用於商業模式嗎？</li>
<li>五、商業模式失去了專利權保障，網路公司該如何獲利</li>
</ul>
</dd>
</dl>
<p>冀望透過一系列的思考，將問題釐清頭緒</p>
</div>
<div class="section" id="id2">
<h2>一、商業模式適用於專利權的法源基礎</h2>
<p>在過去，電腦軟體一向被認為僅得受到著作權法及營業祕密法之保護，而無法申請獲准專利，在資訊產業一向居於領導地位的美國，其實務界在以往亦認為
電腦軟體不得申請專利，然而在軟體產業高度發展且各項軟體之應用日趨商業化後，軟體研發成果之週全保護成為不得不正視之議題，許多企業為確保其商
業之經營與投資，一再試圖尋求軟體之專利保護，一九八一年之Diamond v. Diehr一案，其中牽涉到的係一個以數學公式為基礎之電腦程式應用於控制橡
膠製模成形的時間，美國聯邦最高法院此一判決使電腦軟體至少確保了可獲得專利法保護之可能性。[1]</p>
<p>為實務上運作之需要，美國專利商標局（US PTO）隨即於一九九六年公佈了「電腦相關發明審查基準」
（Examination Guidelines for Computer-Related Invention），明定審查基準為機械、方法、製造品之法定標作為專利商標局審查軟體專利時之依據。</p>
<p>原本美國專利商標局審查員逕可核駁商業方法(Method of Doing Business)請求，但美國聯邦巡迴上訴法院於State Street Bank and Trust Company, v.
Signature Finacial Group, Inc.(38 USPQ2d 1530, 927 F. Supp. 502.) 一案中判決『審查員審查專利申請案含有商業方法請求項時，不可逕將該請求項
歸類成商業方法，而應以方法請求項進行實質審查』。此即商業方法申請案若符合可專利要件，再經審查員審定者，亦可能獲證。[2]</p>
<p>與State Street Bank &amp; Trust Co. v. Signature Financial Group Inc.,(47 U.S.P.Q.2d 1596（Fed. Cir. 1998). cert. denied, 119 S.Ct. 851）一
案中，判決確認一項用於網際網路之商業方法(business method）軟體具有可專利性（patentable subject matter）[3]</p>
<p>自此，造就了商業模式適用於專利權的法源基礎，也開啟了另一新的網路專利戰爭，許多網路公司，將賴以為生的技術與商業模式權利化、法律化。冀藉此
將競爭者排除於電子商務領域之外。</p>
</div>
<div class="section" id="id3">
<h2>二、商業模式適用於專利權造成的影響</h2>
<p>從去年 9月中至今，在美國即發生了數件與電子商務有關的專利訴訟，因為訴訟當事人均是諸如Microsoft、Amazon、Barnes&amp;Noble、DoubleClick等在電子
商務界舉足輕重的大公司，乃引發網路界的重大關切。底下就依發生時間簡述案件的經過。[4]</p>
<div class="section" id="priceline-commicrosoft">
<h3>1.priceline.com控告Microsoft</h3>
<p>1999年10月13日priceline.com Inc.於美國康乃狄克州地方法院對Microsoft提出告訴，主張Microsoft所提供之網路旅館價格拍賣 (Hotel Price Matching
System) 侵害其享有專利權之reverse auction patent (patent 5,794,207)，因為Microsoft於卓站中的Expedia travel site提供一套名為「name your price」
系統，由網路使用者輸入旅遊地點、希望的旅館等級及預算後，選出最適合該使用者之旅遊行程，並自動將該使用者之信用卡號碼寄給接受該筆交易的旅館
。而上述「name your price」系統所應用的商業方法正是priceline.com Inc.申請獲准之5,794,207專利涵蓋的範圍。</p>
</div>
<div class="section" id="amazonbarnesandnoble-com">
<h3>2.Amazon控告barnesandnoble.com</h3>
<p>繼priceline.com Inc.之訴訟後，全美第一大網路書籍、音樂零售商亞馬遜書店 (Amazon) 於10月21日在西雅圖地方法院提出告訴，主張美國第一大書店
Barnes &amp; Noble所設立的網路書店barnesandnoble.com侵害其於1999年09月28日獲准享有專利權之「1-Click technoloby」 (Patent No. 5,960,411) 。</p>
<p>Amazon於訴訟中除請求相當於三倍合理權利金之損害賠償及訴訟費用外，Amazon更申請法院發布禁制令，禁止Barnes &amp; Noble繼續使用相同之商業方法。
於禁制令頒布後，Barnesandnoble.com即表示將於近日內推出一種名為「Express Checkout」的新服務，並指出該公司將提出上訴，因為Amazon所獲得的專利其
實是一種早被廣泛使用的科技。</p>
</div>
<div class="section" id="doubleclickl90-inc">
<h3>3.DoubleClick控訴L90 Inc.</h3>
<p>知名的網路廣告DoubleClick於1999年11月12日向維吉尼亞州東區地方法院控訴加州網路公司 L90 Inc.侵害其有關傳輸、鎖定與衡量網路廣告之專利「Method
of Delivery,Targeting and Measuring Advertising over the Internet」(Patent No. 5,948,061) 。</p>
<p>由於該專利為目前多數網路廣告普遍採行的方式，因此倘若法院判決DoubleClick勝訴者，則絕大多數提供網路廣告的公司通通都會被逐出該市場而無法繼續經營。</p>
<p>上述的三個案例，均有利用專利訴訟來達到排除競爭對手目的的意味，此外其專利在獨創性上更有所爭議；將已普遍使用的技術通過專利申請，US PTO對於
專利的發放是否過於浮爛呢？</p>
</div>
</div>
<div class="section" id="id4">
<h2>三、各國對於商業模式適用於專利權造成紛爭的回應</h2>
<p>跟據電子時報2000年05月05日的報導[5] ，日本、美國與歐盟 (EU) 的專利組織日前宣佈，將加強在電子商務商業模式 (Business Model) 專利權審核方面
的合作，以創造合適的環境，幫助新產業發展。三方國家組織的專利機構將以建立國際共同的認定標準為目的，預計2002年架構既有商業模式專利資料庫，
共享各種資訊。各國將強化在專利資訊上的交流，共享審核報告、法院判例等資訊。各專利機構也將進行專利權實例分析，以建立公認的專利認定標準，並
共同對負責審核的法官進行教育。由於電子商務可能是跨國經營，在某一國家的企業可能在另一國家侵犯其他企業的專利，各國必須及早建立共同的標準。</p>
<p>美國對商業模式專利的認定甚為積極，1999年約有600件專利權申請獲得通過。從1999年層出不窮的專利訴訟可知一斑。美國政府指出，商業模式專利對產業
發展是不可或缺的一部份，由於負責的法官對電子商務專利審核的經驗與資料可能較為欠缺，美國將盡力給予日本、歐洲等國家有關此方面的協助。</p>
<p>各國預定在七月舉行的國際高峰會議中達成共識，將從嚴訂定審核標準。除保障申請專利者的權益外，也要防止專利權被濫用。</p>
</div>
<div class="section" id="id5">
<h2>四、專利法在人類社會到底該辦演的是何種角色？</h2>
<p>專利法該適用於商業模式嗎？</p>
<p>中華民國專利法第一條便開宗明義宣告「為鼓勵、保護、利用發明與創作，以促進產業發展，特制定本法。」而世界各國的專利法也是依此原則所立法。</p>
<p>基本上經濟學家認為，專利權的存在具有兩個功用─創作 (Invention)與創新 (Innovation) ，前者指的是從事發明的行為，後者指的是將發明市場化。接
著本文將從這兩個角度來探討專利法該適用於網際網路的商業模式嗎？</p>
<div class="section" id="id6">
<h3>1.創作動機理論</h3>
<p>創作動機理論或許是最常見為專利權背書的經濟學理論，這理論認為，專利權的存在是在鼓勵那些若失去專利權保障便不會發生的發明。也就是說專利權提
供了發明的誘因。從反方向來思考，對於不須要專利權保障便會發生的發明是否便不須要給與專利上的保障呢？</p>
<p>根據 IDC公司估計，至2002年全球透過網際網路網站之交易金額將突破4000億美元。究竟在如此龐大的經濟誘因之下，失去專利權保障，各種不同的網際網
路商業模式難到就不會被發明嗎？</p>
</div>
<div class="section" id="id7">
<h3>2.創新理論</h3>
<dl class="docutils">
<dt>創新理論認為</dt>
<dd><ol class="first last arabic simple">
<li>對大公司來說，由於政府規定對於專利權的標的物必須充分揭露資料，為了避免在專利過期後無償被公眾使用，在專利權期間必定會大量授權給其它廠商以謀取利益。</li>
<li>對創業家來說擁有獨佔的專利權，較容易於市場上集資。</li>
</ol>
</dd>
</dl>
<p>相較於後者的說法，前者應用在網際網路商業模式時便不太恰當，由於電子商務是屬於全球化的競爭，將商業模式授權給它人僅會增加競爭對手，且在變化
快速的網際網路上，一個好的商業模式很可能在半年內便被另一個更好的取代，因此相較於開放市場，倒不如獨占市場較有利可圖。</p>
<p>綜觀上述兩點，本文認為商業模式適用於專利權並不恰當。</p>
</div>
</div>
<div class="section" id="id8">
<h2>結尾、商業模式失去了專利權保障，網路公司該如何獲利</h2>
<p>寫在最後本文想要引入一個觀念，就是由 Richard M. Stallman與自由軟體基金會[7] 所倡導的 Free Software與Eric Raymond的OpenSource中的軟體無價
服務有價；將技術開放出來成為公共財，促進整體經濟的繁容，而透過應用技術的服務賺取利潤。</p>
<p>對於商業模式的發明者來講，一個新的商業模式，從一開始便擁有市場的競爭優勢，外在的進入者在進入這個市場的時候就必須跨過這個關卡，受不受到專
利權的保障似乎並不那麼重要。</p>
</div>
<div class="section" id="id9">
<h2>參考資料：</h2>
<dl class="docutils">
<dt>[1]電腦軟體專利對電子商務之影響</dt>
<dd><a class="reference external" href="http://www.ithome.com.tw/column/eclaw/eclaw20000224.html">http://www.ithome.com.tw/column/eclaw/eclaw20000224.html</a></dd>
<dt>[2]美國電子商務專利之最新動態</dt>
<dd><a class="reference external" href="http://stlc.iii.org.tw/publish/ipma/23/2305.htm">http://stlc.iii.org.tw/publish/ipma/23/2305.htm</a></dd>
<dt>[3]Internet Business Methods: What Role Does and Should Patent Law Play?</dt>
<dd><a class="reference external" href="http://scs.student.virginia.edu/~vjolt/graphics/vol4/v4i2a9-grusd.html">http://scs.student.virginia.edu/~vjolt/graphics/vol4/v4i2a9-grusd.html</a></dd>
<dt>[4]電子商務網路專利世紀大戰－從Amazon告Barnes Noble侵權談起</dt>
<dd>電子時報  1999.12.14  網路與軟體專欄</dd>
<dt>[5]日美歐加強EC專利審核</dt>
<dd><a class="reference external" href="http://news.kimo.com.tw/2000/05/05/technology/digi/320333.html">http://news.kimo.com.tw/2000/05/05/technology/digi/320333.html</a></dd>
</dl>
<p>[6]ROBERTO MAZZOLENI &amp; RICHARD NELSON, ECONOMIC THEORIES ABOUT THE BENEFITS AND COSTS OF PATENTS (1996).</p>
<p>[7]http://www.fsf.org</p>
</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/30/mongodb-dao/">Mongodb Scala DAO</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-30T11:50:00+08:00" pubdate data-updated="true">Apr 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>這篇文章將說說，我使用 MongoDB &amp; Cashbah 的一些心得，這程式的主架構是
我從 <a class="reference external" href="https://github.com/aboisvert/simplistic">simplistic</a> 學來的。</p>
<div class="section" id="the-abstract-dao">
<h2>The Abstract DAO</h2>
<p>底下是一個很簡單的 CRUD 的 MongoDB DAO. 在這邊，我們建立一個 DAO 時，我們會把這
個 DAO 用的儲存空間 MongoCollection 傳進來，另外要注意的一點是，這個 MongoCollection 的
WriteConcert 必需是 Strict 的。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> *  Base class for all DAO classes.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">AbstractDAO</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ID</span> <span class="k">&lt;:</span> <span class="kt">Serializable</span><span class="o">](</span><span class="k">protected</span><span class="o">[</span><span class="kt">locadz</span><span class="o">]</span> <span class="k">val</span> <span class="n">mongoCol</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** builder to turn mongodb object into model object */</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">builder</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">T</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** builder to turn model object into mongodb object */</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">extractor</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="nc">DBObject</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** this dao expects the underlying mongoCol would throw exception when error occurs. */</span>
</span><span class="line">  <span class="n">require</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">  <span class="n">require</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span><span class="o">.</span><span class="n">getW</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="s">&quot;Write must be &gt;= 1, was %d&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span><span class="o">.</span><span class="n">getW</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** insert object into the underly*/</span>
</span><span class="line">  <span class="k">def</span> <span class="n">insert</span><span class="o">(</span><span class="n">obj</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">ID</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">(</span><span class="n">obj</span><span class="o">)</span>
</span><span class="line">      <span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">WriteResult</span> <span class="o">=</span> <span class="n">mongoCol</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span><span class="n">dbObj</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">ID</span><span class="o">](</span><span class="s">&quot;_id&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span>      <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">save</span><span class="o">(</span><span class="n">obj</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">DataAccessException</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">res</span> <span class="k">=</span> <span class="n">mongoCol</span><span class="o">.</span><span class="n">save</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">obj</span><span class="o">)</span>
</span><span class="line">      <span class="nc">None</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span>      <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">findById</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">ID</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="n">mongoCol</span><span class="o">.</span><span class="n">findOneByID</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">None</span>        <span class="k">=&gt;</span> <span class="nc">Right</span><span class="o">(</span><span class="nc">None</span><span class="o">)</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">dbObj</span><span class="o">).</span><span class="n">right</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">Option</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">delete</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">ID</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">DataAccessException</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="n">mongoCol</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="nc">MongoDBObject</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="n">id</span><span class="o">))</span>
</span><span class="line">      <span class="nc">None</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">find</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">builder</span><span class="k">:</span> <span class="o">(</span><span class="kt">DBObject</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">Iterable</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">        <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">found</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">          <span class="n">builder</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">found</span><span class="o">).</span><span class="n">fold</span><span class="o">(</span>
</span><span class="line">            <span class="n">e</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="n">e</span><span class="o">,</span>
</span><span class="line">            <span class="n">r</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">r</span><span class="o">))</span>
</span><span class="line">        <span class="o">}).</span><span class="n">toStream</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>這邊有兩個需要被實作的東西</p>
<ul class="simple">
<li><cite>val builder: DBObject =&gt; Either[DataAccessException, T]</cite></li>
<li><cite>val extractor: T =&gt; DBObject</cite></li>
</ul>
<p>而怎麼建立這兩個東西，就是全文的重點了。</p>
</div>
<div class="section" id="how-to-use-abstractdao">
<h2>How to use AbstractDAO</h2>
<p>先來看一個範例；實作上，在 UserDAO object 上，我們先把欄位的名稱及資料型態，一個個的定好</p>
<ul class="simple">
<li>&#8216;val Name = attribute(&quot;name&quot;, Conversion.String)`</li>
<li>&#8216;val Email = attribute(&quot;email&quot;, Conversion.String)&#8217;</li>
<li>&#8216;val CreateDate = attribute(&quot;ctime&quot;, Conversion.JodaDate)&#8217;</li>
</ul>
<p>而這個 attribute method 做的是，把資料名稱存起來，然後當這個 Attribute instance</p>
<ul class="simple">
<li>收到一個 DBObject 時，把對應的欄位取出來，並將值給轉成定義的格式</li>
<li>收到一個 property value 時，把他轉成 (name -&gt; value) pair</li>
</ul>
<p>第一個用法的這個方式，用在從 <em>builder</em> 上面，一個個的把值從 DBObject 抓出來再來建立物件，
第二個用法用在，把物件轉成 DBObject 時，及用在建立 query 時。</p>
<div class="section" id="userdao">
<h3>UserDAO 實作</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">UserDAO</span><span class="o">(</span><span class="n">mongoCol</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AbstractDAO</span><span class="o">[</span><span class="kt">User</span>, <span class="kt">String</span><span class="o">](</span><span class="n">mongoCol</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">UserDAO._</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">builder</span><span class="k">:</span> <span class="o">(</span><span class="kt">DBObject</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="nc">UserDAO</span><span class="o">.</span><span class="n">dbObjectToUser</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">extractor</span><span class="k">:</span> <span class="o">(</span><span class="kt">User</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">DBObject</span> <span class="k">=</span> <span class="nc">UserDAO</span><span class="o">.</span><span class="n">userToDBObject</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="k">this</span><span class="o">(</span><span class="n">dbCol</span><span class="k">:</span> <span class="kt">DBCollection</span><span class="o">)</span> <span class="k">=</span> <span class="k">this</span><span class="o">(</span><span class="n">dbCol</span><span class="o">.</span><span class="n">asScala</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">UserDAO</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">Attributes._</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">Name</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">Email</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">CreateDate</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;ctime&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">JodaDate</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">dbObjectToUser</span><span class="o">(</span><span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="n">dbObj</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;_id&quot;</span><span class="o">).</span><span class="n">get</span>
</span><span class="line">
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span>
</span><span class="line">        <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span>
</span><span class="line">          <span class="nc">Name</span><span class="o">(</span><span class="n">dbObj</span><span class="o">),</span>
</span><span class="line">          <span class="nc">Email</span><span class="o">(</span><span class="n">dbObj</span><span class="o">),</span>
</span><span class="line">          <span class="nc">CreateDate</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">        <span class="o">)</span>
</span><span class="line">      <span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">def</span> <span class="n">userToDBObject</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="nc">MongoDBObject</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">Name</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">externalId</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">Email</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">verifiedId</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">createDate</span><span class="o">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">ret</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="attribute-conversion">
<h3>Attribute &amp; Conversion 部份實作</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
</span><span class="line">  <span class="k">val</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class="line">  <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">throw</span> <span class="k">new</span> <span class="nc">MissingRequiredAttributeException</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">new</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">B</span>
</span><span class="line">  <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">Conversion</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">String</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">source</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">value</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Conversion for DateTime to DateTime.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="k">object</span> <span class="nc">JodaDate</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">DateTime</span>, <span class="kt">DateTime</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nc">RegisterJodaTimeConversionHelpers</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=</span> <span class="n">source</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=</span> <span class="n">value</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
<div class="section" id="how-to-use-attributes-to-build-query">
<h2>How to Use Attributes to Build Query</h2>
<p>前面的 Attribute(s) 不只是用來產做 builder 及 extractor 用的，他們最好用的地方在於
建立 query 時，如下</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">findByDateRange</span><span class="o">(</span><span class="n">start</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">return</span> <span class="n">find</span><span class="o">(</span><span class="nc">CreateDate</span><span class="o">.</span><span class="n">name</span> <span class="nc">$gth</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">start</span><span class="o">).</span><span class="n">_2</span>  <span class="nc">$lt</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">range</span><span class="o">).</span><span class="n">_2</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>這邊，我們可以看到用 Conversion 來描述資料型態的好處是，當你儲存的資料型態有變時，你不用去更
改你的 MongoDB query ，欄位的名稱、資料型別的轉換，都被封裝起來，使用者在寫 Query 時，不用去
記欄位的名稱，也不用去記這個欄位的型態是什麼， MongoDB 支不支援這個型態。</p>
<p>第二個好處是， Casbah 本來只支援 java primitive type &amp; java.util.Date ，透過 Conversion ，
我們可以支援任意的資料型態於 query 中，只要透過新的 Conversion 類別，我們就可以增加 MongoDB 可以
支援的資料型態。</p>
<p>例如，如果我們想增加對 <cite>java.net.URL</cite> 的支援，只要訂義以下的 Conversion 即可</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">object</span> <span class="nc">Url</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">URL</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">URL</span><span class="o">)</span> <span class="k">=</span> <span class="n">source</span><span class="o">.</span><span class="n">toExternalForm</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">URL</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="appendix">
<h2>Appendix:</h2>
<div class="section" id="attribute-scala">
<h3>Attribute.scala</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">package</span> <span class="nn">com.locadz.model.mongodb</span>
</span><span class="line">
</span><span class="line"><span class="k">import</span> <span class="nn">com.mongodb.DBObject</span>
</span><span class="line"><span class="k">import</span> <span class="nn">com.mongodb.casbah._</span>
</span><span class="line"><span class="k">import</span> <span class="nn">com.locadz.model.exception.MissingRequiredAttributeException</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Date: 2/20/12</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">object</span> <span class="nc">Attributes</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
</span><span class="line">    <span class="k">val</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">OptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Any</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">v</span> <span class="k">=</span> <span class="n">value</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="k">_</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
</span><span class="line">      <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">v</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">throw</span> <span class="k">new</span> <span class="nc">MissingRequiredAttributeException</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">SingleValueOptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span>
</span><span class="line">    <span class="k">extends</span> <span class="nc">OptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">optionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="nc">SingleValueOptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/26/mongodb-java-driver-sucks/">Problem in Mongodb&#8217;s Java and Scala Driver.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-26T18:45:00+08:00" pubdate data-updated="true">Apr 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MongoDB 的 Java Driver 支援透過 <a class="reference external" href="http://api.mongodb.org/java/2.5/org/bson/Transformer.html">Transformer</a> 去掛上 encodingHook 及 decodingHook，
使用方式可以參考 <a class="reference external" href="https://github.com/novus/salat/blob/9d7988fbd212b6a1423cb2be72065ebff3570777/salat-core/src/test/scala/com/novus/salat/test/util/UriConversionHelper.scala">Salat URISerializer</a>.</p>
<p>原本我以為透過這樣，我就可以透過自定 encoding and decoding Hook ，去動態
的把 MongoDB 內部的資料型態，在抓取時，自動轉成我要的形態。</p>
<p>例如透過底下的程式碼，就在呼叫 <a class="reference external" href="http://api.mongodb.org/scala/casbah/2.1.5.0/scaladoc/com/mongodb/casbah/commons/MongoDBObject.html#getAs[A](String)(Manifest[A]):Option[A]">getAs[URL](&quot;url&quot;)</a> 時，才即時的把 String 轉成 URL 。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="nc">BSON</span><span class="o">.</span><span class="n">addEncodingHook</span><span class="o">(</span><span class="n">class</span><span class="o">[</span><span class="kt">URL</span><span class="o">],</span> <span class="k">new</span> <span class="nc">Transformer</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">transform</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">AnyRef</span> <span class="o">=</span> <span class="n">o</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="n">u</span><span class="k">:</span> <span class="kt">URL</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">toExternalForm</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span>      <span class="k">=&gt;</span> <span class="n">o</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">})</span>
</span><span class="line"><span class="nc">BSON</span><span class="o">.</span><span class="n">addDecodingHook</span><span class="o">(</span><span class="n">class</span><span class="o">[</span><span class="kt">URL</span><span class="o">],</span> <span class="k">new</span> <span class="nc">Transformer</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">transform</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">AnyRef</span> <span class="o">=</span> <span class="n">o</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">URL</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure><p>結果，事情不如我預期所想的， <cite>decodingHook</cite> 是掛在 MongoDB 儲存的資料
型態上，而不是你所需要的資料型態上；換個方法講， <cite>decodingHook</cite> 是在
BSON driver 把資料讀出來時，就呼叫的。</p>
<p>實作上，如果你去細看 Salat URISerializer ，他的 <cite>decodingHook</cite> 是註冊
在 <cite>String Type</cite> 而非 <cite>URI Type</cite> ，而實作時，是把字串加上了 &quot;<cite>URI~</cite>&quot; 來
判斷，這個字串是否是該被 URI Serializer 轉型成 URI。</p>
<p>如果你去看 <cite>org.bson.BSON</cite> 的實作，你會看到底下這段恐怖的程式碼，BSON
在讀出資料時，會把對該型別的 <cite>Transformer</cite> 全跑一遍，而這個東西又是個
Gloabal Variable，這樣一來出了三個問題</p>
<ul class="simple">
<li>所有 Custom Data Type 都需要被轉成 String 並加上 Prefix 才可以寫入，
你不可以把一個 Custom Data Type 轉成 Integer ，如果你這麼做了，所有
的 Integer ，包含本來就該是 Integer 的欄位，未來在讀出來時，全都會變成
這個 Custom Data Type ！</li>
<li>你的 MongoDB Driver 仰賴所有的使用者都清楚他在做什麼，也清楚別人在
做什麼，如果有一個 Transformer 出錯了，或者是 Prefix 重覆了，那麼
你自定的 Custom Data Type 也會出錯。</li>
<li>你 MongoDB 中的資料，為了儲存 Data Type 於資料欄位中而被污染了！</li>
</ul>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addDecodingHook</span><span class="o">(</span> <span class="n">Class</span> <span class="n">c</span> <span class="o">,</span> <span class="n">Transformer</span> <span class="n">t</span> <span class="o">){</span>
</span><span class="line">    <span class="n">_decodeHooks</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Transformer</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">_decodingHooks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="n">c</span> <span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span> <span class="n">l</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">){</span>
</span><span class="line">        <span class="n">l</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Transformer</span><span class="o">&gt;();</span>
</span><span class="line">        <span class="n">_decodingHooks</span><span class="o">.</span><span class="na">put</span><span class="o">(</span> <span class="n">c</span> <span class="o">,</span> <span class="n">l</span> <span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">l</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="n">t</span> <span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">applyDecodingHooks</span><span class="o">(</span> <span class="n">Object</span> <span class="n">o</span> <span class="o">){</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span> <span class="o">!</span> <span class="n">_anyHooks</span><span class="o">()</span> <span class="o">||</span> <span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Transformer</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">_decodingHooks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span> <span class="n">l</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span>
</span><span class="line">        <span class="k">for</span> <span class="o">(</span> <span class="n">Transformer</span> <span class="n">t</span> <span class="o">:</span> <span class="n">l</span> <span class="o">)</span>
</span><span class="line">            <span class="n">o</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span> <span class="n">o</span> <span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p><a class="reference external" href="https://jira.mongodb.org/browse/SCALA-66">SCALA-66</a> 說 3.0.0 release 時，會有一個 per field, per data type 的
type conversion機制，不過 3.0.0-M2 時還沒把這塊做進去，所以看來有得等了</p>
<p>我是自己有參照 <a class="reference external" href="https://github.com/aboisvert/simplistic">simplistic</a> 刻一個機制，可以在 DAO 中讀進讀出物件時做轉
換，但是在寫 Query 時，仍是有些不便。</p>
<p>如果你有這需求的話，可以跟我連絡，我把 source code 給你。</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/22/dependency-injection-in-scala/">Dependency Injection in Scala</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-22T22:44:00+08:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>這是 4/23 要在 Scala Taiepi Meeting 3 用的講稿，先打出來放這。</p>
<div class="section" id="dependency-injection-inversion-of-control">
<h2>Dependency Injection &amp; Inversion of Control</h2>
<p><a class="reference external" href="http://martinfowler.com/articles/injection.html">Dependency Injection &amp; Inversion of Control</a> 是 Martin Fowler 在 2004 年所
提出來的一個的概念，Martin Fowler在這篇文章中指出，DI可以三種型式來實作，這觀念後來由 Spring
Source 及 Google 實做出來，變成 Java Enterprise 應用中，不可或缺的一塊。</p>
<p>在 Ioc 觀念的出現前，物件相依的元件(Component)，多是於物件建立時，就帶入(binding)的，Martin
的供獻在於，IoC把物件對元件的相依性拆出來，變成可以替換的實作。</p>
<p>底下是 Martin 所舉的例子，接著我們會看到用 DI 改進的方式</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span> <span class="o">{</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">  <span class="kd">public</span> <span class="nf">MovieLister</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">finder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ColonDelimitedMovieFinder</span><span class="o">(</span><span class="s">&quot;movies1.txt&quot;</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>Martin 提出的 DI 型式分別是 Constructor Injection, Setter Injection, and Interface Injection.</p>
<div class="section" id="constructor-injection">
<h3>Constructor Injection</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span><span class="o">...</span>
</span><span class="line">  <span class="kd">public</span> <span class="nf">MovieLister</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">this</span><span class="o">.</span><span class="na">finder</span> <span class="o">=</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="setter-injection">
<h3>Setter Injection</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span><span class="o">...</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinder</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">finder</span> <span class="o">=</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">   <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="interface-injection">
<h3>Interface Injection</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">InjectFinder</span> <span class="o">{</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">injectFinder</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span> <span class="kd">implements</span> <span class="n">InjectFinder</span><span class="o">...</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">injectFinder</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">finder</span> <span class="o">=</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">class</span> <span class="nc">Tester</span><span class="o">...</span>
</span><span class="line">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">registerComponents</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">container</span><span class="o">.</span><span class="na">registerComponent</span><span class="o">(</span><span class="s">&quot;MovieLister&quot;</span><span class="o">,</span> <span class="n">MovieLister</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">    <span class="n">container</span><span class="o">.</span><span class="na">registerComponent</span><span class="o">(</span><span class="s">&quot;MovieFinder&quot;</span><span class="o">,</span> <span class="n">ColonMovieFinder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">registerInjectors</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">container</span><span class="o">.</span><span class="na">registerInjector</span><span class="o">(</span><span class="n">InjectFinder</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">container</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;MovieFinder&quot;</span><span class="o">));</span>
</span><span class="line">    <span class="n">container</span><span class="o">.</span><span class="na">registerInjector</span><span class="o">(</span><span class="n">InjectFinderFilename</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">FinderFilenameInjector</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="jsr-330-annotation">
<h3><a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a> Annotation</h3>
<p>而後，這些 DI 的用法，也被 J2EE 給採用，變成 <a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a> 標準，用法如下</p>
<div class="section" id="id2">
<h4>Constructor Injection</h4>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span><span class="o">...</span>
</span><span class="line">  <span class="nd">@Inject</span> <span class="kd">public</span> <span class="n">MovieLister</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">this</span><span class="o">.</span><span class="na">finder</span> <span class="o">=</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MovieFinder</span> <span class="o">{</span>
</span><span class="line">    <span class="n">List</span> <span class="nf">findAll</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="property-injection">
<h4>Property Injection</h4>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span> <span class="o">{</span>
</span><span class="line">  <span class="nd">@Inject</span> <span class="kd">private</span> <span class="n">MoveFinder</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
</div>
<div class="section" id="dependency-injection-in-scala">
<h2>Dependency Injection in Scala</h2>
<p>花了許久時間解釋 DI 於 Java 的演進，我們總算可以進入本文的正題 Dependency Injection in Scala。在 Scala 中
實做 DI 的方式有有那些呢，接下來我們要談的就是 DI in Scala 的幾個選擇。</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a></li>
<li>Cake Pattern</li>
<li>SubCut</li>
<li>Functional DI - Reader Monad</li>
</ul>
<div class="section" id="id3">
<h3><a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a></h3>
<p>由於 Scala 本身在編譯時，會被編成 Java Byte Code ，所以可以直接套用支源 <a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a> 的
框架，但是在使用上有一些小眉角，就是，若是使用 Constructor Injection 時，需要用 <cite>&#64;Inject()</cite> 標
在 class 定義之前，使用 Property Injection 時，由於 Scala 的 <cite>val</cite> 被定義成 final 的，所以不
能夠被用在 Property Injection 之上，在這時候，只能用 <cite>var</cite> 來做。</p>
<p>為了達到 immutable 的效果，我通常都是用 Constructor Injection 的。( 另一個原因是我不喜歡 AOP )</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">@Inject</span><span class="o">()</span> <span class="nc">MovieLister</span><span class="o">(</span><span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MovieLister2</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">var</span> <span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span> <span class="o">=</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="cake-pattern">
<h3>Cake Pattern</h3>
<p>Cake Pattern 大概是除了 JSR-330 外，最常被提到在 Scala 下的實作 DI 的方式了，Cake Pattern 是由
Scala 之父 Martin Odersky 的一篇論文 <a class="reference external" href="http://lamp.epfl.ch/~odersky/papers/ScalableComponent.pdf">Scalable Component Abstractions</a> 中提到，不過大
多數人看過的版本，應該是 Jonas Bonér 的 <a class="reference external" href="http://jonasboner.com/2008/10/06/real-world-scala-dependency-injection-di/">Real-World Scala: Dependency Injection (DI)</a></p>
<p>Cake Pattern 是利用 Scala Mixin 的功能，讓物件被創造時，才把相依的元件，透過 Mixin 的方式綁在一起。</p>
<p>接下來，我們就看看要怎麼樣用 Cake Pattern 重新實作上面的 MovieFinder 的例子</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">MovieFinderComponent</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">MovieFinder</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">findAll</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">NilMovieFinderComponent</span> <span class="k">extends</span> <span class="nc">MovieFinderComponent</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NilMovieFinder</span>
</span><span class="line">
</span><span class="line">  <span class="k">class</span> <span class="nc">NilMovieFinder</span> <span class="k">extends</span> <span class="nc">MovieFinder</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">findAll</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Nil</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">MovieLister</span> <span class="o">{</span>
</span><span class="line">  <span class="k">this:</span> <span class="kt">MovieFinderComponent</span> <span class="o">=&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">findByAuthor</span><span class="o">(</span><span class="n">author</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">finder</span><span class="o">.</span><span class="n">findAll</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">m</span> <span class="k">=&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">author</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>上面便是一個使用 Cake Pattern 實作 MovieFinder 所需要的程式碼；首先，我們要把所需的
元件，包在一個 Component trait (MovieFinderComponent) 裡頭，再把這個原元件的規格，
寫在 Component trait 中的另一個 trait 中(MovieFinder)，最後，再是訂一個取存這元件的
method <cite>def finder: MovieFinder</cite>.</p>
<p>在被注入的這一方 (MovieLister) ，我們使用 self-type annotation 來宣告，當要生成一個
MovieLister instance 時，我們必需要提供 MovieFinderComponent 的實作，同時，在MovieLister
內，我們可以透過 <cite>finder</cite> 這個 method 來呼叫 MovieFinder 的實作 ；這邊的寫法是</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">movieLister</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MovieLister</span> <span class="k">extends</span> <span class="nc">NilMovieFinderComponent</span>
</span></code></pre></td></tr></table></div></figure><div class="section" id="component-registry">
<h4>Component Registry</h4>
<p>在應用上，由於我們的系統可能包含不只一個元件，而一個物件，可能須要多個不同的元件，因此，
Jonas建議我們，如　Guice 用 Module 來定義所有元件的實作類別，在Cake Pattern上，我們
可以用一個 ComponentRegistry Object 來把所有的實作類別指定好。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">ComponentRegistry</span> <span class="k">extends</span>
</span><span class="line">  <span class="nc">MyMovieFinderComponent</span> <span class="k">with</span>
</span><span class="line">  <span class="nc">MyAuthorFinderComponent</span> <span class="k">with</span>
</span><span class="line">  <span class="nc">MyUserRepositoryComponent</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">TestEnvironment</span> <span class="k">extends</span>
</span><span class="line">  <span class="nc">MockMovieFinderComponent</span> <span class="k">with</span>
</span><span class="line">  <span class="nc">MockAuthorFinderComponent</span> <span class="k">with</span>
</span><span class="line">  <span class="nc">MockUserRepositoryComponent</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Test</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">testList</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="n">lister</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MovieLister</span> <span class="k">extends</span> <span class="nc">TestEnvironment</span>
</span><span class="line">    <span class="c1">// testing code.</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><div class="note">
<p class="first admonition-title">Note</p>
<p class="last">一個動動腦的時間，在使用 ComponentRegistry 時，我們要怎麼寫，才會讓某一個 Component 的實作變成 Singleton</p>
</div>
</div>
<div class="section" id="pros-and-cons-of-cake-pattern">
<h4>Pros and Cons of Cake Pattern</h4>
<dl class="docutils">
<dt>Pros</dt>
<dd><ul class="first last simple">
<li>no framework required, using only language features</li>
<li>type safe – a missing dependency is found at compile-time</li>
<li>powerful – “assisted inject”, scoping possible by implementing the dependency-providing method appropriately</li>
</ul>
</dd>
<dt>Cons</dt>
<dd><ul class="first last simple">
<li>lot of boilerplate code</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="problem-of-cake-pattern">
<h4>Problem of Cake Pattern</h4>
<p>然而，從我的使用經驗來講， Cake Pattern 有個缺點，讓我不推薦各位來使用 Cake Pattern ，缺點是， Cake Pattern
只能使用在第一層相依性的元件上，造成實作上的程式碼的不一致性，以及可重用性的問題。</p>
<p>今天，假設我們電影的數量一直成長，所以我們開始分門別類來存放這些電影的類別，而我們在找作者時，只在各個子類別下
找；為了這個變更，我們不只需要新增一些元件，我們連舊有的 MovieLister 都需要更改他的實作才行。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">CategorizedMovieFinderFactoryComponent</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span>  <span class="nc">CategorizedMovieFinderFactory</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">create</span><span class="o">(</span><span class="n">category</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">MovieFinder</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">MovieListerFactory</span> <span class="o">{</span>
</span><span class="line">  <span class="k">this:</span> <span class="kt">CategorizedMovieFinderComponent</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">create</span><span class="o">(</span><span class="n">category</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">MovieLister</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MovieLister</span><span class="o">(</span><span class="n">finder</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="c1">// WTF, the implementation has to change here?!</span>
</span><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">MovieLister</span><span class="o">(</span><span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">findByAuthor</span><span class="o">(</span><span class="n">author</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">finder</span><span class="o">.</span><span class="n">findAll</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">m</span> <span class="k">=&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">author</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
</div>
<div class="section" id="subcut">
<h2><a class="reference external" href="https://github.com/dickwall/subcut/blob/master/GettingStarted.md">SubCut</a></h2>
<p><a class="reference external" href="https://github.com/dickwall/subcut/blob/master/GettingStarted.md">SubCut</a> 是由 Dick Wall 這位 Java Posse Podcaster 所完成的專案，由於我個人並沒有實際使用的經驗
，所以只能就他所提供的文件做個概述。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">SomeModule</span> <span class="k">extends</span> <span class="nc">NewBindingModule</span><span class="o">({</span> <span class="k">implicit</span> <span class="n">module</span> <span class="k">=&gt;</span>
</span><span class="line">  <span class="k">import</span> <span class="nn">module._</span>  <span class="c1">// optional but convenient</span>
</span><span class="line">
</span><span class="line">  <span class="n">bind</span> <span class="o">[</span><span class="kt">ServiceA</span><span class="o">]</span> <span class="n">toSingle</span> <span class="n">Y</span>
</span><span class="line">  <span class="n">bind</span> <span class="o">[</span><span class="kt">Z</span><span class="o">]</span> <span class="n">toProvider</span> <span class="o">{</span> <span class="n">codeToGetInstanceOfZ</span><span class="o">()</span> <span class="o">}</span>
</span><span class="line"><span class="o">})</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">SomeService</span><span class="o">(</span><span class="n">param1</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">param2</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">bindingModule</span><span class="k">:</span> <span class="kt">BindingModule</span><span class="o">)</span>
</span><span class="line">    <span class="k">extends</span> <span class="nc">SomeTrait</span> <span class="k">with</span> <span class="nc">Injectable</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">service1</span> <span class="k">=</span> <span class="n">inject</span> <span class="o">[</span><span class="kt">ServiceA</span><span class="o">]</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>在 SubCut 中，是讓需要被注入的元件庫，使用 implicit variable 的方式，從執行環境中帶入，然後直接讓
SomeService對整個 Module 做存取。</p>
<p>然而，因為 SubCut 的這一個缺陷，我個人是不用去使用 SubCut 的，這個缺點，在 Martin Fowler 文中被稱
做 <a class="reference external" href="http://martinfowler.com/articles/injection.html#ServiceLocatorVsDependencyInjection">Service Locator</a> ，使用 Service Locator Pattern 的缺點是，你把整個環境都傳給了需要被注入的物
件，讓物件自己在環境中去挖寶；這正好就把把 Inversion of Control 的拿交出的控制權又還給了物件本身；
除了去閱讀程式碼外，你無法單看 class constructor 就可以了解到，某一個物件到底是相依在那些元件之上。</p>
<p>好不容易爭來的控制權，又還了一大半回去</p>
</div>
<div class="section" id="reader-monad">
<h2>Reader Monad</h2>
<p>跳脫了從 OO 出發而來的 DI 方式， Runar Oli 在 Northeast Scala Symposium 2012上 ，提出了一個
純用 <a class="reference external" href="http://www.youtube.com/watch?v=ZasXwtTRkio">Functional Programming 的 DI 實作</a> (<a class="reference external" href="http://dl.dropbox.com/u/4588997/Runar-NEScala-DI.pdf">slides</a>)</p>
<p>Runar 用的例子是一個使用 JDBC 的範例</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">setUserPwd</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">               <span class="n">pwd</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">               <span class="n">c</span><span class="k">:</span> <span class="kt">Connection</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">stmt</span> <span class="k">=</span> <span class="n">c</span><span class="o">.</span><span class="n">prepareStatement</span><span class="o">(</span>
</span><span class="line">    <span class="s">&quot;update users set pwd = ? where id = ?&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="n">stmt</span><span class="o">.</span><span class="n">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">pwd</span><span class="o">)</span>
</span><span class="line">  <span class="n">stmt</span><span class="o">.</span><span class="n">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
</span><span class="line">  <span class="n">stmt</span><span class="o">.</span><span class="n">executeUpdate</span>
</span><span class="line">  <span class="n">stmt</span><span class="o">.</span><span class="n">close</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>上面的程式碼，我們可以用 Functional Way 改寫成底下的方式，讓 <cite>setUserPwd</cite> 改成
回傳一個 (Connection =&gt; Unit) 的函式，這個函式，收進一個 DB Connection 然後對
這個 Connection 做一些操作。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">setUserPwd</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">               <span class="n">pwd</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Connection</span> <span class="o">=&gt;</span> <span class="nc">Unit</span> <span class="k">=</span>
</span><span class="line">  <span class="n">c</span><span class="k">:</span> <span class="kt">Connection</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">stmt</span> <span class="k">=</span> <span class="n">c</span><span class="o">.</span><span class="n">prepareStatement</span><span class="o">(</span>
</span><span class="line">      <span class="s">&quot;update users set pwd = ? where id = ?&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">stmt</span><span class="o">.</span><span class="n">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">pwd</span><span class="o">)</span>
</span><span class="line">    <span class="n">stmt</span><span class="o">.</span><span class="n">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
</span><span class="line">    <span class="n">stmt</span><span class="o">.</span><span class="n">executeUpdate</span>
</span><span class="line">    <span class="n">stmt</span><span class="o">.</span><span class="n">close</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>接著，我們可以用一個 DB Monad 把所有 DB Operation 都抽像化，讓這些 DB Operation 可
以堆疊起來。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">g</span><span class="k">:</span> <span class="kt">Connection</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">Connection</span><span class="o">)</span> <span class="k">=</span> <span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
</span><span class="line">    <span class="nc">DB</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">)))</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">flatMap</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">DB</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
</span><span class="line">    <span class="nc">DB</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">))(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">pure</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span><span class="nc">DB</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="n">a</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">implicit</span> <span class="k">def</span> <span class="n">db</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">Connection</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">DB</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure><p>底下是堆疊起來的成果，透過 scala <a class="reference external" href="http://stackoverflow.com/questions/1052476/can-someone-explain-scalas-yield">for comprehension</a> 把 getUserPwd, setUserPwd 堆
疊起來，變成一個 changePwd method ，這一步步的把函式加成，符合了 Functional Programming 中
的 no side-effect ，在函式加成的過程中，我們並沒有去執行任何有 side effect 的呼叫，只是單純的
把函式加乘起來，等到最後再來選定執行環境。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">changePwd</span><span class="o">(</span><span class="n">userid</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">              <span class="n">oldPwd</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">              <span class="n">newPwd</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span>
</span><span class="line"><span class="k">for</span> <span class="o">{</span>
</span><span class="line">  <span class="n">pwd</span> <span class="k">&lt;-</span> <span class="n">getUserPwd</span><span class="o">(</span><span class="n">userid</span><span class="o">)</span>
</span><span class="line">  <span class="n">eq</span> <span class="k">&lt;-</span> <span class="k">if</span> <span class="o">(</span><span class="n">pwd</span> <span class="o">==</span> <span class="n">oldPwd</span><span class="o">)</span> <span class="k">for</span> <span class="o">{</span>
</span><span class="line">          <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">setUserPwd</span><span class="o">(</span><span class="n">userid</span><span class="o">,</span> <span class="n">newPwd</span><span class="o">)</span>
</span><span class="line">        <span class="o">}</span> <span class="k">yield</span> <span class="kc">true</span>
</span><span class="line">        <span class="k">else</span> <span class="n">pure</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span> <span class="k">yield</span> <span class="n">eq</span>
</span></code></pre></td></tr></table></div></figure><p>那 DI 在這個 DB Monad 中要怎麼使用呢？</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">ConnProvider</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">mkProvider</span><span class="o">(</span><span class="n">driver</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">url</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">  <span class="k">new</span> <span class="nc">ConnProvider</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Class</span><span class="o">.</span><span class="n">forName</span><span class="o">(</span><span class="n">driver</span><span class="o">)</span>
</span><span class="line">      <span class="k">val</span> <span class="n">conn</span> <span class="k">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">      <span class="k">try</span> <span class="o">{</span> <span class="n">f</span><span class="o">(</span><span class="n">conn</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">      <span class="k">finally</span> <span class="o">{</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span> <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">lazy</span> <span class="k">val</span> <span class="n">sqliteTestDB</span> <span class="k">=</span>
</span><span class="line">  <span class="n">mkProvider</span><span class="o">(</span><span class="s">&quot;org.sqlite.JDBC&quot;</span><span class="o">,</span> <span class="s">&quot;jdbc:sqlite::memory:&quot;</span><span class="o">)</span>
</span><span class="line"><span class="k">lazy</span> <span class="k">val</span> <span class="n">mysqlProdDB</span> <span class="k">=</span>
</span><span class="line">  <span class="n">mkProvider</span><span class="o">(</span><span class="s">&quot;org.gjt.mm.mysql.Driver&quot;</span><span class="o">,</span>
</span><span class="line">    <span class="s">&quot;jdbc:mysql://prod:3306/?user=one&amp;password=two&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure><p>Runar 是把 DB Connection 的建立用 ConnProvider 抽像化，透過這樣，
我鍆可以簡單的定意兩種不同的執行環境，一組是 MySQL 另一組是測試用的 SQLite，</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">runInTest</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">ConnProvider</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span>
</span><span class="line">  <span class="n">f</span><span class="o">(</span><span class="n">sqliteTestDB</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">runInProduction</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">ConnProvider</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span>
</span><span class="line">  <span class="n">f</span><span class="o">(</span><span class="n">mysqlProdDB</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">myProgram</span><span class="o">(</span><span class="n">userid</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ConnProvider</span> <span class="o">=&gt;</span> <span class="nc">Unit</span> <span class="k">=</span>
</span><span class="line">  <span class="n">r</span><span class="k">:</span> <span class="kt">ConnProvider</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;Enter old password&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">oldPwd</span> <span class="k">=</span> <span class="n">readLine</span>
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;Enter new password&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">newPwd</span> <span class="k">=</span> <span class="n">readLine</span>
</span><span class="line">    <span class="n">r</span><span class="o">(</span><span class="n">changePwd</span><span class="o">(</span><span class="n">userid</span><span class="o">,</span> <span class="n">oldPwd</span><span class="o">,</span> <span class="n">newPwd</span><span class="o">))</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">=</span>
</span><span class="line">  <span class="n">runInTest</span><span class="o">(</span><span class="n">myProgram</span><span class="o">(</span><span class="n">args</span><span class="o">(</span><span class="mi">0</span><span class="o">)))</span>
</span></code></pre></td></tr></table></div></figure><p>以上就是如何用 DB Monad 來達到 DB DI 的功用，這樣做的好處是</p>
<ul class="simple">
<li>Dead-simple. Just function composition.</li>
<li>Explicit, type-safe dependencies.</li>
<li>Lift any function.</li>
<li>No frameworks, annotations, or XML.</li>
<li>No initialization step.</li>
<li>Doesn’t rely on esoteric language features.</li>
</ul>
<div class="section" id="more-useful-monad">
<h3>More Useful Monad</h3>
<p>上面的 DB Monad ，只能對 DB 來做 DB ，然而，若是我們再多抽像化一層，把 DB Connection 變成
一個 <strong>type parameter</strong> ，那麼，我們就有一個 Reader Monad ，可以套用在許多不同應用上，
至於實際的用法， <a class="reference external" href="http://www.youtube.com/watch?v=ZasXwtTRkio">Runar 的演講</a> 有給一個範例，請大家移步去看。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">Reader</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">A</span><span class="o">](</span><span class="n">g</span><span class="k">:</span> <span class="kt">C</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">Reader._</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">C</span><span class="o">)</span> <span class="k">=</span> <span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">c</span><span class="k">:</span> <span class="kt">C</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">flatMap</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Reader</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">B</span><span class="o">]</span>  <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">c</span><span class="k">:</span> <span class="kt">C</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">))(</span><span class="n">c</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">Reader</span> <span class="o">{</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">def</span> <span class="n">reader</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Reader</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
<div class="section" id="id5">
<h2>總結</h2>
<p>There is no silver bullet, choose your solution wisely.</p>
</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/22/migrate-to-octopress/">搬家到 Octopress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-22T04:31:00+08:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>把 Blog System 從 blogger.com 換成 Octopress ，用 reStructuredText 寫技術文件還是比較簡單。</p>
<p>轉換中，若文章顯示有問題，請到舊站 <a class="reference external" href="http://yunglinho.blogspot.com">http://yunglinho.blogspot.com</a> 看</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/20/lesson-learned-from-developing-locadz-sdk/">Lesson Learned Form Developing Locadz SDK</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-20T23:07:00+08:00" pubdate data-updated="true">Apr 20<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="section" id="introduction">
<h2>Introduction</h2>
<p>市面上大部份講 Android 的書，多數都是在講 API 要怎麼樣使用，但是，許多的書都沒有提到一個重要的問題，就是什
麼是 UI Thread (有時被稱做Main Thread) ，為什麼要有 UI Thread 以及為什麼不可以在 UI Thread 中執行耗時間的運算。</p>
<p>在本文中，我講談一談我們在開發Locadz SDK所使用到的一些技巧。</p>
</div>
<div class="section" id="ui-thread">
<h2>UI Thread</h2>
<p>UI Thread是Android(or other GUI library)用來處理 Event 的 thread ，這些 Event 可能是使用者處發的，如
Touch Event，或者是其它程式或者是系統底層的事件，如 Intent 或 <a class="reference external" href="http://developer.android.com/reference/android/location/LocationListener.html">Location Updates</a>.</p>
<p>在 UI Thread 處理完一個事件後， UI Thread 會重畫整個 Application ，而前面這句話解釋了處理 ANR 的兩個原則</p>
<ul class="simple">
<li>UI事件的處理要越快越好，在處理完前，UI不會有反應</li>
<li>UI的更新，一定要發生在UI Thread，要不然，要等到下次UI Event被處發時才會一併被處理</li>
</ul>
</div>
<div class="section" id="lesson-i-use-weakreference-to-avoid-strong-reference-and-memory-leak">
<h2>Lesson I: Use WeakReference to Avoid Strong Reference and Memory Leak</h2>
<p>有許多的文章談到如何用 <a class="reference external" href="http://developer.android.com/reference/android/os/AsyncTask.html">AsyncTask</a> 或 <a class="reference external" href="http://stackoverflow.com/questions/3197335/restful-api-service/3197456#3197456">ResultReceiver</a> 來把需要大量運算的程式，放在另一個 Thread 來做處理。</p>
<p>然而，這些範例都有著一個常備忽略的問題，那就是，這些 AsyncTask or ResultReceiver 常會把前景的Activity包進來
，如果說你的程式只有一個 Activity 的話，這或許不是什麼問題，但是若是你的 App 有多個畫面的話，這些在背景執行的程
式可能就會讓你的程式有 memory leak 的問題；如某家廣告商的 SDK 就有此問題。</p>
<p>一個可能的發生狀況是，Activity A透過 AsyncTask 去遠端下載一個圖片來顯示在 <em>Activity A</em> 之上，但因為某些因素
(如忘了設 connection timeout)，這個下載的程緒卡住了，既使 User 以從 <em>Activity A</em> 切換到 <em>Activity B</em> 之
上，這個 <em>Activity A</em> 還是不會被 GC 回收掉。</p>
<p>要避開因為有個 Strong Reference 造成 Activity 無法被回收的問題，我們在把有可能被回收的物件傳到另一個 Thread 中
被延後執行時，必需用 <a class="reference external" href="http://docs.oracle.com/javase/1.5.0/docs/api/java/lang/ref/WeakReference.html">WeakReference</a> 包住這個物件；如此一來，當Garbage Collector碰到一個已經不在前景的 Activity
時，Garbage Collector會把這物件處理掉，如此一來，就不會有 memory leak 的問題。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> *  AsyncTask to Load Image</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownloadImagesTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Uri</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">imageview</span><span class="o">&gt;</span> <span class="n">imageViewWeakReference</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="nf">DownloadImagesTask</span><span class="o">(</span><span class="n">ImageView</span> <span class="n">imageView</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">imageViewWeakReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Imageview</span><span class="o">&gt;(</span><span class="n">imageView</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="n">Bitmap</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Uri</span><span class="o">...</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nf">downloadImage</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">ImageView</span> <span class="n">imageView</span> <span class="o">=</span> <span class="n">imageViewWeakReference</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">imageView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">imageView</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">downloadImage</span><span class="o">(</span><span class="n">Uri</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">     <span class="o">...</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="lesson-ii-use-intentservice-to-run-business-logic">
<h2>Lesson II: Use IntentService to Run Business Logic</h2>
<p>AsyncTask是 Android 最常被用來處理複雜運算時用的工具，透過AsyncTask，我們可以在背景處裡
一些複雜的運算，再把結果放回前景之上。</p>
<p>但據我的經驗，使用 AsyncTask 同時間來擔任 MVC 中的 View &amp; Controller 的工作，最後往往是
把程式碼弄成一團麵線。因此，在開發 Locadz SDK 時，我們把一些跟 UI 無關的運算，都切出來
變成 IntentService 或者是非 Inner class 的 AsyncTask ，把所有的運算邏輯從 Activity 中切出
來，增加重用的可能。</p>
<p>然後運算的結果，再透過 <a class="reference external" href="http://developer.android.com/reference/android/os/Handler.html#post(java.lang.Runnable)">getHandler().post(&#8230;)</a> 更新到 UI 之上.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/** Service that retrieve the ad unit allocations from external source and cache locally in SharedPreference. */</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdUnitAllocationService</span> <span class="kd">extends</span> <span class="n">IntentService</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CACHE_EXPIRATION_PERIOD</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span> <span class="c1">// 30 minutes.</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">PREFS_STRING_TIMESTAMP</span> <span class="o">=</span> <span class="s">&quot;timestamp&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">PREFS_STRING_CONFIG</span> <span class="o">=</span> <span class="s">&quot;config&quot;</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// response code for possible result.</span>
</span><span class="line">  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RESULT_OK</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="nf">AdUnitAllocationService</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">super</span><span class="o">(</span><span class="n">AdUnitAllocationService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onHandleIntent</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="n">AdUnitContext</span> <span class="n">adUnitContext</span> <span class="o">=</span>
</span><span class="line">     <span class="o">(</span><span class="n">AdUnitContext</span><span class="o">)</span> <span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_ADUNIT_CONTEXT</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="n">AdUnitAllocation</span> <span class="n">adUnitAllocation</span> <span class="o">=</span> <span class="n">getAdUnitAllocation</span><span class="o">(</span><span class="n">adUnitContext</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">adUnitAllocation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">Ration</span> <span class="n">ration</span> <span class="o">=</span> <span class="n">getRandomRation</span><span class="o">(</span><span class="n">adUnitAllocation</span><span class="o">.</span><span class="na">getRations</span><span class="o">());</span>
</span><span class="line">
</span><span class="line">      <span class="c1">// send response through ResultReceiver.</span>
</span><span class="line">      <span class="n">ResultReceiver</span> <span class="n">receiver</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_RECEIVER</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">      <span class="n">Bundle</span> <span class="n">resultData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bundle</span><span class="o">();</span>
</span><span class="line">      <span class="n">resultData</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_ADUNIT_ID</span><span class="o">,</span> <span class="n">adUnitContext</span><span class="o">.</span><span class="na">getAdUnitId</span><span class="o">());</span>
</span><span class="line">      <span class="n">resultData</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_RATION</span><span class="o">,</span> <span class="n">ration</span><span class="o">);</span>
</span><span class="line">      <span class="n">resultData</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_EXTRA</span><span class="o">,</span>
</span><span class="line">                                 <span class="n">adUnitAllocation</span><span class="o">.</span><span class="na">getExtra</span><span class="o">());</span>
</span><span class="line">
</span><span class="line">      <span class="n">receiver</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">RESULT_OK</span><span class="o">,</span> <span class="n">resultData</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Select a random ration form the provided rations.</span>
</span><span class="line"><span class="cm">   * @param rations   the candidates.</span>
</span><span class="line"><span class="cm">   * @return a random ration from the candidates.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Ration</span> <span class="nf">getRandomRation</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Ration</span><span class="o">&gt;</span> <span class="n">rations</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">//...</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Get the allocation configuration for the adunit.</span>
</span><span class="line"><span class="cm">   * @param adUnitContext the context of the adunit.</span>
</span><span class="line"><span class="cm">   * @return the allocation configuration for the adunit.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="n">AdUnitAllocation</span> <span class="nf">getAdUnitAllocation</span><span class="o">(</span><span class="n">AdUnitContext</span> <span class="n">adUnitContext</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">//...</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="lesson-iii-use-disk-cache-instead-of-main-memory-cache">
<h2>Lesson III: Use Disk Cache instead of (Main) Memory Cache</h2>
<p>底下的圖表，是Jeff Dean發表的，在談的是讀取資料的的效率，我們把這幾個數字先記起來，
再加一個代表UI設計時人體覺得是即時反應的反應時間上限 100 ms。然後我們再來談 Android UI 的設計。</p>
<img alt="/images/2012-04-20/numbers-everyone-should-know.png" src="/images/2012-04-20/numbers-everyone-should-know.png" />
<p>大家可以看到 Main Memory Reference(0.001ms) 與 Disk Seek(10ms) Disk Read(30ms) 的重大差
距，然而，後者的數字在 Mobile Phone 上就不是這樣了。在 Mobile Phone 上，傳統的硬碟扮演的角色，
被NAND Flash Memory, External SD Card所取代了。在存取效率上 NAND Flash Memory 雖然不
比 RAM 快，但是，也仍是 seek time ~1ms 的狠角色。</p>
<p>這 1ms 的負擔，雖比 0.001ms 的負擔高上百倍，以上，但是在 100ms 這UI 反應需求上，卻又變得很渺小了。</p>
<p>因此，在這邊，我會建議大家，若是有 cache 的需求時，直接往 <a class="reference external" href="http://developer.android.com/guide/topics/data/data-storage.html#filesInternal">Internal Storage</a> 塞吧，不要放
在Main memory上，或用個SoftReferenceMap包著。</p>
</div>
<div class="section" id="lesson-iv-make-all-public-method-async-to-avoid-ui-update-issue">
<h2>Lesson IV: Make All Public Method Async to Avoid UI Update Issue</h2>
<p>在上面第一個範例中有個錯誤，那就是DownloadImagesTask.onPostExecute()會在呼叫DownloadImagesTask.execute(&#8230;)的
那個 Thread 上執行，如果說，很不幸的，這個 DownloadImagesTask 並不是從 UI Thread 上來呼叫的話，那
麼，imageView.setImageBitmap(result)便有可能不會即時更新到UI之上。</p>
<p>如果你的開發環境會有這種問題，在包在層層呼叫後，無法確保 Method 是否是在 UI Thread 上執行；那麼我
會建議你把會更新 UI 的 Method ，標成 protected ，然後開放一個 public async method 出來，範例如下：</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm">  * Remove old ad views and push the new one.</span>
</span><span class="line"><span class="cm">  *</span>
</span><span class="line"><span class="cm">  * @param subView the adview to push.</span>
</span><span class="line"><span class="cm">  */</span>
</span><span class="line"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">pushSubView</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">subView</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="c1">//....</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> *  submit a push view request to Android&#39;s handler. This will remove</span>
</span><span class="line"><span class="cm"> *  old ad view and push a new one to this layout asynchronously.</span>
</span><span class="line"><span class="cm"> *</span>
</span><span class="line"><span class="cm"> * @param subView   the adview to push.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">submitPushSubViewRequest</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">subView</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Scheduled pushSubView(%s)&quot;</span><span class="o">,</span> <span class="n">subView</span><span class="o">));</span>
</span><span class="line">  <span class="n">getHandler</span><span class="o">().</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">ViewAdRunnable</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">subView</span><span class="o">));</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Runnable runs on the Main Thread that pushes an AdView to the layout.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ViewAdRunnable</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Adunitlayout</span><span class="o">&gt;</span> <span class="n">locadzLayoutWeakReference</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">ViewGroup</span> <span class="n">subView</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="nf">ViewAdRunnable</span><span class="o">(</span><span class="n">AdUnitLayout</span> <span class="n">layout</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">subView</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">locadzLayoutWeakReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Adunitlayout</span><span class="o">&gt;(</span><span class="n">layout</span><span class="o">);</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">subView</span> <span class="o">=</span> <span class="n">subView</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">AdUnitLayout</span> <span class="n">locadzLayout</span> <span class="o">=</span> <span class="n">locadzLayoutWeakReference</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">locadzLayout</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">locadzLayout</span><span class="o">.</span><span class="na">pushSubView</span><span class="o">(</span><span class="n">subView</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/05/23/slash-runtime-quality-metrics-series-3/">軟體品質指標系列(三)：軟體品質如何測量</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/22/runtime-quality-metrics-series-2/">軟體品質指標系列(二)：軟體品質指標有那些</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/17/runtime-quality-metrics-series-1/">軟體品質指標系列(一)：為什麼軟體開發者需要在意軟體品質指標</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/17/ridiculous-rule-change/">鬼島之鬼交通法規變革</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/08/shall-patent-apply-to-business-model/">Shall Patent Apply to Business Model</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("yunglinho", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/yunglinho" class="twitter-follow-button" data-show-count="false">Follow @yunglinho</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/101164690243066571931?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 -  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yunglin';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
