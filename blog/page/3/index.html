
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>碎碎唸</title>
  <meta name="author" content="">

  
  <meta name="description" content="California Regulator Passes First Ridesharing Rules, A Big Win For Lyft, SideCar, And Uber
我把這篇 TechCrunch 的新聞貼在我的 FB 上，反應不佳，所以只好幫他做個中文補述：
因為既有的私人出租車 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.yunglinho.com/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/yunglinho" rel="alternate" title="碎碎唸" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11857878-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">碎碎唸</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/yunglinho" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.yunglinho.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/23/california-legalize-ridesharing/">加州公共事業委員會通過共乘法案</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-23T02:04:00+08:00" pubdate data-updated="true">Sep 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a class="reference external" href="http://techcrunch.com/2013/09/19/cpuc-ridesharing-regulations/">California Regulator Passes First Ridesharing Rules, A Big Win For Lyft, SideCar, And Uber</a></p>
<p>我把這篇 TechCrunch 的新聞貼在我的 FB 上，反應不佳，所以只好幫他做個中文補述：</p>
<p>因為既有的私人出租車、共乘服務，與既有的加州法規不相容，所以『加州公共事業委員會』在七月提出一個建議案，經過一個半月的討論，在 9/19 通過生效，這種行政單位的效率，是台灣遠遠不及的，才花一個半月就解決一個問題。</p>
<p>Lyft 這種服務的殺傷力很大，以後學生暑假打工又多一個選擇，可以開計程車，或是跑機場接送，別人一趟要 60 ，學生半價就好，然後還可以接到朋友開的 AirBnb etc&#8230;</p>
<p>所以我前一篇才寫 this only happens in California ，在短短的一段時間內，又一個破壞性創新發生了。</p>
<p>如果是社會主義國家如台灣，大概是要炒說乘客的安全誰來保障（乘客都不在乎了，你管那麼多幹麻），出了事誰負責（現在坐計程車車禍，還是健保買單啊，車子也沒保險）？最後，就是長官出來，官僚式的說一聲：「我們再研究，這問題很好，要從長計議&#8230;.」</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/17/on-hr/">談人力資源主管</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-17T11:13:00+08:00" pubdate data-updated="true">Sep 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div id="fb-root"></div> <script>(function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/all.js#xfbml=1"; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-post" data-href="https://www.facebook.com/samlu128/posts/4693698999344" data-width="550"><div class="fb-xfbml-parse-ignore"><a href="https://www.facebook.com/samlu128/posts/4693698999344">Post</a> by <a href="https://www.facebook.com/samlu128">Sam Lu</a>.</div></div><p>台灣 HR 的心態再不改，台灣一定完蛋，前陣子跟美國的朋友聊到台美之間 HR 的差別，我說，台灣的 HR 像買菜一樣，樣樣挑錯批評，想辦法用最便宜的價錢把人請進來，既使激怒你也沒關係；美國的 HR 比較像是服務業，雖然也是一開始丟個較低的數字，但然是想盡辦法僅量滿足你的需求，讓你高高興興的進來。</p>
<p>我到台灣某最大網路公司面試時， HR 問我薪資要求，我說了一個數字，對方直接回『不可能』三個字（最後我在外面兩間公司拿到一樣的數字），也沒問說薪水之外有什麼其它要求的。</p>
<p>我在美國的某百人公司，在談的時候，薪水較我前一份工作有減少，但是，我問他公司的年假的數量可不可以多幾天，因為我一年要回台灣一趟，就這樣，一進去公司就幫我加了18天的假可以用，雖然薪水有少，但滿足了我的要求，所以也不覺得有委屈到。</p>
<p>台灣的 HR 處處都講「制度」，挑人時再用個模板套在你身上，對不合的地方東挑西撿，完全忽視掉人性的差異跟大家需求的差異，如果 HR 是這樣當的，那乾脆找台電腦來當 HR 就好啦～</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/12/politics-or-not-politics/">是政治還是不是政治？</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-12T22:52:00+08:00" pubdate data-updated="true">Sep 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>這幾天關說很熱門，所以我想來談談什麼是「美國式的關說」</p>
<p>我第一次學到什麼叫「美國式的關說」是在 <a class="reference external" href="http://www.amazon.com/Liars-Poker-Rising-Through-Wreckage/dp/0739357301">Liar&#8217;s Poker</a> 中學到的，這本書有一大半是在講房地產證券化的歷史的，在 1983 年房地產證券化之前，美國的房貸因為都是要跟當地銀行借的，而當地銀行手中的投資標地無法多樣化分散系統風險，因此房貸的利率很高，借款條件也高。</p>
<p>而 Salomon Brothers 的 Lewis S. Ranieri 發明了房地產證券化 Mortgage-Backed Securities ，讓銀行能將手中的房地產債券重新包裝起來銷售，把風險轉價出去，自此，美國的房貸利率大降，許多的家庭都能負擔的起自己房產。（至於25年後發生的房地產泡沫化才是後話了）</p>
<p>一個數千億的交易市場就被創造出來， Salomon Brothers 最早投入，所以佔有七成的交易額，而發明 MBS 的 Lewis S. Ranieri 則領到了三億美金的獎金。（數字可能有記錯，但是是用億來算沒錯）</p>
<div class="section" id="id1">
<h2>關說</h2>
<p>那這跟我要講的「關說」有什麼關系呢？這關係可大了，因為一個商業模式的發明，他不一定與既有的法規相容，所以要透過修改法規，才能夠讓一個商業模式運行下去。</p>
<p>但要修改法規，必須要有數位立委主導，並有全體立委的半數投票同意才能通過；但是立委手上工作繁多，為什麼要幫你先做呢？因此，就需要透過「關說」，利用金錢或其它的誘因，讓立委將提案的優先順序提高。</p>
<p><strong>這邊，會有兩個問題出現</strong></p>
<p>第一個問題是，提出新法規的人，由於資訊的優先取得，必然在商業競爭中取到極大的優勢，事先布局好在法規一通過，在對手還搞不清楚狀況之下，就搶佔市場，如上文說的 Salomon Brothers</p>
<p>第二個問題是，既使新的商業模式是有利的，但是對既有的競爭者是不利的，那政府是否能該修改遊戲規則，去偏好某一方呢？</p>
<p>這兩個問題的答案，就我從經濟法學的角度來看，一個新的商業模式，若是能增加全民的福祇，那麼政府本來就應當去推動，至於發明新經濟模式的，我們本該獎勵創新，所以，沒有什麼問題才對。</p>
<p>在美國「關說」是一個非常合理的政治手段，只是有一個附加條件，就是關說的內容及政治獻金的金額，必須公開。</p>
</div>
<div class="section" id="id2">
<h2>台灣的狀況</h2>
<p>過去幾年我曾問過幾個朋友「如果某人發明一個新的商業模式，透過關說推動法律變革，讓全民及自己得利，你覺得合不合理？」</p>
<p>非常可惜的是，我得到的答案都是負面的，覺得「關說是不對的」、「法規該是公正不變動的」</p>
<p>或許，這也就是台灣社會目前停滯在「開發中國家」這階段的原因之一吧；一個缺乏變革動力的國家，自然是不可能趕上或併肩走在其它已開國家身旁的。</p>
</div>
<div class="section" id="id3">
<h2>美國的偉大之處</h2>
<p>在這邊我要先岔題講一下，台灣及美國在變革上的差別。</p>
<p>在台灣，一個新的服務或法規變革，其細節往往是官大學問大，在一兩個官員的小圈圈中就決定的，由於台灣是落後國家，所以有可以抄襲的對像，所以，往往結果還算可以。</p>
<p>但是大家可以想看看，歐美這些國家，是等於一個探險家，在黑暗中獨自前行；那麼先進國家是怎麼樣在黑暗中摸索成功的呢？</p>
<p>這一點，就不得不歸功於美國開國先烈的「美妙的意外」，將一個美國劃分成五十個州，在各州允許有自己的自治法規，將美國這國家，變成全世界最大的一個 AB Test</p>
<p>當一個問題出現時，美國不會有一個明君，像是被雷打到一樣，天知到他怎麼知道什麼是最好的，就把法規給定了下來。美國反而是各州會有不同的法規，經過十年的運行，累積了許多的資料後，讓經濟學家去研究，到底，這五十個州的法規，那一個較好，然後大家把這問題解決後，就往下一個問題去處理。</p>
<p>就這樣，一個「美妙的意外」，讓美國透過聯邦制度，成為世上最創新的國家。</p>
</div>
<div class="section" id="id4">
<h2>是政治還是不是政治？</h2>
<p>回到原題「是政治還不是政治？」我記得在我念大二 1998 年的時候，台灣就開始談「小額付款」的工具，但是台灣一直到 2009「電子票證發行管理條例」通過，台灣才真正能透過儲值的方式來作小額付款。</p>
<p>但其實 2002 年電子票券法就已經躺在立法院了，只是一直到 2009 年某個明星要從政，所屬政黨要把功勞做給他，所以才把電子票券法給通過，若不是這樣，大家可能還在苦等小額付款的工具。</p>
<p>而這一段歷史，也就是台灣發展的困境，在台灣新的商業模式要去修改法規，必定要透過找門神的方式，才能夠推動法規的變革；有時萬事具備只欠東風，但是那個可以領功的門神偏偏年紀還太小，不適合太早出世，那麼眾生也只有苦等七年的份。</p>
<p>在過去的幾年間，美國透過修改法規，出現了 Square ，加州通過了「無人架駛車輛標準」，而 Uber 還在跟許多州溝通中，要去修改出租車的法規。</p>
<p>反觀台灣，類似 AirBnB 的民宿及短租公寓的需求已經出現，但是政府還是只會一昧的禁止，拒絕跟沒有門神背景的業者對談。</p>
<p>許多人覺得我常講政治，但是對創業家來說，要麻就是避走他鄉或是不碰利潤最大的這一塊，要不然必然還是要碰上走「關說」、「碰政治」這一條路的</p>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/12/us-trip/">美國出差行</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-12T21:24:00+08:00" pubdate data-updated="true">Sep 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>八月底到美國出差了兩個多禮拜，算起來，這是我自 2010 年搬回台灣後，第二次造訪美國；前一次是 2012 年 10 月出差到 San Jose ，這次則是到 San Francisco ，兩次造訪，這一次的震憾較上一次強烈許多。</p>
<p>當年離美時就很清楚知道，離開三年後就會跟美國的商業環境開始脫節，但是親身經歷起來，還是有不少的感嘆，2008年金融風暴開始，房價爆跌、民間消費銳減、許多企業開始裁減支出，許多的商業計劃都被裁轍，美國的經濟陷入一段蕭條期。</p>
<div class="section" id="tesla">
<h2>Tesla</h2>
<p>這一次來美國，見到了許多美國在這一段時間做出的變化；最大的特色還是鋼鐵人的公司 Tesla</p>
<img alt="http://www.teslamotors.com/sites/all/themes/tesla/homepage/images/hero_20130823.jpg?20130826" src="http://www.teslamotors.com/sites/all/themes/tesla/homepage/images/hero_20130823.jpg?20130826" style="width: 800px;" />
<p>Tesla 在前一年推出 Model S 後，雖然售價仍是高達七萬美金，但是銷售量大增，2013上半年就賣了 12,700 台，其中有 4,713 台是在加州賣掉；舊金山街頭處處可以看到 Tesla 的身影，連我去商店買東西跟老闆聊天，她也說她先生才剛買一台；在不遠的未來， Tesla 將是美國及加州經濟的一大推手。</p>
</div>
<div class="section" id="square">
<h2>第二變化則是 Square</h2>
<img alt="/images/2013-09-12/square-stand.jpg" src="/images/2013-09-12/square-stand.jpg" style="width: 800px;" />
<p>Square 解決了兩個問題，第一個是過去在申請信用卡刷卡機時，需要遷有電話線，造成行動性不佳，許多的街頭攤販在無法使用信用卡付款的方式下，只能消售價格較低的產品，但是在 Square 出現後，這問題就迎刃而解；只要可以行動上網就可以接受信用卡付款，讓銷售行為更有便利性。</p>
<p>Square 解決的第二個問題是 POS 系統的問題， Square 內建一個簡單的 POS 系統，可以讓你製作簡單的產品型錄、購物車及結帳，透過 Square 小型商家不用多花經費外包，就可以有一個 store front 可以用。</p>
<p>在某一個週五下班後，我跟同事到一個 <a class="reference external" href="http://www.bluxomewinery.com/">倉庫</a> 去參加品酒會，現場的酒商，就是用 Square 來當 POS 系統，當場的試喝或者是買幾瓶幾箱回去，都可以在 Square 上完成，不用擔心是因為臨時性的場地無法做大金額的銷售。</p>
</div>
<div class="section" id="id1">
<h2>第三個變化是穿戴性配備</h2>
<p>從 2012 起 <strong>硬體文藝復興</strong> <a class="reference external" href="http://www.paulgraham.com/hw.html">Hardware Renaissance</a> 開始成為一個熱門的話題，成為創投開始關注的下一個目標，硬體及 IC 設計代工產業，讓開發硬體設備的成本越來越低，讓各種小型專案（在 Kickstarter) 開始盛行，其中大家最關注的一個方向就是穿戴性設備。</p>
<p>美國創業土壤良好的一個因素，就是美國的消費者對新事物的接受度很高，在我們美國辦公室內，七個人就有三個人買了 <a class="reference external" href="https://jawbone.com/up">Jawbone Up</a> ，我們 CEO 還買了另一家的產品來用，讓愛嘗鮮的我也買了一支來試用。</p>
<p>在舊金山的市區的 Apple Store ，有一整個櫃子在賣穿戴性設備，有 <a class="reference external" href="https://jawbone.com/up">Jawbone Up</a> <a class="reference external" href="http://www.fitbit.com/one">Fitbit One</a> <a class="reference external" href="http://www.nike.com/cdp/fuelband/us/en_us/">Nike Fuel Band</a> 等產品，其中 Up 還賣到斷貨，許多人都在問要何時在有適合的尺寸跟顏色進來。</p>
<img alt="/images/2013-09-12/up.png" class="align-left" src="/images/2013-09-12/up.png" style="width: 180px;" />
<img alt="/images/2013-09-12/fitbit.png" class="align-left" src="/images/2013-09-12/fitbit.png" style="width: 180px;" />
<img alt="/images/2013-09-12/fitbit_one.jpg" class="align-left" src="/images/2013-09-12/fitbit_one.jpg" style="width: 180px;" />
<img alt="/images/2013-09-12/fuelband.png" class="align-left" src="/images/2013-09-12/fuelband.png" style="width: 180px;" />
</div>
<div class="section" id="uber">
<h2>第四個變化是 Uber</h2>
<p>在台灣我們習慣使用電話叫車，但是美國已經變成使用手機叫車，在手機選好車種，叫車到特定地點，上車，下車時也不用再掏錢付款，直接在 Uber 結帳；與傳統的叫車攔車相比，又是更方便快速一些。</p>
</div>
<div class="section" id="id2">
<h2>感想</h2>
<p>美國在經歷 2008 年的房地產金融泡沫後，已經從衰退中，找到許多新的商業模式站起來，Tesla無疑的將對汽車製造業有市場重劃的影響。Google 的無人車計劃更是將把對個交通產業翻過來，未來個人不用擁有汽車，要用車，直接在手機上叫車，車輛自己開來你家接你，把你載到某個地點後，自己會再去找下一個客人，或者去找地方充電；在駕駛上，因為車輛可以互相溝通，所以在高速公路上可以保持非常近的安全距離，帶頭的第一台車要煞車時，同時也將電子訊號送給後面的車輛立即煞車，可以把道路空間更有效的利用。</p>
<p>在電子製造業於美國無利可途的環境下，美國的消費產業，善用消費者及製造端的特性，開發出一樣又一樣的試驗型產品，雖然目前的穿戴式設備仍有電力及資料傳輸便利性的問題，但消費者、生產者及資本市場，仍不吝於給與嘗試的機會。</p>
<p>Square, Uber 等電子化消費工具，將交易的成本降低，讓金錢的流通更迅速，加強美國在商業環境上的競爭力。在工業上，因為油頁岩探堪技術的突破，美國煉鋼成本大降，未來成為汽車等製造業成本最低的國家。</p>
<p>在短短的五年間，美國就脫胎換骨，找到未來十年發展的發產潛力；反觀台灣，在過去幾年間，仍是以炒作房地產為主，家庭收入六成都卡在房貸上，民間消費全部停下來，百貨業今年的銷售額只有前一年的六成。</p>
<p>在 2000, 2005, 2008 年就該被逃汰的 DRAM LCD WiMAX 產業，在政府的補助下，仍茍延殘喘，無法將勞動力釋出，產業結構仍是停留在 1990 年代的 <em>高人力成本</em> 的製造業為主。</p>
<p>美國的產業轉型從 2008 年就開始了，台灣在過去五年內仍是炒房，目前台北市的房價已經跟曼哈頓島上一樣貴了，天龍國大安區信義區，價錢更是高到紐約中央公園第一排的水準；日前，台灣又開放保險業投資房地產的資金比率，再次幫房地產增加上漲的動力，有機會再漲兩年。</p>
<p>三年前 31 歲的我，覺得能在台灣跟台灣一起面對經濟轉型，沒想到台灣沒有轉型，反而是要再拖至少兩年才能改革，而且是要走「日本失落的二十年」模式，而非美國的模式；已經不年輕的我，還有機會再等下去嗎？想來就悲哀</p>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/19/parallel-external-merge-sort/">Parallel External Merge Sort</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-19T21:43:00+08:00" pubdate data-updated="true">Mar 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week, I was working on importing a large input file into the system. Part of the process involved with
reading a large file (~10GB) from remote server and them sort the inputs locally.</p>
<p>At that moment, I decided to give Scala&#8217;s new <a class="reference external" href="http://docs.scala-lang.org/sips/pending/futures-promises.html">Future API</a> a try. Within one day, I wrote a parallel external
merge sort that can</p>
<blockquote>
<ol class="arabic simple">
<li>Read the file from remote server and split it into smaller chunks.</li>
<li>Use in-memory quicksort to sort each chunk and then save chunks into files.</li>
<li>Perform merge sort on the files generated in the previous step.</li>
</ol>
</blockquote>
<p>The most amazing thing is that multiple threads could work on these tasks simultanously. While one thread is busy
reading bytes from remote server, other threads would perform quicksort on the part that has already been read. Once,
all of the data has been written to file system. Another thread will start to merge sort these files.</p>
<p>Here is how I do it.</p>
<div class="section" id="read-lines-from-inputstream">
<h2>Read Lines From InputStream</h2>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">soure</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">).</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure><p>The above code will turn a <strong>InputStream</strong> into a <strong>Stream[Int]</strong> , and then allow us to perform operation on it
without having to fully read it into memory first. But still, this is a huge Stream. Because we are going to use
in-memory sort, I need to split it into smaller pieces first.</p>
<p>The following code will <strong>lift</strong> a Stream into a Stream of Stream. Again, this operation does not require read the whole
original stream into memory. All the operation only happens logically.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Lift a Stream into a Stream of Stream. The size of each sub-stream is specified by the chunkSize</span>
</span><span class="line"><span class="cm"> * @param stream        the origin stream.</span>
</span><span class="line"><span class="cm"> * @param chunkSize     the size of each substream</span>
</span><span class="line"><span class="cm"> * @tparam A</span>
</span><span class="line"><span class="cm"> * @return              chunked stream of the original stream.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">def</span> <span class="n">lift</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">stream</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">remaining</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">remaining</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Stream</span><span class="o">.</span><span class="n">empty</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="k">=</span> <span class="n">remaining</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">      <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">val</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="k">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">  <span class="k">return</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="perform-quick-sort">
<h2>Perform Quick Sort</h2>
<p>After we have split <strong>InputStream</strong> into <strong>Streams</strong>, we can start to read each sub-stream into memory and perform
quicksort on them.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">linesStream</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">lift</span><span class="o">(</span><span class="n">soure</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line"><span class="k">val</span> <span class="n">chunkCounter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">sortedFileDir</span> <span class="k">=</span> <span class="nc">Files</span><span class="o">.</span><span class="n">createTempDir</span><span class="o">()</span>
</span><span class="line"><span class="n">sortedFileDir</span><span class="o">.</span><span class="n">deleteOnExit</span><span class="o">()</span>
</span><span class="line">
</span><span class="line"><span class="c1">// read source stream, read n entries into memory and save it to file in parallel.</span>
</span><span class="line"><span class="k">val</span> <span class="n">fileFutures</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Future</span><span class="o">[</span><span class="kt">File</span><span class="o">]]</span> <span class="k">=</span> <span class="n">linesStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span>
</span><span class="line">  <span class="n">s</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">chunk</span> <span class="k">=</span> <span class="n">chunkCounter</span><span class="o">.</span><span class="n">getAndIncrement</span>
</span><span class="line">    <span class="nc">Future</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">sorted</span> <span class="k">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sorted</span>
</span><span class="line">      <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">sortedFileDir</span><span class="o">,</span> <span class="s">&quot;%d&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">chunk</span> <span class="o">*</span> <span class="n">chunkSize</span><span class="o">))</span>
</span><span class="line">      <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">ret</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">      <span class="k">try</span> <span class="o">{</span>
</span><span class="line">        <span class="n">sorted</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">ret</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}).</span><span class="n">toList</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="perform-merge-sort">
<h2>Perform Merge Sort</h2>
<p>Because I want to perform mergesort on all of results, I have to turn <strong>List[Future[File]]</strong> into <strong>Future[List[File]]</strong>
first. So that I can instruct the <strong>Future</strong> to do merge sort once it has all the pieces.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">saveTmpFiles</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">File</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">sequence</span><span class="o">(</span><span class="n">fileFutures</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">ret</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">File</span><span class="o">]</span> <span class="k">=</span> <span class="n">saveTmpFiles</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">    <span class="n">files</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">  <span class="k">var</span> <span class="n">merged</span> <span class="k">=</span> <span class="n">files</span>
</span><span class="line">
</span><span class="line">  <span class="k">while</span> <span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">splited</span> <span class="k">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">tuple</span> <span class="k">=</span> <span class="n">splited</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">splited</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">m2</span> <span class="k">=</span> <span class="n">tuple</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="o">(</span><span class="n">f1</span><span class="o">,</span> <span class="n">f2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">        <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">sortedFileDir</span><span class="o">,</span> <span class="n">f1</span><span class="o">.</span><span class="n">getName</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">f2</span><span class="o">.</span><span class="n">getName</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">val</span> <span class="n">source1</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromFile</span><span class="o">(</span><span class="n">f1</span><span class="o">)</span>
</span><span class="line">        <span class="k">val</span> <span class="n">source2</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromFile</span><span class="o">(</span><span class="n">f2</span><span class="o">)</span>
</span><span class="line">        <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">ret</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">try</span> <span class="o">{</span>
</span><span class="line">          <span class="k">val</span> <span class="n">stream1</span> <span class="k">=</span> <span class="n">source1</span><span class="o">.</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">          <span class="k">val</span> <span class="n">stream2</span> <span class="k">=</span> <span class="n">source2</span><span class="o">.</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">          <span class="n">merge</span><span class="o">(</span><span class="n">stream1</span><span class="o">,</span> <span class="n">stream2</span><span class="o">).</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">          <span class="n">ret</span>
</span><span class="line">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">          <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">          <span class="n">source1</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">          <span class="n">source2</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">          <span class="nc">FileUtils</span><span class="o">.</span><span class="n">deleteQuietly</span><span class="o">(</span><span class="n">f1</span><span class="o">)</span>
</span><span class="line">          <span class="nc">FileUtils</span><span class="o">.</span><span class="n">deleteQuietly</span><span class="o">(</span><span class="n">f2</span><span class="o">)</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">merged</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">m2</span> <span class="o">:+</span> <span class="n">merged</span><span class="o">.</span><span class="n">last</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="n">m2</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="n">merged</span><span class="o">.</span><span class="n">head</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Merge two streams into one stream.</span>
</span><span class="line"><span class="cm"> * @param streamA</span>
</span><span class="line"><span class="cm"> * @param streamB</span>
</span><span class="line"><span class="cm"> * @return</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">def</span> <span class="n">merge</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">streamA</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">streamB</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ord</span><span class="k">:</span> <span class="kt">Ordering</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="o">(</span><span class="n">streamA</span><span class="o">,</span> <span class="n">streamB</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">b</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">streamA</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">      <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="n">streamB</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">ord</span><span class="o">.</span><span class="n">compare</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">merge</span><span class="o">(</span><span class="n">streamA</span><span class="o">.</span><span class="n">tail</span><span class="o">,</span> <span class="n">streamB</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">merge</span><span class="o">(</span><span class="n">streamA</span><span class="o">,</span> <span class="n">streamB</span><span class="o">.</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="give-this-method-a-pretty-face">
<h2>Give this Method a Pretty Face.</h2>
<p>So how does the method signature of this parallel external merge sort look like?</p>
<p>In fact, it is quite simple. It takes an <strong>InputStream</strong> and returns a <strong>Future[File]</strong>. So that, everything
happens asynchronously, nothing blocks the main thread. You can send an inputStream to this method, go to do other
things first and then come back to wait for the result.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">sort</span><span class="o">(</span><span class="n">inputStream</span><span class="k">:</span> <span class="kt">InputStream</span><span class="o">,</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2000000</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">File</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="limits-number-of-threads-running-at-the-same-time">
<h2>Limits Number of Threads Running at the Same Time.</h2>
<p>Because this parallel external mergesort is an IO and memory intense operations, we can not run too many of it
simultaneously. We must put a constraint on the number of threads it can use at a time. Otherwise, we may receive
OutOfMemoryError or having many threads writing to disk simultaneously.</p>
<p>Also, this constraint must be a global constraint. No matter how many requests has been sent to this method at the
same time, it should only use up-to <em>N</em> threads.</p>
<p>Luckly, this is quite easy to do with Scala&#8217;s Future API. All we need to do is to provide a fixed size thread pool
for this method. So that it won&#8217;t spawn new thread by itself, instead, it uses threads provided by this global thread
pool.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * limits number of reading and sorting can be executed simultaneously. Because this is an IO</span>
</span><span class="line"><span class="cm"> * bound operation, unless the inputstream is coming from a slow http connection, otherwise, 5</span>
</span><span class="line"><span class="cm"> * is more than enough.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">val</span> <span class="nc">GLOBAL_THREAD_LIMIT</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="o">.</span><span class="n">availableProcessors</span><span class="o">()</span> <span class="o">/</span> <span class="mi">2</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="mi">5</span>
</span><span class="line">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">    <span class="n">ret</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">private</span> <span class="k">lazy</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">executionContext</span> <span class="k">=</span>
</span><span class="line">  <span class="nc">ExecutionContext</span><span class="o">.</span><span class="n">fromExecutorService</span><span class="o">(</span><span class="nc">Executors</span><span class="o">.</span><span class="n">newFixedThreadPool</span><span class="o">(</span><span class="nc">GLOBAL_THREAD_LIMIT</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="put-everything-alltogether">
<h2>Put Everything Alltogether</h2>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
<span class="line-number">106</span>
<span class="line-number">107</span>
<span class="line-number">108</span>
<span class="line-number">109</span>
<span class="line-number">110</span>
<span class="line-number">111</span>
<span class="line-number">112</span>
<span class="line-number">113</span>
<span class="line-number">114</span>
<span class="line-number">115</span>
<span class="line-number">116</span>
<span class="line-number">117</span>
<span class="line-number">118</span>
<span class="line-number">119</span>
<span class="line-number">120</span>
<span class="line-number">121</span>
<span class="line-number">122</span>
<span class="line-number">123</span>
<span class="line-number">124</span>
<span class="line-number">125</span>
<span class="line-number">126</span>
<span class="line-number">127</span>
<span class="line-number">128</span>
<span class="line-number">129</span>
<span class="line-number">130</span>
<span class="line-number">131</span>
<span class="line-number">132</span>
<span class="line-number">133</span>
<span class="line-number">134</span>
<span class="line-number">135</span>
<span class="line-number">136</span>
<span class="line-number">137</span>
<span class="line-number">138</span>
<span class="line-number">139</span>
<span class="line-number">140</span>
<span class="line-number">141</span>
<span class="line-number">142</span>
<span class="line-number">143</span>
<span class="line-number">144</span>
<span class="line-number">145</span>
<span class="line-number">146</span>
<span class="line-number">147</span>
<span class="line-number">148</span>
<span class="line-number">149</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">import</span> <span class="nn">com.google.common.io.Files</span>
</span><span class="line"><span class="k">import</span> <span class="nn">java.io.</span><span class="o">{</span><span class="nc">PrintWriter</span><span class="o">,</span> <span class="nc">File</span><span class="o">,</span> <span class="nc">InputStream</span><span class="o">}</span>
</span><span class="line"><span class="k">import</span> <span class="nn">java.util.concurrent.Executors</span>
</span><span class="line"><span class="k">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span>
</span><span class="line">
</span><span class="line"><span class="k">import</span> <span class="nn">org.apache.commons.io.FileUtils</span>
</span><span class="line">
</span><span class="line"><span class="k">import</span> <span class="nn">scala.concurrent.</span><span class="o">{</span><span class="nc">ExecutionContext</span><span class="o">,</span> <span class="nc">Future</span><span class="o">}</span>
</span><span class="line"><span class="k">import</span> <span class="nn">scala.io.Source</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">InputStreams</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * limits number of reading and sorting can be executed simultaneously. Because</span>
</span><span class="line"><span class="cm"> * this is an IO bound operation, unless the inputstream is coming from a slow</span>
</span><span class="line"><span class="cm"> * http connection, otherwise, 5 is more than enough.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">val</span> <span class="nc">GLOBAL_THREAD_LIMIT</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="o">.</span><span class="n">availableProcessors</span><span class="o">()</span> <span class="o">/</span> <span class="mi">2</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="mi">5</span>
</span><span class="line">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">    <span class="n">ret</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">private</span> <span class="k">lazy</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">executionContext</span> <span class="k">=</span>
</span><span class="line">  <span class="nc">ExecutionContext</span><span class="o">.</span><span class="n">fromExecutorService</span><span class="o">(</span><span class="nc">Executors</span><span class="o">.</span><span class="n">newFixedThreadPool</span><span class="o">(</span><span class="nc">GLOBAL_THREAD_LIMIT</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">sort</span><span class="o">(</span><span class="n">inputStream</span><span class="k">:</span> <span class="kt">InputStream</span><span class="o">,</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2000000</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">File</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// open source stream</span>
</span><span class="line">  <span class="k">val</span> <span class="n">soure</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">).</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">linesStream</span> <span class="k">=</span> <span class="n">lift</span><span class="o">(</span><span class="n">soure</span><span class="o">,</span> <span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">chunkCounter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">sortedFileDir</span> <span class="k">=</span> <span class="nc">Files</span><span class="o">.</span><span class="n">createTempDir</span><span class="o">()</span>
</span><span class="line">  <span class="n">sortedFileDir</span><span class="o">.</span><span class="n">deleteOnExit</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// read source stream, read n entries into memory and save it to file in parallel.</span>
</span><span class="line">  <span class="k">val</span> <span class="n">saveTmpFiles</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">File</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">sequence</span><span class="o">(</span>
</span><span class="line">    <span class="n">linesStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">chunk</span> <span class="k">=</span> <span class="n">chunkCounter</span><span class="o">.</span><span class="n">getAndIncrement</span>
</span><span class="line">      <span class="nc">Future</span> <span class="o">{</span>
</span><span class="line">        <span class="k">val</span> <span class="n">sorted</span> <span class="k">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sorted</span>
</span><span class="line">        <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">sortedFileDir</span><span class="o">,</span> <span class="s">&quot;%d&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">chunk</span> <span class="o">*</span> <span class="n">chunkSize</span><span class="o">))</span>
</span><span class="line">        <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">ret</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">try</span> <span class="o">{</span>
</span><span class="line">          <span class="n">sorted</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">          <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">        <span class="n">ret</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}).</span><span class="n">toList</span>
</span><span class="line">  <span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// perform merge sort.</span>
</span><span class="line">  <span class="n">saveTmpFiles</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">    <span class="n">files</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="k">var</span> <span class="n">merged</span> <span class="k">=</span> <span class="n">files</span>
</span><span class="line">      <span class="k">while</span> <span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="k">val</span> <span class="n">splited</span> <span class="k">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span>
</span><span class="line">        <span class="k">val</span> <span class="n">tuple</span> <span class="k">=</span> <span class="n">splited</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="n">splited</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">        <span class="k">val</span> <span class="n">m2</span> <span class="k">=</span> <span class="n">tuple</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">          <span class="k">case</span> <span class="o">(</span><span class="n">f1</span><span class="o">,</span> <span class="n">f2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">            <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">sortedFileDir</span><span class="o">,</span> <span class="n">f1</span><span class="o">.</span><span class="n">getName</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="n">f2</span><span class="o">.</span><span class="n">getName</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">            <span class="k">val</span> <span class="n">source1</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromFile</span><span class="o">(</span><span class="n">f1</span><span class="o">)</span>
</span><span class="line">            <span class="k">val</span> <span class="n">source2</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">fromFile</span><span class="o">(</span><span class="n">f2</span><span class="o">)</span>
</span><span class="line">            <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="n">ret</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">            <span class="k">try</span> <span class="o">{</span>
</span><span class="line">              <span class="k">val</span> <span class="n">stream1</span> <span class="k">=</span> <span class="n">source1</span><span class="o">.</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">              <span class="k">val</span> <span class="n">stream2</span> <span class="k">=</span> <span class="n">source2</span><span class="o">.</span><span class="n">getLines</span><span class="o">().</span><span class="n">toStream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class="line">              <span class="n">merge</span><span class="o">(</span><span class="n">stream1</span><span class="o">,</span> <span class="n">stream2</span><span class="o">).</span><span class="n">foreach</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">              <span class="n">ret</span>
</span><span class="line">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">              <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">              <span class="n">source1</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">              <span class="n">source2</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">              <span class="nc">FileUtils</span><span class="o">.</span><span class="n">deleteQuietly</span><span class="o">(</span><span class="n">f1</span><span class="o">)</span>
</span><span class="line">              <span class="nc">FileUtils</span><span class="o">.</span><span class="n">deleteQuietly</span><span class="o">(</span><span class="n">f2</span><span class="o">)</span>
</span><span class="line">            <span class="o">}</span>
</span><span class="line">
</span><span class="line">          <span class="o">}</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">        <span class="n">merged</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">merged</span><span class="o">.</span><span class="n">length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">          <span class="n">m2</span> <span class="o">:+</span> <span class="n">merged</span><span class="o">.</span><span class="n">last</span>
</span><span class="line">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">          <span class="n">m2</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">      <span class="n">merged</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Lift a Stream into a Stream of Stream. The size of each sub-stream is specified</span>
</span><span class="line"><span class="cm"> * by the chunkSize.</span>
</span><span class="line"><span class="cm"> *</span>
</span><span class="line"><span class="cm"> * @param stream        the origin stream.</span>
</span><span class="line"><span class="cm"> * @param chunkSize     the size of each substream</span>
</span><span class="line"><span class="cm"> * @tparam A</span>
</span><span class="line"><span class="cm"> * @return              chunked stream of the original stream.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">def</span> <span class="n">lift</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">stream</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">chunkSize</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">remaining</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">remaining</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Stream</span><span class="o">.</span><span class="n">empty</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="k">=</span> <span class="n">remaining</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">      <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">val</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">)</span> <span class="k">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">splitAt</span><span class="o">(</span><span class="n">chunkSize</span><span class="o">)</span>
</span><span class="line">  <span class="k">return</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">tailFn</span><span class="o">(</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Merge two streams into one stream.</span>
</span><span class="line"><span class="cm"> * @param streamA</span>
</span><span class="line"><span class="cm"> * @param streamB</span>
</span><span class="line"><span class="cm"> * @return</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">private</span> <span class="k">def</span> <span class="n">merge</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">streamA</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">streamB</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ord</span><span class="k">:</span> <span class="kt">Ordering</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="o">(</span><span class="n">streamA</span><span class="o">,</span> <span class="n">streamB</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span>
</span><span class="line">    <span class="k">case</span> <span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="nc">Empty</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">b</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">streamA</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">      <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="n">streamB</span><span class="o">.</span><span class="n">head</span>
</span><span class="line">
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">ord</span><span class="o">.</span><span class="n">compare</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">merge</span><span class="o">(</span><span class="n">streamA</span><span class="o">.</span><span class="n">tail</span><span class="o">,</span> <span class="n">streamB</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="nc">Stream</span><span class="o">.</span><span class="n">cons</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">merge</span><span class="o">(</span><span class="n">streamA</span><span class="o">,</span> <span class="n">streamB</span><span class="o">.</span><span class="n">tail</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/19/clean-future-api-design-sort.rst/">Clean Future API Design</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-19T21:43:00+08:00" pubdate data-updated="true">Mar 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content">The Review
===========================================================================

歡迎來到 2013 Java Developer Day ，一年又過去了，在去年這個時間，我跟大家介紹了我們這一代程式
設計師面對的挑戰是什麼？同時也介紹了 Actor Model 這個用來面對多核心挑戰的工具之一。

在今年的議程裡，我將會介紹在 Scala 中，另一個用來做非同步處理（asynchronous programming)的工具。

Why Asynchronous is Valuable
============================================================================

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/04/why-kimdotcom-can-offer-free-broadband/">為什麼 Kim DotCom/Mega 能夠提供免費的網路</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-04T19:21:00+08:00" pubdate data-updated="true">Feb 4<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a class="reference external" href="http://www.nownews.com/2012/11/20/11814-2874727.htm">NOWNews 為紐西蘭提供免費光纖！盜版之王Kim Dotcom發豪語</a></p>
<pre class="literal-block">
現在，這位『網路頑童』再次放出讓人驚歎的承諾：為紐西蘭的每個人提供免費光纖服務。

引用 Dotcom 在 Twitter 上 的話就是：『The new Mega company will be based in
NZ &amp; become it's most valuable IT biz. I will relaunch Pacific Fibre. Free
broadband for all Kiwi's
</pre>
<p>為什麼 Kim DotCom/Mega 能夠提供免費的網路呢？這要先從國際專線的拆帳機制講起；所謂拆帳就是，從甲地到乙地的線路
，如果是甲地往乙地的流量佔四成，乙地往甲地的佔六成，那麼，這條專線的流量費用，就是六四分，甲付六成乙付四成。</p>
<p>所以說，如果 Kim Dotcom 可以在紐西蘭建立起一個超大的 ICP ，這條專線，百分之九十九的流量都是流出紐西蘭的，那麼
他就有機會只要付出 1% 的費用就可，當然要怎樣說服對連的電信商，接受這個條件，那就是 KD 的功力了。</p>
<p>反觀中XX電信，由於台灣的對外頻寬，由於多數是外往內，國內沒有好的 ICP ，造成這些專線的費用，都是台灣買單的。</p>
<p>小時候學的那些，台灣是東南亞重要戰略樞紐都是狗屁，過境的專線一堆，但是都沒留下實質的好處</p>
<p>之前同事有問我，為什麼國外的 Hosting 公司可以免錢的，我說，就是因為養 ICP 對 ISP 有好處，所以國外的公司養一堆當談判條件用。</p>
<p>台灣這邊，除了 <a class="reference external" href="http://wp.xdite.net/?p=122">「無名」被Giga當成談判條件</a> 過之外，就沒有聽過有人拿 ICP 當談判條件了，話說回來，大部份的 ICP 都被中華給拉過去後，也 <a class="reference external" href="http://blog.urdada.net/2009/03/24/197/">沒人有條件跟中華談了</a> 。</p>
<p>但是，在國際專線這塊，台灣應該也來養幾個這種免費空間，這樣子才不會在國際專線費用這塊，被人家吃透透</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/03/move-erp-to-cloud/">中小企業ERP系統上雲端？</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-03T17:11:00+08:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><pre class="literal-block">
※ 引述《NightWind (gin and tonic)》之銘言：
: 我們是一家中小企業
: 大約三年前才把古早的DOS系統
: 換裝成鼎新的ERP
: 現在當初買的伺服器主機保固也要到了
: 老闆突發奇想把ERP系統裝在中華HiCloud那樣的雲端虛擬主機上
: 節省定期維護主機與擔心主機突然掛掉的費用
: 請問真的有人會這樣做的嗎？
: 又如果有的話，台北地區有沒有規劃的廠商？
</pre>
<p>HiCloud 沒用過，所以用 <a class="reference external" href="http://aws.amazon.com">AWS</a> 的例子來解釋要這麼做會碰上那些例子。</p>
<p>第一個問題是 VM 的可靠度是比你自己買伺服器等級的機器還來的低的， AWS EC2 的
合約是說 99.95% Available ，但是這不包括你 VM 被 AWS會有隨機關掉的機會。當
被關掉後，你是要自己手動或自動重啟才有 99.95%</p>
<p>第二個問題是，台灣多數的 ERP是2-tier的架構而非 3 tier 的，若是用 2-tier 的
軟體，使用者端要從本機連到 AWS去，一個來回的時間從 &lt;10ms跳到 100ms 以上，如
果程式寫的不好，本來一個流程的轉換要跑兩個 SQL command，原來是 (10ms*2 + SQL execution time) * 2，
還有機會是小於 100ms看起來很即時就可以反應，一搬到雲端，時間就跳昇到 100ms * 4，變的超級鈍。</p>
<p>再來，放到 AWS 去，還要考慮台美專線速度的問題，過去幾年來，台灣對外的海纜，幾乎
每兩年都會斷線超過一天。所以放在雲端你的架構能提供的，就只剩不到 99.5%</p>
<p>在 EC2 上，如果要用 EBS讓 VM 當機後資料還在的話， EBS的效能是有口皆呸的
，但是如果不用 EBS，那 VM 一死，上面的資料又全消失了，變成你自己要做 Data Replication</p>
<p>最後，如果要用台灣的雲端，不用要 HiCloud，比較建議的環境會是開發資源及支援較多
的 <a class="reference external" href="http://www.microsoft.com/taiwan/windowsazure/">MS Azure</a> 或是使用 <a class="reference external" href="http://joyent.com/">joynet</a> 技術的 <a class="reference external" href="http://micloud.tw/">MiCloud</a> 會比較妥當。</p>
<p>縱觀來講，搬到雲端有其它新的挑戰要處理，第一個看軟體要先 3tier 化，再來是要
做DB online replication 保護資料，最後，是公司對外的專線要能跟的上資料量。</p>
<p>如果前述問題都能解決的話，貴公司得到的會是</p>
<ol class="arabic simple">
<li>更短的錯誤迴復時間：伺服器一死，跟廠商搬機器來迴復也要一個工作天以上，用雲端可以降到一兩小時</li>
<li>更敏捷的硬體效能：如果硬體效能不夠，使用雲端系統，是直接選更高等級的VM重開，當下就可以昇級。
不用等採買硬體所需的數星期到數個月的時間，也不必擔心折舊週期還沒到就又要昇級。</li>
</ol>
<p>在是否該選用雲端方案的話，就看你們目前的 ERP是否是 3-tier 的，另外就是找顧問來來編
寫相關的工具及作業流程。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/23/cloud-computing-and-rocket-science/">為什麼雲端產業在台灣行不通</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-23T11:26:00+08:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>很想寫這個主題很久了，雖然可能永遠也無法把道理完整的解釋清楚，不過，有個開頭總是好的。</p>
<p>首先，先寫個嘴炮給非軟體業的人看，台灣名嘴大喊：「台灣現在要找到能殺出血路的產業，雲端計算是很
好的機會」、「打造雲端大國，再造兆元產業」，政客名嘴喊喊口號就好，問題是，我們在這產業有什麼利
機，能夠在 <a class="reference external" href="http://www.books.com.tw/exep/prod/booksfile.php?item=0010090268">落後歐美社會四百年</a> 的狀況下，在不懂數字管理下，一次追趕過這些差距，超英趕美？</p>
<p>如果沒有確實的利基及施行方案， <strong>「打造雲端大國，再造兆元產業」</strong> 同樣也可以改寫成 「打造月球
基地，開採外星綠能」、「打造火星計劃，一統太陽系」，後兩者講起來不是更威嗎？</p>
<p>台灣有許多硬體公司在喊，雲端是未來的機會，問題是，雲端的目標是共享資源、是消減 IT 的支出，對硬
體廠來說，是個產業危機，也是個大洗牌的機會，但是，對台灣整體來說，絕對是個不利的未來。至於某些
公司開始喊，雲端業務已經佔公司營業而多少，我的看法是，把伺服器部門改個招牌，雲端營業額就大增了
啊，問題是， <a class="reference external" href="http://www.wretch.cc/blog/JaguarCSIA/16236603">公司的總營收有成長嗎？</a></p>
<p>講完了這些後，再講個小故事， 2010 年我回台灣前，公司同事問我，回台灣要做雲端嗎？我回，我不會
在一個有 <strong>颱風、地震、洪水、土石流、及戰爭危機</strong> 的地方建資料中心。另外，台灣雖然是美國
對亞洲網路的樞紐，但是台灣的網路流量費過高，就是另一個要面對的問題。已上幾點，就是台灣要做雲端
資料中心地理環境上的外部問題。</p>
<p>再來講到台灣軟體業自己內部的問題，做網路服務，同時能服務 <strong>十萬個用戶</strong> 是一個門坎， <strong>一百萬個用戶</strong>
、 <strong>一千萬個用戶</strong> 、 <strong>一億個用戶</strong> 、 <strong>十億個用戶</strong> 都是不同的門坎，每跨過一階，整個
系統架構跟考量的點都完全不同，十萬個用戶用 <a class="reference external" href="http://en.wikipedia.org/wiki/LAMP_(software_bundle)">LAMP</a> 一台就夠了，一百萬用戶，那就要開始做 server farm, cache 等，到了
一千萬用戶，連 DB 都受不了用量，要找其它的解決方案( ex: <a class="reference external" href="http://en.wikipedia.org/wiki/Shard_(database_architecture)">shard</a> )，到上億用戶，你的客戶已
經不會都是居住在同一地了，光解決 data locality 都是個大問題了，更不用講怎麼 deploy service</p>
<p>台灣目前有超過百萬用戶的服務，大概就是 Yahoo、無名、痞客幫、PCHome，這四間了，除了這四間外，
很少公司會有經營百萬人服務的經驗，問題是，台灣喊著要做雲端運算的，都不是這四間，而是剩下來沒有
經營網路服務經驗的公司。</p>
<p>為什麼這經驗很重要呢？因為，一個新架構的好壞，只有經過實際的流量摧殘才能知道，在這之前，一切只
是工程師們用腦補的假設而已，腦補的假設越多，系統上線後要修改的地方越多，至於沒做過百萬人服務的
工程師要怎麼用腦補來假設上億人服務的狀況，那就不是我能想像的了。</p>
<p>美國最大的 Hosting Company <a class="reference external" href="http://dreamhost.com">DreamHost</a> 的創辦人 Sage Weil，在幾年前回去念博士，發展了
<a class="reference external" href="http://www.ssrc.ucsc.edu/Papers/weil-osdi06.pdf">Ceph</a> 這套 distributed file system ，人家想要研究資料時，只要回 DreamHost 回去挖一挖 log 就
有用不完的資料了，至於要驗證就更簡單了，只要把 5% 的用戶放到新架構上，就有用不完的資料可以用來
發掘新架構的缺陷。</p>
<p>這一點，是美國現有網路公司在跨足雲端服務的極大優勢；台灣的雲端廠商，如XX電信、XX研院、XX勢，跟本無
法彌補這中間的差距，記得在某場 CloudTW 的會議中，某家台廠在展視他們的雲端 OS 時， <a class="reference external" href="http://pingyeh.blogspot.com/">葉博士</a> 問了一
個問題就把這個雲端OS擊沉了，該雲端平台只能該台廠所提供的客制化OS，所有的系統 library 都是經過修改
，不能自行更換的，於是 <a class="reference external" href="http://pingyeh.blogspot.com/">葉博士</a> 就問，「要是今天 PHP X.Y.Z 有個 security hole 那麼，他能不能
自行補洞，還是要等台廠把整個環境更新才可把洞補上？」</p>
<p>現實( physical) 的環境沒有優勢，在經營網路服務上，更是落後國外數十年，沒有人材、經驗上的優勢，
這也就是為什麼 <strong>雲端產業在台灣行不通</strong> 的原因。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/23/corrupted-software-company/">關於遊戲公司裁員的感想</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-23T00:44:00+08:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>看到 <a class="reference external" href="https://www.facebook.com/MonkeyPotion?ref=stream">半路</a> <a class="reference external" href="https://www.facebook.com/MonkeyPotion/posts/445760425469302">分享</a> 最近 <a class="reference external" href="http://news.17173.com/content/2012-08-22/20120822114550361.shtml">幾間遊戲公司裁員</a> 的新聞，不經讓我想到過去在矽谷流浪歲月所認知到
的黑暗面，底下就是一個我親身看過的一個例子。</p>
<p>許多年前，AE用三億美金買了一家flash game公司，當時我上 linkedin 看一下 CEO 的背景，一看，
不得了了，我竟然在 linkedin 上跟他是有直接聯結，原來我認識大人物自己都不知道。</p>
<p>後來一查才知道，他們是我工作公司，在三年前買的一間英國公司，我們把他們買下來後，兩年閉鎖期一到
，他們一群六七個人就離職開新公司去了，這間公司後來就又被AE買過去。</p>
<p>當時，我不懂的是，為什麼AE要買這間公司呢？因為一個遊戲的生命週期就是六個月而已，一間遊戲公司的
價值是在於有一個團隊可以持續生產出賣座的遊戲，然而這間flash game的團隊，已經證明了他們兩年一到
就會走人，那為什麼AE公司要買這個公司呢？</p>
<p>後來問一問做金融的朋友，答案跟我猜想的不遠，AE就是買一天的新聞就好 <strong>「AE買下flash game公司，跨足FB市場，未來營收將有爆發性成長」</strong></p>
<p>上市公司們，他們想的，跟你我想的不一樣；靠股票換鈔票的公司，新聞效果過了，股價漲了，執行長選擇權
生效後，就是可以把買進的公司全裁了，反正當初就是買新聞效應而已。</p>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/01/parking-token-failover/">遺失停車代幣的解決方案</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/23/type-inference-and-code-review/">Type Inference 在實務上碰上的問題</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/05/on-compensation-of-youth/">談台灣年輕人低薪問題</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/13/tdd/">TDD</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/03/cross-strait-trade-agreement/">我看服貿</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Facebook</h1>
  <div class="fb-follow" data-href="https://www.facebook.com/yunglin.ho" data-width="260" data-show-faces="true"></div>
</section>
<section>
  <h1>Twitter</h1>
  <a class="twitter-timeline" href="https://twitter.com/yunglinho" data-widget-id="379628400123445248">Tweets by @yunglinho</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/101164690243066571931?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
<a title="tumblr stats"
href="http://statcounter.com/tumblr/" target="_blank"><img
src="http://c.statcounter.com/8085210/0/5c96ca74/0/"
alt="tumblr stats" style="border:none;"></a></section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 -  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yunglin';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
