
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>碎碎唸</title>
  <meta name="author" content="">

  
  <meta name="description" content="看到 Oracle 告 Google 被判定 API 也可享有著作權，讓我想到我非常多年
前授教於劉靜怡教授底下，集各家大成(抄襲)而成的一篇期末報告。
至於到底什麼該被 Patent 保護，什麼不該被 Patent 保護，What is patent worth，日
後，受教於 Dr. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.yunglinho.com/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/yunglinho" rel="alternate" title="碎碎唸" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11857878-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">碎碎唸</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/yunglinho" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.yunglinho.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/08/shall-patent-apply-to-business-model/">Shall Patent Apply to Business Model</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-08T14:27:00+08:00" pubdate data-updated="true">May 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>看到 Oracle 告 Google 被判定 API 也可享有著作權，讓我想到我非常多年
前授教於劉靜怡教授底下，集各家大成(抄襲)而成的一篇期末報告。</p>
<p>至於到底什麼該被 Patent 保護，什麼不該被 Patent 保護，What is patent worth，日
後，受教於 <a class="reference external" href="http://econ.arizona.edu/faculty/pingry.asp">Dr. David E. Pingry</a> 時，他用了一個 <a class="reference external" href="http://www.sciencedirect.com/science/article/pii/S0167923604002374">方程式</a> ，回達了我的問題。</p>
<p>數學模型之美，差點讓我改念 Econ PhD. 還好我太愛玩英文寫作又太差，所以沒有繼續念博士。</p>
<p>時光飛逝，我的年紀已比初識劉教授，教授當時的年紀還大了，十多年過去，我從那個長髮怪變怪叔叔了，
在專業上還是一事無成阿&#8230;</p>
<div class="section" id="shall-business-model-apply-to-patent">
<h2>Shall Business Model Apply to patent?</h2>
<p>前言：</p>
<p>1999年10月21日，全美第一大網路書籍、音樂零售商亞馬遜書店（Amazon）於西雅圖地方法院提出告訴，主張美國第一大書店Barnes &amp; Noble所設立的網路
書店barnesandnoble.com侵害其於同年9月28日獲准享有專利權之「1-Click technoloby」（Patent No. 5,960,411）；掀起了全球對商業模式是否適用
於專利權的重視。而國內經濟部智慧財產局與中華民國發明協會於2000年04月11日在台北國際會議中心舉辦的一場「新電子商務教戰守策國際研討會」，更
是讓這個話題在國內變的熱門起來。</p>
<dl class="docutils">
<dt>到底是否商業模式是否適用於專利權保障，本文將就下列幾個論點進行討論：</dt>
<dd><ul class="first last simple">
<li>一、商業模式適用於專利權的法源基礎</li>
<li>二、商業模式適用於專利權造成的影響</li>
<li>三、各國對於商業模式適用於專利權造成紛爭的回應</li>
<li>四、專利法在人類社會到底該辦演的是何種角色？又專利法該適用於商業模式嗎？</li>
<li>五、商業模式失去了專利權保障，網路公司該如何獲利</li>
</ul>
</dd>
</dl>
<p>冀望透過一系列的思考，將問題釐清頭緒</p>
</div>
<div class="section" id="id2">
<h2>一、商業模式適用於專利權的法源基礎</h2>
<p>在過去，電腦軟體一向被認為僅得受到著作權法及營業祕密法之保護，而無法申請獲准專利，在資訊產業一向居於領導地位的美國，其實務界在以往亦認為
電腦軟體不得申請專利，然而在軟體產業高度發展且各項軟體之應用日趨商業化後，軟體研發成果之週全保護成為不得不正視之議題，許多企業為確保其商
業之經營與投資，一再試圖尋求軟體之專利保護，一九八一年之Diamond v. Diehr一案，其中牽涉到的係一個以數學公式為基礎之電腦程式應用於控制橡
膠製模成形的時間，美國聯邦最高法院此一判決使電腦軟體至少確保了可獲得專利法保護之可能性。[1]</p>
<p>為實務上運作之需要，美國專利商標局（US PTO）隨即於一九九六年公佈了「電腦相關發明審查基準」
（Examination Guidelines for Computer-Related Invention），明定審查基準為機械、方法、製造品之法定標作為專利商標局審查軟體專利時之依據。</p>
<p>原本美國專利商標局審查員逕可核駁商業方法(Method of Doing Business)請求，但美國聯邦巡迴上訴法院於State Street Bank and Trust Company, v.
Signature Finacial Group, Inc.(38 USPQ2d 1530, 927 F. Supp. 502.) 一案中判決『審查員審查專利申請案含有商業方法請求項時，不可逕將該請求項
歸類成商業方法，而應以方法請求項進行實質審查』。此即商業方法申請案若符合可專利要件，再經審查員審定者，亦可能獲證。[2]</p>
<p>與State Street Bank &amp; Trust Co. v. Signature Financial Group Inc.,(47 U.S.P.Q.2d 1596（Fed. Cir. 1998). cert. denied, 119 S.Ct. 851）一
案中，判決確認一項用於網際網路之商業方法(business method）軟體具有可專利性（patentable subject matter）[3]</p>
<p>自此，造就了商業模式適用於專利權的法源基礎，也開啟了另一新的網路專利戰爭，許多網路公司，將賴以為生的技術與商業模式權利化、法律化。冀藉此
將競爭者排除於電子商務領域之外。</p>
</div>
<div class="section" id="id3">
<h2>二、商業模式適用於專利權造成的影響</h2>
<p>從去年 9月中至今，在美國即發生了數件與電子商務有關的專利訴訟，因為訴訟當事人均是諸如Microsoft、Amazon、Barnes&amp;Noble、DoubleClick等在電子
商務界舉足輕重的大公司，乃引發網路界的重大關切。底下就依發生時間簡述案件的經過。[4]</p>
<div class="section" id="priceline-commicrosoft">
<h3>1.priceline.com控告Microsoft</h3>
<p>1999年10月13日priceline.com Inc.於美國康乃狄克州地方法院對Microsoft提出告訴，主張Microsoft所提供之網路旅館價格拍賣 (Hotel Price Matching
System) 侵害其享有專利權之reverse auction patent (patent 5,794,207)，因為Microsoft於卓站中的Expedia travel site提供一套名為「name your price」
系統，由網路使用者輸入旅遊地點、希望的旅館等級及預算後，選出最適合該使用者之旅遊行程，並自動將該使用者之信用卡號碼寄給接受該筆交易的旅館
。而上述「name your price」系統所應用的商業方法正是priceline.com Inc.申請獲准之5,794,207專利涵蓋的範圍。</p>
</div>
<div class="section" id="amazonbarnesandnoble-com">
<h3>2.Amazon控告barnesandnoble.com</h3>
<p>繼priceline.com Inc.之訴訟後，全美第一大網路書籍、音樂零售商亞馬遜書店 (Amazon) 於10月21日在西雅圖地方法院提出告訴，主張美國第一大書店
Barnes &amp; Noble所設立的網路書店barnesandnoble.com侵害其於1999年09月28日獲准享有專利權之「1-Click technoloby」 (Patent No. 5,960,411) 。</p>
<p>Amazon於訴訟中除請求相當於三倍合理權利金之損害賠償及訴訟費用外，Amazon更申請法院發布禁制令，禁止Barnes &amp; Noble繼續使用相同之商業方法。
於禁制令頒布後，Barnesandnoble.com即表示將於近日內推出一種名為「Express Checkout」的新服務，並指出該公司將提出上訴，因為Amazon所獲得的專利其
實是一種早被廣泛使用的科技。</p>
</div>
<div class="section" id="doubleclickl90-inc">
<h3>3.DoubleClick控訴L90 Inc.</h3>
<p>知名的網路廣告DoubleClick於1999年11月12日向維吉尼亞州東區地方法院控訴加州網路公司 L90 Inc.侵害其有關傳輸、鎖定與衡量網路廣告之專利「Method
of Delivery,Targeting and Measuring Advertising over the Internet」(Patent No. 5,948,061) 。</p>
<p>由於該專利為目前多數網路廣告普遍採行的方式，因此倘若法院判決DoubleClick勝訴者，則絕大多數提供網路廣告的公司通通都會被逐出該市場而無法繼續經營。</p>
<p>上述的三個案例，均有利用專利訴訟來達到排除競爭對手目的的意味，此外其專利在獨創性上更有所爭議；將已普遍使用的技術通過專利申請，US PTO對於
專利的發放是否過於浮爛呢？</p>
</div>
</div>
<div class="section" id="id4">
<h2>三、各國對於商業模式適用於專利權造成紛爭的回應</h2>
<p>跟據電子時報2000年05月05日的報導[5] ，日本、美國與歐盟 (EU) 的專利組織日前宣佈，將加強在電子商務商業模式 (Business Model) 專利權審核方面
的合作，以創造合適的環境，幫助新產業發展。三方國家組織的專利機構將以建立國際共同的認定標準為目的，預計2002年架構既有商業模式專利資料庫，
共享各種資訊。各國將強化在專利資訊上的交流，共享審核報告、法院判例等資訊。各專利機構也將進行專利權實例分析，以建立公認的專利認定標準，並
共同對負責審核的法官進行教育。由於電子商務可能是跨國經營，在某一國家的企業可能在另一國家侵犯其他企業的專利，各國必須及早建立共同的標準。</p>
<p>美國對商業模式專利的認定甚為積極，1999年約有600件專利權申請獲得通過。從1999年層出不窮的專利訴訟可知一斑。美國政府指出，商業模式專利對產業
發展是不可或缺的一部份，由於負責的法官對電子商務專利審核的經驗與資料可能較為欠缺，美國將盡力給予日本、歐洲等國家有關此方面的協助。</p>
<p>各國預定在七月舉行的國際高峰會議中達成共識，將從嚴訂定審核標準。除保障申請專利者的權益外，也要防止專利權被濫用。</p>
</div>
<div class="section" id="id5">
<h2>四、專利法在人類社會到底該辦演的是何種角色？</h2>
<p>專利法該適用於商業模式嗎？</p>
<p>中華民國專利法第一條便開宗明義宣告「為鼓勵、保護、利用發明與創作，以促進產業發展，特制定本法。」而世界各國的專利法也是依此原則所立法。</p>
<p>基本上經濟學家認為，專利權的存在具有兩個功用─創作 (Invention)與創新 (Innovation) ，前者指的是從事發明的行為，後者指的是將發明市場化。接
著本文將從這兩個角度來探討專利法該適用於網際網路的商業模式嗎？</p>
<div class="section" id="id6">
<h3>1.創作動機理論</h3>
<p>創作動機理論或許是最常見為專利權背書的經濟學理論，這理論認為，專利權的存在是在鼓勵那些若失去專利權保障便不會發生的發明。也就是說專利權提
供了發明的誘因。從反方向來思考，對於不須要專利權保障便會發生的發明是否便不須要給與專利上的保障呢？</p>
<p>根據 IDC公司估計，至2002年全球透過網際網路網站之交易金額將突破4000億美元。究竟在如此龐大的經濟誘因之下，失去專利權保障，各種不同的網際網
路商業模式難到就不會被發明嗎？</p>
</div>
<div class="section" id="id7">
<h3>2.創新理論</h3>
<dl class="docutils">
<dt>創新理論認為</dt>
<dd><ol class="first last arabic simple">
<li>對大公司來說，由於政府規定對於專利權的標的物必須充分揭露資料，為了避免在專利過期後無償被公眾使用，在專利權期間必定會大量授權給其它廠商以謀取利益。</li>
<li>對創業家來說擁有獨佔的專利權，較容易於市場上集資。</li>
</ol>
</dd>
</dl>
<p>相較於後者的說法，前者應用在網際網路商業模式時便不太恰當，由於電子商務是屬於全球化的競爭，將商業模式授權給它人僅會增加競爭對手，且在變化
快速的網際網路上，一個好的商業模式很可能在半年內便被另一個更好的取代，因此相較於開放市場，倒不如獨占市場較有利可圖。</p>
<p>綜觀上述兩點，本文認為商業模式適用於專利權並不恰當。</p>
</div>
</div>
<div class="section" id="id8">
<h2>結尾、商業模式失去了專利權保障，網路公司該如何獲利</h2>
<p>寫在最後本文想要引入一個觀念，就是由 Richard M. Stallman與自由軟體基金會[7] 所倡導的 Free Software與Eric Raymond的OpenSource中的軟體無價
服務有價；將技術開放出來成為公共財，促進整體經濟的繁容，而透過應用技術的服務賺取利潤。</p>
<p>對於商業模式的發明者來講，一個新的商業模式，從一開始便擁有市場的競爭優勢，外在的進入者在進入這個市場的時候就必須跨過這個關卡，受不受到專
利權的保障似乎並不那麼重要。</p>
</div>
<div class="section" id="id9">
<h2>參考資料：</h2>
<dl class="docutils">
<dt>[1]電腦軟體專利對電子商務之影響</dt>
<dd><a class="reference external" href="http://www.ithome.com.tw/column/eclaw/eclaw20000224.html">http://www.ithome.com.tw/column/eclaw/eclaw20000224.html</a></dd>
<dt>[2]美國電子商務專利之最新動態</dt>
<dd><a class="reference external" href="http://stlc.iii.org.tw/publish/ipma/23/2305.htm">http://stlc.iii.org.tw/publish/ipma/23/2305.htm</a></dd>
<dt>[3]Internet Business Methods: What Role Does and Should Patent Law Play?</dt>
<dd><a class="reference external" href="http://scs.student.virginia.edu/~vjolt/graphics/vol4/v4i2a9-grusd.html">http://scs.student.virginia.edu/~vjolt/graphics/vol4/v4i2a9-grusd.html</a></dd>
<dt>[4]電子商務網路專利世紀大戰－從Amazon告Barnes Noble侵權談起</dt>
<dd>電子時報  1999.12.14  網路與軟體專欄</dd>
<dt>[5]日美歐加強EC專利審核</dt>
<dd><a class="reference external" href="http://news.kimo.com.tw/2000/05/05/technology/digi/320333.html">http://news.kimo.com.tw/2000/05/05/technology/digi/320333.html</a></dd>
</dl>
<p>[6]ROBERTO MAZZOLENI &amp; RICHARD NELSON, ECONOMIC THEORIES ABOUT THE BENEFITS AND COSTS OF PATENTS (1996).</p>
<p>[7]http://www.fsf.org</p>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/30/mongodb-dao/">Mongodb Scala DAO</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-30T11:50:00+08:00" pubdate data-updated="true">Apr 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>這篇文章將說說，我使用 MongoDB &amp; Cashbah 的一些心得，這程式的主架構是
我從 <a class="reference external" href="https://github.com/aboisvert/simplistic">simplistic</a> 學來的。</p>
<div class="section" id="the-abstract-dao">
<h2>The Abstract DAO</h2>
<p>底下是一個很簡單的 CRUD 的 MongoDB DAO. 在這邊，我們建立一個 DAO 時，我們會把這
個 DAO 用的儲存空間 MongoCollection 傳進來，另外要注意的一點是，這個 MongoCollection 的
WriteConcert 必需是 Strict 的。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> *  Base class for all DAO classes.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">AbstractDAO</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ID</span> <span class="k">&lt;:</span> <span class="kt">Serializable</span><span class="o">](</span><span class="k">protected</span><span class="o">[</span><span class="kt">locadz</span><span class="o">]</span> <span class="k">val</span> <span class="n">mongoCol</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** builder to turn mongodb object into model object */</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">builder</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">T</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** builder to turn model object into mongodb object */</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">extractor</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="nc">DBObject</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** this dao expects the underlying mongoCol would throw exception when error occurs. */</span>
</span><span class="line">  <span class="n">require</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">  <span class="n">require</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span><span class="o">.</span><span class="n">getW</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="s">&quot;Write must be &gt;= 1, was %d&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span><span class="o">.</span><span class="n">getW</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** insert object into the underly*/</span>
</span><span class="line">  <span class="k">def</span> <span class="n">insert</span><span class="o">(</span><span class="n">obj</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">ID</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">(</span><span class="n">obj</span><span class="o">)</span>
</span><span class="line">      <span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">WriteResult</span> <span class="o">=</span> <span class="n">mongoCol</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span><span class="n">dbObj</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">ID</span><span class="o">](</span><span class="s">&quot;_id&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span>      <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">save</span><span class="o">(</span><span class="n">obj</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">DataAccessException</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">res</span> <span class="k">=</span> <span class="n">mongoCol</span><span class="o">.</span><span class="n">save</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">obj</span><span class="o">)</span>
</span><span class="line">      <span class="nc">None</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span>      <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">findById</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">ID</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="n">mongoCol</span><span class="o">.</span><span class="n">findOneByID</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">None</span>        <span class="k">=&gt;</span> <span class="nc">Right</span><span class="o">(</span><span class="nc">None</span><span class="o">)</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">dbObj</span><span class="o">).</span><span class="n">right</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">Option</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">delete</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">ID</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">DataAccessException</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="n">mongoCol</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="nc">MongoDBObject</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="n">id</span><span class="o">))</span>
</span><span class="line">      <span class="nc">None</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">find</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">builder</span><span class="k">:</span> <span class="o">(</span><span class="kt">DBObject</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">Iterable</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">        <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">found</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">          <span class="n">builder</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">found</span><span class="o">).</span><span class="n">fold</span><span class="o">(</span>
</span><span class="line">            <span class="n">e</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="n">e</span><span class="o">,</span>
</span><span class="line">            <span class="n">r</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">r</span><span class="o">))</span>
</span><span class="line">        <span class="o">}).</span><span class="n">toStream</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>這邊有兩個需要被實作的東西</p>
<ul class="simple">
<li><cite>val builder: DBObject =&gt; Either[DataAccessException, T]</cite></li>
<li><cite>val extractor: T =&gt; DBObject</cite></li>
</ul>
<p>而怎麼建立這兩個東西，就是全文的重點了。</p>
</div>
<div class="section" id="how-to-use-abstractdao">
<h2>How to use AbstractDAO</h2>
<p>先來看一個範例；實作上，在 UserDAO object 上，我們先把欄位的名稱及資料型態，一個個的定好</p>
<ul class="simple">
<li>&#8216;val Name = attribute(&quot;name&quot;, Conversion.String)`</li>
<li>&#8216;val Email = attribute(&quot;email&quot;, Conversion.String)&#8217;</li>
<li>&#8216;val CreateDate = attribute(&quot;ctime&quot;, Conversion.JodaDate)&#8217;</li>
</ul>
<p>而這個 attribute method 做的是，把資料名稱存起來，然後當這個 Attribute instance</p>
<ul class="simple">
<li>收到一個 DBObject 時，把對應的欄位取出來，並將值給轉成定義的格式</li>
<li>收到一個 property value 時，把他轉成 (name -&gt; value) pair</li>
</ul>
<p>第一個用法的這個方式，用在從 <em>builder</em> 上面，一個個的把值從 DBObject 抓出來再來建立物件，
第二個用法用在，把物件轉成 DBObject 時，及用在建立 query 時。</p>
<div class="section" id="userdao">
<h3>UserDAO 實作</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">UserDAO</span><span class="o">(</span><span class="n">mongoCol</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AbstractDAO</span><span class="o">[</span><span class="kt">User</span>, <span class="kt">String</span><span class="o">](</span><span class="n">mongoCol</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">UserDAO._</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">builder</span><span class="k">:</span> <span class="o">(</span><span class="kt">DBObject</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="nc">UserDAO</span><span class="o">.</span><span class="n">dbObjectToUser</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">extractor</span><span class="k">:</span> <span class="o">(</span><span class="kt">User</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">DBObject</span> <span class="k">=</span> <span class="nc">UserDAO</span><span class="o">.</span><span class="n">userToDBObject</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="k">this</span><span class="o">(</span><span class="n">dbCol</span><span class="k">:</span> <span class="kt">DBCollection</span><span class="o">)</span> <span class="k">=</span> <span class="k">this</span><span class="o">(</span><span class="n">dbCol</span><span class="o">.</span><span class="n">asScala</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">UserDAO</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">Attributes._</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">Name</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">Email</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">CreateDate</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;ctime&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">JodaDate</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">dbObjectToUser</span><span class="o">(</span><span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="n">dbObj</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;_id&quot;</span><span class="o">).</span><span class="n">get</span>
</span><span class="line">
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span>
</span><span class="line">        <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span>
</span><span class="line">          <span class="nc">Name</span><span class="o">(</span><span class="n">dbObj</span><span class="o">),</span>
</span><span class="line">          <span class="nc">Email</span><span class="o">(</span><span class="n">dbObj</span><span class="o">),</span>
</span><span class="line">          <span class="nc">CreateDate</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">        <span class="o">)</span>
</span><span class="line">      <span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">def</span> <span class="n">userToDBObject</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="nc">MongoDBObject</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">Name</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">externalId</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">Email</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">verifiedId</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">createDate</span><span class="o">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">ret</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="attribute-conversion">
<h3>Attribute &amp; Conversion 部份實作</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
</span><span class="line">  <span class="k">val</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class="line">  <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">throw</span> <span class="k">new</span> <span class="nc">MissingRequiredAttributeException</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">new</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">B</span>
</span><span class="line">  <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">Conversion</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">String</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">source</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">value</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Conversion for DateTime to DateTime.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="k">object</span> <span class="nc">JodaDate</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">DateTime</span>, <span class="kt">DateTime</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nc">RegisterJodaTimeConversionHelpers</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=</span> <span class="n">source</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=</span> <span class="n">value</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
<div class="section" id="how-to-use-attributes-to-build-query">
<h2>How to Use Attributes to Build Query</h2>
<p>前面的 Attribute(s) 不只是用來產做 builder 及 extractor 用的，他們最好用的地方在於
建立 query 時，如下</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">findByDateRange</span><span class="o">(</span><span class="n">start</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">return</span> <span class="n">find</span><span class="o">(</span><span class="nc">CreateDate</span><span class="o">.</span><span class="n">name</span> <span class="nc">$gth</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">start</span><span class="o">).</span><span class="n">_2</span>  <span class="nc">$lt</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">range</span><span class="o">).</span><span class="n">_2</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>這邊，我們可以看到用 Conversion 來描述資料型態的好處是，當你儲存的資料型態有變時，你不用去更
改你的 MongoDB query ，欄位的名稱、資料型別的轉換，都被封裝起來，使用者在寫 Query 時，不用去
記欄位的名稱，也不用去記這個欄位的型態是什麼， MongoDB 支不支援這個型態。</p>
<p>第二個好處是， Casbah 本來只支援 java primitive type &amp; java.util.Date ，透過 Conversion ，
我們可以支援任意的資料型態於 query 中，只要透過新的 Conversion 類別，我們就可以增加 MongoDB 可以
支援的資料型態。</p>
<p>例如，如果我們想增加對 <cite>java.net.URL</cite> 的支援，只要訂義以下的 Conversion 即可</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">object</span> <span class="nc">Url</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">URL</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">URL</span><span class="o">)</span> <span class="k">=</span> <span class="n">source</span><span class="o">.</span><span class="n">toExternalForm</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">URL</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="appendix">
<h2>Appendix:</h2>
<div class="section" id="attribute-scala">
<h3>Attribute.scala</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">package</span> <span class="nn">com.locadz.model.mongodb</span>
</span><span class="line">
</span><span class="line"><span class="k">import</span> <span class="nn">com.mongodb.DBObject</span>
</span><span class="line"><span class="k">import</span> <span class="nn">com.mongodb.casbah._</span>
</span><span class="line"><span class="k">import</span> <span class="nn">com.locadz.model.exception.MissingRequiredAttributeException</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Date: 2/20/12</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">object</span> <span class="nc">Attributes</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
</span><span class="line">    <span class="k">val</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">OptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Any</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">v</span> <span class="k">=</span> <span class="n">value</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="k">_</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
</span><span class="line">      <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">v</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">throw</span> <span class="k">new</span> <span class="nc">MissingRequiredAttributeException</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">SingleValueOptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span>
</span><span class="line">    <span class="k">extends</span> <span class="nc">OptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">optionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="nc">SingleValueOptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/26/mongodb-java-driver-sucks/">Problem in Mongodb&#8217;s Java and Scala Driver.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-26T18:45:00+08:00" pubdate data-updated="true">Apr 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MongoDB 的 Java Driver 支援透過 <a class="reference external" href="http://api.mongodb.org/java/2.5/org/bson/Transformer.html">Transformer</a> 去掛上 encodingHook 及 decodingHook，
使用方式可以參考 <a class="reference external" href="https://github.com/novus/salat/blob/9d7988fbd212b6a1423cb2be72065ebff3570777/salat-core/src/test/scala/com/novus/salat/test/util/UriConversionHelper.scala">Salat URISerializer</a>.</p>
<p>原本我以為透過這樣，我就可以透過自定 encoding and decoding Hook ，去動態
的把 MongoDB 內部的資料型態，在抓取時，自動轉成我要的形態。</p>
<p>例如透過底下的程式碼，就在呼叫 <a class="reference external" href="http://api.mongodb.org/scala/casbah/2.1.5.0/scaladoc/com/mongodb/casbah/commons/MongoDBObject.html#getAs[A](String)(Manifest[A]):Option[A]">getAs[URL](&quot;url&quot;)</a> 時，才即時的把 String 轉成 URL 。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="nc">BSON</span><span class="o">.</span><span class="n">addEncodingHook</span><span class="o">(</span><span class="n">class</span><span class="o">[</span><span class="kt">URL</span><span class="o">],</span> <span class="k">new</span> <span class="nc">Transformer</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">transform</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">AnyRef</span> <span class="o">=</span> <span class="n">o</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="n">u</span><span class="k">:</span> <span class="kt">URL</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">toExternalForm</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span>      <span class="k">=&gt;</span> <span class="n">o</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">})</span>
</span><span class="line"><span class="nc">BSON</span><span class="o">.</span><span class="n">addDecodingHook</span><span class="o">(</span><span class="n">class</span><span class="o">[</span><span class="kt">URL</span><span class="o">],</span> <span class="k">new</span> <span class="nc">Transformer</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">transform</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">AnyRef</span> <span class="o">=</span> <span class="n">o</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">URL</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure><p>結果，事情不如我預期所想的， <cite>decodingHook</cite> 是掛在 MongoDB 儲存的資料
型態上，而不是你所需要的資料型態上；換個方法講， <cite>decodingHook</cite> 是在
BSON driver 把資料讀出來時，就呼叫的。</p>
<p>實作上，如果你去細看 Salat URISerializer ，他的 <cite>decodingHook</cite> 是註冊
在 <cite>String Type</cite> 而非 <cite>URI Type</cite> ，而實作時，是把字串加上了 &quot;<cite>URI~</cite>&quot; 來
判斷，這個字串是否是該被 URI Serializer 轉型成 URI。</p>
<p>如果你去看 <cite>org.bson.BSON</cite> 的實作，你會看到底下這段恐怖的程式碼，BSON
在讀出資料時，會把對該型別的 <cite>Transformer</cite> 全跑一遍，而這個東西又是個
Gloabal Variable，這樣一來出了三個問題</p>
<ul class="simple">
<li>所有 Custom Data Type 都需要被轉成 String 並加上 Prefix 才可以寫入，
你不可以把一個 Custom Data Type 轉成 Integer ，如果你這麼做了，所有
的 Integer ，包含本來就該是 Integer 的欄位，未來在讀出來時，全都會變成
這個 Custom Data Type ！</li>
<li>你的 MongoDB Driver 仰賴所有的使用者都清楚他在做什麼，也清楚別人在
做什麼，如果有一個 Transformer 出錯了，或者是 Prefix 重覆了，那麼
你自定的 Custom Data Type 也會出錯。</li>
<li>你 MongoDB 中的資料，為了儲存 Data Type 於資料欄位中而被污染了！</li>
</ul>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addDecodingHook</span><span class="o">(</span> <span class="n">Class</span> <span class="n">c</span> <span class="o">,</span> <span class="n">Transformer</span> <span class="n">t</span> <span class="o">){</span>
</span><span class="line">    <span class="n">_decodeHooks</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Transformer</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">_decodingHooks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="n">c</span> <span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span> <span class="n">l</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">){</span>
</span><span class="line">        <span class="n">l</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Transformer</span><span class="o">&gt;();</span>
</span><span class="line">        <span class="n">_decodingHooks</span><span class="o">.</span><span class="na">put</span><span class="o">(</span> <span class="n">c</span> <span class="o">,</span> <span class="n">l</span> <span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">l</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="n">t</span> <span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">applyDecodingHooks</span><span class="o">(</span> <span class="n">Object</span> <span class="n">o</span> <span class="o">){</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span> <span class="o">!</span> <span class="n">_anyHooks</span><span class="o">()</span> <span class="o">||</span> <span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Transformer</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">_decodingHooks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span> <span class="n">l</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span>
</span><span class="line">        <span class="k">for</span> <span class="o">(</span> <span class="n">Transformer</span> <span class="n">t</span> <span class="o">:</span> <span class="n">l</span> <span class="o">)</span>
</span><span class="line">            <span class="n">o</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span> <span class="n">o</span> <span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p><a class="reference external" href="https://jira.mongodb.org/browse/SCALA-66">SCALA-66</a> 說 3.0.0 release 時，會有一個 per field, per data type 的
type conversion機制，不過 3.0.0-M2 時還沒把這塊做進去，所以看來有得等了</p>
<p>我是自己有參照 <a class="reference external" href="https://github.com/aboisvert/simplistic">simplistic</a> 刻一個機制，可以在 DAO 中讀進讀出物件時做轉
換，但是在寫 Query 時，仍是有些不便。</p>
<p>如果你有這需求的話，可以跟我連絡，我把 source code 給你。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/22/dependency-injection-in-scala/">Dependency Injection in Scala</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-22T22:44:00+08:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>這是 4/23 要在 Scala Taiepi Meeting 3 用的講稿，先打出來放這。</p>
<div class="section" id="dependency-injection-inversion-of-control">
<h2>Dependency Injection &amp; Inversion of Control</h2>
<p><a class="reference external" href="http://martinfowler.com/articles/injection.html">Dependency Injection &amp; Inversion of Control</a> 是 Martin Fowler 在 2004 年所
提出來的一個的概念，Martin Fowler在這篇文章中指出，DI可以三種型式來實作，這觀念後來由 Spring
Source 及 Google 實做出來，變成 Java Enterprise 應用中，不可或缺的一塊。</p>
<p>在 Ioc 觀念的出現前，物件相依的元件(Component)，多是於物件建立時，就帶入(binding)的，Martin
的供獻在於，IoC把物件對元件的相依性拆出來，變成可以替換的實作。</p>
<p>底下是 Martin 所舉的例子，接著我們會看到用 DI 改進的方式</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span> <span class="o">{</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">  <span class="kd">public</span> <span class="nf">MovieLister</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">finder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ColonDelimitedMovieFinder</span><span class="o">(</span><span class="s">&quot;movies1.txt&quot;</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>Martin 提出的 DI 型式分別是 Constructor Injection, Setter Injection, and Interface Injection.</p>
<div class="section" id="constructor-injection">
<h3>Constructor Injection</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span><span class="o">...</span>
</span><span class="line">  <span class="kd">public</span> <span class="nf">MovieLister</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">this</span><span class="o">.</span><span class="na">finder</span> <span class="o">=</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="setter-injection">
<h3>Setter Injection</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span><span class="o">...</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinder</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">finder</span> <span class="o">=</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">   <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="interface-injection">
<h3>Interface Injection</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">InjectFinder</span> <span class="o">{</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">injectFinder</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span> <span class="kd">implements</span> <span class="n">InjectFinder</span><span class="o">...</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">injectFinder</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">finder</span> <span class="o">=</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">class</span> <span class="nc">Tester</span><span class="o">...</span>
</span><span class="line">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">registerComponents</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">container</span><span class="o">.</span><span class="na">registerComponent</span><span class="o">(</span><span class="s">&quot;MovieLister&quot;</span><span class="o">,</span> <span class="n">MovieLister</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">    <span class="n">container</span><span class="o">.</span><span class="na">registerComponent</span><span class="o">(</span><span class="s">&quot;MovieFinder&quot;</span><span class="o">,</span> <span class="n">ColonMovieFinder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">registerInjectors</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">container</span><span class="o">.</span><span class="na">registerInjector</span><span class="o">(</span><span class="n">InjectFinder</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">container</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;MovieFinder&quot;</span><span class="o">));</span>
</span><span class="line">    <span class="n">container</span><span class="o">.</span><span class="na">registerInjector</span><span class="o">(</span><span class="n">InjectFinderFilename</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">FinderFilenameInjector</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="jsr-330-annotation">
<h3><a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a> Annotation</h3>
<p>而後，這些 DI 的用法，也被 J2EE 給採用，變成 <a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a> 標準，用法如下</p>
<div class="section" id="id2">
<h4>Constructor Injection</h4>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span><span class="o">...</span>
</span><span class="line">  <span class="nd">@Inject</span> <span class="kd">public</span> <span class="n">MovieLister</span><span class="o">(</span><span class="n">MovieFinder</span> <span class="n">finder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="k">this</span><span class="o">.</span><span class="na">finder</span> <span class="o">=</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MovieFinder</span> <span class="o">{</span>
</span><span class="line">    <span class="n">List</span> <span class="nf">findAll</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="property-injection">
<h4>Property Injection</h4>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">class</span> <span class="nc">MovieLister</span> <span class="o">{</span>
</span><span class="line">  <span class="nd">@Inject</span> <span class="kd">private</span> <span class="n">MoveFinder</span> <span class="n">finder</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
</div>
<div class="section" id="dependency-injection-in-scala">
<h2>Dependency Injection in Scala</h2>
<p>花了許久時間解釋 DI 於 Java 的演進，我們總算可以進入本文的正題 Dependency Injection in Scala。在 Scala 中
實做 DI 的方式有有那些呢，接下來我們要談的就是 DI in Scala 的幾個選擇。</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a></li>
<li>Cake Pattern</li>
<li>SubCut</li>
<li>Functional DI - Reader Monad</li>
</ul>
<div class="section" id="id3">
<h3><a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a></h3>
<p>由於 Scala 本身在編譯時，會被編成 Java Byte Code ，所以可以直接套用支源 <a class="reference external" href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">JSR-330</a> 的
框架，但是在使用上有一些小眉角，就是，若是使用 Constructor Injection 時，需要用 <cite>&#64;Inject()</cite> 標
在 class 定義之前，使用 Property Injection 時，由於 Scala 的 <cite>val</cite> 被定義成 final 的，所以不
能夠被用在 Property Injection 之上，在這時候，只能用 <cite>var</cite> 來做。</p>
<p>為了達到 immutable 的效果，我通常都是用 Constructor Injection 的。( 另一個原因是我不喜歡 AOP )</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">@Inject</span><span class="o">()</span> <span class="nc">MovieLister</span><span class="o">(</span><span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MovieLister2</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">var</span> <span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span> <span class="o">=</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="cake-pattern">
<h3>Cake Pattern</h3>
<p>Cake Pattern 大概是除了 JSR-330 外，最常被提到在 Scala 下的實作 DI 的方式了，Cake Pattern 是由
Scala 之父 Martin Odersky 的一篇論文 <a class="reference external" href="http://lamp.epfl.ch/~odersky/papers/ScalableComponent.pdf">Scalable Component Abstractions</a> 中提到，不過大
多數人看過的版本，應該是 Jonas Bonér 的 <a class="reference external" href="http://jonasboner.com/2008/10/06/real-world-scala-dependency-injection-di/">Real-World Scala: Dependency Injection (DI)</a></p>
<p>Cake Pattern 是利用 Scala Mixin 的功能，讓物件被創造時，才把相依的元件，透過 Mixin 的方式綁在一起。</p>
<p>接下來，我們就看看要怎麼樣用 Cake Pattern 重新實作上面的 MovieFinder 的例子</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">MovieFinderComponent</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">MovieFinder</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">findAll</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">NilMovieFinderComponent</span> <span class="k">extends</span> <span class="nc">MovieFinderComponent</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NilMovieFinder</span>
</span><span class="line">
</span><span class="line">  <span class="k">class</span> <span class="nc">NilMovieFinder</span> <span class="k">extends</span> <span class="nc">MovieFinder</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">findAll</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Nil</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">MovieLister</span> <span class="o">{</span>
</span><span class="line">  <span class="k">this:</span> <span class="kt">MovieFinderComponent</span> <span class="o">=&gt;</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">findByAuthor</span><span class="o">(</span><span class="n">author</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">finder</span><span class="o">.</span><span class="n">findAll</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">m</span> <span class="k">=&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">author</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>上面便是一個使用 Cake Pattern 實作 MovieFinder 所需要的程式碼；首先，我們要把所需的
元件，包在一個 Component trait (MovieFinderComponent) 裡頭，再把這個原元件的規格，
寫在 Component trait 中的另一個 trait 中(MovieFinder)，最後，再是訂一個取存這元件的
method <cite>def finder: MovieFinder</cite>.</p>
<p>在被注入的這一方 (MovieLister) ，我們使用 self-type annotation 來宣告，當要生成一個
MovieLister instance 時，我們必需要提供 MovieFinderComponent 的實作，同時，在MovieLister
內，我們可以透過 <cite>finder</cite> 這個 method 來呼叫 MovieFinder 的實作 ；這邊的寫法是</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">movieLister</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MovieLister</span> <span class="k">extends</span> <span class="nc">NilMovieFinderComponent</span>
</span></code></pre></td></tr></table></div></figure><div class="section" id="component-registry">
<h4>Component Registry</h4>
<p>在應用上，由於我們的系統可能包含不只一個元件，而一個物件，可能須要多個不同的元件，因此，
Jonas建議我們，如　Guice 用 Module 來定義所有元件的實作類別，在Cake Pattern上，我們
可以用一個 ComponentRegistry Object 來把所有的實作類別指定好。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">ComponentRegistry</span> <span class="k">extends</span>
</span><span class="line">  <span class="nc">MyMovieFinderComponent</span> <span class="k">with</span>
</span><span class="line">  <span class="nc">MyAuthorFinderComponent</span> <span class="k">with</span>
</span><span class="line">  <span class="nc">MyUserRepositoryComponent</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">TestEnvironment</span> <span class="k">extends</span>
</span><span class="line">  <span class="nc">MockMovieFinderComponent</span> <span class="k">with</span>
</span><span class="line">  <span class="nc">MockAuthorFinderComponent</span> <span class="k">with</span>
</span><span class="line">  <span class="nc">MockUserRepositoryComponent</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Test</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">testList</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="n">lister</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MovieLister</span> <span class="k">extends</span> <span class="nc">TestEnvironment</span>
</span><span class="line">    <span class="c1">// testing code.</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><div class="note">
<p class="first admonition-title">Note</p>
<p class="last">一個動動腦的時間，在使用 ComponentRegistry 時，我們要怎麼寫，才會讓某一個 Component 的實作變成 Singleton</p>
</div>
</div>
<div class="section" id="pros-and-cons-of-cake-pattern">
<h4>Pros and Cons of Cake Pattern</h4>
<dl class="docutils">
<dt>Pros</dt>
<dd><ul class="first last simple">
<li>no framework required, using only language features</li>
<li>type safe – a missing dependency is found at compile-time</li>
<li>powerful – “assisted inject”, scoping possible by implementing the dependency-providing method appropriately</li>
</ul>
</dd>
<dt>Cons</dt>
<dd><ul class="first last simple">
<li>lot of boilerplate code</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="problem-of-cake-pattern">
<h4>Problem of Cake Pattern</h4>
<p>然而，從我的使用經驗來講， Cake Pattern 有個缺點，讓我不推薦各位來使用 Cake Pattern ，缺點是， Cake Pattern
只能使用在第一層相依性的元件上，造成實作上的程式碼的不一致性，以及可重用性的問題。</p>
<p>今天，假設我們電影的數量一直成長，所以我們開始分門別類來存放這些電影的類別，而我們在找作者時，只在各個子類別下
找；為了這個變更，我們不只需要新增一些元件，我們連舊有的 MovieLister 都需要更改他的實作才行。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">CategorizedMovieFinderFactoryComponent</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span>  <span class="nc">CategorizedMovieFinderFactory</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">create</span><span class="o">(</span><span class="n">category</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">MovieFinder</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">MovieListerFactory</span> <span class="o">{</span>
</span><span class="line">  <span class="k">this:</span> <span class="kt">CategorizedMovieFinderComponent</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">create</span><span class="o">(</span><span class="n">category</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">MovieLister</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MovieLister</span><span class="o">(</span><span class="n">finder</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="c1">// WTF, the implementation has to change here?!</span>
</span><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">MovieLister</span><span class="o">(</span><span class="n">finder</span><span class="k">:</span> <span class="kt">MovieFinder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">findByAuthor</span><span class="o">(</span><span class="n">author</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Movie</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">finder</span><span class="o">.</span><span class="n">findAll</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">m</span> <span class="k">=&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">author</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
</div>
<div class="section" id="subcut">
<h2><a class="reference external" href="https://github.com/dickwall/subcut/blob/master/GettingStarted.md">SubCut</a></h2>
<p><a class="reference external" href="https://github.com/dickwall/subcut/blob/master/GettingStarted.md">SubCut</a> 是由 Dick Wall 這位 Java Posse Podcaster 所完成的專案，由於我個人並沒有實際使用的經驗
，所以只能就他所提供的文件做個概述。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">SomeModule</span> <span class="k">extends</span> <span class="nc">NewBindingModule</span><span class="o">({</span> <span class="k">implicit</span> <span class="n">module</span> <span class="k">=&gt;</span>
</span><span class="line">  <span class="k">import</span> <span class="nn">module._</span>  <span class="c1">// optional but convenient</span>
</span><span class="line">
</span><span class="line">  <span class="n">bind</span> <span class="o">[</span><span class="kt">ServiceA</span><span class="o">]</span> <span class="n">toSingle</span> <span class="n">Y</span>
</span><span class="line">  <span class="n">bind</span> <span class="o">[</span><span class="kt">Z</span><span class="o">]</span> <span class="n">toProvider</span> <span class="o">{</span> <span class="n">codeToGetInstanceOfZ</span><span class="o">()</span> <span class="o">}</span>
</span><span class="line"><span class="o">})</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">SomeService</span><span class="o">(</span><span class="n">param1</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">param2</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">bindingModule</span><span class="k">:</span> <span class="kt">BindingModule</span><span class="o">)</span>
</span><span class="line">    <span class="k">extends</span> <span class="nc">SomeTrait</span> <span class="k">with</span> <span class="nc">Injectable</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">service1</span> <span class="k">=</span> <span class="n">inject</span> <span class="o">[</span><span class="kt">ServiceA</span><span class="o">]</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>在 SubCut 中，是讓需要被注入的元件庫，使用 implicit variable 的方式，從執行環境中帶入，然後直接讓
SomeService對整個 Module 做存取。</p>
<p>然而，因為 SubCut 的這一個缺陷，我個人是不用去使用 SubCut 的，這個缺點，在 Martin Fowler 文中被稱
做 <a class="reference external" href="http://martinfowler.com/articles/injection.html#ServiceLocatorVsDependencyInjection">Service Locator</a> ，使用 Service Locator Pattern 的缺點是，你把整個環境都傳給了需要被注入的物
件，讓物件自己在環境中去挖寶；這正好就把把 Inversion of Control 的拿交出的控制權又還給了物件本身；
除了去閱讀程式碼外，你無法單看 class constructor 就可以了解到，某一個物件到底是相依在那些元件之上。</p>
<p>好不容易爭來的控制權，又還了一大半回去</p>
</div>
<div class="section" id="reader-monad">
<h2>Reader Monad</h2>
<p>跳脫了從 OO 出發而來的 DI 方式， Runar Oli 在 Northeast Scala Symposium 2012上 ，提出了一個
純用 <a class="reference external" href="http://www.youtube.com/watch?v=ZasXwtTRkio">Functional Programming 的 DI 實作</a> (<a class="reference external" href="http://dl.dropbox.com/u/4588997/Runar-NEScala-DI.pdf">slides</a>)</p>
<p>Runar 用的例子是一個使用 JDBC 的範例</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">setUserPwd</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">               <span class="n">pwd</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">               <span class="n">c</span><span class="k">:</span> <span class="kt">Connection</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">stmt</span> <span class="k">=</span> <span class="n">c</span><span class="o">.</span><span class="n">prepareStatement</span><span class="o">(</span>
</span><span class="line">    <span class="s">&quot;update users set pwd = ? where id = ?&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="n">stmt</span><span class="o">.</span><span class="n">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">pwd</span><span class="o">)</span>
</span><span class="line">  <span class="n">stmt</span><span class="o">.</span><span class="n">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
</span><span class="line">  <span class="n">stmt</span><span class="o">.</span><span class="n">executeUpdate</span>
</span><span class="line">  <span class="n">stmt</span><span class="o">.</span><span class="n">close</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>上面的程式碼，我們可以用 Functional Way 改寫成底下的方式，讓 <cite>setUserPwd</cite> 改成
回傳一個 (Connection =&gt; Unit) 的函式，這個函式，收進一個 DB Connection 然後對
這個 Connection 做一些操作。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">setUserPwd</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">               <span class="n">pwd</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Connection</span> <span class="o">=&gt;</span> <span class="nc">Unit</span> <span class="k">=</span>
</span><span class="line">  <span class="n">c</span><span class="k">:</span> <span class="kt">Connection</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">stmt</span> <span class="k">=</span> <span class="n">c</span><span class="o">.</span><span class="n">prepareStatement</span><span class="o">(</span>
</span><span class="line">      <span class="s">&quot;update users set pwd = ? where id = ?&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">stmt</span><span class="o">.</span><span class="n">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">pwd</span><span class="o">)</span>
</span><span class="line">    <span class="n">stmt</span><span class="o">.</span><span class="n">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
</span><span class="line">    <span class="n">stmt</span><span class="o">.</span><span class="n">executeUpdate</span>
</span><span class="line">    <span class="n">stmt</span><span class="o">.</span><span class="n">close</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>接著，我們可以用一個 DB Monad 把所有 DB Operation 都抽像化，讓這些 DB Operation 可
以堆疊起來。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">g</span><span class="k">:</span> <span class="kt">Connection</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">Connection</span><span class="o">)</span> <span class="k">=</span> <span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
</span><span class="line">    <span class="nc">DB</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">)))</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">flatMap</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">DB</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
</span><span class="line">    <span class="nc">DB</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">))(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">pure</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span><span class="nc">DB</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="n">a</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">implicit</span> <span class="k">def</span> <span class="n">db</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">Connection</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">DB</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure><p>底下是堆疊起來的成果，透過 scala <a class="reference external" href="http://stackoverflow.com/questions/1052476/can-someone-explain-scalas-yield">for comprehension</a> 把 getUserPwd, setUserPwd 堆
疊起來，變成一個 changePwd method ，這一步步的把函式加成，符合了 Functional Programming 中
的 no side-effect ，在函式加成的過程中，我們並沒有去執行任何有 side effect 的呼叫，只是單純的
把函式加乘起來，等到最後再來選定執行環境。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">changePwd</span><span class="o">(</span><span class="n">userid</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">              <span class="n">oldPwd</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class="line">              <span class="n">newPwd</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span>
</span><span class="line"><span class="k">for</span> <span class="o">{</span>
</span><span class="line">  <span class="n">pwd</span> <span class="k">&lt;-</span> <span class="n">getUserPwd</span><span class="o">(</span><span class="n">userid</span><span class="o">)</span>
</span><span class="line">  <span class="n">eq</span> <span class="k">&lt;-</span> <span class="k">if</span> <span class="o">(</span><span class="n">pwd</span> <span class="o">==</span> <span class="n">oldPwd</span><span class="o">)</span> <span class="k">for</span> <span class="o">{</span>
</span><span class="line">          <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">setUserPwd</span><span class="o">(</span><span class="n">userid</span><span class="o">,</span> <span class="n">newPwd</span><span class="o">)</span>
</span><span class="line">        <span class="o">}</span> <span class="k">yield</span> <span class="kc">true</span>
</span><span class="line">        <span class="k">else</span> <span class="n">pure</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span> <span class="k">yield</span> <span class="n">eq</span>
</span></code></pre></td></tr></table></div></figure><p>那 DI 在這個 DB Monad 中要怎麼使用呢？</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">ConnProvider</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">mkProvider</span><span class="o">(</span><span class="n">driver</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">url</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">  <span class="k">new</span> <span class="nc">ConnProvider</span> <span class="o">{</span>
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">DB</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Class</span><span class="o">.</span><span class="n">forName</span><span class="o">(</span><span class="n">driver</span><span class="o">)</span>
</span><span class="line">      <span class="k">val</span> <span class="n">conn</span> <span class="k">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="n">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">      <span class="k">try</span> <span class="o">{</span> <span class="n">f</span><span class="o">(</span><span class="n">conn</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">      <span class="k">finally</span> <span class="o">{</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span> <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">lazy</span> <span class="k">val</span> <span class="n">sqliteTestDB</span> <span class="k">=</span>
</span><span class="line">  <span class="n">mkProvider</span><span class="o">(</span><span class="s">&quot;org.sqlite.JDBC&quot;</span><span class="o">,</span> <span class="s">&quot;jdbc:sqlite::memory:&quot;</span><span class="o">)</span>
</span><span class="line"><span class="k">lazy</span> <span class="k">val</span> <span class="n">mysqlProdDB</span> <span class="k">=</span>
</span><span class="line">  <span class="n">mkProvider</span><span class="o">(</span><span class="s">&quot;org.gjt.mm.mysql.Driver&quot;</span><span class="o">,</span>
</span><span class="line">    <span class="s">&quot;jdbc:mysql://prod:3306/?user=one&amp;password=two&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure><p>Runar 是把 DB Connection 的建立用 ConnProvider 抽像化，透過這樣，
我鍆可以簡單的定意兩種不同的執行環境，一組是 MySQL 另一組是測試用的 SQLite，</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">runInTest</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">ConnProvider</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span>
</span><span class="line">  <span class="n">f</span><span class="o">(</span><span class="n">sqliteTestDB</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">runInProduction</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">ConnProvider</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span>
</span><span class="line">  <span class="n">f</span><span class="o">(</span><span class="n">mysqlProdDB</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">myProgram</span><span class="o">(</span><span class="n">userid</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">ConnProvider</span> <span class="o">=&gt;</span> <span class="nc">Unit</span> <span class="k">=</span>
</span><span class="line">  <span class="n">r</span><span class="k">:</span> <span class="kt">ConnProvider</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;Enter old password&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">oldPwd</span> <span class="k">=</span> <span class="n">readLine</span>
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;Enter new password&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">newPwd</span> <span class="k">=</span> <span class="n">readLine</span>
</span><span class="line">    <span class="n">r</span><span class="o">(</span><span class="n">changePwd</span><span class="o">(</span><span class="n">userid</span><span class="o">,</span> <span class="n">oldPwd</span><span class="o">,</span> <span class="n">newPwd</span><span class="o">))</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">=</span>
</span><span class="line">  <span class="n">runInTest</span><span class="o">(</span><span class="n">myProgram</span><span class="o">(</span><span class="n">args</span><span class="o">(</span><span class="mi">0</span><span class="o">)))</span>
</span></code></pre></td></tr></table></div></figure><p>以上就是如何用 DB Monad 來達到 DB DI 的功用，這樣做的好處是</p>
<ul class="simple">
<li>Dead-simple. Just function composition.</li>
<li>Explicit, type-safe dependencies.</li>
<li>Lift any function.</li>
<li>No frameworks, annotations, or XML.</li>
<li>No initialization step.</li>
<li>Doesn’t rely on esoteric language features.</li>
</ul>
<div class="section" id="more-useful-monad">
<h3>More Useful Monad</h3>
<p>上面的 DB Monad ，只能對 DB 來做 DB ，然而，若是我們再多抽像化一層，把 DB Connection 變成
一個 <strong>type parameter</strong> ，那麼，我們就有一個 Reader Monad ，可以套用在許多不同應用上，
至於實際的用法， <a class="reference external" href="http://www.youtube.com/watch?v=ZasXwtTRkio">Runar 的演講</a> 有給一個範例，請大家移步去看。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">Reader</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">A</span><span class="o">](</span><span class="n">g</span><span class="k">:</span> <span class="kt">C</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">Reader._</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">C</span><span class="o">)</span> <span class="k">=</span> <span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">c</span><span class="k">:</span> <span class="kt">C</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">flatMap</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Reader</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">B</span><span class="o">]</span>  <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">c</span><span class="k">:</span> <span class="kt">C</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">(</span><span class="n">g</span><span class="o">(</span><span class="n">c</span><span class="o">))(</span><span class="n">c</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">Reader</span> <span class="o">{</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">def</span> <span class="n">reader</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Reader</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Reader</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
<div class="section" id="id5">
<h2>總結</h2>
<p>There is no silver bullet, choose your solution wisely.</p>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/22/migrate-to-octopress/">搬家到 Octopress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-22T04:31:00+08:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>把 Blog System 從 blogger.com 換成 Octopress ，用 reStructuredText 寫技術文件還是比較簡單。</p>
<p>轉換中，若文章顯示有問題，請到舊站 <a class="reference external" href="http://yunglinho.blogspot.com">http://yunglinho.blogspot.com</a> 看</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/20/lesson-learned-from-developing-locadz-sdk/">Lesson Learned Form Developing Locadz SDK</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-20T23:07:00+08:00" pubdate data-updated="true">Apr 20<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="section" id="introduction">
<h2>Introduction</h2>
<p>市面上大部份講 Android 的書，多數都是在講 API 要怎麼樣使用，但是，許多的書都沒有提到一個重要的問題，就是什
麼是 UI Thread (有時被稱做Main Thread) ，為什麼要有 UI Thread 以及為什麼不可以在 UI Thread 中執行耗時間的運算。</p>
<p>在本文中，我講談一談我們在開發Locadz SDK所使用到的一些技巧。</p>
</div>
<div class="section" id="ui-thread">
<h2>UI Thread</h2>
<p>UI Thread是Android(or other GUI library)用來處理 Event 的 thread ，這些 Event 可能是使用者處發的，如
Touch Event，或者是其它程式或者是系統底層的事件，如 Intent 或 <a class="reference external" href="http://developer.android.com/reference/android/location/LocationListener.html">Location Updates</a>.</p>
<p>在 UI Thread 處理完一個事件後， UI Thread 會重畫整個 Application ，而前面這句話解釋了處理 ANR 的兩個原則</p>
<ul class="simple">
<li>UI事件的處理要越快越好，在處理完前，UI不會有反應</li>
<li>UI的更新，一定要發生在UI Thread，要不然，要等到下次UI Event被處發時才會一併被處理</li>
</ul>
</div>
<div class="section" id="lesson-i-use-weakreference-to-avoid-strong-reference-and-memory-leak">
<h2>Lesson I: Use WeakReference to Avoid Strong Reference and Memory Leak</h2>
<p>有許多的文章談到如何用 <a class="reference external" href="http://developer.android.com/reference/android/os/AsyncTask.html">AsyncTask</a> 或 <a class="reference external" href="http://stackoverflow.com/questions/3197335/restful-api-service/3197456#3197456">ResultReceiver</a> 來把需要大量運算的程式，放在另一個 Thread 來做處理。</p>
<p>然而，這些範例都有著一個常備忽略的問題，那就是，這些 AsyncTask or ResultReceiver 常會把前景的Activity包進來
，如果說你的程式只有一個 Activity 的話，這或許不是什麼問題，但是若是你的 App 有多個畫面的話，這些在背景執行的程
式可能就會讓你的程式有 memory leak 的問題；如某家廣告商的 SDK 就有此問題。</p>
<p>一個可能的發生狀況是，Activity A透過 AsyncTask 去遠端下載一個圖片來顯示在 <em>Activity A</em> 之上，但因為某些因素
(如忘了設 connection timeout)，這個下載的程緒卡住了，既使 User 以從 <em>Activity A</em> 切換到 <em>Activity B</em> 之
上，這個 <em>Activity A</em> 還是不會被 GC 回收掉。</p>
<p>要避開因為有個 Strong Reference 造成 Activity 無法被回收的問題，我們在把有可能被回收的物件傳到另一個 Thread 中
被延後執行時，必需用 <a class="reference external" href="http://docs.oracle.com/javase/1.5.0/docs/api/java/lang/ref/WeakReference.html">WeakReference</a> 包住這個物件；如此一來，當Garbage Collector碰到一個已經不在前景的 Activity
時，Garbage Collector會把這物件處理掉，如此一來，就不會有 memory leak 的問題。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> *  AsyncTask to Load Image</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownloadImagesTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Uri</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Bitmap</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">imageview</span><span class="o">&gt;</span> <span class="n">imageViewWeakReference</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="nf">DownloadImagesTask</span><span class="o">(</span><span class="n">ImageView</span> <span class="n">imageView</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">imageViewWeakReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Imageview</span><span class="o">&gt;(</span><span class="n">imageView</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="n">Bitmap</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Uri</span><span class="o">...</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nf">downloadImage</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">ImageView</span> <span class="n">imageView</span> <span class="o">=</span> <span class="n">imageViewWeakReference</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">imageView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">imageView</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">downloadImage</span><span class="o">(</span><span class="n">Uri</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">     <span class="o">...</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="lesson-ii-use-intentservice-to-run-business-logic">
<h2>Lesson II: Use IntentService to Run Business Logic</h2>
<p>AsyncTask是 Android 最常被用來處理複雜運算時用的工具，透過AsyncTask，我們可以在背景處裡
一些複雜的運算，再把結果放回前景之上。</p>
<p>但據我的經驗，使用 AsyncTask 同時間來擔任 MVC 中的 View &amp; Controller 的工作，最後往往是
把程式碼弄成一團麵線。因此，在開發 Locadz SDK 時，我們把一些跟 UI 無關的運算，都切出來
變成 IntentService 或者是非 Inner class 的 AsyncTask ，把所有的運算邏輯從 Activity 中切出
來，增加重用的可能。</p>
<p>然後運算的結果，再透過 <a class="reference external" href="http://developer.android.com/reference/android/os/Handler.html#post(java.lang.Runnable)">getHandler().post(&#8230;)</a> 更新到 UI 之上.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/** Service that retrieve the ad unit allocations from external source and cache locally in SharedPreference. */</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdUnitAllocationService</span> <span class="kd">extends</span> <span class="n">IntentService</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CACHE_EXPIRATION_PERIOD</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span> <span class="c1">// 30 minutes.</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">PREFS_STRING_TIMESTAMP</span> <span class="o">=</span> <span class="s">&quot;timestamp&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">PREFS_STRING_CONFIG</span> <span class="o">=</span> <span class="s">&quot;config&quot;</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// response code for possible result.</span>
</span><span class="line">  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RESULT_OK</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="nf">AdUnitAllocationService</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">super</span><span class="o">(</span><span class="n">AdUnitAllocationService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onHandleIntent</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="n">AdUnitContext</span> <span class="n">adUnitContext</span> <span class="o">=</span>
</span><span class="line">     <span class="o">(</span><span class="n">AdUnitContext</span><span class="o">)</span> <span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_ADUNIT_CONTEXT</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="n">AdUnitAllocation</span> <span class="n">adUnitAllocation</span> <span class="o">=</span> <span class="n">getAdUnitAllocation</span><span class="o">(</span><span class="n">adUnitContext</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">adUnitAllocation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">Ration</span> <span class="n">ration</span> <span class="o">=</span> <span class="n">getRandomRation</span><span class="o">(</span><span class="n">adUnitAllocation</span><span class="o">.</span><span class="na">getRations</span><span class="o">());</span>
</span><span class="line">
</span><span class="line">      <span class="c1">// send response through ResultReceiver.</span>
</span><span class="line">      <span class="n">ResultReceiver</span> <span class="n">receiver</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_RECEIVER</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">      <span class="n">Bundle</span> <span class="n">resultData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bundle</span><span class="o">();</span>
</span><span class="line">      <span class="n">resultData</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_ADUNIT_ID</span><span class="o">,</span> <span class="n">adUnitContext</span><span class="o">.</span><span class="na">getAdUnitId</span><span class="o">());</span>
</span><span class="line">      <span class="n">resultData</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_RATION</span><span class="o">,</span> <span class="n">ration</span><span class="o">);</span>
</span><span class="line">      <span class="n">resultData</span><span class="o">.</span><span class="na">putSerializable</span><span class="o">(</span><span class="n">IntentConstants</span><span class="o">.</span><span class="na">EXTRA_EXTRA</span><span class="o">,</span>
</span><span class="line">                                 <span class="n">adUnitAllocation</span><span class="o">.</span><span class="na">getExtra</span><span class="o">());</span>
</span><span class="line">
</span><span class="line">      <span class="n">receiver</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">RESULT_OK</span><span class="o">,</span> <span class="n">resultData</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Select a random ration form the provided rations.</span>
</span><span class="line"><span class="cm">   * @param rations   the candidates.</span>
</span><span class="line"><span class="cm">   * @return a random ration from the candidates.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">Ration</span> <span class="nf">getRandomRation</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Ration</span><span class="o">&gt;</span> <span class="n">rations</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">//...</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Get the allocation configuration for the adunit.</span>
</span><span class="line"><span class="cm">   * @param adUnitContext the context of the adunit.</span>
</span><span class="line"><span class="cm">   * @return the allocation configuration for the adunit.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="n">AdUnitAllocation</span> <span class="nf">getAdUnitAllocation</span><span class="o">(</span><span class="n">AdUnitContext</span> <span class="n">adUnitContext</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">//...</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="lesson-iii-use-disk-cache-instead-of-main-memory-cache">
<h2>Lesson III: Use Disk Cache instead of (Main) Memory Cache</h2>
<p>底下的圖表，是Jeff Dean發表的，在談的是讀取資料的的效率，我們把這幾個數字先記起來，
再加一個代表UI設計時人體覺得是即時反應的反應時間上限 100 ms。然後我們再來談 Android UI 的設計。</p>
<img alt="/images/2012-04-20/numbers-everyone-should-know.png" src="/images/2012-04-20/numbers-everyone-should-know.png" />
<p>大家可以看到 Main Memory Reference(0.001ms) 與 Disk Seek(10ms) Disk Read(30ms) 的重大差
距，然而，後者的數字在 Mobile Phone 上就不是這樣了。在 Mobile Phone 上，傳統的硬碟扮演的角色，
被NAND Flash Memory, External SD Card所取代了。在存取效率上 NAND Flash Memory 雖然不
比 RAM 快，但是，也仍是 seek time ~1ms 的狠角色。</p>
<p>這 1ms 的負擔，雖比 0.001ms 的負擔高上百倍，以上，但是在 100ms 這UI 反應需求上，卻又變得很渺小了。</p>
<p>因此，在這邊，我會建議大家，若是有 cache 的需求時，直接往 <a class="reference external" href="http://developer.android.com/guide/topics/data/data-storage.html#filesInternal">Internal Storage</a> 塞吧，不要放
在Main memory上，或用個SoftReferenceMap包著。</p>
</div>
<div class="section" id="lesson-iv-make-all-public-method-async-to-avoid-ui-update-issue">
<h2>Lesson IV: Make All Public Method Async to Avoid UI Update Issue</h2>
<p>在上面第一個範例中有個錯誤，那就是DownloadImagesTask.onPostExecute()會在呼叫DownloadImagesTask.execute(&#8230;)的
那個 Thread 上執行，如果說，很不幸的，這個 DownloadImagesTask 並不是從 UI Thread 上來呼叫的話，那
麼，imageView.setImageBitmap(result)便有可能不會即時更新到UI之上。</p>
<p>如果你的開發環境會有這種問題，在包在層層呼叫後，無法確保 Method 是否是在 UI Thread 上執行；那麼我
會建議你把會更新 UI 的 Method ，標成 protected ，然後開放一個 public async method 出來，範例如下：</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm">  * Remove old ad views and push the new one.</span>
</span><span class="line"><span class="cm">  *</span>
</span><span class="line"><span class="cm">  * @param subView the adview to push.</span>
</span><span class="line"><span class="cm">  */</span>
</span><span class="line"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">pushSubView</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">subView</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="c1">//....</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> *  submit a push view request to Android&#39;s handler. This will remove</span>
</span><span class="line"><span class="cm"> *  old ad view and push a new one to this layout asynchronously.</span>
</span><span class="line"><span class="cm"> *</span>
</span><span class="line"><span class="cm"> * @param subView   the adview to push.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">submitPushSubViewRequest</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">subView</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Scheduled pushSubView(%s)&quot;</span><span class="o">,</span> <span class="n">subView</span><span class="o">));</span>
</span><span class="line">  <span class="n">getHandler</span><span class="o">().</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">ViewAdRunnable</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">subView</span><span class="o">));</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Runnable runs on the Main Thread that pushes an AdView to the layout.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ViewAdRunnable</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Adunitlayout</span><span class="o">&gt;</span> <span class="n">locadzLayoutWeakReference</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">private</span> <span class="n">ViewGroup</span> <span class="n">subView</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kd">public</span> <span class="nf">ViewAdRunnable</span><span class="o">(</span><span class="n">AdUnitLayout</span> <span class="n">layout</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">subView</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">locadzLayoutWeakReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Adunitlayout</span><span class="o">&gt;(</span><span class="n">layout</span><span class="o">);</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">subView</span> <span class="o">=</span> <span class="n">subView</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">AdUnitLayout</span> <span class="n">locadzLayout</span> <span class="o">=</span> <span class="n">locadzLayoutWeakReference</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">locadzLayout</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">locadzLayout</span><span class="o">.</span><span class="na">pushSubView</span><span class="o">(</span><span class="n">subView</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/18/">成本降就該降售價嗎？</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-18T01:01:00+08:00" pubdate data-updated="true">Apr 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><!--
  ~ Copyright (c) 2012. Blue Tang Studio LLC. All rights reserved.
  -->

<div class='post'>
台灣媒體從業人員笨死了，成天在媒體上獵女巫，檢討別人的成本結構；殊不知，(除了原物料必需品外)，售價是由供需曲線決定的，而不是由成本所決定的，成本，只決定是否有業者會提供某項產品。<br /><br />媒體成天講什麼，稅金降所以該降價，成本漲所以物價漲，全民的腦力都浪費在幫別人算成本，而不是幫自己開創新產品。<br /><br />講多了，全民都變笨了。而且還偏好用名牌，漲價時不會去選用替代品，只會忙著叫龍頭降價，問題是，你越愛用，龍頭業者越有調漲的本錢。<br /><br />最近年紀到了，開始準備生小孩，就開始頭痛未來教育問題，不知道怎麼幫他規劃如何活在這塊土地上，而不被一些錯誤的觀念所誤導呢？﻿<br /><br />還是說，我又該離鄉背景工作個幾年，幫小孩弄個外國籍，未來送到台北歐洲學校或日僑學校去(美僑學校已經招生爆炸，只收父母都是美國人的小孩了)</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/27/-service-how-to-debian-ize-your-web-application/">[Service上線前你該知道的事]How to Debian-ize Your Web Application.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-27T23:19:00+08:00" pubdate data-updated="true">Mar 27<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
在布建一個Web Application時，用.war來佈屬服務，算是最沒有效率的一種方式，因為，這樣無法把web container所需要的設定檔一起佈建出去，同時，也無法板本控製你的應用程式；本文接下來會敘述，如何用maven & jetty & debian來佈屬你的Web Application。<br /><br />首先，先講講我的需求，我的需求如下<br /><ul><li>Web Application的版本必需能夠簡單被管理，要能簡單的就知道目前安裝的版本，並且輕鬆的昇級到新版</li><li>Web Application被佈建時，要連Web Container及設定擋包在一起</li><li>Debian Box開關機時，要能自動開關Web Container</li></ul><br />這些需求，我是靠 unix-maven-plugin ，幫我把我的 web application 包成一個 .deb 來做到的，包成 .deb 的好處是，在 debian 上可以簡單的安裝，若是公司有架 debian package repository, 那麼，打個 apt-get install <app> 就可以安裝或昇級到最新版，同時間，可以透過 debian 安裝的機制，來把些 script 掛入 rc.*<br /><br />由於 unix-maven-plugin 已被原作者遺棄，所以需要從 <a href="https://github.com/yunglin/unix-maven-plugin">github</a>下載並安裝後人修改過的版本。<br /><br />然後依<a href="#appendix">附錄</a>的方式，增修你的設定檔，需要增修的檔案有<br /><ul><li>pom.xml: 加入 unix-maven-plugin 及服務的名稱及PORT</li><li>src/main/unix/resources/default/${service.user} : 給 jetty 用的 default 設定值，在這邊你可以修改 JAVA_OPTIONS 及 NO_START</li><li>src/main/unix/resources/etc/jetty.conf</li><li>src/main/unix/resources/etc/start.conf</li><li>src/main/unix/resources/scripts/${service.user} : 給 debian 用的 init script</li><li>src/main/unix/resources/scripts/post-install post-remove pre-install pre-remove : debian 在安裝及昇級 .deb 時會跑的 script</li></ul><br />將這些檔案設定好後，在 debian 的機器上打 mvn package deploy ,就可以自動生成 .deb 的檔案，並且上傳到你的 maven repository 上去，如果貴公司有架 debian package repository　的話，還可以加一段程式碼把 .deb 傳到 debian package repository 去。<br /><br />接著，打 dpkg -i xxxx.deb 就可以把你的 web application 當成一個 debian service 安裝到你的 debain machine 上去。<br /><br />查詢目前安裝的板本則是打 dpkg -l xxxx 即可<br /><br /><pre class="brush: shell;">||/ Name           Version        Description<br />+++-==============-==============-============================================<br />ii  backend       1.2.0-20120327.143115          backend<br /></pre><br /><br /><a name="appendix"><h3>附錄</h3></a><br /><br />把底下的這段，加入你的 pom.xml <br /><br /><pre class="brush: xml;"><project xmlns="http://maven.apache.org/POM/4.0.0" <br />         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" <br />         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0<br />         http://maven.apache.org/xsd/maven-4.0.0.xsd"><br />  <modelversion>4.0.0</modelVersion><br />  <groupid>com.locadz</groupId><br />  <artifactid>backend</artifactId><br />  <packaging>war</packaging><br />  <description>backend</description><br />  <version>1.2.0-SNAPSHOT</version><br />  <name>backend</name><br />  <properties><br />    <version.maven.unix.plugin>1.0-alpha-6.1</version.maven.unix.plugin><br />    <version.jetty>7.4.5.v20110725</version.jetty><br /><br />    <service.name>Locadz Backend</service.name><br />    <service.home>/var/lib/bluetang/locadz-backend</service.home><br />    <service.user>locadz-backend</service.user><br />    <service.port>9080</service.port><br />  </properties><br />  <profiles><br />    <profile><br />      <id>debian-package</id><br />      <activation><br />        <os><br />          <family>unix</family><br />          <name>linux</name><br />        </os><br />      </activation><br />      <build><br />        <plugins><br />          <plugin><br />            <artifactid>maven-resources-plugin</artifactId><br />            <version>2.5</version><br />            <executions><br />              <execution><br />                <id>copy-resources</id><br />                <!-- here the phase you need --><br />                <phase>process-resources</phase><br />                <goals><br />                  <goal>copy-resources</goal><br />                </goals><br />                <configuration><br />                  <outputdirectory>${basedir}/target</outputDirectory><br />                  <resources><br />                    <resource><br />                      <directory>src/main/unix</directory><br />                      <targetpath>unix</targetPath><br />                      <includes><br />                        <include>**/*</include><br />                      </includes><br />                      <filtering>true</filtering><br />                    </resource><br />                  </resources><br />                </configuration><br />              </execution><br />            </executions><br />          </plugin><br /><br />          <!-- build .deb --><br />          <plugin><br />            <groupid>org.mortbay.jetty.toolchain</groupId><br />            <artifactid>unix-maven-plugin</artifactId><br />            <version>${version.maven.unix.plugin}</version><br />            <extensions>true</extensions><br />            <executions><br />              <execution><br />                <phase>package</phase><br />                <goals><br />                  <goal>package-deb-attached</goal><br />                </goals><br />              </execution><br />            </executions><br />            <configuration><br />              <!-- debug mode should be always enable on this plugin. cause the info it<br />                  provided is not sufficient when things goes wrong. Also, it does not<br />                  take the maven standard debug flag '-X'.<br />              --><br />              <debug>true</debug><br />              <contact>yho@bluetangstudio.com</contact><br />              <contactemail>yho@bluetangstudio.com</contactEmail><br />              <defaults><br />                <fileattributes><br />                  <user>${service.user}</user><br />                  <group>adm</group><br />                </fileAttributes><br />                <directoryattributes><br />                  <user>${service.user}</user><br />                  <group>adm</group><br />                </directoryAttributes><br />              </defaults><br />              <deb><br />                <section>bluetang</section><br />                <priority>extra</priority><br />              </deb><br />              <assembly><br /><br />                <!-- extract jetty first --><br />                <extract-artifact><br />                  <artifact>org.eclipse.jetty:jetty-distribution:zip</artifact><br />                  <to>${service.home}</to><br />                  <pattern>/jetty-distribution-${version.jetty}(.*)</pattern><br />                  <replacement>$1</replacement><br />                  <excludes><br />                    <!-- Exclude all default contexts and web application, no need for them --><br />                    <exclude>*/contexts/**</exclude><br />                    <exclude>*/contexts-available/**</exclude><br />                    <exclude>*/webapps/**</exclude><br />                    <exclude>*/javadoc/**</exclude><br />                    <exclude>*/LICENSES/**</exclude><br />                    <exclude>*/logs/**</exclude><br />                    <exclude>**/win32/**</exclude><br />                  </excludes><br />                </extract-artifact><br />                <!-- put war file on the top of jetty --><br />                <copyfile><br />                  <path>${project.build.directory}/${project.build.finalName}.${project.packaging}<br />                  </path><br />                  <tofile>${service.home}/webapps/ROOT.war</toFile><br />                </copyFile><br />                <copyfile><br />                  <path>${basedir}/target/unix/resources/default/${service.user}</path><br />                  <todir>/etc/default</toDir><br />                </copyFile><br />                <copydirectory><br />                  <from>${basedir}/target/unix/resources/etc</from><br />                  <to>/etc/bluetang/${service.user}</to><br />                </copyDirectory><br />                <copyfile><br />                  <path>${basedir}/target/unix/scripts/${service.user}</path><br />                  <todir>/etc/init.d</toDir><br />                  <attributes><br />                    <mode>0754</mode><br />                    <user>${service.user}</user><br />                    <group>admin</group><br />                  </attributes><br />                </copyFile><br />              </assembly><br />            </configuration><br />          </plugin><br />        </plugins><br />      </build><br /><br />    </profile><br />  </profiles><br /><br />  <dependencies><br />    <!-- because of a bug in unix-maven-plugin, it can not pickup dependency from<br />                   plguin-dependencies. As a result, we put jetty-distribution here.<br />            --><br />    <dependency><br />      <groupid>org.eclipse.jetty</groupId><br />      <artifactid>jetty-distribution</artifactId><br />      <version>${version.jetty}</version><br />      <type>zip</type><br />      <!-- SC-57: dirty hack to excludes all child dependencies --><br />      <exclusions><br />        <exclusion><br />          <groupid>*</groupId><br />          <artifactid>*</artifactId><br />        </exclusion><br />      </exclusions><br />    </dependency><br />  </dependencies><br /></project><br /></pre><br />然後把下面這塊存成 src/main/unix/resources/default/${service.user}<br /><br /><pre class="brush: shell;"># Defaults for jetty see /etc/${service.user}/jetty for more<br /><br /># change to 0 to allow Jetty to start<br />NO_START=0<br /><br /># change to 'no' or uncomment to use the default setting in /etc/default/rcS<br />VERBOSE=yes<br /><br /># Run Jetty as this user ID (default: jetty)<br /># Set this to an empty string to prevent Jetty from starting automatically<br />JETTY_USER=${service.user}<br /><br /># Listen to connections from this network host<br /># Use 0.0.0.0 as host to accept all connections.<br /># Uncomment to restrict access to localhost<br />#JETTY_HOST=$(uname -n)<br />JETTY_HOST=0.0.0.0<br /><br /># The network port used by Jetty<br />JETTY_PORT=${service.port}<br /><br /># Timeout in seconds for the shutdown of all webapps<br />#JETTY_SHUTDOWN=30<br /><br /># Additional arguments to pass to Jetty<br />#JETTY_ARGS=<br /><br /># Extra options to pass to the JVM<br />JAVA_OPTIONS="-Xmx256m -Djava.awt.headless=true -Duser.timezone=UTC"<br /><br /># Home of Java installation.<br />#JAVA_HOME=<br /><br /># The first existing directory is used for JAVA_HOME (if JAVA_HOME is not<br /># defined in /etc/default/jetty). Should contain a list of space separated directories.<br />#JDK_DIRS="/usr/lib/jvm/default-java /usr/lib/jvm/java-6-sun"<br /><br /># Java compiler to use for translating JavaServer Pages (JSPs). You can use all<br /># compilers that are accepted by Ant's build.compiler property.<br />#JSP_COMPILER=jikes<br /><br /># Jetty uses a directory to store temporary files like unpacked webapps<br />JETTY_TMP=/var/cache/bluetang/jetty<br /><br /># Jetty uses a config file to setup its boot classpath<br />JETTY_START_CONFIG=/etc/bluetang/${service.user}/start.config<br /><br /># Default for number of days to keep old log files in /var/log/jetty/<br />#LOGFILE_DAYS=14<br /></pre><br /><br />然後把下面這塊存成 src/main/unix/resources/ect/jetty.conf<br /><br /><pre class="brush: shell;"># list of jetty configuration and property files<br />/var/lib/bluetang/${service.user}/etc/jetty-logging.xml<br /></pre><br /><br />然後把下面這塊存成 src/main/unix/resources/etc/start.conf<br /><br /><pre class="brush: shell;"># This file controls what file are to be put on classpath or command line.<br />#<br /># Format is as follows:<br /># Each line contains entry for one JAR file.<br /># Format of line:<br />#<br />#  SUBJECT [ [!] CONDITION [AND|OR] ]*<br />#<br /># where SUBJECT:<br />#   ends with ".class" is the Main class to run.<br />#   ends with ".xml" is a configuration file for the command line<br />#   ends with "/" is a directory from which to add all jar and zip files.<br />#   ends with "/*" is a directory from which to add all unconsidered jar and zip files.<br />#   ends with "/**" is a directory from which to recursively add all unconsidered jar and zip files.<br />#   Containing = are used to assign system properties.<br />#   all other subjects are treated as files to be added to the classpath.<br />#<br /># Subjects may include system properties with $(propertyname) syntax.<br />#<br /># Files starting with "/" are considered absolute, all others are relative to<br /># the home directory.<br />#<br /># CONDITION is one of:<br />#   always<br />#   never<br />#   available classname        # true if class on classpath<br />#   property name              # true of set<br />#   java OPERATOR version      # java version compared to literal<br />#   nargs OPERATOR number      # number of command line args compared to literal<br />#   OPERATOR := one of "<",">","<=",">=","==","!="<br />#<br /># CONDITIONS can be combined with AND OR or !, with AND being the assume<br /># operator for a list of CONDITIONS.<br /># Classpath operations are evaluated on the fly, so once a class or jar is<br /># added to the classpath, subsequent available conditions will see that class.<br />#<br /><br />$(jetty.class.path)                              always<br />$(jetty.lib)/**                                  exists $(jetty.lib)<br /><br />jetty.home=/var/lib/bluetang/${service.user}                      always<br /><br /># The main class to run<br />org.mortbay.xml.XmlConfiguration.class<br /><br /># The default configuration files<br />$(jetty.home)/etc/jetty.xml                      nargs == 0<br /><br />/usr/share/java/servlet-api-2.5.jar<br />/usr/share/java/slf4j-api.jar<br /><br /># Optional stuff for libjetty-extra-java<br />/usr/share/java/gnumail.jar<br />/usr/share/java/activation.jar<br />/usr/share/java/ant.jar<br /><br /># Set the jetty classpath<br />/usr/share/jetty/lib/**<br /><br /># Add a resources directory if it is there<br />$(jetty.home)/resources/<br /><br /></pre><br /><br /><br />然後把下面這塊存成 src/main/unix/scripts/${service.user}<br /><br /><pre class="brush: shell;">#!/bin/bash  <br />### BEGIN INIT INFO<br /># Provides:          ${service.user}<br /># Required-Start:<br /># Required-Stop:<br /># Default-Start:     2 3 4 5<br /># Default-Stop:      0 1 6<br /># Short-Description: Start daemon at boot time<br /># Description:       Enable service provided by daemon.<br />### END INIT INFO<br />#<br /># Startup script for jetty under *nix systems (it works under NT/cygwin too).<br />#<br /># Configuration files<br />#<br /># /etc/default/${service.user}<br />#   If it exists, this is read at the start of script. It may perform any <br />#   sequence of shell commands, like setting relevant environment variables.<br />#<br /># /etc/bluetang/${service.user}/jetty.conf<br />#   If found, and no configurations were given on the command line,<br />#   the file will be used as this script's configuration. <br />#   Each line in the file may contain:<br />#     - A comment denoted by the pound (#) sign as first non-blank character.<br />#     - The path to a regular file, which will be passed to jetty as a <br />#       config.xml file.<br />#     - The path to a directory. Each *.xml file in the directory will be<br />#       passed to jetty as a config.xml file.<br />#<br />#   The files will be checked for existence before being passed to jetty.<br />#<br /># $JETTY_HOME/etc/jetty.xml<br />#   If found, used as this script's configuration file, but only if<br />#   /etc/bluetang/${service.user}/jetty.conf was not present. See above.<br />#   <br /># Configuration variables<br />#<br /># JAVA<br />#   Command to invoke Java. If not set, java (from the PATH) will be used.<br />#<br /># JAVA_OPTIONS<br />#   Extra options to pass to the JVM<br />#<br /># JETTY_HOME<br />#   Where Jetty is installed. If not set, the script will try go<br />#   guess it by first looking at the invocation path for the script,<br />#   and then by looking in standard locations as $HOME/opt/jetty<br />#   and /opt/jetty. The java system property "jetty.home" will be<br />#   set to this value for use by configure.xml files, f.e.:<br />#<br />#    <arg><systemproperty name="jetty.home" default="."/>/webapps/jetty.war</Arg><br />#<br /># JETTY_PORT<br />#   Override the default port for Jetty servers. If not set then the<br />#   default value in the xml configuration file will be used. The java<br />#   system property "jetty.port" will be set to this value for use in<br />#   configure.xml files. For example, the following idiom is widely<br />#   used in the demo config files to respect this property in Listener<br />#   configuration elements:<br />#<br />#    <set name="Port"><systemproperty name="jetty.port" default="8080"/></Set><br />#<br />#   Note: that the config file could ignore this property simply by saying:<br />#<br />#    <set name="Port">8080</Set><br />#<br /># JETTY_RUN<br />#   Where the jetty.pid file should be stored. It defaults to the<br />#   first available of /var/run, /usr/var/run, and /tmp if not set.<br />#  <br /># JETTY_PID<br />#   The Jetty PID file, defaults to $JETTY_RUN/jetty.pid<br />#   <br /># JETTY_ARGS<br />#   The default arguments to pass to jetty.<br />#<br /># JETTY_USER<br />#   if set, then used as a username to run the server as<br />#<br />JETTY_HOME=${service.home}<br />JETTY_USER=${service.user}<br />JETTY_PID=$JETTY_RUN/${service.user}.pid<br />usage()<br />{<br />    echo "Usage: ${0##*/} [-d] {start|stop|run|restart|check|supervise} [ CONFIGS ... ] "<br />    exit 1<br />}<br /><br />[ $# -gt 0 ] || usage<br /><br /><br />##################################################<br /># Some utility functions<br />##################################################<br />findDirectory()<br />{<br />  local L OP=$1<br />  shift<br />  for L in "$@"; do<br />    [ "$OP" "$L" ] || continue<br />    printf %s "$L"<br />    break<br />  done<br />}<br /><br />running()<br />{<br />  local PID=$(cat "$1" 2>/dev/null) || return 1<br />  kill -0 "$PID" 2>/dev/null<br />}<br /><br />readConfig()<br />{<br />  (( DEBUG )) && echo "Reading $1.."<br />  source "$1"<br />}<br /><br /><br /><br />##################################################<br /># Get the action & configs<br />##################################################<br />CONFIGS=()<br />NO_START=0<br />DEBUG=0<br /><br />while [[ $1 = -* ]]; do<br />  case $1 in<br />    -d) DEBUG=1 ;;<br />  esac<br />  shift<br />done<br />ACTION=$1<br />shift<br /><br />##################################################<br /># See if there's a default configuration file<br />##################################################<br />if [ -f /etc/default/${service.user} ] ; then<br />  . /etc/default/${service.user}<br />fi<br /><br /><br />##################################################<br /># Set tmp if not already set.<br />##################################################<br />TMPDIR=${TMPDIR:-/tmp}<br /><br />##################################################<br /># Jetty's hallmark<br />##################################################<br />JETTY_INSTALL_TRACE_FILE="etc/jetty.xml"<br /><br /><br />##################################################<br /># Try to determine JETTY_HOME if not set<br />##################################################<br />if [ -z "$JETTY_HOME" ] <br />then<br />  JETTY_SH=$0<br />  case "$JETTY_SH" in<br />    /*)   ;;<br />    ./*)  ;;<br />    *)    JETTY_SH=./$JETTY_SH ;;<br />  esac<br />  JETTY_HOME=${JETTY_SH%/*/*}<br /><br />  if [ ! -f "${JETTY_SH%/*/*}/$JETTY_INSTALL_TRACE_FILE" ]<br />  then<br />    JETTY_HOME=<br />  fi<br />fi<br /><br /><br /><br />##################################################<br /># if no JETTY_HOME, search likely locations.<br />##################################################<br />if [ -z "$JETTY_HOME" ] ; then<br />  STANDARD_LOCATIONS=(<br />        "/usr/share"<br />        "/usr/share/java"<br />        "${HOME}"<br />        "${HOME}/src"<br />        "${HOME}/opt"<br />        "/opt"<br />        "/java"<br />        "/usr/local"<br />        "/usr/local/share"<br />        "/usr/local/share/java"<br />        "/home"<br />        )<br />  JETTY_DIR_NAMES=(<br />        "jetty-7"<br />        "jetty7"<br />        "jetty-7.*"<br />        "jetty"<br />        "Jetty-7"<br />        "Jetty7"<br />        "Jetty-7.*"<br />        "Jetty"<br />        )<br /><br />  for L in "${STANDARD_LOCATIONS[@]}"<br />  do<br />    for N in "${JETTY_DIR_NAMES[@]}"<br />    do<br />      POSSIBLE_JETTY_HOME=("$L/"$N)<br />      if [ ! -d "$POSSIBLE_JETTY_HOME" ]<br />      then<br />        # Not a directory. skip.<br />        unset POSSIBLE_JETTY_HOME<br />      elif [ ! -f "$POSSIBLE_JETTY_HOME/$JETTY_INSTALL_TRACE_FILE" ]<br />      then<br />        # Trace file not found. skip.<br />        unset POSSIBLE_JETTY_HOME<br />      else<br />        # Good hit, Use it<br />        JETTY_HOME=$POSSIBLE_JETTY_HOME<br />        # Break out of JETTY_DIR_NAMES loop<br />        break<br />      fi<br />    done<br />    if [ -n "$POSSIBLE_JETTY_HOME" ]<br />    then<br />      # We have found our JETTY_HOME<br />      # Break out of STANDARD_LOCATIONS loop<br />      break<br />    fi<br />  done<br />fi<br /><br /><br />##################################################<br /># No JETTY_HOME yet? We're out of luck!<br />##################################################<br />if [ -z "$JETTY_HOME" ]; then<br />  echo "** ERROR: JETTY_HOME not set, you need to set it or install in a standard location"<br />  exit 1<br />fi<br /><br />cd "$JETTY_HOME"<br />JETTY_HOME=$PWD<br /><br /><br />#####################################################<br /># Check that jetty is where we think it is<br />#####################################################<br />if [ ! -r "$JETTY_HOME/$JETTY_INSTALL_TRACE_FILE" ]<br />then<br />  echo "** ERROR: Oops! Jetty doesn't appear to be installed in $JETTY_HOME"<br />  echo "** ERROR:  $JETTY_HOME/$JETTY_INSTALL_TRACE_FILE is not readable!"<br />  exit 1<br />fi<br /><br />##################################################<br /># Try to find this script's configuration file,<br /># but only if no configurations were given on the<br /># command line.<br />##################################################<br />if [ -z "$JETTY_CONF" ] <br />then<br />  if [ -f /etc/bluetang/${service.user}/jetty.conf ]<br />  then<br />     JETTY_CONF=/etc/bluetang/${service.user}/jetty.conf<br />  elif [ -f "${JETTY_HOME}/etc/jetty.conf" ]<br />  then<br />     JETTY_CONF="${JETTY_HOME}/etc/jetty.conf"<br />  fi<br />fi<br /><br />##################################################<br /># Get the list of config.xml files from jetty.conf<br />##################################################<br />if [ -z "$CONFIGS" ] && [ -f "$JETTY_CONF" ] && [ -r "$JETTY_CONF" ]<br />then<br />  while read -r CONF<br />  do<br />    if expr "$CONF" : '#' >/dev/null ; then<br />      continue<br />    fi<br /><br />    if [ -d "$CONF" ]<br />    then<br />      # assume it's a directory with configure.xml files<br />      # for example: /etc/jetty.d/<br />      # sort the files before adding them to the list of CONFIGS<br />      for file in "$CONF/"*.xml<br />      do<br />        if [ -r "$FILE" ] && [ -f "$FILE" ]<br />        then<br />          CONFIGS+=("$FILE")<br />        else<br />          echo "** WARNING: Cannot read '$FILE' specified in '$JETTY_CONF'"<br />        fi<br />      done<br />    else<br />      # assume it's a command line parameter (let start.jar deal with its validity)<br />      CONFIGS+=("$CONF")<br />    fi<br />  done < "$JETTY_CONF"<br />fi<br /><br />#####################################################<br /># Find a location for the pid file<br />#####################################################<br />if [ -z "$JETTY_RUN" ]<br />then<br />  JETTY_RUN=$(findDirectory -w /var/run /usr/var/run /tmp)<br />fi<br /><br />#####################################################<br /># Find a PID for the pid file<br />#####################################################<br />if [ -z "$JETTY_PID" ]<br />then<br />  JETTY_PID="$JETTY_RUN/jetty.pid"<br />fi<br /><br />##################################################<br /># Setup JAVA if unset<br />##################################################<br />if [ -z "$JAVA" ]<br />then<br />  JAVA=$(which java)<br />fi<br /><br />if [ -z "$JAVA" ]<br />then<br />  echo "Cannot find a Java JDK. Please set either set JAVA or put java (>=1.5) in your PATH." 2>&2<br />  exit 1<br />fi<br /><br />#####################################################<br /># See if JETTY_PORT is defined<br />#####################################################<br />if [ "$JETTY_PORT" ]<br />then<br />  JAVA_OPTIONS+=("-Djetty.port=$JETTY_PORT")<br />fi<br /><br />#####################################################<br /># See if JETTY_LOGS is defined<br />#####################################################<br />if [ "$JETTY_LOGS" ]<br />then<br />  JAVA_OPTIONS+=("-Djetty.logs=$JETTY_LOGS")<br />fi<br /><br />#####################################################<br /># Are we running on Windows? Could be, with Cygwin/NT.<br />#####################################################<br />case "`uname`" in<br />CYGWIN*) PATH_SEPARATOR=";";;<br />*) PATH_SEPARATOR=":";;<br />esac<br /><br /><br />#####################################################<br /># Add jetty properties to Java VM options.<br />#####################################################<br />JAVA_OPTIONS+=("-Djetty.home=$JETTY_HOME" "-Djava.io.tmpdir=$TMPDIR")<br /><br />[ -f "$JETTY_HOME/etc/start.config" ] && JAVA_OPTIONS=("-DSTART=$JETTY_HOME/etc/start.config" "${JAVA_OPTIONS[@]}")<br /><br />#####################################################<br /># This is how the Jetty server will be started<br />#####################################################<br /><br />JETTY_START=$JETTY_HOME/start.jar<br />[ ! -f "$JETTY_START" ] && JETTY_START=$JETTY_HOME/lib/start.jar<br /><br />START_INI=$(dirname $JETTY_START)/start.ini<br />[ -r "$START_INI" ] || START_INI=""<br /><br />RUN_ARGS=(${JAVA_OPTIONS[@]} -jar "$JETTY_START" $JETTY_ARGS "${CONFIGS[@]}")<br />RUN_CMD=("$JAVA" ${RUN_ARGS[@]})<br /><br />#####################################################<br /># Comment these out after you're happy with what <br /># the script is doing.<br />#####################################################<br />if (( DEBUG ))<br />then<br />  echo "JETTY_HOME     =  $JETTY_HOME"<br />  echo "JETTY_CONF     =  $JETTY_CONF"<br />  echo "JETTY_RUN      =  $JETTY_RUN"<br />  echo "JETTY_PID      =  $JETTY_PID"<br />  echo "JETTY_ARGS     =  $JETTY_ARGS"<br />  echo "CONFIGS        =  ${CONFIGS[*]}"<br />  echo "JAVA_OPTIONS   =  ${JAVA_OPTIONS[*]}"<br />  echo "JAVA           =  $JAVA"<br />  echo "RUN_CMD        =  ${RUN_CMD}"<br />fi<br /><br />##################################################<br /># Do the action<br />##################################################<br />case "$ACTION" in<br />  start)<br />    echo -n "Starting ${service.name}: "<br /><br />    if (( NO_START )); then<br />      echo "Not starting ${service.user} - NO_START=1";<br />      exit<br />    fi<br /><br /><br />    if type start-stop-daemon > /dev/null 2>&1<br />    then<br />      unset CH_USER<br />      if [ -n "$JETTY_USER" ]<br />      then<br />        CH_USER="-c$JETTY_USER"<br />      fi<br />      if start-stop-daemon -S -p"$JETTY_PID" $CH_USER -d"$JETTY_HOME" -b -m -a "$JAVA" -- "${RUN_ARGS[@]}" --daemon<br />      then<br />        sleep 1<br />        if running "$JETTY_PID"<br />        then<br />          echo "OK"<br />        else<br />          echo "FAILED"<br />        fi<br />      fi<br /><br />    else<br /><br />      if [ -f "$JETTY_PID" ]<br />      then<br />        if running $JETTY_PID<br />        then<br />          echo "Already Running!"<br />          exit 1<br />        else<br />          # dead pid file - remove<br />          rm -f "$JETTY_PID"<br />        fi<br />      fi<br /><br />      if [ "$JETTY_USER" ]<br />      then<br />        touch "$JETTY_PID"<br />        chown "$JETTY_USER" "$JETTY_PID"<br />        # FIXME: Broken solution: wordsplitting, pathname expansion, arbitrary command execution, etc.<br />        su - "$JETTY_USER" -c "<br />          ${RUN_CMD[*]} --daemon &<br />          disown \$!<br />          echo \$! > '$JETTY_PID'"<br />      else<br />        "${RUN_CMD[@]}" &<br />        disown $!<br />        echo $! > "$JETTY_PID"<br />      fi<br /><br />      echo "STARTED ${service.name} `date`"<br />    fi<br /><br />    ;;<br /><br />  stop)<br />    echo -n "Stopping ${service.name}: "<br />    if type start-stop-daemon > /dev/null 2>&1; then<br />      start-stop-daemon -K -p"$JETTY_PID" -d"$JETTY_HOME" -a "$JAVA" -s HUP<br /><br />      TIMEOUT=30<br />      while running "$JETTY_PID"; do<br />        if (( TIMEOUT-- == 0 )); then<br />          start-stop-daemon -K -p"$JETTY_PID" -d"$JETTY_HOME" -a "$JAVA" -s KILL<br />        fi<br /><br />        sleep 1<br />      done<br /><br />      rm -f "$JETTY_PID"<br />      echo OK<br />    else<br />      PID=$(cat "$JETTY_PID" 2>/dev/null)<br />      kill "$PID" 2>/dev/null<br /><br />      TIMEOUT=30<br />      while running $JETTY_PID; do<br />        if (( TIMEOUT-- == 0 )); then<br />          kill -KILL "$PID" 2>/dev/null<br />        fi<br /><br />        sleep 1<br />      done<br /><br />      rm -f "$JETTY_PID"<br />      echo OK<br />    fi<br /><br />    ;;<br /><br />  restart)<br />    JETTY_SH=$0<br />    if [ ! -f $JETTY_SH ]; then<br />      if [ ! -f $JETTY_HOME/bin/jetty.sh ]; then<br />        echo "$JETTY_HOME/bin/jetty.sh does not exist."<br />        exit 1<br />      fi<br />      JETTY_SH=$JETTY_HOME/bin/jetty.sh<br />    fi<br /><br />    "$JETTY_SH" stop "$@"<br />    "$JETTY_SH" start "$@"<br /><br />    ;;<br /><br />  supervise)<br />    #<br />    # Under control of daemontools supervise monitor which<br />    # handles restarts and shutdowns via the svc program.<br />    #<br />    exec "${RUN_CMD[@]}"<br /><br />    ;;<br /><br />  run|demo)<br />    echo "Running Jetty: "<br /><br />    if [ -f "$JETTY_PID" ]<br />    then<br />      if running "$JETTY_PID"<br />      then<br />        echo "Already Running!"<br />        exit 1<br />      else<br />        # dead pid file - remove<br />        rm -f "$JETTY_PID"<br />      fi<br />    fi<br /><br />    exec "${RUN_CMD[@]}"<br /><br />    ;;<br /><br />  check)<br />    echo "Checking arguments to Jetty: "<br />    echo "JETTY_HOME     =  $JETTY_HOME"<br />    echo "JETTY_CONF     =  $JETTY_CONF"<br />    echo "JETTY_RUN      =  $JETTY_RUN"<br />    echo "JETTY_PID      =  $JETTY_PID"<br />    echo "JETTY_PORT     =  $JETTY_PORT"<br />    echo "JETTY_LOGS     =  $JETTY_LOGS"<br />    echo "START_INI      =  $START_INI"<br />    echo "CONFIGS        =  ${CONFIGS[*]}"<br />    echo "JAVA_OPTIONS   =  ${JAVA_OPTIONS[*]}"<br />    echo "JAVA           =  $JAVA"<br />    echo "CLASSPATH      =  $CLASSPATH"<br />    echo "RUN_CMD        =  ${RUN_CMD[*]}"<br />    echo<br /><br />    if [ -f "$JETTY_RUN/jetty.pid" ]<br />    then<br />      echo "Jetty running pid=$(< "$JETTY_RUN/jetty.pid")"<br />      exit 0<br />    fi<br />    exit 1<br /><br />    ;;<br /><br />  *)<br />    usage<br /><br />    ;;<br />esac<br /><br />exit 0<br /><br /></pre>然後把下面這塊存成 src/main/unix/scripts/post-install，並修改 USER=locadz-backend 這一行成跟你 ${service.user} 一樣的值<pre class="brush: shell;">#!/bin/sh<br />set -e<br /><br />USER=locadz-backend<br /><br />case "$1" in<br />    configure)<br />        if ! id $USER > /dev/null 2>&1 ; then<br />            adduser --system --home /var/lib/bluetang/$USER --no-create-home \<br />                --group --disabled-password --shell /bin/false \<br />                $USER<br />        fi<br /><br />        if [ ! -e /var/log/bluetang ]<br />        then<br />            mkdir -p /var/log/bluetang<br />        fi<br />        if [ ! -e /var/log/bluetang/$USER/ ]<br />        then<br />            ln -s /var/lib/bluetang/$USER/logs /var/log/bluetang/$USER<br />        fi<br />        if [ ! -e /var/cache/bluetang/$USER ]<br />        then<br />            mkdir -p /var/cache/bluetang/$USER<br />        fi<br /><br /><br />        chown -R $USER:adm /var/cache/bluetang/$USER /var/log/bluetang/$USER /var/lib/bluetang/$USER<br />        chmod 0744 /etc/init.d/$USER<br />        update-rc.d $USER defaults<br /><br />    ;;<br /><br />    abort-upgrade|abort-remove|abort-deconfigure)<br />    ;;<br /><br />    *)<br />        echo "$0 called with unknown argument \`$1'" >&2<br />        exit 1<br />    ;;<br />esac<br /><br /></pre>然後把下面這塊存成 src/main/unix/scripts/post-remove，並修改 USER=locadz-backend 這一行成跟你 ${service.user} 一樣的值<pre class="brush: shell;">#!/bin/sh<br />set -e<br /><br />USER=locadz-backend<br /><br />#DEBHELPER#<br /><br /># Remove cached files<br />rm -rf /var/cache/blutang/$USER/*<br /><br />case "$1" in<br />    remove)<br />        # Remove ROOT webapp if not modified<br />        RWLOC="/var/lib/bluetang/$USER/webapps/root"<br />        RWFILES="$RWLOC/index.html $RWLOC/jetty_banner.gif"<br />        if [ "`(cat $RWFILES | md5sum -) 2>/dev/null | cut -d ' ' -f 1`" \<br />                            = "12471c4b3020defb7ebd30ef84c0f9dd" ] ; then<br />            rm $RWFILES<br />            rmdir --ignore-fail-on-non-empty \<br />                /var/lib/bluetang/$USER/webapps/root \<br />                /var/lib/bluetang/$USER/webapps \<br />                /var/lib/bluetang/$USER || true<br />        fi<br />        if [ -d "/var/cache/bluetang/$USER" ] ; then<br />            rm -rf /var/cache/bluetang/$USER<br />        fi<br />    ;;<br /><br />    purge)<br />        # Remove user/group and log files (don't remove everything under<br />        # /var/lib/jetty because there might be user-installed webapps)<br />        deluser jetty || true<br />        rm -rf /var/log/bluetang/$USER<br />        if [ -d "/var/lib/bluetang/$USER" ] ; then<br />            rmdir --ignore-fail-on-non-empty /var/lib/bluetang/$USER || true<br />        fi<br />        rmdir --ignore-fail-on-non-empty /etc/bluetang/$USER/contexts /etc/bluetang/$USER || true<br />    ;;<br /><br />    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)<br />        # Nothing to do here<br />    ;;<br /><br />    *)<br />        echo "$0 called with unknown argument \`$1'" >&2<br />        exit 1<br />    ;;<br />esac<br /></pre>然後把下面這塊存成 src/main/unix/scripts/pre-install，並修改 USER=locadz-backend 這一行成跟你 ${service.user} 一樣的值<pre class="brush: shell;">#!/bin/sh<br />#<br /># This is the preinst script for the Blue Tang Servers<br />#<br /># Written by Yung-Lin Ho yho@bluetangstudio.com<br /><br />set -e<br />USER=locadz-backend<br />SCRIPT=/etc/init.d/$USER<br /><br /><br />case "$1" in<br />    upgrade|remove|purge)<br />        $SCRIPT stop<br />        ;;<br />    install|failed-upgrade|abort-install|abort-upgrade|disappear)<br />        ;;<br />    *)<br />        echo "preinst called with unknown argument \`$1'" >&2<br />        ;;<br />esac<br /><br />exit 0<br /></pre>下面這塊存成 src/main/unix/scripts/pre-remove，並修改 USER=locadz-backend 這一行成跟你 ${service.user} 一樣的值<pre class="brush: shell;">#!/bin/sh<br />#<br /># This is the prerm script for the Blue Tang Servers<br />#<br /># Written by Yung-Lin Ho yho@bluetangstudio.com<br /><br />set -e<br />USER=locadz-backend<br />SCRIPT=/etc/init.d/$USER<br /><br />case "$1" in<br />    upgrade)<br />        ;;<br />    remove|purge)<br />        $SCRIPT stop<br />        ;;<br />    failed-upgrade|abort-install|abort-upgrade|disappear)<br />        ;;<br />    *)<br />        echo "prerm called with unknown argument \`$1'" >&2<br />        ;;<br />esac<br /><br />exit 0<br /></pre></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/27/bravo-to-spotify-apps/">Bravo to Spotify Apps.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-27T16:14:00+08:00" pubdate data-updated="true">Mar 27<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
spotify&#8217;s app is pretty good business model. 之前我抱怨 #spotify 的 editorial material 比不上 #rhapsody. 用 Rhapsody 時，因為 Rhapsody 內有十多位人員負責編排本週推薦的音樂，還有客製化的播放清單及電台，所以訂閱 rhapsody 就像有 DJ 幫你找歌來聽。<br /><br />但是用 Spotify ，就只能夠聽，你已知的歌手， spotify 沒有一個好用的推薦功能可用。<br /><br />最近 spotify 的 gui client 開始可以放上第三方App的功能，馬上就把缺的地方補上，而且還更好。<br /><br />像是串入 last.fm 就有推薦清單可用，soundrop可以當線上DJ，TuneWiki可以看歌詞，歌詞還會照時間來跳到現在唱的句子；這證明了 Open API的威力，你有缺的地方，用 3rd party app 來補上，而且可以做的更好。<br /><br />其實 Rhapsody 內部早在 2005 已有這種 API ，我在 real.com 時就是做這一塊的，許多第三方的程式及硬體就是呼叫我們的API，如 sonos, sandisk sansa, 我自己也寫了隻程式給我的Nokia N82用，只是可惜不能放出來。<br /><br />Rhapsody 再不把 API 放出來，恐怕就連美國這塊市場都要開始敗退了&#8230;</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/07/-job-job-market-in-us/">[Job]Job Market in US</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-07T23:05:00+08:00" pubdate data-updated="true">Mar 7<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<blockquote>這篇的草稿躺在我的部絡格兩個月了，看來完成遙遙無期，所以先把屍體放出來好了<br /></blockquote><br />要在美國求職，第一要務，就是先了解到，美國的求職市場是怎樣的環境。<br /><br />大多人在台灣的求職的方式，是上 104 找適合的工作，然後再寄信過去應徵工作；然而，很不幸的是，你把求職市場放大十倍，這種方式就變得不是很有效率了。<br /><br />首先，你要知道的是，在矽谷，一個工作被登上美國的求職網站，兩週內，可能吸引到2000個應徵者投遞履例表，這數字是什麼意思呢，這是說，當 HR 過濾履例表時，既使只花30秒在一份履例表上，也要花上整整16小時兩個工作天，才能篩檢完畢。我曾經看過同事在過濾履例時，就像在拿電風扇在吹一樣，看到過去工作過的公司有趣留下來，看到經驗有趣的留下來，看到名字念起來有趣的留下來；有時後，會不會被找來面識，真的是要靠一點運氣的。<br /><br />所以說，要寫出一份好的履例表，讓 HR 一目了然，抓到重點，把你的履例表留下來細看，就是一件很重要的事了。<br /><br /><br />好的履例表，第一要鍵就是，格式要清楚，格式不清楚，當下就是被放一邊，不會有 HR 去細看的；第二則是，不管你經歷有多少，履例表的內容，一定要是一業滿版，比一頁多，你要刪成只有一頁，比一頁少，你不管怎樣就是要加到一頁滿版。<br /><br />底下是我2005時，剛畢業時用的履例表；內容的格式有點小問題，不過這個板型也是我後來一直延用下去的格式。<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-Vm3na4cyjDY/TyLY4P1rwSI/AAAAAAAADEY/4i38pZRR8Ec/s1600/resume_2005-001.jpg" imageanchor="1"><img border="0" src="http://4.bp.blogspot.com/-Vm3na4cyjDY/TyLY4P1rwSI/AAAAAAAADEY/4i38pZRR8Ec/s1600/resume_2005-001.jpg" width="600" /></a></div><br />這份履例表的排列是社會新鮮人用的，(未完待續)</div>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/26/island-of-greed/">我們的政府很有錢啊</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/19/government-intervention/">談政府干預怎麼摧毀了台灣的軟體業</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/30/new-york-taxi/">談紐約的計程車如何降低乘客及司機間的不信任感</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/23/california-legalize-ridesharing/">加州公共事業委員會通過共乘法案</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/17/on-hr/">談人力資源主管</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Facebook</h1>
  <div class="fb-follow" data-href="https://www.facebook.com/yunglin.ho" data-width="260" data-show-faces="true"></div>
</section>
<section>
  <h1>Twitter</h1>
  <a class="twitter-timeline" href="https://twitter.com/yunglinho" data-widget-id="379628400123445248">Tweets by @yunglinho</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/101164690243066571931?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
<a title="tumblr stats"
href="http://statcounter.com/tumblr/" target="_blank"><img
src="http://c.statcounter.com/8085210/0/5c96ca74/0/"
alt="tumblr stats" style="border:none;"></a></section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 -  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yunglin';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
