
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>碎碎唸</title>
  <meta name="author" content="">

  
  <meta name="description" content="The Challenge
在今天的講題開始前，我要先花一點時間講一下，我們這一代程式設計師面對的挑戰是什麼，為什麼我們需要一個新的程式架構？
大家應該都很熟悉摩爾定律，摩爾定律是指：一個尺寸相同的晶片上，所容納的電晶體數量，約每隔18個月便會增加一倍，性能也將提升一倍。
在Dr. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.yunglinho.com/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/yunglinho" rel="alternate" title="碎碎唸" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11857878-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">碎碎唸</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/yunglinho" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.yunglinho.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/19/introduction-to-actor-model/">[未完] Introduction to Actor Model</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-19T14:42:00+08:00" pubdate data-updated="true">Jul 19<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="section" id="the-challenge">
<h2>The Challenge</h2>
<p>在今天的講題開始前，我要先花一點時間講一下，我們這一代程式設計師面對的挑戰是什麼，為什麼我們需要一個新的程式架構？</p>
<p>大家應該都很熟悉摩爾定律，摩爾定律是指：一個尺寸相同的晶片上，所容納的電晶體數量，約每隔18個月便會增加一倍，性能也將提升一倍。
在Dr. Moore於1965年提出摩爾而後的40年間，摩爾定律準確的預測電晶體的發展，每18月就有更快一倍的處理器出來，每18個月記憶體的就倍
增。對於軟體工程師來說，摩爾定律讓我們的程式，不用更新軟體，每隔一段時間，效能就自動增加。</p>
<p>然而這一切，在 2005 年左右開始崩壞，那年，我在 ACM Queue 九月號讀到 &quot;The Future of Microprocessors&quot;,
&quot;The Free Lunch Is Over: A Fundamental Turn Toward Concurrency in Software.&quot;等文章，提到，軟體工程師的免費午餐
已經結束了，未來，處理器的時脈將不會隨著電晶體數而增長，只有處理器的核心數依然跟隨著摩爾定律，每18個月增加一倍，而後，類似的
文章開始大量的出現在各樣的軟體雜誌之中。 Intel於 2006 年一月發表了個人電腦用的雙核處理器 - Core Duo， 2007 年四核的Core 2 Quad
發表，我想現在在場的聽眾中，有不少的是用 Intel i7 八核的處理器。</p>
<p>對軟體工程師來說，新的現實是 Amdahl&#8217;s Law ，一個程式能被多核心處理器加速的程度，不會高於程式中不可平行處理的部份的倒數。
也就是說，如果程式中只有50%的部份是可平行處理的，那麼，多核心的處理器最多只能幫你加速兩倍，不管你有雙核，四核，還是六十四
核等。如果程式中有 95% 的部份是可平行處理的，縱使你有兩千核的處理器，還是只能幫你加速 20 倍。</p>
<p>不管你是寫單機版程式，或者是多人用的網路系統，如何善用多核心的處理器，是現在不得不開始面對的問題。</p>
</div>
<div class="section" id="concurrency-and-parallelism">
<h2>Concurrency and Parallelism</h2>
<p>接下來我們要先定義一下名詞，我們中文中講的平行處理，代表了兩個不同的涵意，一個是 Concurrency ， 另一個是 Parallelism</p>
<p>Parallelism 講的是，程式中有兩個以上的部份，可以同時間被處理，而不會互相干擾。</p>
<p>Concurrency 指的是，程式中的兩個以上的部份，可以同時間被處理，或者透過分時分享資源，同時間被處理器處理。</p>
<p>然而，對軟體工程師來說，這兩者都是很困難的，因為我們的程式不免會用到共享的資源，在 Parallelism 中，如何找出共享的資源
將這些模組分離出來最小化，是一種挑戰，在 Concurrency 中，如何確保共享的資源不變成程式中的瓶頸，又是另一個挑戰。</p>
<p>在 Java 6 Concurrency API 就提供了不少工具來協助處理 Concurrency 的問題，如 Executor, CountDownLatch, Semaphore
, DelayQueue 等工具。</p>
</div>
<div class="section" id="issue-shared-memory-concurrency">
<h2>Issue: Shared Memory Concurrency</h2>
<p>那 Shared Memory Concurrency 的問題在那呢？我記得我在學寫網頁時，第一次寫 Web Counter 時就學到了，原來小
到一個 counter++ ，都會因為 thread 存取的順序，而發生 race condition 造成結果與預測的不同。Shared Memory
Concurrency的難點就在於，如何正確的使用 Lock 及 Lock 的不可預測性。</p>
<p>由於作業系統設計時，為了效能，不會將 Lock 設計成完全的公平，當有三個 Thread 依序去要一個 Lock 時，你執行三次，
可能三次都是不同的 Thread 第一個拿到這個 Lock ，這個特性，造成了測試時及執行時的不可決定性，無法在測試時，模擬可
能發生的所有狀況。</p>
<p>此外 Lock 並不是容易去使用的，如果你在程式中使用了大量的 Lock ，將會造成程式中可被併行處理的部份減少，在 Java6
之前，若是你在沒有需要用 lock 的地方使用了 lock ， jvm 仍然會去要這個 lock ，在 Java6 Mustang Release中， HotSpot JVM
的實作引入了 lock elision 的觀念， HotSpot VM 將會透過執行階段的分析，去忽略掉這些多餘的 lock。</p>
<p>然而， Lock 仍帶入了許多問題，如 lock starvation ，當許多 thread 大量、重覆的取用同一個 lock 時，由於取得 lock
的機制並不是公平的，所以有可能會有 thread 一直取不到 lock 的狀況發生。</p>
<p>另外，若是多個 Thread 都要存取相同的數個 lock ，則會造成互相卡位的狀況，形成 live lock。</p>
<p>當然，你也可以說，用 Lock 太麻煩，而減少 Lock 的使用，那麼你的程式就會變得不 Thread-Safe ，在處理量大時，會發生
Race Condition造成不可預期的結果產生。</p>
<p>而用 Lock 最讓人絕望的是，若是 Lock 的順序弄錯了，會造成 Dead Lock ，變成，程式在設計的初期就要把各物件呼叫的順序
先定出來，才可以避免 Dead Lock 的產生，但是你能保證你的程式 1.0版、1.1版、2.0版的呼叫順序都不變嗎？</p>
<div class="section" id="false-sharing-cache-line-issue">
<h3>False sharing: Cache Line Issue</h3>
<p>如果說 Lock 的問題就夠讓人頭大了，那麼底下這個我最近讀到的問題，則會讓你更吃驚。在電腦的架構中，我們有主記憶體、處理器
上有L1 L2 L3快取，處理器存取資料時，會把資料放在快取中，在適當的時機 在把修改寫回主記憶體；這點，大家應該不難去想像。</p>
<p>然而，處理器在從主記憶體存取資料至快取時，是一個區塊一個區塊的去存取，所以在取用資料時，不只會拿回所需的資料，同時也會
取用到相鄰的資料，這在多核心的機器上造成，若是core A 及 core B會去存取相鄰的資料，那麼他鍆將互相 invalidate 對方的
L1快取，造成要從下層的快取或主計憶體上重新讀取資料。</p>
<p>在一篇測試報告中，在一台八核的機器上的測式結果，有False Sharing問題的程式將比沒有False Sharing問題的程式慢12倍，這
數字差不多就是L1及L2讀取速度的差異。依此推測，若是要從主記億體重讀的話，則會慢上200倍！</p>
</div>
</div>
<div class="section" id="the-solution">
<h2>The Solution</h2>
<div class="section" id="a-new-high-level-programming-model">
<h3>A new high level programming model</h3>
<p>講完了問題，當然之後，當然要開始講解決方案了；許多大神、大師們覺得我們須要一個不同的 Programming Model
來解決這問題，他們覺的，這個新的解決方案要有底下幾個特性</p>
<ul class="simple">
<li>要容易被理解，跟容易被測試。</li>
<li>換言之，也就是要deterministic，如果程式流程是輸入 A 產出 B ，那麼不管執行多少次，這個結果仍是要
一樣的。</li>
<li>既然 shared mutable state 是問題的根源，我們就把這問題給移除。</li>
<li>能夠善用多核心所帶來的優點。</li>
</ul>
</div>
<div class="section" id="possible-solutions">
<h3>Possible Solutions</h3>
<p>有個不同的解決方案被提出來，首先是 Functional Programming ，完全的把 Mutable State 移除，程式變
成如同數學函式一般可以被堆疊，程式函式的本身不帶有狀態，所有的狀態都是由外部傳入的，如此一來，程式本身
的運算處理就變的 deterministic</p>
<p>而既然函式本身不帶有狀態，那麼他們便可以平行的被處理，例如在 scala 中，就引如了 parallel collection
，讓軟體工程師可以很簡單的就會一群資料做平行的運算</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="n">par</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">2</span><span class="o">)</span>
</span><span class="line"><span class="n">res</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure><p>Functional Programming所需的 Lambda expression 將會在 Java8 時被實作出來，而 Parallel Collection
也有機會在 Java8 時出現。</p>
<p>在此順便打個廣告，台灣目前有個 functional programming user group 在運作中，若是各位有性去，可以上網
找 fpug.tw</p>
<p>而另一個可能的解決方案是 Actor Model ， Actor Model 將狀態封裝在Actor內部，Actor及Actor間，則是透過
非同步的機制去傳遞訊息。</p>
</div>
</div>
<div class="section" id="a-brief-history-of-the-actor-model">
<h2>A Brief History of the Actor Model</h2>
<p>在開始介紹 Actor Model 前，先簡單介紹一下 Actor Model 的歷史。 Actor Model 是於 1973 年 Carl Hewitt
命名的，而由 Gul Agha 這位先生於 1985 年左右更精確的描述 Actor Model 。</p>
<p>第一個大型的商業應用，則是由 Ericsson 於 1980 年代中期所完成的一個電信系統，這個系統非常的容錯，當大家在介
紹 Actor Model 時，多會提到這個例子，因為這個系統達到了 99.9999999% 九個九的 uptime ，也就是說
一整年下來，他停機的時間只有 31 ms ，非常的匪疑所思，因為，一般我們在寫的系統，能有兩個九，就已經是很了不
起的成就了。</p>
<p>這個專案另一個有名的產品是 erlang 這程式語言， erlang 在 1990 年代被 opensource ，後來被大量運用在
message queue 跟 Concurrency 的程式之中。例如大家常用的 RabbitMQ 就是利用 erlang 寫成的，據說他的核
心只有 5000 行 erlang 的程式碼。</p>
</div>
<div class="section" id="actor">
<h2>Actor</h2>
<p>那什麼是 Actor 呢， Actor 是一個非常輕量化的元件，在 Akka 的實作中，每一個 Actor 只占了約400 bytes
的記憶體空間，每一個 Actor 擁有自己的狀態以及行為，將些狀態及行為都被封裝在 Actor 裡面。</p>
<p>其他的 Actor 只能夠透過送訊息的方式，來與這個 Actor 來溝通，存取 Actor 的狀態及觸發行為；當 Actor 收
到外部的訊息時，這些訊息會被放在信箱裡，依照順序來被這個 Actor 來處理。</p>
<p>這個送訊息的及處理訊息的機制，是非同步的，你不能假設這個訊息一定會立刻被同一個 thread 處理，甚至，你不能
假設說，你一定會收到一個回應。</p>
<p>當 Actor 處理訊息時，他會被放在系統中預先配制好的 Thread 上執行、處理訊息。</p>
<p>很有趣的是，當你這樣設計一個系統時，你的系統便會變得非常的 scalable 及非常的輕量化。因為使用 Actor Model
你的 call stack 會變的很小，在我們用 imperative programming ，我們的 call stack 是從系統最外部，透過
一層層的 method call 累加上來起來，當 CPU 在 Context Switching ，在從一個 Thread 跳到另一個 Thread 去
執行時，需要讀入該 Thread 的 Call Stack ，當 Call Stack 越大時，Context Switch的成本就愈高。</p>
<p>在Actor Model 中，兩個 Actor 在傳遞訊息時，其實只有把這個訊息的 reference 丟到另一個 Actor 的信箱中，訊
息傳遞的成本非常的小，而 Actor 在被喚起處理訊息時，他的 call stack 是從他的信箱開始，而非整串的呼叫流程，因
此， context switch 的成本變的很小。</p>
<p>在 Actor Model 中，一個工作的處理，會變得很像我們在辦公室內做業的方法，當我們從系統外部收到一個訊息時，我們
會把這個工作連同這個工作的寄送者先記錄下來，放到信箱中延後處理，當前一手完成工作後，運行中的 Actor 會把處理
好的資料轉發給下一手，就這樣一層層轉發，最後在將完成的工作結果，送還給原始的寄送者。</p>
</div>
<div class="section" id="introduce-akka">
<h2>Introduce Akka</h2>
<p>接下來的部份，我們要介紹 Akka 這個 JVM 上 Actor Model 的實作。</p>
<p>Akka 是由 Jonas Boner 於 2009 年所發起的，在開發 Akka 之前， Jonas 是在 Terracotta 做 JVM Clustering 以及在 BEA
做 JRockit VM 的，具有多年食作 distributed system 的經驗。目前 Akka 背後的商業公司是 typesafe ， typesafe
同時也是開發 Scala 這個 JVM 上最盛行 JAVA.NEXT 語言的公司。</p>
<p>這個實作是跑在 JVM 上，提供了 Java 及 Scala 的 API ，在接下來的簡報中，我會用 Java API 為主 Scala API 為輔
來介紹怎麼使用 Akka。</p>
<p>Akka另外也引入了 remote actor 這個觀念，既然，我們所有的訊息傳遞都是非同步的，透過訊息的傳遞來呼叫，而這訊息本
身，又是不帶狀態，可以被 serialize 的，狀態的本身是存在 Actor 中的，那麼，為什麼我們自然有可能的將工作放到別台
機器上來處理。</p>
<p>除了 Actor Model 外，Akka還提供了許多 module 來跟外部的系統整合，如 akka-camel ，能讓 akka 串接上 camel 這
個 enterprise service bus ，便程它的一個 endpoint ，讓 Actor 能處理 camel 送來的訊息然後再將訊息轉發回 camel 中。</p>
</div>
<div class="section" id="define-actor">
<h2>Define Actor</h2>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kn">import</span> <span class="nn">akka.actor.UntypedActor</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Counter</span> <span class="kd">extends</span> <span class="n">UntypedActor</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">   <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">     <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;increase&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">       <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;get&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">getSender</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="n">count</span><span class="o">));</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="n">unhandled</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="fault-tolerance-in-akka">
<h2>Fault Tolerance in Akka</h2>
<p>接下來我們要談的就是為什麼 ericsson 的系統能夠達到那麼高可靠度的原因以及 Akka 容錯的機制。</p>
<p>當一個系統在運作時，不免因為一些設計外的因素、或不可預期的輸入，造成系統產生錯誤的狀態，有時，這個錯
誤的狀態只是丟出一個 exception 就結束，但是在某些情況下，系統會處於一個混亂的狀態之中，無法再繼續處
理任何的訊息。</p>
<p>這個狀況，我相信大多數的 Windows 用戶都有碰上過，也非常清楚這個問題的解決方案，也就是 &#8211; 重開機</p>
<p>在 Akka 中，Actor們如同現實生活中公司的組織，可以有低層的員工以及高層的 Supervisor ，當一個員工
在處理訊息時，若是有發生無法自己無法排解的錯誤狀況的話，他將會把這錯誤狀況，回報給他的上級，由上級來
決定如何處理。</p>
<p>如果說，一個 supervisor 管理的 workers 都是獨立的個體，沒有交互影響的問題，那麼， supervisor 可以
選擇將有問題的 worker 單獨重開機，當一個 actor 被重啟時，他的 actor reference 將保持不變，外面的 actor
仍可以透過原有舊的 actor reference 跟這個重啟後的 actor 溝通。而被重啟的 actor 的信箱，仍會保存的
尚未被處理的訊息在信箱內，而造成錯誤的訊息，則是在重啟時可以決定是否要保留重新處理。</p>
<p>若是一個 supervisor 下的 workers 有相互依賴的情況的話，那麼， supervisor 可以在某一個 worker 發
生錯誤時，重新啟動所有的 workers。</p>
<p>這個錯誤排解的機制不止是可以串上一層而以，而是可以一層層的堆疊起來，位在最上端的，則是前面所看過的 ActorSystem
；當一個錯誤是直屬主管無法排除的錯誤，那麼，這個錯誤訊息可以再轉發給更高層的主管，由他來解決。同樣的，重啟的觀
念也可以套用在這邊。當一個系統的子系統發生錯誤時，我們可以重新啟動整個環境</p>
</div>
<div class="section" id="remote-actor">
<h2>Remote Actor</h2>
<p>在 Akka 的實作中 Actor 預設就是可以被 Remote 化的， Actor 在設計時，就已經是設計成 location transparent 及
可被配置在本機或是遠端的，一個原本設計成本機用的 Actor ，可以不經任何的程式變化，直接修改設定檔，變成在啟動一個
Actor時，自動就是啟動在遠端的。</p>
<p>而傳遞訊息給 Remote Actor 跟傳給本機的 Actor 是沒有差別的，同樣是透過 tell 及 ask 這兩個 API ，在底層實作上
Actor Reference 會帶有 Remote Actor 實際所在機器的位址，若是一個 Actor 是 Remote Actor 的話，被傳送的訊息
就會透過 Java Serialization, Protocol Buffer Serializer 或者是自定的 Serializer 來將訊息寫入到遠方。</p>
<p>而要使用那一種 Serializer ，是可以透過設定檔做切換的。</p>
<p>Remote Actor 的配置，也是可以透過程式來控製，下圖便是一個例子。</p>
</div>
<div class="section" id="routing-clustering">
<h2>Routing &amp; Clustering</h2>
<p>對於 Cluster 的設計，目前 Akka 的團隊還在重新設計中，目標將會是在下一個 release 時，將 cluster 的功能
加入到 Akka 中。</p>
<p>目前，Akka 則是只支援 Routing 而已。 Routing 的機制是說，你有一群一樣的 actor，他們可以處理同樣類型的訊息
，但是由誰來處理訊息，則是由 Router 來決定。</p>
<p>你可能會問，什麼時候需要這樣做呢？會有 Routing 的需求時，多是因為有處理量限制的問題，例如，我想要最多不超過五個
這類型的工作可以同時間被處理，或者是從使用者A來的需求，最多只讓它同時跑五個，但是從使用者B來的需求，最多可以跑十
個，而且兩個人的程序不能混用。</p>
<p>Akka 目前支援的 Routing 機制有</p>
<ul class="simple">
<li>RoundRobinRouter： 在一群 actor 中，依序將工作配發給他們。</li>
<li>RandomRouter: 在一群 actor 中，隨意的將工作配發給他們。</li>
<li>SmallestMailboxRouter: 在一群 actor 中，將工作配發給目前沒有在工作的，或者是待辦工作最少的 actor</li>
<li>BroadcastRouter: 將工作配發給所有的 Actor</li>
<li>ScatterGatherFirstCompletedRouter:  將工作配發給所有的 Actor，然後等待第一個回應，其餘的回應則是會被忽略捨棄掉。</li>
</ul>
<p>Routing 的機制也可以跟 Remote Actor 混用，將 Remote Actor 配發在多台機器上，然後透過 Router 將訊息配
發給他們。</p>
</div>
<div class="section" id="performance">
<h2>Performance</h2>
<p>下圖的是 Akka 官方，於一台48核的 AMD 機器上，做簡單訊息傳送的 Performance Test 的測試結果。</p>
<p>在一開始的實作中，Akka是使用 java.util.concurrent.ThreadPoolExecutor 控制最多有多少個 Actor 能同
時被執行，然而在這 48核 的機器上，Akka Team發現，Akka無法 scale 超過 12 個併行的 actor ，不管你增加
多少個 actor ，同時間內被處理的最大量卡在每秒一百四十萬個訊息這個數字。然而，同時間 CPU 的 Load 並沒
有超過 10%</p>
<p>Akka Team猜想是因為 ThreadPoolExecutor 底層的 task queue, LinkedBlockingQueue 有一個共用的 lock，
最後造成擁塞，才會造成效率的不佳。</p>
<p>後來在經過了 Doug Lea 的協助，使用 Fork-Join 重新實作 task executor ，於是效能就拉高到每秒兩千萬個訊息
這數字。</p>
</div>
<div class="section" id="use-case">
<h2>Use Case</h2>
<p>那 Akka 可以被用在那些地方呢？目前 Akka 被應用在下面幾個地方。</p>
<ul class="simple">
<li>messaging system: 例如國內的 Cubie 就有用到 Akka 來處理訊息。</li>
<li>Data Analysis: klout.com 例用 akka 來分析社群網站上如 facebook twitter 上訊息轉發的熱門程度
以及誰是意見領袖等資料。</li>
<li>股票交易系統： Akka 的一大客戶群是倫敦的金融公司，Akka的幾個特性很適合用來做股市交易用。像是用 Actor
來追蹤一個股票的現貨股價變化以及產生各種線型圖；又或者是說，結合 Rule Based Engine 可以做風險控管的
模組。例如說交易員要下單買一支股票時，Akka可以幫你同時檢查，這個交易員他目前手上可用資金的是多少，
交易員目前股票組合的風險是多少，公司目前整體股票組合的風險是多少。
數十至數百個不同規則的檢查是可以透過 remote actor 分散在許多機器上併行處理的，一個交易的風險評估，並不
會隨著檢查的數量而線性增長。</li>
<li>另外一個 Akka 被大量使用的環境是線上遊戲，過去有許多遊戲公司選擇用 MySQL 當後台，然後透過 cache 及 db
sharding的方式，來增加 throughput ，後來他們發現，與其把 server 寫成 stateless 然後把狀態放在後台
的 db 讓 db 變成效能的頻頸，不如把 state 放在 Actor 中，讓每個 Actor 代表一個遊戲中的角色，獨立維護
它的狀態，這樣才能更 scalable.</li>
</ul>
</div>
<div class="section" id="case-study">
<h2>Case Study</h2>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/11/spatial-search-with-lucene/">Spatial Search With Lucene</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-11T16:06:00+08:00" pubdate data-updated="true">Jul 11<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="section" id="before-we-start">
<h2>Before We Start</h2>
<p>As some of my blog readers may know, my previous startup project was an online location based search service. Thing
does not go well and I am going to open source some of the related work.</p>
<p>In this post, I will show you how to use Lucene to do spatial search as well as how it works internally.</p>
</div>
<div class="section" id="spatial-search">
<h2>Spatial Search</h2>
<div class="section" id="spatial-search-and-geo-tagging">
<h3>Spatial Search and Geo Tagging</h3>
<p>Geo-tagging is a popular way to do spatial search. Instead of using the actual location to tag a POI, the geo-tagging
uses geotag to group items within a predefined range as a whole. When performing a search, it is simply pull out all
items with the same tag.</p>
<dl class="docutils">
<dt>There are few popular ways to do geo-tagging, including</dt>
<dd><ul class="first last simple">
<li>GeoHash</li>
<li>QuadTree</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="geohash">
<h3>GeoHash</h3>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Geohash">GeoHash</a> is way to encode latitude and longitude using base32 code. There is a fundamental flaw that makes it hard to
do spatial search. The problem is the geo hash generated is not continuous. The neighbor of a particular block may not
share the same prefix with its nearest eight neighbors. When using geohash to do spatial search, we need to calculate
the hash value of nearby neighbors by ourselves.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">+-------+-------+-------+
</span><span class="line">| ezefr | ezs48 | ezs49 |
</span><span class="line">+-------+-------+-------+
</span><span class="line">| ezefr | ezs42 | ezs43 |
</span><span class="line">+-------+-------+-------+
</span><span class="line">| ezefp | ezs40 | ezs41 |
</span><span class="line">+-------+-------+-------+
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="quad-tree">
<h3>Quad-Tree</h3>
<p>Quad-Tree addresses the issue in geohash and adapt a better way to do geo-tagging. This example gives us a
great example on how Quad-Tree does geo-tagging.</p>
<img alt="http://i.msdn.microsoft.com/dynimg/IC96238.jpg" src="http://i.msdn.microsoft.com/dynimg/IC96238.jpg" />
<dl class="docutils">
<dt>The Quad-Tree has the following advantage when doing spatial search</dt>
<dd><ul class="first last simple">
<li>it can be really fast if you stores data as a tri. Such as, Lucene, internally, it uses indexed tri to store
NumericField.</li>
<li>the neighbors of a block share the longest common prefix.</li>
</ul>
</dd>
</dl>
<p>For more extensive information regarding geo-tagging, you should check
<a class="reference external" href="http://msdn.microsoft.com/en-us/library/bb259689.aspx">here</a>,
<a class="reference external" href="http://www.maptiler.org/google-maps-coordinates-tile-bounds-projection/]">here</a> and
<a class="reference external" href="http://gist.github.com/1193577">here</a>.</p>
</div>
</div>
<div class="section" id="our-custom-approach">
<h2>Our Custom Approach</h2>
<p>Lucene&#8217;s <a class="reference external" href="http://lucene.apache.org/core/old_versioned_docs/versions/2_9_1/api/contrib-spatial/index.html">contrib-spatial</a> uses geo-tagging to implements spatial search and only support searching for
features near a point.</p>
<p>A pair of latitude and longitude gives us a quickstart for your location based application. However, not every
single feature in a LBS application can be described as a point. Let us take school district as an example.
The School A may be closer to your house than School B is, but your house is belong to school district for school B.
Another example is bike trails, bike trail is a line not a single point.</p>
<p>A full feature spatial search must support complicated geometric operations. This is why we create our own Lucene
spatial search implementation.</p>
<p>In the GIS area, Geometry are used to describe shape of features. The common geometries are:</p>
<div class="section" id="geometry-primitives-2d">
<h3>Geometry primitives(2D)</h3>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="56%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Type</th>
<th class="head">Text Format</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Point</td>
<td>POINT (30 10)</td>
<td><img alt="PointExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/SFA_Point.svg/51px-SFA_Point.svg.png" /></td>
</tr>
<tr><td>LineString</td>
<td>LINESTRING (30 10, 10 30, 40 40)</td>
<td><img alt="LineStringExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/b/b9/SFA_LineString.svg/51px-SFA_LineString.svg.png" /></td>
</tr>
<tr><td rowspan="2">Polygon</td>
<td>POLYGON ((30 10, 10 20, 20 40, 40 40, 30 10))</td>
<td><img alt="PolygonExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/SFA_Polygon.svg/51px-SFA_Polygon.svg.png" /></td>
</tr>
<tr><td>POLYGON ((35 10, 10 20, 15 40, 45 45, 35 10),
(20 30, 35 35, 30 20, 20 30))|</td>
<td><img alt="PolygonExample2" src="http://upload.wikimedia.org/wikipedia/commons/thumb/5/55/SFA_Polygon_with_hole.svg/51px-SFA_Polygon_with_hole.svg.png" /></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="multipart-geometries-2d">
<h3>Multipart geometries (2D)</h3>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="53%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Type</th>
<th class="head">Text Format</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>MultiPoint</td>
<td>MULTIPOINT ((10 40), (40 30), (20 20), (30 10))</td>
<td><img alt="MultiPointExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/SFA_MultiPoint.svg/51px-SFA_MultiPoint.svg.png" /></td>
</tr>
<tr><td>MultiLineString</td>
<td>MULTILINESTRING ((10 10, 20 20, 10 40)
(40 40, 30 30, 40 20, 30 10))</td>
<td><img alt="MultiLineStringExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/8/86/SFA_MultiLineString.svg/51px-SFA_MultiLineString.svg.png" /></td>
</tr>
<tr><td>MultiPolygon</td>
<td>MULTIPOLYGON (((30 20, 10 40, 45 40, 30 20)),
((15 5, 40 10, 10 20, 5 10, 15 5)))</td>
<td><img alt="MultiPolygonExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/d/dc/SFA_MultiPolygon.svg/51px-SFA_MultiPolygon.svg.png" /></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="how-to-calculate-quadtree-value-for-geometries">
<h3>How to Calculate QuadTree value for Geometries</h3>
<p>When hashing a <tt class="docutils literal">Geometry primitive</tt>, we will calculate the minimum bounding rectangle(MBR) of this geometry. For
example, the minumum bouding box for <img alt="PolygonExample" src="http://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/SFA_Polygon.svg/51px-SFA_Polygon.svg.png" /> is the grid made up of (1, 1), (1, 4), (4, 4), (4, 1).</p>
<p>We will calculate the quadtree hashcode for the MBR, the quadtree hashcode for the MBR is the longest common prefix of
quadtree values for the four corners.</p>
<dl class="docutils">
<dt>When indexing this geometry with Lucene, we will store these fields in lucene</dt>
<dd><ul class="first last simple">
<li>geometry: POLYGON ((3 1, 1 2, 2 4, 4 4, 3 1))</li>
<li>geometry__quadtree: QuadTree value of the polygon.</li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="implementation-detail">
<h2>Implementation Detail</h2>
<p>The number of digits we used in the quad-tree implementation is 17 digits. This allows us to lay items on an 600 x 600
meter block. This number comes from 40075000 / 2 ^16 (Earth Circumference / level of details). The 17 digits number
will be stored as a long value. The digits we used are 1(upper left), 2(upper right), 3(lower left), 4(lower right),
and 0 (whole block in the given detail).</p>
<p>When encoding a coordinate, we will stores the quadtree value as a NumericField in Lucene. Internally, Lucene will use
indexed trie to store NumericField. The &quot;Indexed Trie&quot; uses buckets to group terms. We will use the default
precisionStep(4) for now.</p>
<div class="section" id="index-phase">
<h3>Index Phase</h3>
<p>During the index phase, we will store the geometry in its text form and in quadtree value. Each of them has their own
use during search phase.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">point</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="mf">24.123</span><span class="o">,</span> <span class="mf">18.921</span><span class="o">)</span>
</span><span class="line"><span class="k">val</span> <span class="n">code</span> <span class="k">=</span> <span class="n">point</span><span class="o">.</span><span class="n">quadtree</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">raw</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Field</span><span class="o">(</span><span class="s">&quot;location&quot;</span><span class="o">,</span> <span class="n">point</span><span class="o">.</span><span class="n">wkt</span><span class="o">,</span> <span class="nc">Field</span><span class="o">.</span><span class="nc">Store</span><span class="o">.</span><span class="nc">YES</span><span class="o">,</span> <span class="nc">Field</span><span class="o">.</span><span class="nc">Index</span><span class="o">.</span><span class="nc">NOT_ANALYZED</span><span class="o">)</span>
</span><span class="line"><span class="k">val</span> <span class="n">field</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">NumericField</span><span class="o">(</span><span class="s">&quot;location&quot;</span> <span class="o">+</span> <span class="s">&quot;__quadtree&quot;</span><span class="o">)</span>
</span><span class="line"><span class="n">field</span><span class="o">.</span><span class="n">setLongValue</span><span class="o">(</span><span class="n">code</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="n">doc</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">raw</span><span class="o">)</span>
</span><span class="line"><span class="n">doc</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">field</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="search-phase">
<h3>Search Phase</h3>
<dl class="docutils">
<dt>The search phase has two parts</dt>
<dd><ul class="first last simple">
<li>filter: fetches all possible features that may contains the geometry X by using Lucene&#8217;s range query against the
quadtree field.</li>
<li>select: for each possible results, run geometric operation to see if result Y contains geometry X.</li>
</ul>
</dd>
</dl>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">val</span> <span class="n">field</span> <span class="k">=</span> <span class="s">&quot;location&quot;</span>
</span><span class="line"><span class="c1">// create a point.</span>
</span><span class="line"><span class="k">val</span> <span class="n">point</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">makeShape</span><span class="o">(</span><span class="nc">Point</span><span class="o">(</span><span class="mi">24</span><span class="o">,</span> <span class="mi">18</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// turn point into search range.</span>
</span><span class="line"><span class="k">val</span> <span class="n">circle</span> <span class="k">=</span> <span class="n">point</span><span class="o">.</span><span class="n">buffer</span><span class="o">(</span><span class="nc">Distance</span><span class="o">(</span><span class="s">&quot;500m&quot;</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a query container for complex queries.</span>
</span><span class="line"><span class="k">val</span> <span class="n">query</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">BooleanQuery</span><span class="o">()</span>
</span><span class="line">
</span><span class="line"><span class="c1">// filtering: search for items in this range</span>
</span><span class="line"><span class="n">query</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">QuadTreeRangeQueryFactory</span><span class="o">.</span><span class="n">buildLocalQuery</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">circle</span><span class="o">.</span><span class="n">quadtree</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// selecting and scoring: the value source will return the distance between</span>
</span><span class="line"><span class="c1">// the point and each feature.</span>
</span><span class="line"><span class="n">query</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ValueSourceQuery</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="n">makeValueSource</span><span class="o">(</span><span class="s">&quot;location&quot;</span><span class="o">,</span> <span class="n">point</span><span class="o">));</span>
</span><span class="line">
</span><span class="line"><span class="k">val</span> <span class="n">founds</span> <span class="k">=</span> <span class="n">indexSearcher</span><span class="o">.</span><span class="n">search</span><span class="o">(</span><span class="n">query</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
<div class="section" id="open-source-projects">
<h2>Open Source Projects</h2>
<div class="section" id="scala-shapely">
<h3>Scala Shapely</h3>
<p><a class="reference external" href="https://bitbucket.org/bluetang/common-shapely/">Shapely</a> is Scala binding for JTS Topology Suite. The goal of Shapely is to provide an easy to use factory to
create JTS geometry class instances. It allows us to create various geometry shape with easy to use factory methods.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="c1">// create a point</span>
</span><span class="line"><span class="nc">Point</span><span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a line string</span>
</span><span class="line"><span class="nc">LineString</span><span class="o">((</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">40</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a polygon</span>
</span><span class="line"><span class="nc">Polygon</span><span class="o">((</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a polygon with a hole in it.</span>
</span><span class="line"><span class="nc">Polygon</span><span class="o">(</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">((</span><span class="mi">35</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">45</span><span class="o">,</span> <span class="mi">45</span><span class="o">),</span> <span class="o">(</span><span class="mi">35</span><span class="o">,</span> <span class="mi">10</span><span class="o">)),</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">((</span><span class="mi">20</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span> <span class="o">(</span><span class="mi">35</span><span class="o">,</span> <span class="mi">35</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">30</span><span class="o">)))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a multi-point</span>
</span><span class="line"><span class="nc">MultiPoint</span><span class="o">((</span><span class="mi">10</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span> <span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a multi line-string.</span>
</span><span class="line"><span class="nc">MultiLineString</span><span class="o">(</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">((</span><span class="mi">10</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">40</span><span class="o">)),</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">((</span><span class="mi">40</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">30</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">10</span><span class="o">))</span>
</span><span class="line"><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a multi-polygon.</span>
</span><span class="line"><span class="nc">MultiPolygon</span><span class="o">(</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">(</span>
</span><span class="line">        <span class="nc">Seq</span><span class="o">((</span><span class="mi">30</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">45</span><span class="o">,</span> <span class="mi">40</span><span class="o">),</span> <span class="o">(</span><span class="mi">30</span><span class="o">,</span> <span class="mi">20</span><span class="o">))</span>
</span><span class="line">        <span class="o">),</span>
</span><span class="line">    <span class="nc">Seq</span><span class="o">(</span>
</span><span class="line">        <span class="nc">Seq</span><span class="o">((</span><span class="mi">15</span><span class="o">,</span> <span class="mi">5</span><span class="o">),</span> <span class="o">(</span><span class="mi">40</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">),</span> <span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">10</span><span class="o">),</span> <span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="mi">5</span><span class="o">))</span>
</span><span class="line">        <span class="o">)</span>
</span><span class="line">    <span class="o">)</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="lucene-spatial">
<h3>Lucene Spatial</h3>
<p><a class="reference external" href="https://bitbucket.org/bluetang/lucene-spatial/">Lucene Spatial</a> is the geo-spatial module for lucene built on the top of shapely. The
lucene-spatial modules uses a SpatialContext instance to encode location fields and to
create location queries.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="c1">// create a context.</span>
</span><span class="line"><span class="k">val</span> <span class="n">context</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SpatialContext</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a shape from the representation of a geometry.</span>
</span><span class="line"><span class="k">val</span> <span class="n">shape</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">makeShape</span><span class="o">(</span><span class="s">&quot;Point(0 10)&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create lucene fieldables for a location field.</span>
</span><span class="line"><span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">makeFieldables</span><span class="o">(</span><span class="s">&quot;field&quot;</span><span class="o">,</span> <span class="n">shape</span><span class="o">).</span><span class="n">toList</span>
</span><span class="line">
</span><span class="line"><span class="c1">// create a location query to look for features within 5KM radius.</span>
</span><span class="line"><span class="k">val</span> <span class="n">query</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">makeQuery</span><span class="o">(</span><span class="s">&quot;field&quot;</span><span class="o">,</span> <span class="n">shape</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Distance</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Distance</span><span class="o">.</span><span class="nc">Unit</span><span class="o">.</span><span class="nc">KM</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/27/pricing-error/">那些系統整合教我的事 &#8211; 資料錯誤</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-27T18:52:00+08:00" pubdate data-updated="true">Jun 27<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>首先，今天要恭喜 iTunes Stores 台灣版總算上線了，恭喜蘋果搞定眾多台灣商家搞不定的
數位資料授權的問題；既然 iTunes Store 幫忙打通了關節，接下來許多的台灣的小 start-up 可以
透過串接 iTunes Store 的方式來賺取介紹費，又多了許多新的 business idea 可以在台
灣實作的可能。</p>
<p>iTunes Store 上線， <a class="reference external" href="http://briian.com/?p=8426">許多人發現</a> 許多專輯的費用只有 20 元，這讓我想到，當年我在
某音樂公司的經驗，當時是美國幾大音樂公司開放開始賣 non-DRM 音樂的年代，我們公司在線
上串流服務上做到全美最大，有三百萬的訂戶，音樂資料庫中，有超過一百萬首歌曲的資料，隨
著 non-DRM 的熱潮，我們也非得開賣 non-DRM 的音樂。</p>
<p>當時我是主管 QA 工程師的，問了再上頭的主管，問說除了網站的功能外，需要再做資料測試嗎
，因為跟據我當時的經驗，許多的音樂專籍的資料是有缺或有錯的；但是主管的說法是有其它的
單位會保證資料無誤，所以我這邊只要擔心功能性的問題就好。</p>
<p>當時產品的訂價方式是，一首歌的成本是 0.6 美金，我們賣 0.99 美金，每一張專輯我們則是
賣 9.99 ，等於是專輯如果超過 10 首歌，我們就開始吸收中間的價差。</p>
<p>然而一上線的隔天我們就知道錯了，上線的當晚就有人發現，有許多張精選輯，一張精選輯有數
張CD我們仍是只賣 9.99 每元，當晚，這些專輯就賣掉四千套，一晚就幫公司賠掉了五十萬美金
以上。由於這些音樂都是 DRM Free 的，所以賣出去就是賣出去了，沒有辦法收回，我們仍是要
依照賣掉的數量付錢原始授權的擁有者。</p>
<p>其實，這些歌曲的資料庫我們是跟外部另一家公司買的，並不是自建的；我(們)在這邊學到的一課
是，不管資料是內部還是外部建的，要用時，還是要自己全部檢查一遍才可用。</p>
<p>至於給台灣 iTunes Store 消費者的建議是 <strong>快買</strong> 等美國那邊睡起來後，產品就會下架再
改回原價了</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/23/runtime-quality-metrics-series-3/">軟體品質指標系列(三)：軟體品質如何測量</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-23T14:45:00+08:00" pubdate data-updated="true">May 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在這一系列的第一回我們談到，我們是軟體工程師，不談虛幻的概念，只講能夠量化追蹤的數值指標，那麼，
我們要怎麼把品質轉換程數值指標呢？</p>
<div class="section" id="id1">
<h2>軟體品質如何測量</h2>
<div class="section" id="id2">
<h3>幾個故事</h3>
<p>在開始講怎麼做前，我想先講兩個我親身的經驗，在我第一份工作時，前雇主是做手機遊戲的，整間公
司有兩百個員工，但是只有三個是做Server端的，在 2005 年時，多數遊戲都是單機板的，那時公司
簽下 World Series Of Poker 要做多人的線上遊戲，需要開發一個簡易的配對及遊戲訊息交換的伺
服器，當然，大家當年都沒有經驗，所以說，要怎麼樣確保在上線時，不會被用戶衝垮就變成我的工作。</p>
<p>而在我第二份工作時，也有相似的經驗，我們本來已有一個運作中的音樂平台，讓公司內外超過40個Partner使用；
當時，公司又簽下一個合約，說是在三個月後的 6/1 ，會新增 200萬用戶！如何不讓大水衝垮我們的
應用程式，又變成我那幾個月的工作重點。</p>
<img alt="/images/2012-05-23/troops.jpg" src="/images/2012-05-23/troops.jpg" style="width: 800px;" />
</div>
</div>
<div class="section" id="load-test">
<h2>Load Test</h2>
<p>寫到這邊，大部份的讀者應該都知道接下來要講的是 Load Test 了，Load Test是個很大的議題，通
常我們在講 Load Test 時，常講的其實是三件不同的事</p>
<ul class="simple">
<li>Performance Test</li>
<li>Stress Test</li>
<li>Longevity Test</li>
</ul>
<p>這三個測試，用的工具雖然一樣，但是要找個指標跟目的卻是大不相同。</p>
<div class="section" id="performance-test">
<h3>Performance Test</h3>
<p>Performance Test 的目地是在找出應用程式的 baseline performance ，做為未來績效評估及設計變
革時的依據。</p>
<p>被 Performance Test 的標的物，通常是已經 feature complete 的模組，然後我們將對模組的每
一個功能，一個一個進行黑箱及白箱測試；然後再用腳本的型態，模擬實際上線的流量，再來測試看看
各功能間對效能的互相影響程度；最後，是找到測試標的物的 Turning Point 及 Scale Factor。</p>
<div class="section" id="best-case-performance">
<h4>尋找 Best Case Performance</h4>
<p>尋找應用程式的 best case performance  大概是最常被忽略的事了， best case performance 指的是你
一個功能的最佳效率，不管怎樣測試，對單一功能來說，怎麼樣你的效率都不可能會再比這個數字
好了；這個數字的第一個用處就在這，如果你的最佳效率比目標效率還糟，剩下來的就不用測了，
因為怎樣都會比這個數字還糟，只能先停下來，回去修改程式碼增進效能。</p>
<p>Best Case Performance 的測法是：</p>
<ol class="arabic simple">
<li>將應用程式啟動</li>
<li>先用幾個 request 替應用程式暖身(warm up)，以 Java VM 來說，這樣可以讓 Hotspot VM 幫 bytecode 最
佳化，有些需要被啟動的內部原件也會被啟動。</li>
<li>接著是一個一個的慢慢送一百個 requests ，然後取平均值及標準差。</li>
</ol>
<p>若是標準差的值過高，或者是反應時間有增長的現像，那麼這個狀況應該記錄下來，然後使用白箱
測試的工具(如 <a class="reference external" href="http://www.yourkit.com/">yourkit profiler</a> 去找問題的根源。</p>
<p>除了平均數及標準差外，常用的數字還有</p>
<ul class="simple">
<li>mean</li>
<li>standard deviation</li>
<li>minimum</li>
<li>maximum</li>
<li>96   percentile</li>
<li>99   percentile</li>
<li>99.9 percentile</li>
<li>5 minutes moving average</li>
<li>throughput</li>
<li>error rate</li>
</ul>
<p>另外，圖表也是常用的工具，因為相較於數字，圖表更容易看出來趨勢的走向；以下圖為例，藍線的
平均反應時間是1.354秒，但跑load test二十分鐘後，每一個 request 都已經超過了平均數，因
此將數字用圖像來呈現是有助於判別數字的。</p>
<img alt="/images/2012-05-23/chart-1.png" src="/images/2012-05-23/chart-1.png" style="width: 480px;" />
</div>
<div class="section" id="performance-baseline">
<h4>建立 Performance Baseline</h4>
<p>接下來的工作，是定出比較的基礎，建立一個你覺得合理的流量，然後就這個比較基礎去找出來不同
狀況下的平均反應時間及處理量的變化。</p>
<p>基礎效能的建立，我們要先控制兩個變數 <strong>requests per minutes</strong> 及 <strong>number of concurrent requests</strong> ；
透過調整這兩個變數，先找出反應時間較 best case 的流量，然後就此數字開始調整到一個你覺
得合理的值，開始進行 Load Test。</p>
<p>劉接下來我們開始把 <strong>requests per minutes(RPM) 倍增</strong> 但 <strong>number of concurrent requests(CR) 不變</strong> 來看，當流量
增加時應用程式的反應時間會如何增長，接著是 RPM 及 CR 同時都倍增，看反應時間如何增長，
依此規則，就二的次方(2^N)開始往上增加，直到 response 開始嚴重衰退，或者 throughput 開
始衰退。</p>
<p>接著，如果你的應用程式支援 Scale-Out ，那麼，我們依此規則，就 RPM, CR, Machines 三
個變數再次就二的次方(2^N)開始調整流量來做測試。</p>
<p>前面這個過程，可以幫我們了解以下幾件事</p>
<ul class="simple">
<li>應用程式對壓力的反應是如何，當流量被增時，反應時間成長的幅度是線性還是成等比級數成長。</li>
<li>處理量 throughput 是否會隨著 request 數增加而增加，是否在超過某個轉折點時，會開始
反轉下降</li>
<li>上述的轉折點，便可當做未來評估是否需要增加機器或者是昇級機器的基準值。當實既須求接近這
個點，或有事件會造成流量超過這個點，那麼，我們就可以在事前進行反應。或者，在監控應用程
式中加入警告，當線上程式逼近這個值的時候，主動告知我們該加機器了</li>
<li>當我們增加機器時，如果應用程式不是寫成完全 stateless 的，而是有共享資料資源時，那麼
，scale factor便會小於 2，那麼，我們需要關查 scale factor 到底是隨著機器的增加而
不變、還是緩慢成長、或者是快速成長。即使因為某些因素讓我們不能夠準備有實際上線時的機器
數，但是透過分析 scale factor ，我們可以預估上線該使用多少機器。</li>
</ul>
</div>
</div>
<div class="section" id="stress-test">
<h3>Stress Test</h3>
<p>與 Performance Test 不同的是， Stress Test 是看，應用程式在極度的狀況下，是怎麼樣反
應的，是全面性的停止服務，還是仍能正常處理部份的 request ，其餘未能處理的部份是被堆到排
程中等待處理、還是直接收到錯誤訊息告知服務暫時不可用。而當這極端的狀況停下來後，應用程式
是否會自行回復正常，還是需要
重新啟動才能回復正常。</p>
<p>Stress Test 的方式是直接把 performance test 中 <strong>處理量</strong> 開始反轉的那個點的流量再
次倍增，看處理量及反應時間會如何的變化。</p>
</div>
<div class="section" id="longevity-test">
<h3>Longevity Test</h3>
<p>Longevity Test 跟前述兩者不同的是， Longevity Test 是在看，應用程式對長時間、持續性、
平緩的流量是如何反應的，是否在某個時間點會有不良的反應，或者是說會有處理量越來越少或反應時
間越來越長的跡象。</p>
<p>透過 Longevity Test 我們可以發覺
- 應用服務是否有 memory leak
- 是否有背景的排程工作，造成某個時間點系統資源會被大量耗用</p>
</div>
</div>
<div class="section" id="monitoring">
<h2>Monitoring</h2>
<p>除了從應用程式的外部去觀查應用程式的執行效能，我們還可以更進一步的</p>
<ul class="simple">
<li>從作業系統了解CPU, Memory, Disc I/O, and Network Usage</li>
<li>從JVM 了解 Memory Usage, Object counts, GC Cycles.</li>
<li>從應用程式自訂的 metrics 來觀察 request count, method call time, size of queue,
cache hit/miss ratio, etc&#8230;</li>
</ul>
<p>透過截取、記錄、追縱這些數據，搭配上 Performance Test 產生的圖表，我們可以再進一步的了解
應用程式耗用了多少的資源，應用程式的 bottleneck 在那，是 cpu bound, memory bound,
disc io bound or network bound.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">不要小看了這些監控的細節，我的某個程式，有少量用到 ActiveMQ, ZooKeeper 做溝通，照理說
應該是 cpu or memory bound的應用，但是經過幾次 load test ，發覺不管加多少機器，總處
理量還是不變。後來翻了翻OS來的數據才發現，整個環境的網路頻寬被限制在 250M bps ，再進一
步了解到原來 Amazon EC2 的 Load Balancer 把流量限制在這個數字。</p>
</div>
<p>監控的工具有很多種，不過脫不了兩大類
- <strong>監控系統用量</strong> 如: Munin, Graphite, RRDTools
- <strong>監控系統異常</strong> 如: Nagios</p>
<p>這些監控工具，我們不只是可以套用在 Load Test 時使用，更該被大量的佈建在監控線上的應用程
式及外部的服務上，透過長期的追縱，我們可以了解到應用程式及外部的服務的可用度及可靠度。</p>
</div>
<div class="section" id="id3">
<h2>(全文完)</h2>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/22/runtime-quality-metrics-series-2/">軟體品質指標系列(二)：軟體品質指標有那些</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-22T17:49:00+08:00" pubdate data-updated="true">May 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>接下來，我們就來探討，軟體品質指標有那些種類</p>
<div class="section" id="availability">
<h2>可用度 Availability</h2>
<p>一個服務的可用度，是由很多環節組合起來的，某些環節是掌控在開發者手中，某些環節則是
在使用者手中的；對使用者來說，一個服務的可用度，是由底下幾個環節的總合：</p>
<ul class="simple">
<li>軟體本身的可用度</li>
<li>IT/Cloud 架構本身的可用度</li>
<li>服務提供者端的網路環境</li>
<li>外部服務的可用度</li>
<li>使用者端的網路環境</li>
</ul>
<p>在計算 Availability 時，是把上面幾個因素相乘起來，便是你服務的可用度，假設你的IT架構
本身只能提供 99.99% 的可用度，那你的服務本身的可用度將會小於 99.99% 。當然，你可以透
過 Multi-Host 的方式，將服務布建在多個不同 Data Center，此時你的服務可用度，將可超
過單一平台可以提供的可用度。</p>
<blockquote>
假設 Cloud A 可以提供的可用度是 99% ， Cloud B 可以提供的可用度是 98% ，而你將服
務同部布建在兩者之上，那麼兩者一起停機的機會是 (1-99%)*(1-98%) = 0.02% ，因此可靠
度提昇為 99.98% 。</blockquote>
<p>然而，為了提高可靠到而佈建到 Multi-Host 時，不只要把 Presentation Layer / Frontend 放
到多個平台上面去，同時，使用者的資料也要同步到多個平台去，這樣，才能夠必免單一IT平台停機的
問題。但是這麼一來，當停機的平台再次上線時，如何處理資料的不一致問題，便成了另一難題。因此
，多數的服務提供者只會把服務佈建在單一平台上。</p>
<div class="section" id="id1">
<h3>服務提供者端的網路環境</h3>
<p>目前，多數的雲端服務商仍是把主機設立在海外，在台灣沒有 Data Center ，因此，當台灣對外的海
纜出了問題時，雖然服務本身在海外仍是可用的，但是在台灣就連不上線，這一點，也是台灣的開發者
在選用雲端平台時需要考慮進去的。</p>
<p>過去幾年來，台灣對外的海纜，幾乎每兩年都會斷線超過一天。</p>
<blockquote>
<ul class="simple">
<li>2001/02/09 中美海纜遭魚船勾破，數據傳輸容量遽減至原來的四成。HiNet, SeedNet, TaNet 均受影響</li>
<li>2003/10/02 中美海纜遭魚船勾破</li>
<li>2006/12/26 恆春地震造成四條國際海纜中美海纜、法新歐亞三號、亞太光纜一號二號網絡斷線，
影響到台灣對中國、香港、新加坡等東南亞國家和地區，以及上述地區對外的國際通信。耗時三週修複。</li>
<li>2009/08/13 莫拉克颱風造成對外海纜斷線，影響台灣往中國大陸汕頭及東南亞地區，包括新加坡、菲律
賓及香港等地之通信。影響時間超過一週</li>
<li>2010/03/04 高雄甲仙地震造成中美海纜斷線，影響時間超過一個月</li>
<li>2011/11/14 ~ 2012/21/26 海纜進行維修，將造成HiNet連線中國之部份連網服務傳輸延遲時間變長。</li>
</ul>
</blockquote>
<p>若是你服務的對像是以亞洲為主，還是建議放在台灣或日本，若是服務對像以全球為目標，建議還是就放在美國吧。</p>
</div>
<div class="section" id="soa-in-reality">
<h3>外部服務的可用度 / SOA in Reality</h3>
<img alt="/images/2012-05-22/cloud-farm.jpg" src="/images/2012-05-22/cloud-farm.jpg" style="width: 400px;" />
<p>在幾年前，流行的系統架構是 SOA ，讓每一個團隊專注在單一面向功能的服務，將服務透
過SOAP/Restful API供內部及外部的使用者來使用。這樣的好處是，可以增快服務更新的速度減少
測試的範圍，在組織上，也可讓組織將重點放在核心服務上，而將其它的需求委由外部服務處理。</p>
<p>如此一來，對使用者來說，多重 SOA 子服務組合而成的服務，看起來就像是在雲端運行的一台大電
腦，跟舊式的服務並沒有差異。</p>
<img alt="/images/2012-05-22/cloud-server.png" src="/images/2012-05-22/cloud-server.png" style="width: 400px;" />
<p>然而經過幾年的經驗後，大家發現實際上的經驗並不是那麼的美好；如同開頭所說的，服務的可用度，
是所有子服務的總合，單一服務的問題，將會把整體的可用度都拉低。</p>
<p>在我的實務經驗上， SOA 架構，反而變成無止境的 finger pointing ，最後變成，需要對所有外
部服務的可用度做長期的追縱，評估他實際上的可用度。另外，在委外給外部服務時，只會把可以離線
處理的服務委外給外部服務，需要線上即時處理的，還是自行開發較好。</p>
<img alt="/images/2012-05-22/finger-pointing.png" src="/images/2012-05-22/finger-pointing.png" style="width: 400px;" />
</div>
<div class="section" id="service-level-agreement-term-of-service">
<h3>Service Level Agreement / Term of Service</h3>
<p>TBD</p>
</div>
</div>
<div class="section" id="manageability">
<h2>可維護性 Manageability</h2>
<p>可維護性指的是，一個服務在運行時，留下了多少的資料，供 admin 做為判斷服務狀況的依據。一
個線上的服務，除了基本的 log 檔外，還需提供底下的特性</p>
<ul class="simple">
<li>Configurability: 提供設定檔，讓 admin / tester 能夠在不修改程式碼本身，而對軟體的
功能做調整。</li>
<li>Monitorability : 提供開放性的介面，讓 admin 可以很容易的去追縱服務本身的建康狀態及用
量，供 admin 來判斷，是否需要增加硬體的來分散線上伺服器的負擔。</li>
</ul>
<div class="section" id="monitoring-is-must">
<h3>Monitoring is Must</h3>
<p>在提供一個服務時，我們一定要監控服務本身的狀況，並且要把這份資料與外部分享，減少本身溝通的
成本及增加客戶對服務的信任。</p>
<p>不管是設計多麼精良的服務，各個軟體平台商仍免不了會發生大型的災難，如：</p>
<ul class="simple">
<li>Amazon AWS 於 2008, 2010, 2011 各發生過數小時的問題，造成 EBS 使用上的問題，導
制 reddit, zynga 等下遊廠商的服務問題</li>
<li>Google Gamil 於 2009 年發生過大形的停機，耖造成拳體用戶無法使用 Gmail 兩個半小時。</li>
<li>Azure 於 2012/02/29 ，由於時間同步的問題，造成用戶無法開啟新的 VM instance.</li>
</ul>
</div>
</div>
<div class="section" id="performance">
<h2>Performance</h2>
<p>效能，算是個最常用的品質指標了，在講效能時我們通常會分成兩塊來講，一塊是反應時間(Response Time)，
另一塊是處理量(throughput)，前者只的是服務單一需求所要花的時間，後者則是單位時間內，可同
時服務的總需求數量。</p>
<p>影響效能的因素有很多，在多數的系統中，往往處理量增加的結果就是反應時間也一起增加，因此在系
統設計的初期，這些就要納入規格中，變成設計的一環；那麼，什麼是好的效能呢？在反應時間這邊有
個很好的指標，就是跟人互動的UI程式，如果反應時間能壓在 100ms 以下，那麼人們的認知就會覺的
這個程式是即時使用的，如果反應時間拉到 200ms 以上，就會開始覺得頓頓的。</p>
<p>對於網頁程式來說，反應時間不只是從 Web Server 這一端出去的時間，還要算上網路傳輸的時間以
及流覽器繪製畫面的時間，因此能留給網站主機的反應時間只剩下 50ms 上下；如果你的程式還有呼叫
其於的外部程式，那麼每多一層，反應時間至少增加 20ms ，或者是說少 20ms 給你的程式使用。</p>
</div>
<div class="section" id="reliability">
<h2>Reliability</h2>
<p>可靠度(Reliability)跟可用度(Availability)是兩個常被弄混的名詞，Availability講的是，
在一段長的時間內，系統可被使用的時間(Up Time)，Reliability則講的是在單位時間內，系統出
錯的次數。一個線上服務，可能是可用的(Available)但是他的輸出結果是有問題的(Unreliable)</p>
<p>Reliability 的評量指標有</p>
<ul class="simple">
<li>單位時間內，回傳錯誤訊息或者是無回應的次數。</li>
<li>單位時間內，輸出結果是錯誤的次數。</li>
</ul>
<p>Reliability的問題，往往是系統內的 Bug ，只是在使用量大時，才會凸顯他的存在，因此軟體開發
者不可忽略這微小的訊號。</p>
</div>
<div class="section" id="scalability">
<h2>Scalability</h2>
<p>Scalability 講的是你的服務能不能夠隨著用戶數的增長，而跟著成長，服務的可延展性可以分為
， <strong>直向擴充 Scale Up</strong> 及 <strong>橫向擴充 Scale Out</strong> ，兩者都可以幫你增加可同時服務的
線上用戶數，但是後者的可擴充的程度，仍是遠高過前者的。</p>
<p>Scalability 讓我們動態的依事件配置不同數量的伺服器數量，以防止 Slashdot Effect 的發生
，如總統大選或報稅截止日等事件，往往會在一日內擁入超過平日百倍的用戶數，如何讓服務正常運做
，是軟體品質極重要的一環。</p>
<p>而 Scalability 對 Application Service Provider 更是重要，因為 Cloud Based ERP or CRM 系
統，較一般的網頁更有黏著性，一個有數萬個用戶的中型網站，同時間上線的用戶可能只有數百個，而
於他們的 Session 中存的資料也只有數 kilo bytes。然而對企業用戶來說 Cloud Based ERP, CRM ，
在上班時間，可是一直在使用的，一間 200 人公司用的 ERP 系統，可能就會有 200 active sessions ，每
個 Session 又存了許多正在處理中的表格資料。</p>
<p>如何 scale up/out database intensive application 變成 ASP 提供者不得不面對的難題。</p>
</div>
<div class="section" id="security">
<h2>Security</h2>
<p>網路服務的安全性問題，常常是個被誤會且忽略的問題，台灣許多主流的 Hosting Company 及 Billing Provider 的網站都出
過問題；他們的問題是，某本常用的軟體手冊的程式碼，在教導如何實作使用者認證時，只有在首頁
有檢查帳號，等帳號檢查過了，就會被導到內部的網頁去，然而，在內部網頁這邊，卻沒有檢查使用
者有沒有登入。</p>
<p>變成，只要得知內部網業的網址(form target)就可以直接存取內部的資料，因此，許多網站就
被 Search Engine Crawler 長驅直入，把所有的使用者資料都放在搜尋結果中公開了。至於實際
的例子我就不多舉了。</p>
<p>另外我有寫過一篇 <a class="reference external" href="/blog/2012/01/03/how-to-protect-a-webservice/">專文</a> 討論，該如合保護一個 WebService ，台灣的政府及民間網站，常常
用一些沒有被認可的電子簽證來做 https 的安全通訊，然而 https 的金鑰交換，在第一次是不安
全的，因此，若是你的金鑰是沒有經過第三方簽核的，那麼再交換金鑰時可能會受到 <a class="reference external" href="http://en.wikipedia.org/wiki/Man-in-the-middle_attack">Man in
the middle attack</a> 直接把金鑰換掉。</p>
<p>使用 https 時，必需遵守幾個使用規範，這樣子通訊才會是安全的。</p>
<p>回到正題，服務的安全性可以分為幾塊</p>
<ul class="simple">
<li>通訊的安全性。</li>
<li>身份的認可查核</li>
<li>資料的安全性及使用權限</li>
<li>資料的使用及變更的計錄追蹤</li>
</ul>
</div>
<div class="section" id="id3">
<h2>待續</h2>
<p>在下一篇，我將講述，如何把這些概念，轉換成實際的數值指標。</p>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/17/runtime-quality-metrics-series-1/">軟體品質指標系列(一)：為什麼軟體開發者需要在意軟體品質指標</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-17T11:01:00+08:00" pubdate data-updated="true">May 17<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>下個月受軟協的邀請，要跟國內發展雲端服務的廠商講一場演講，原本想講的是 Coda Hale 的 <a class="reference external" href="http://metrics.codahale.com/">metrics library</a> 的使用
不過跟軟協的詹副秘書長聊了一聊後，決定把主題改成 <em>軟體品質</em> ，畢竟，太偏實作的東西，拿來給
中高階主管聽，可能會睡著吧 XD</p>
<div class="section" id="id1">
<h2>軟體品質指標</h2>
<p>一般我們在談軟體績效指標時，多講的是 <em>Lines Of Code</em>, <em>Number of Functions</em>, <em>Number of Classes</em>
, <em>Cohesion and Coupling</em>, <em>Test Coverage</em> 等，但是，我今天想講的不是這些靜態分析所使
用的指標，而是在程式運行時的評量指標 Production/Runtime Quality Metrics。</p>
<p>這些執行階段的品質指標，讓我們了解程式在運行時的效率(performance),可靠度(reliability),可
用度(availability),維護性(maintainability)等重要問題。</p>
</div>
<div class="section" id="id2">
<h2>為什麼我們要在意這些指標</h2>
<p>在台灣的許多軟體公司可能會問，為什麼我們需要在意這些指標？這些指標又不能拿來賣，客戶在意的
是功能及價錢，開發客戶所需要的功能及尋找客戶，比做這些沒辦法拿來賣錢的東西重要多了。部份中小
企業主認為，找案子跟找錢，才是軟體公司生存之道，軟體品質，是可以在案子簽下來後甚至結案時在去
關心就好。</p>
<img alt="/images/2012-05-17/busy_1.png" src="/images/2012-05-17/busy_1.png" />
<img alt="/images/2012-05-17/busy_2.png" src="/images/2012-05-17/busy_2.png" />
<p>但是，如果我們換一個角度來看，這些執行階段的指標，也可以是軟體功能的一環，可以當做銷售時期
的功能及策略性武器來看；試想，若是有兩家小公司來賣你雲端服務，一間滿口都是功能可以做到OOXX
，我們的服務是一條龍，什麼都做的到。另一間則是把功能的項目清楚的定意出來，同時也告訴你，他們
的服務同時可以服務多少客戶、過去的停機維修週期是多少、他們可以保障的可靠度是多少；身為專案採
購人員的你，會比較 <strong>信任</strong> 那一家的說法呢？</p>
</div>
<div class="section" id="id3">
<h2>軟體賣的就是信任</h2>
<p>軟體賣的就是信任，信任你的軟體，不會出問題把客戶的重要商業資料、商業流程、及客戶關係都一起毀掉。</p>
<dl class="docutils">
<dt>在過去單機板的軟體環境下，軟體賣的是</dt>
<dd><ul class="first last simple">
<li>信任軟體的功能有達到預期目標</li>
<li>信任軟體不管跑多少次，都有一致性的輸出</li>
<li>信任軟體的資料儲存是可靠的</li>
<li>信任軟體的資料可以轉換到另一個昇級版本或其它軟體</li>
</ul>
</dd>
</dl>
<p>許多單機版或 2-Tier 的程式，經過時間的證明，他們的生命週期，甚至超過了開發者的生命週期，許多
國內百貨零售業用的進銷存系統，目前仍是在用20年前的 DOS 系統就是一例。對客戶來說，他們對這些DOS版
軟體的信任，超越了新科技所帶來的新功能需求。只要更新硬體，他們就可以繼續使用這些軟體，甚至是享受新
硬體所帶來的更高效能。</p>
<p><strong>信任</strong> 在雲端服務上，更是重要；在享受雲端服務的便利的另一方面，雲端服務的使用者更是需要放更多
的信任在服務提供商上，除了上述的信任外，客戶還要信任你的服務可以隨著他的服務及你的服務一起增長。</p>
<div class="section" id="slashdot-effect">
<h3>Slashdot Effect</h3>
<p>在談服務的可靠度時，我常用 <a class="reference external" href="http://en.wikipedia.org/wiki/Slashdot_effect">slashdot effect</a> 來當例子，換成中文就是「爆紅效應」，slashdot 是
國外一個很大的科技網站，一登上 slashdot 的首頁，在短短的一天內，就可以帶來數十萬的訪問數及數萬的註
冊會員，然而，爆紅後帶來的往往是個災難，許多的軟體在設計、佈建(deployment)時，並沒有考量到會有這麼
大量的用戶，因此一爆紅後往往就是停機收場。</p>
<p>overnight success turns into overnight disaster. 爆紅後，留下的是一些不滿意的負面記錄，
讓客戶及潛在客戶，喪失了對服務的信任；在這個有 Google 等搜尋引擎的年代，過去的不良記錄將永久留
存在網路上，因此，服務的 <a class="reference external" href="http://horicky.blogspot.com/2009/07/between-elasticity-and-scalability.html">可延展性(Scalability &amp; Elasticity)</a> 變的格外重要。</p>
</div>
</div>
<div class="section" id="id5">
<h2>如何建立信任</h2>
<p>信任是個很抽象的名詞，你摸不到看不到，但是卻在人與人的往來，無形中慢慢的形成；信任就如宗教信仰一樣，
你無法買到，無法強迫別人去接受、也無法一促即成，只能一步步的去建立。</p>
<p>但是，我們是軟體工程師，我們信仰的是科學、是工程技術、是數字管理，我們善長的是透過科學的研究手法，
一步步的去拆解問題，弄清楚什麼是已知的事實，什麼是未知的問題，面對問題，解決問題。</p>
<p>販賣口號，不是軟體工程師所善長及該做的。</p>
<img alt="/images/2012-05-17/we-can-do-it.jpg" src="/images/2012-05-17/we-can-do-it.jpg" />
</div>
<div class="section" id="id6">
<h2>可量化的軟體品質就是信任的來源</h2>
<p>對於中小企業及新進入雲端服務的公司，「可量化的軟體品質指標」就是可以最快取得客戶信任的方式；我希望
在未來的某一天，我可以聽見台灣的軟體公司是這麼介紹自己的產品</p>
<blockquote>
我們的網路服務，能夠同時服務兩百萬上線用戶，提供 50ms 以下的即時性的反應，我們的服務，整合了超過
40個內部及外部的開發商客戶，在過去的兩年內，我們提供了 99% availability ； Agile 的開發流程，
讓我們有一致的服務更新週期，面對軟體 Bug 我們能夠提供客戶一個預計的修正時間，並準時將補丁上線。</blockquote>
<p>待續&#8230;</p>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/17/ridiculous-rule-change/">鬼島之鬼交通法規變革</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-17T00:35:00+08:00" pubdate data-updated="true">May 17<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近脾氣好像大爆發，對鬼島的很多事情很不爽。覺得真的沒救了，核四當然是最大問題，另一塊大問題就是台灣的法規。</p>
<p>台灣的法規許多就是官員我說了算，沒什麼科學根據的；不像美國法律，很多(交通)法規，你細看下去，其實滿滿的是學理，而不是中國人的想當然爾。</p>
<p>今天又看到個鬼島的鬼例子，原來CRV2上市前，被國內車商整，推動交通部去改法規，
<a class="reference external" href="http://www.mobile01.com/topicdetail.php?f=261&amp;t=1881390&amp;p=2#24145485">讓CRV2不適用小客貨車的15%稅率，而要用35%的稅率，讓CRV一台要多繳12萬的稅</a> ，喪失產品競爭力。</p>
<p>民國91年五月前的原本的條文是:</p>
<pre class="literal-block">
 三、客貨兩用車：
（一）大客貨兩用車：總重量逾三、五ＯＯ公斤，並核定載人
     座位，或全部座位在一Ｏ座以上，並核定載重量之汽車。
（二）小客貨兩用車：總重量逾三、五ＯＯ公斤以下，並核定
     載人座位及載重量，或全部座位在九座以下，而又核定
     載人座位及載重量之汽車。
</pre>
<p><strong>91年五月後被改成</strong>:</p>
<pre class="literal-block">
 三、客貨兩用車：
（一）大客貨兩用車：總重量逾三千五百公斤，並核定載人座位，或全部
     座位在十座以上，並核定載重量之汽車。
（二）小客貨兩用車：總重量在三千五百公斤以下，或全部座位在九座以
     下，並核定載人座位及載重量，其最後一排座椅固定後，後方實際
     之載貨空間達一立方公尺以上之汽車。
</pre>
<p>不知道當年立法單位，跟據什麼原則理由，做出這樣的變革的？原本後排座椅可前後移動，車輛使用更有彈性，不知為何要走倒退路呢</p>
<p>看來，答案可能就如同 <a class="reference external" href="http://www.mobile01.com/topicdetail.php?f=444&amp;t=2737205&amp;p=4#35905978">01 上 爆料</a> 的一樣，是被國慘車王子整了</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/08/shall-patent-apply-to-business-model/">Shall Patent Apply to Business Model</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-08T14:27:00+08:00" pubdate data-updated="true">May 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>看到 Oracle 告 Google 被判定 API 也可享有著作權，讓我想到我非常多年
前授教於劉靜怡教授底下，集各家大成(抄襲)而成的一篇期末報告。</p>
<p>至於到底什麼該被 Patent 保護，什麼不該被 Patent 保護，What is patent worth，日
後，受教於 <a class="reference external" href="http://econ.arizona.edu/faculty/pingry.asp">Dr. David E. Pingry</a> 時，他用了一個 <a class="reference external" href="http://www.sciencedirect.com/science/article/pii/S0167923604002374">方程式</a> ，回達了我的問題。</p>
<p>數學模型之美，差點讓我改念 Econ PhD. 還好我太愛玩英文寫作又太差，所以沒有繼續念博士。</p>
<p>時光飛逝，我的年紀已比初識劉教授，教授當時的年紀還大了，十多年過去，我從那個長髮怪變怪叔叔了，
在專業上還是一事無成阿&#8230;</p>
<div class="section" id="shall-business-model-apply-to-patent">
<h2>Shall Business Model Apply to patent?</h2>
<p>前言：</p>
<p>1999年10月21日，全美第一大網路書籍、音樂零售商亞馬遜書店（Amazon）於西雅圖地方法院提出告訴，主張美國第一大書店Barnes &amp; Noble所設立的網路
書店barnesandnoble.com侵害其於同年9月28日獲准享有專利權之「1-Click technoloby」（Patent No. 5,960,411）；掀起了全球對商業模式是否適用
於專利權的重視。而國內經濟部智慧財產局與中華民國發明協會於2000年04月11日在台北國際會議中心舉辦的一場「新電子商務教戰守策國際研討會」，更
是讓這個話題在國內變的熱門起來。</p>
<dl class="docutils">
<dt>到底是否商業模式是否適用於專利權保障，本文將就下列幾個論點進行討論：</dt>
<dd><ul class="first last simple">
<li>一、商業模式適用於專利權的法源基礎</li>
<li>二、商業模式適用於專利權造成的影響</li>
<li>三、各國對於商業模式適用於專利權造成紛爭的回應</li>
<li>四、專利法在人類社會到底該辦演的是何種角色？又專利法該適用於商業模式嗎？</li>
<li>五、商業模式失去了專利權保障，網路公司該如何獲利</li>
</ul>
</dd>
</dl>
<p>冀望透過一系列的思考，將問題釐清頭緒</p>
</div>
<div class="section" id="id2">
<h2>一、商業模式適用於專利權的法源基礎</h2>
<p>在過去，電腦軟體一向被認為僅得受到著作權法及營業祕密法之保護，而無法申請獲准專利，在資訊產業一向居於領導地位的美國，其實務界在以往亦認為
電腦軟體不得申請專利，然而在軟體產業高度發展且各項軟體之應用日趨商業化後，軟體研發成果之週全保護成為不得不正視之議題，許多企業為確保其商
業之經營與投資，一再試圖尋求軟體之專利保護，一九八一年之Diamond v. Diehr一案，其中牽涉到的係一個以數學公式為基礎之電腦程式應用於控制橡
膠製模成形的時間，美國聯邦最高法院此一判決使電腦軟體至少確保了可獲得專利法保護之可能性。[1]</p>
<p>為實務上運作之需要，美國專利商標局（US PTO）隨即於一九九六年公佈了「電腦相關發明審查基準」
（Examination Guidelines for Computer-Related Invention），明定審查基準為機械、方法、製造品之法定標作為專利商標局審查軟體專利時之依據。</p>
<p>原本美國專利商標局審查員逕可核駁商業方法(Method of Doing Business)請求，但美國聯邦巡迴上訴法院於State Street Bank and Trust Company, v.
Signature Finacial Group, Inc.(38 USPQ2d 1530, 927 F. Supp. 502.) 一案中判決『審查員審查專利申請案含有商業方法請求項時，不可逕將該請求項
歸類成商業方法，而應以方法請求項進行實質審查』。此即商業方法申請案若符合可專利要件，再經審查員審定者，亦可能獲證。[2]</p>
<p>與State Street Bank &amp; Trust Co. v. Signature Financial Group Inc.,(47 U.S.P.Q.2d 1596（Fed. Cir. 1998). cert. denied, 119 S.Ct. 851）一
案中，判決確認一項用於網際網路之商業方法(business method）軟體具有可專利性（patentable subject matter）[3]</p>
<p>自此，造就了商業模式適用於專利權的法源基礎，也開啟了另一新的網路專利戰爭，許多網路公司，將賴以為生的技術與商業模式權利化、法律化。冀藉此
將競爭者排除於電子商務領域之外。</p>
</div>
<div class="section" id="id3">
<h2>二、商業模式適用於專利權造成的影響</h2>
<p>從去年 9月中至今，在美國即發生了數件與電子商務有關的專利訴訟，因為訴訟當事人均是諸如Microsoft、Amazon、Barnes&amp;Noble、DoubleClick等在電子
商務界舉足輕重的大公司，乃引發網路界的重大關切。底下就依發生時間簡述案件的經過。[4]</p>
<div class="section" id="priceline-commicrosoft">
<h3>1.priceline.com控告Microsoft</h3>
<p>1999年10月13日priceline.com Inc.於美國康乃狄克州地方法院對Microsoft提出告訴，主張Microsoft所提供之網路旅館價格拍賣 (Hotel Price Matching
System) 侵害其享有專利權之reverse auction patent (patent 5,794,207)，因為Microsoft於卓站中的Expedia travel site提供一套名為「name your price」
系統，由網路使用者輸入旅遊地點、希望的旅館等級及預算後，選出最適合該使用者之旅遊行程，並自動將該使用者之信用卡號碼寄給接受該筆交易的旅館
。而上述「name your price」系統所應用的商業方法正是priceline.com Inc.申請獲准之5,794,207專利涵蓋的範圍。</p>
</div>
<div class="section" id="amazonbarnesandnoble-com">
<h3>2.Amazon控告barnesandnoble.com</h3>
<p>繼priceline.com Inc.之訴訟後，全美第一大網路書籍、音樂零售商亞馬遜書店 (Amazon) 於10月21日在西雅圖地方法院提出告訴，主張美國第一大書店
Barnes &amp; Noble所設立的網路書店barnesandnoble.com侵害其於1999年09月28日獲准享有專利權之「1-Click technoloby」 (Patent No. 5,960,411) 。</p>
<p>Amazon於訴訟中除請求相當於三倍合理權利金之損害賠償及訴訟費用外，Amazon更申請法院發布禁制令，禁止Barnes &amp; Noble繼續使用相同之商業方法。
於禁制令頒布後，Barnesandnoble.com即表示將於近日內推出一種名為「Express Checkout」的新服務，並指出該公司將提出上訴，因為Amazon所獲得的專利其
實是一種早被廣泛使用的科技。</p>
</div>
<div class="section" id="doubleclickl90-inc">
<h3>3.DoubleClick控訴L90 Inc.</h3>
<p>知名的網路廣告DoubleClick於1999年11月12日向維吉尼亞州東區地方法院控訴加州網路公司 L90 Inc.侵害其有關傳輸、鎖定與衡量網路廣告之專利「Method
of Delivery,Targeting and Measuring Advertising over the Internet」(Patent No. 5,948,061) 。</p>
<p>由於該專利為目前多數網路廣告普遍採行的方式，因此倘若法院判決DoubleClick勝訴者，則絕大多數提供網路廣告的公司通通都會被逐出該市場而無法繼續經營。</p>
<p>上述的三個案例，均有利用專利訴訟來達到排除競爭對手目的的意味，此外其專利在獨創性上更有所爭議；將已普遍使用的技術通過專利申請，US PTO對於
專利的發放是否過於浮爛呢？</p>
</div>
</div>
<div class="section" id="id4">
<h2>三、各國對於商業模式適用於專利權造成紛爭的回應</h2>
<p>跟據電子時報2000年05月05日的報導[5] ，日本、美國與歐盟 (EU) 的專利組織日前宣佈，將加強在電子商務商業模式 (Business Model) 專利權審核方面
的合作，以創造合適的環境，幫助新產業發展。三方國家組織的專利機構將以建立國際共同的認定標準為目的，預計2002年架構既有商業模式專利資料庫，
共享各種資訊。各國將強化在專利資訊上的交流，共享審核報告、法院判例等資訊。各專利機構也將進行專利權實例分析，以建立公認的專利認定標準，並
共同對負責審核的法官進行教育。由於電子商務可能是跨國經營，在某一國家的企業可能在另一國家侵犯其他企業的專利，各國必須及早建立共同的標準。</p>
<p>美國對商業模式專利的認定甚為積極，1999年約有600件專利權申請獲得通過。從1999年層出不窮的專利訴訟可知一斑。美國政府指出，商業模式專利對產業
發展是不可或缺的一部份，由於負責的法官對電子商務專利審核的經驗與資料可能較為欠缺，美國將盡力給予日本、歐洲等國家有關此方面的協助。</p>
<p>各國預定在七月舉行的國際高峰會議中達成共識，將從嚴訂定審核標準。除保障申請專利者的權益外，也要防止專利權被濫用。</p>
</div>
<div class="section" id="id5">
<h2>四、專利法在人類社會到底該辦演的是何種角色？</h2>
<p>專利法該適用於商業模式嗎？</p>
<p>中華民國專利法第一條便開宗明義宣告「為鼓勵、保護、利用發明與創作，以促進產業發展，特制定本法。」而世界各國的專利法也是依此原則所立法。</p>
<p>基本上經濟學家認為，專利權的存在具有兩個功用─創作 (Invention)與創新 (Innovation) ，前者指的是從事發明的行為，後者指的是將發明市場化。接
著本文將從這兩個角度來探討專利法該適用於網際網路的商業模式嗎？</p>
<div class="section" id="id6">
<h3>1.創作動機理論</h3>
<p>創作動機理論或許是最常見為專利權背書的經濟學理論，這理論認為，專利權的存在是在鼓勵那些若失去專利權保障便不會發生的發明。也就是說專利權提
供了發明的誘因。從反方向來思考，對於不須要專利權保障便會發生的發明是否便不須要給與專利上的保障呢？</p>
<p>根據 IDC公司估計，至2002年全球透過網際網路網站之交易金額將突破4000億美元。究竟在如此龐大的經濟誘因之下，失去專利權保障，各種不同的網際網
路商業模式難到就不會被發明嗎？</p>
</div>
<div class="section" id="id7">
<h3>2.創新理論</h3>
<dl class="docutils">
<dt>創新理論認為</dt>
<dd><ol class="first last arabic simple">
<li>對大公司來說，由於政府規定對於專利權的標的物必須充分揭露資料，為了避免在專利過期後無償被公眾使用，在專利權期間必定會大量授權給其它廠商以謀取利益。</li>
<li>對創業家來說擁有獨佔的專利權，較容易於市場上集資。</li>
</ol>
</dd>
</dl>
<p>相較於後者的說法，前者應用在網際網路商業模式時便不太恰當，由於電子商務是屬於全球化的競爭，將商業模式授權給它人僅會增加競爭對手，且在變化
快速的網際網路上，一個好的商業模式很可能在半年內便被另一個更好的取代，因此相較於開放市場，倒不如獨占市場較有利可圖。</p>
<p>綜觀上述兩點，本文認為商業模式適用於專利權並不恰當。</p>
</div>
</div>
<div class="section" id="id8">
<h2>結尾、商業模式失去了專利權保障，網路公司該如何獲利</h2>
<p>寫在最後本文想要引入一個觀念，就是由 Richard M. Stallman與自由軟體基金會[7] 所倡導的 Free Software與Eric Raymond的OpenSource中的軟體無價
服務有價；將技術開放出來成為公共財，促進整體經濟的繁容，而透過應用技術的服務賺取利潤。</p>
<p>對於商業模式的發明者來講，一個新的商業模式，從一開始便擁有市場的競爭優勢，外在的進入者在進入這個市場的時候就必須跨過這個關卡，受不受到專
利權的保障似乎並不那麼重要。</p>
</div>
<div class="section" id="id9">
<h2>參考資料：</h2>
<dl class="docutils">
<dt>[1]電腦軟體專利對電子商務之影響</dt>
<dd><a class="reference external" href="http://www.ithome.com.tw/column/eclaw/eclaw20000224.html">http://www.ithome.com.tw/column/eclaw/eclaw20000224.html</a></dd>
<dt>[2]美國電子商務專利之最新動態</dt>
<dd><a class="reference external" href="http://stlc.iii.org.tw/publish/ipma/23/2305.htm">http://stlc.iii.org.tw/publish/ipma/23/2305.htm</a></dd>
<dt>[3]Internet Business Methods: What Role Does and Should Patent Law Play?</dt>
<dd><a class="reference external" href="http://scs.student.virginia.edu/~vjolt/graphics/vol4/v4i2a9-grusd.html">http://scs.student.virginia.edu/~vjolt/graphics/vol4/v4i2a9-grusd.html</a></dd>
<dt>[4]電子商務網路專利世紀大戰－從Amazon告Barnes Noble侵權談起</dt>
<dd>電子時報  1999.12.14  網路與軟體專欄</dd>
<dt>[5]日美歐加強EC專利審核</dt>
<dd><a class="reference external" href="http://news.kimo.com.tw/2000/05/05/technology/digi/320333.html">http://news.kimo.com.tw/2000/05/05/technology/digi/320333.html</a></dd>
</dl>
<p>[6]ROBERTO MAZZOLENI &amp; RICHARD NELSON, ECONOMIC THEORIES ABOUT THE BENEFITS AND COSTS OF PATENTS (1996).</p>
<p>[7]http://www.fsf.org</p>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/30/mongodb-dao/">Mongodb Scala DAO</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-30T11:50:00+08:00" pubdate data-updated="true">Apr 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>這篇文章將說說，我使用 MongoDB &amp; Cashbah 的一些心得，這程式的主架構是
我從 <a class="reference external" href="https://github.com/aboisvert/simplistic">simplistic</a> 學來的。</p>
<div class="section" id="the-abstract-dao">
<h2>The Abstract DAO</h2>
<p>底下是一個很簡單的 CRUD 的 MongoDB DAO. 在這邊，我們建立一個 DAO 時，我們會把這
個 DAO 用的儲存空間 MongoCollection 傳進來，另外要注意的一點是，這個 MongoCollection 的
WriteConcert 必需是 Strict 的。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> *  Base class for all DAO classes.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">AbstractDAO</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ID</span> <span class="k">&lt;:</span> <span class="kt">Serializable</span><span class="o">](</span><span class="k">protected</span><span class="o">[</span><span class="kt">locadz</span><span class="o">]</span> <span class="k">val</span> <span class="n">mongoCol</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** builder to turn mongodb object into model object */</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">builder</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">T</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** builder to turn model object into mongodb object */</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">extractor</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="nc">DBObject</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** this dao expects the underlying mongoCol would throw exception when error occurs. */</span>
</span><span class="line">  <span class="n">require</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">  <span class="n">require</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span><span class="o">.</span><span class="n">getW</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="s">&quot;Write must be &gt;= 1, was %d&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span><span class="o">.</span><span class="n">getW</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** insert object into the underly*/</span>
</span><span class="line">  <span class="k">def</span> <span class="n">insert</span><span class="o">(</span><span class="n">obj</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">ID</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">(</span><span class="n">obj</span><span class="o">)</span>
</span><span class="line">      <span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">WriteResult</span> <span class="o">=</span> <span class="n">mongoCol</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span><span class="n">dbObj</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">ID</span><span class="o">](</span><span class="s">&quot;_id&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span>      <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">save</span><span class="o">(</span><span class="n">obj</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">DataAccessException</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">res</span> <span class="k">=</span> <span class="n">mongoCol</span><span class="o">.</span><span class="n">save</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">obj</span><span class="o">)</span>
</span><span class="line">      <span class="nc">None</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span>      <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">findById</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">ID</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="n">mongoCol</span><span class="o">.</span><span class="n">findOneByID</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">None</span>        <span class="k">=&gt;</span> <span class="nc">Right</span><span class="o">(</span><span class="nc">None</span><span class="o">)</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">dbObj</span><span class="o">).</span><span class="n">right</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">Option</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">delete</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">ID</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">DataAccessException</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="n">mongoCol</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="nc">MongoDBObject</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="n">id</span><span class="o">))</span>
</span><span class="line">      <span class="nc">None</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">find</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">builder</span><span class="k">:</span> <span class="o">(</span><span class="kt">DBObject</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">Iterable</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">        <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">found</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">          <span class="n">builder</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">found</span><span class="o">).</span><span class="n">fold</span><span class="o">(</span>
</span><span class="line">            <span class="n">e</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="n">e</span><span class="o">,</span>
</span><span class="line">            <span class="n">r</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">r</span><span class="o">))</span>
</span><span class="line">        <span class="o">}).</span><span class="n">toStream</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>這邊有兩個需要被實作的東西</p>
<ul class="simple">
<li><cite>val builder: DBObject =&gt; Either[DataAccessException, T]</cite></li>
<li><cite>val extractor: T =&gt; DBObject</cite></li>
</ul>
<p>而怎麼建立這兩個東西，就是全文的重點了。</p>
</div>
<div class="section" id="how-to-use-abstractdao">
<h2>How to use AbstractDAO</h2>
<p>先來看一個範例；實作上，在 UserDAO object 上，我們先把欄位的名稱及資料型態，一個個的定好</p>
<ul class="simple">
<li>&#8216;val Name = attribute(&quot;name&quot;, Conversion.String)`</li>
<li>&#8216;val Email = attribute(&quot;email&quot;, Conversion.String)&#8217;</li>
<li>&#8216;val CreateDate = attribute(&quot;ctime&quot;, Conversion.JodaDate)&#8217;</li>
</ul>
<p>而這個 attribute method 做的是，把資料名稱存起來，然後當這個 Attribute instance</p>
<ul class="simple">
<li>收到一個 DBObject 時，把對應的欄位取出來，並將值給轉成定義的格式</li>
<li>收到一個 property value 時，把他轉成 (name -&gt; value) pair</li>
</ul>
<p>第一個用法的這個方式，用在從 <em>builder</em> 上面，一個個的把值從 DBObject 抓出來再來建立物件，
第二個用法用在，把物件轉成 DBObject 時，及用在建立 query 時。</p>
<div class="section" id="userdao">
<h3>UserDAO 實作</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">UserDAO</span><span class="o">(</span><span class="n">mongoCol</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AbstractDAO</span><span class="o">[</span><span class="kt">User</span>, <span class="kt">String</span><span class="o">](</span><span class="n">mongoCol</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">UserDAO._</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">builder</span><span class="k">:</span> <span class="o">(</span><span class="kt">DBObject</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="nc">UserDAO</span><span class="o">.</span><span class="n">dbObjectToUser</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">extractor</span><span class="k">:</span> <span class="o">(</span><span class="kt">User</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">DBObject</span> <span class="k">=</span> <span class="nc">UserDAO</span><span class="o">.</span><span class="n">userToDBObject</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="k">this</span><span class="o">(</span><span class="n">dbCol</span><span class="k">:</span> <span class="kt">DBCollection</span><span class="o">)</span> <span class="k">=</span> <span class="k">this</span><span class="o">(</span><span class="n">dbCol</span><span class="o">.</span><span class="n">asScala</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">UserDAO</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">Attributes._</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">Name</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">Email</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">CreateDate</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;ctime&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">JodaDate</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">dbObjectToUser</span><span class="o">(</span><span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="n">dbObj</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;_id&quot;</span><span class="o">).</span><span class="n">get</span>
</span><span class="line">
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span>
</span><span class="line">        <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span>
</span><span class="line">          <span class="nc">Name</span><span class="o">(</span><span class="n">dbObj</span><span class="o">),</span>
</span><span class="line">          <span class="nc">Email</span><span class="o">(</span><span class="n">dbObj</span><span class="o">),</span>
</span><span class="line">          <span class="nc">CreateDate</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">        <span class="o">)</span>
</span><span class="line">      <span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">def</span> <span class="n">userToDBObject</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="nc">MongoDBObject</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">Name</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">externalId</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">Email</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">verifiedId</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">createDate</span><span class="o">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">ret</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="attribute-conversion">
<h3>Attribute &amp; Conversion 部份實作</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
</span><span class="line">  <span class="k">val</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class="line">  <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">throw</span> <span class="k">new</span> <span class="nc">MissingRequiredAttributeException</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">new</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">B</span>
</span><span class="line">  <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">Conversion</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">String</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">source</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">value</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Conversion for DateTime to DateTime.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="k">object</span> <span class="nc">JodaDate</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">DateTime</span>, <span class="kt">DateTime</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nc">RegisterJodaTimeConversionHelpers</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=</span> <span class="n">source</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=</span> <span class="n">value</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
<div class="section" id="how-to-use-attributes-to-build-query">
<h2>How to Use Attributes to Build Query</h2>
<p>前面的 Attribute(s) 不只是用來產做 builder 及 extractor 用的，他們最好用的地方在於
建立 query 時，如下</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">findByDateRange</span><span class="o">(</span><span class="n">start</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">return</span> <span class="n">find</span><span class="o">(</span><span class="nc">CreateDate</span><span class="o">.</span><span class="n">name</span> <span class="nc">$gth</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">start</span><span class="o">).</span><span class="n">_2</span>  <span class="nc">$lt</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">range</span><span class="o">).</span><span class="n">_2</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>這邊，我們可以看到用 Conversion 來描述資料型態的好處是，當你儲存的資料型態有變時，你不用去更
改你的 MongoDB query ，欄位的名稱、資料型別的轉換，都被封裝起來，使用者在寫 Query 時，不用去
記欄位的名稱，也不用去記這個欄位的型態是什麼， MongoDB 支不支援這個型態。</p>
<p>第二個好處是， Casbah 本來只支援 java primitive type &amp; java.util.Date ，透過 Conversion ，
我們可以支援任意的資料型態於 query 中，只要透過新的 Conversion 類別，我們就可以增加 MongoDB 可以
支援的資料型態。</p>
<p>例如，如果我們想增加對 <cite>java.net.URL</cite> 的支援，只要訂義以下的 Conversion 即可</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">object</span> <span class="nc">Url</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">URL</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">URL</span><span class="o">)</span> <span class="k">=</span> <span class="n">source</span><span class="o">.</span><span class="n">toExternalForm</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">URL</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="appendix">
<h2>Appendix:</h2>
<div class="section" id="attribute-scala">
<h3>Attribute.scala</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">package</span> <span class="nn">com.locadz.model.mongodb</span>
</span><span class="line">
</span><span class="line"><span class="k">import</span> <span class="nn">com.mongodb.DBObject</span>
</span><span class="line"><span class="k">import</span> <span class="nn">com.mongodb.casbah._</span>
</span><span class="line"><span class="k">import</span> <span class="nn">com.locadz.model.exception.MissingRequiredAttributeException</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Date: 2/20/12</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">object</span> <span class="nc">Attributes</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
</span><span class="line">    <span class="k">val</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">OptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Any</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">v</span> <span class="k">=</span> <span class="n">value</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="k">_</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
</span><span class="line">      <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">v</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">throw</span> <span class="k">new</span> <span class="nc">MissingRequiredAttributeException</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">SingleValueOptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span>
</span><span class="line">    <span class="k">extends</span> <span class="nc">OptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">optionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="nc">SingleValueOptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/26/mongodb-java-driver-sucks/">Problem in Mongodb&#8217;s Java and Scala Driver.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-26T18:45:00+08:00" pubdate data-updated="true">Apr 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MongoDB 的 Java Driver 支援透過 <a class="reference external" href="http://api.mongodb.org/java/2.5/org/bson/Transformer.html">Transformer</a> 去掛上 encodingHook 及 decodingHook，
使用方式可以參考 <a class="reference external" href="https://github.com/novus/salat/blob/9d7988fbd212b6a1423cb2be72065ebff3570777/salat-core/src/test/scala/com/novus/salat/test/util/UriConversionHelper.scala">Salat URISerializer</a>.</p>
<p>原本我以為透過這樣，我就可以透過自定 encoding and decoding Hook ，去動態
的把 MongoDB 內部的資料型態，在抓取時，自動轉成我要的形態。</p>
<p>例如透過底下的程式碼，就在呼叫 <a class="reference external" href="http://api.mongodb.org/scala/casbah/2.1.5.0/scaladoc/com/mongodb/casbah/commons/MongoDBObject.html#getAs[A](String)(Manifest[A]):Option[A]">getAs[URL](&quot;url&quot;)</a> 時，才即時的把 String 轉成 URL 。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="nc">BSON</span><span class="o">.</span><span class="n">addEncodingHook</span><span class="o">(</span><span class="n">class</span><span class="o">[</span><span class="kt">URL</span><span class="o">],</span> <span class="k">new</span> <span class="nc">Transformer</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">transform</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">AnyRef</span> <span class="o">=</span> <span class="n">o</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="n">u</span><span class="k">:</span> <span class="kt">URL</span> <span class="o">=&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">toExternalForm</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span>      <span class="k">=&gt;</span> <span class="n">o</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">})</span>
</span><span class="line"><span class="nc">BSON</span><span class="o">.</span><span class="n">addDecodingHook</span><span class="o">(</span><span class="n">class</span><span class="o">[</span><span class="kt">URL</span><span class="o">],</span> <span class="k">new</span> <span class="nc">Transformer</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">transform</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">AnyRef</span> <span class="o">=</span> <span class="n">o</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">    <span class="k">case</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">URL</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
</span><span class="line">    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure><p>結果，事情不如我預期所想的， <cite>decodingHook</cite> 是掛在 MongoDB 儲存的資料
型態上，而不是你所需要的資料型態上；換個方法講， <cite>decodingHook</cite> 是在
BSON driver 把資料讀出來時，就呼叫的。</p>
<p>實作上，如果你去細看 Salat URISerializer ，他的 <cite>decodingHook</cite> 是註冊
在 <cite>String Type</cite> 而非 <cite>URI Type</cite> ，而實作時，是把字串加上了 &quot;<cite>URI~</cite>&quot; 來
判斷，這個字串是否是該被 URI Serializer 轉型成 URI。</p>
<p>如果你去看 <cite>org.bson.BSON</cite> 的實作，你會看到底下這段恐怖的程式碼，BSON
在讀出資料時，會把對該型別的 <cite>Transformer</cite> 全跑一遍，而這個東西又是個
Gloabal Variable，這樣一來出了三個問題</p>
<ul class="simple">
<li>所有 Custom Data Type 都需要被轉成 String 並加上 Prefix 才可以寫入，
你不可以把一個 Custom Data Type 轉成 Integer ，如果你這麼做了，所有
的 Integer ，包含本來就該是 Integer 的欄位，未來在讀出來時，全都會變成
這個 Custom Data Type ！</li>
<li>你的 MongoDB Driver 仰賴所有的使用者都清楚他在做什麼，也清楚別人在
做什麼，如果有一個 Transformer 出錯了，或者是 Prefix 重覆了，那麼
你自定的 Custom Data Type 也會出錯。</li>
<li>你 MongoDB 中的資料，為了儲存 Data Type 於資料欄位中而被污染了！</li>
</ul>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addDecodingHook</span><span class="o">(</span> <span class="n">Class</span> <span class="n">c</span> <span class="o">,</span> <span class="n">Transformer</span> <span class="n">t</span> <span class="o">){</span>
</span><span class="line">    <span class="n">_decodeHooks</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Transformer</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">_decodingHooks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="n">c</span> <span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span> <span class="n">l</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">){</span>
</span><span class="line">        <span class="n">l</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Transformer</span><span class="o">&gt;();</span>
</span><span class="line">        <span class="n">_decodingHooks</span><span class="o">.</span><span class="na">put</span><span class="o">(</span> <span class="n">c</span> <span class="o">,</span> <span class="n">l</span> <span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">l</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="n">t</span> <span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">applyDecodingHooks</span><span class="o">(</span> <span class="n">Object</span> <span class="n">o</span> <span class="o">){</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span> <span class="o">!</span> <span class="n">_anyHooks</span><span class="o">()</span> <span class="o">||</span> <span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Transformer</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">_decodingHooks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">);</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span> <span class="n">l</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span>
</span><span class="line">        <span class="k">for</span> <span class="o">(</span> <span class="n">Transformer</span> <span class="n">t</span> <span class="o">:</span> <span class="n">l</span> <span class="o">)</span>
</span><span class="line">            <span class="n">o</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span> <span class="n">o</span> <span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p><a class="reference external" href="https://jira.mongodb.org/browse/SCALA-66">SCALA-66</a> 說 3.0.0 release 時，會有一個 per field, per data type 的
type conversion機制，不過 3.0.0-M2 時還沒把這塊做進去，所以看來有得等了</p>
<p>我是自己有參照 <a class="reference external" href="https://github.com/aboisvert/simplistic">simplistic</a> 刻一個機制，可以在 DAO 中讀進讀出物件時做轉
換，但是在寫 Query 時，仍是有些不便。</p>
<p>如果你有這需求的話，可以跟我連絡，我把 source code 給你。</p>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/09/23/california-legalize-ridesharing/">加州公共事業委員會通過共乘法案</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/17/on-hr/">談人力資源主管</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/12/politics-or-not-politics/">是政治還是不是政治？</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/12/us-trip/">美國出差行</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/19/parallel-external-merge-sort/">parallel external merge sort</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Facebook</h1>
  <div class="fb-follow" data-href="https://www.facebook.com/yunglin.ho" data-width="260" data-show-faces="true"></div>
</section>
<section>
  <h1>Twitter</h1>
  <a class="twitter-timeline" href="https://twitter.com/yunglinho" data-widget-id="379628400123445248">Tweets by @yunglinho</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/101164690243066571931?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
<a title="tumblr stats"
href="http://statcounter.com/tumblr/" target="_blank"><img
src="http://c.statcounter.com/8085210/0/5c96ca74/0/"
alt="tumblr stats" style="border:none;"></a></section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 -  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yunglin';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
