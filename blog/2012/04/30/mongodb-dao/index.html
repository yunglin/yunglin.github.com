
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mongodb Scala DAO - 碎碎唸</title>
  <meta name="author" content="">

  
  <meta name="description" content="這篇文章將說說，我使用 MongoDB &amp; Cashbah 的一些心得，這程式的主架構是
我從 simplistic 學來的。 The Abstract DAO
底下是一個很簡單的 CRUD 的 MongoDB DAO. 在這邊，我們建立一個 DAO 時，我們會把這
個 DAO &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.yunglinho.com/blog/2012/04/30/mongodb-dao">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/yunglinho" rel="alternate" title="碎碎唸" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11857878-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">碎碎唸</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/yunglinho" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.yunglinho.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Mongodb Scala DAO</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-30T11:50:00+08:00" pubdate data-updated="true">Apr 30<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>這篇文章將說說，我使用 MongoDB &amp; Cashbah 的一些心得，這程式的主架構是
我從 <a class="reference external" href="https://github.com/aboisvert/simplistic">simplistic</a> 學來的。</p>
<div class="section" id="the-abstract-dao">
<h2>The Abstract DAO</h2>
<p>底下是一個很簡單的 CRUD 的 MongoDB DAO. 在這邊，我們建立一個 DAO 時，我們會把這
個 DAO 用的儲存空間 MongoCollection 傳進來，另外要注意的一點是，這個 MongoCollection 的
WriteConcert 必需是 Strict 的。</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> *  Base class for all DAO classes.</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">AbstractDAO</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ID</span> <span class="k">&lt;:</span> <span class="kt">Serializable</span><span class="o">](</span><span class="k">protected</span><span class="o">[</span><span class="kt">locadz</span><span class="o">]</span> <span class="k">val</span> <span class="n">mongoCol</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** builder to turn mongodb object into model object */</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">builder</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">T</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** builder to turn model object into mongodb object */</span>
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">extractor</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="nc">DBObject</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** this dao expects the underlying mongoCol would throw exception when error occurs. */</span>
</span><span class="line">  <span class="n">require</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">  <span class="n">require</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span><span class="o">.</span><span class="n">getW</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="s">&quot;Write must be &gt;= 1, was %d&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">getWriteConcern</span><span class="o">.</span><span class="n">getW</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/** insert object into the underly*/</span>
</span><span class="line">  <span class="k">def</span> <span class="n">insert</span><span class="o">(</span><span class="n">obj</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">ID</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=</span> <span class="n">extractor</span><span class="o">(</span><span class="n">obj</span><span class="o">)</span>
</span><span class="line">      <span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">WriteResult</span> <span class="o">=</span> <span class="n">mongoCol</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span><span class="n">dbObj</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">ID</span><span class="o">](</span><span class="s">&quot;_id&quot;</span><span class="o">).</span><span class="n">get</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span>      <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">save</span><span class="o">(</span><span class="n">obj</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">DataAccessException</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">res</span> <span class="k">=</span> <span class="n">mongoCol</span><span class="o">.</span><span class="n">save</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">obj</span><span class="o">)</span>
</span><span class="line">      <span class="nc">None</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span>      <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">findById</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">ID</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="n">mongoCol</span><span class="o">.</span><span class="n">findOneByID</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">None</span>        <span class="k">=&gt;</span> <span class="nc">Right</span><span class="o">(</span><span class="nc">None</span><span class="o">)</span>
</span><span class="line">        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">dbObj</span><span class="o">).</span><span class="n">right</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">Option</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">delete</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">ID</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">DataAccessException</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="n">mongoCol</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="nc">MongoDBObject</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="n">id</span><span class="o">))</span>
</span><span class="line">      <span class="nc">None</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MongoException</span> <span class="o">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">find</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">builder</span><span class="k">:</span> <span class="o">(</span><span class="kt">DBObject</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">Iterable</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span><span class="n">mongoCol</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">        <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">found</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">          <span class="n">builder</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">found</span><span class="o">).</span><span class="n">fold</span><span class="o">(</span>
</span><span class="line">            <span class="n">e</span> <span class="k">=&gt;</span> <span class="k">throw</span> <span class="n">e</span><span class="o">,</span>
</span><span class="line">            <span class="n">r</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">r</span><span class="o">))</span>
</span><span class="line">        <span class="o">}).</span><span class="n">toStream</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>這邊有兩個需要被實作的東西</p>
<ul class="simple">
<li><cite>val builder: DBObject =&gt; Either[DataAccessException, T]</cite></li>
<li><cite>val extractor: T =&gt; DBObject</cite></li>
</ul>
<p>而怎麼建立這兩個東西，就是全文的重點了。</p>
</div>
<div class="section" id="how-to-use-abstractdao">
<h2>How to use AbstractDAO</h2>
<p>先來看一個範例；實作上，在 UserDAO object 上，我們先把欄位的名稱及資料型態，一個個的定好</p>
<ul class="simple">
<li>&#8216;val Name = attribute(&quot;name&quot;, Conversion.String)`</li>
<li>&#8216;val Email = attribute(&quot;email&quot;, Conversion.String)&#8217;</li>
<li>&#8216;val CreateDate = attribute(&quot;ctime&quot;, Conversion.JodaDate)&#8217;</li>
</ul>
<p>而這個 attribute method 做的是，把資料名稱存起來，然後當這個 Attribute instance</p>
<ul class="simple">
<li>收到一個 DBObject 時，把對應的欄位取出來，並將值給轉成定義的格式</li>
<li>收到一個 property value 時，把他轉成 (name -&gt; value) pair</li>
</ul>
<p>第一個用法的這個方式，用在從 <em>builder</em> 上面，一個個的把值從 DBObject 抓出來再來建立物件，
第二個用法用在，把物件轉成 DBObject 時，及用在建立 query 時。</p>
<div class="section" id="userdao">
<h3>UserDAO 實作</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">UserDAO</span><span class="o">(</span><span class="n">mongoCol</span><span class="k">:</span> <span class="kt">MongoCollection</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AbstractDAO</span><span class="o">[</span><span class="kt">User</span>, <span class="kt">String</span><span class="o">](</span><span class="n">mongoCol</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">UserDAO._</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">builder</span><span class="k">:</span> <span class="o">(</span><span class="kt">DBObject</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="nc">UserDAO</span><span class="o">.</span><span class="n">dbObjectToUser</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">extractor</span><span class="k">:</span> <span class="o">(</span><span class="kt">User</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">DBObject</span> <span class="k">=</span> <span class="nc">UserDAO</span><span class="o">.</span><span class="n">userToDBObject</span> <span class="k">_</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="k">this</span><span class="o">(</span><span class="n">dbCol</span><span class="k">:</span> <span class="kt">DBCollection</span><span class="o">)</span> <span class="k">=</span> <span class="k">this</span><span class="o">(</span><span class="n">dbCol</span><span class="o">.</span><span class="n">asScala</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">UserDAO</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">import</span> <span class="nn">Attributes._</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">Name</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">Email</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="nc">CreateDate</span> <span class="k">=</span> <span class="n">attribute</span><span class="o">(</span><span class="s">&quot;ctime&quot;</span><span class="o">,</span> <span class="nc">Conversion</span><span class="o">.</span><span class="nc">JodaDate</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">dbObjectToUser</span><span class="o">(</span><span class="n">dbObj</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="n">dbObj</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;_id&quot;</span><span class="o">).</span><span class="n">get</span>
</span><span class="line">
</span><span class="line">      <span class="nc">Right</span><span class="o">(</span>
</span><span class="line">        <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span>
</span><span class="line">          <span class="nc">Name</span><span class="o">(</span><span class="n">dbObj</span><span class="o">),</span>
</span><span class="line">          <span class="nc">Email</span><span class="o">(</span><span class="n">dbObj</span><span class="o">),</span>
</span><span class="line">          <span class="nc">CreateDate</span><span class="o">(</span><span class="n">dbObj</span><span class="o">)</span>
</span><span class="line">        <span class="o">)</span>
</span><span class="line">      <span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">DataAccessException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">implicit</span> <span class="k">def</span> <span class="n">userToDBObject</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">DBObject</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">val</span> <span class="n">ret</span> <span class="k">=</span> <span class="nc">MongoDBObject</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">Name</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">externalId</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">Email</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">verifiedId</span><span class="o">)</span>
</span><span class="line">    <span class="n">ret</span> <span class="o">+=</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">createDate</span><span class="o">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">ret</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="attribute-conversion">
<h3>Attribute &amp; Conversion 部份實作</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
</span><span class="line">  <span class="k">val</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class="line">  <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">throw</span> <span class="k">new</span> <span class="nc">MissingRequiredAttributeException</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">new</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">trait</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">B</span>
</span><span class="line">  <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">object</span> <span class="nc">Conversion</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="k">object</span> <span class="nc">String</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">source</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">value</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * Conversion for DateTime to DateTime.</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="k">object</span> <span class="nc">JodaDate</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">DateTime</span>, <span class="kt">DateTime</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nc">RegisterJodaTimeConversionHelpers</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=</span> <span class="n">source</span>
</span><span class="line">    <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=</span> <span class="n">value</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>
<div class="section" id="how-to-use-attributes-to-build-query">
<h2>How to Use Attributes to Build Query</h2>
<p>前面的 Attribute(s) 不只是用來產做 builder 及 extractor 用的，他們最好用的地方在於
建立 query 時，如下</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">def</span> <span class="n">findByDateRange</span><span class="o">(</span><span class="n">start</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">DataAccessException</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">  <span class="k">return</span> <span class="n">find</span><span class="o">(</span><span class="nc">CreateDate</span><span class="o">.</span><span class="n">name</span> <span class="nc">$gth</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">start</span><span class="o">).</span><span class="n">_2</span>  <span class="nc">$lt</span> <span class="nc">CreateDate</span><span class="o">(</span><span class="n">range</span><span class="o">).</span><span class="n">_2</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure><p>這邊，我們可以看到用 Conversion 來描述資料型態的好處是，當你儲存的資料型態有變時，你不用去更
改你的 MongoDB query ，欄位的名稱、資料型別的轉換，都被封裝起來，使用者在寫 Query 時，不用去
記欄位的名稱，也不用去記這個欄位的型態是什麼， MongoDB 支不支援這個型態。</p>
<p>第二個好處是， Casbah 本來只支援 java primitive type &amp; java.util.Date ，透過 Conversion ，
我們可以支援任意的資料型態於 query 中，只要透過新的 Conversion 類別，我們就可以增加 MongoDB 可以
支援的資料型態。</p>
<p>例如，如果我們想增加對 <cite>java.net.URL</cite> 的支援，只要訂義以下的 Conversion 即可</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">case</span> <span class="k">object</span> <span class="nc">Url</span> <span class="k">extends</span> <span class="nc">Conversion</span><span class="o">[</span><span class="kt">URL</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">source</span><span class="k">:</span> <span class="kt">URL</span><span class="o">)</span> <span class="k">=</span> <span class="n">source</span><span class="o">.</span><span class="n">toExternalForm</span>
</span><span class="line">
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">URL</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="appendix">
<h2>Appendix:</h2>
<div class="section" id="attribute-scala">
<h3>Attribute.scala</h3>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">package</span> <span class="nn">com.locadz.model.mongodb</span>
</span><span class="line">
</span><span class="line"><span class="k">import</span> <span class="nn">com.mongodb.DBObject</span>
</span><span class="line"><span class="k">import</span> <span class="nn">com.mongodb.casbah._</span>
</span><span class="line"><span class="k">import</span> <span class="nn">com.locadz.model.exception.MissingRequiredAttributeException</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Date: 2/20/12</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="k">object</span> <span class="nc">Attributes</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span>
</span><span class="line">    <span class="k">val</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">    <span class="k">protected</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">OptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Any</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">v</span> <span class="k">=</span> <span class="n">value</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="k">_</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
</span><span class="line">      <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">v</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">))</span>
</span><span class="line">
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">trait</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Tuple2</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">DBObject</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">value</span><span class="o">.</span><span class="n">getAs</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">conversion</span><span class="o">.</span><span class="n">unapply</span><span class="o">(</span><span class="n">b</span><span class="o">)).</span><span class="n">getOrElse</span><span class="o">(</span><span class="k">throw</span> <span class="k">new</span> <span class="nc">MissingRequiredAttributeException</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">RequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">case</span> <span class="k">class</span> <span class="nc">SingleValueOptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span>
</span><span class="line">    <span class="k">extends</span> <span class="nc">OptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">attribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="nc">SingleValueRequiredAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="n">optionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span> <span class="k">&lt;:</span> <span class="kt">Any</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">dataType</span><span class="k">:</span> <span class="kt">Conversion</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">manifestA</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">manifestB</span><span class="k">:</span> <span class="kt">Manifest</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">new</span> <span class="nc">SingleValueOptionalAttribute</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">name</span><span class="o">,</span> <span class="n">dataType</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></div>
</div>

</div>


  <footer>
    <p class="meta">
      
  



      








  


<time datetime="2012-04-30T11:50:00+08:00" pubdate data-updated="true">Apr 30<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/mongodb/'>mongodb</a>, <a class='category' href='/blog/categories/scala/'>scala</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.yunglinho.com/blog/2012/04/30/mongodb-dao/" data-via="yunglinho" data-counturl="http://blog.yunglinho.com/blog/2012/04/30/mongodb-dao/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/04/26/mongodb-java-driver-sucks/" title="Previous Post: Problem in Mongodb's java and scala driver.">&laquo; Problem in Mongodb's java and scala driver.</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/05/08/shall-patent-apply-to-business-model/" title="Next Post: Shall Patent Apply to Business Model">Shall Patent Apply to Business Model &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/02/12/mongodb-schemaless/">Mongodb schemaless</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/12/mongodb-shard-key/">MongoDB - Sharding</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/26/qnap-sucks/">QNAP Sucks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/16/make-me-a-german/">德國人為什麼強大</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/15/project-manager-and-product-manager/">project-manager-and-product-manager</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Facebook</h1>
  <div class="fb-follow" data-href="https://www.facebook.com/yunglin.ho" data-width="260" data-show-faces="true"></div>
</section>
<section>
  <h1>Twitter</h1>
  <a class="twitter-timeline" href="https://twitter.com/yunglinho" data-widget-id="379628400123445248">Tweets by @yunglinho</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/101164690243066571931?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
<a title="tumblr stats"
href="http://statcounter.com/tumblr/" target="_blank"><img
src="http://c.statcounter.com/8085210/0/5c96ca74/0/"
alt="tumblr stats" style="border:none;"></a></section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yunglin';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.yunglinho.com/blog/2012/04/30/mongodb-dao/';
        var disqus_url = 'http://blog.yunglinho.com/blog/2012/04/30/mongodb-dao/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
