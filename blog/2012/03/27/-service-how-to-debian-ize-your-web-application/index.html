
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>[Service上線前你該知道的事]How to Debian-ize Your Web Application. - 碎碎唸</title>
  <meta name="author" content="">

  
  <meta name="description" content="在布建一個Web Application時，用.war來佈屬服務，算是最沒有效率的一種方式，因為，這樣無法把web container所需要的設定檔一起佈建出去，同時，也無法板本控製你的應用程式；本文接下來會敘述，如何用maven & jetty & debian來佈屬你的Web &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.yunglinho.com/blog/2012/03/27/-service-how-to-debian-ize-your-web-application">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/yunglinho" rel="alternate" title="碎碎唸" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11857878-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">碎碎唸</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/yunglinho" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.yunglinho.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">[Service上線前你該知道的事]How to Debian-ize Your Web Application.</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-27T23:19:00+08:00" pubdate data-updated="true">Mar 27<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><div class='post'>
在布建一個Web Application時，用.war來佈屬服務，算是最沒有效率的一種方式，因為，這樣無法把web container所需要的設定檔一起佈建出去，同時，也無法板本控製你的應用程式；本文接下來會敘述，如何用maven & jetty & debian來佈屬你的Web Application。<br /><br />首先，先講講我的需求，我的需求如下<br /><ul><li>Web Application的版本必需能夠簡單被管理，要能簡單的就知道目前安裝的版本，並且輕鬆的昇級到新版</li><li>Web Application被佈建時，要連Web Container及設定擋包在一起</li><li>Debian Box開關機時，要能自動開關Web Container</li></ul><br />這些需求，我是靠 unix-maven-plugin ，幫我把我的 web application 包成一個 .deb 來做到的，包成 .deb 的好處是，在 debian 上可以簡單的安裝，若是公司有架 debian package repository, 那麼，打個 apt-get install <app> 就可以安裝或昇級到最新版，同時間，可以透過 debian 安裝的機制，來把些 script 掛入 rc.*<br /><br />由於 unix-maven-plugin 已被原作者遺棄，所以需要從 <a href="https://github.com/yunglin/unix-maven-plugin">github</a>下載並安裝後人修改過的版本。<br /><br />然後依<a href="#appendix">附錄</a>的方式，增修你的設定檔，需要增修的檔案有<br /><ul><li>pom.xml: 加入 unix-maven-plugin 及服務的名稱及PORT</li><li>src/main/unix/resources/default/${service.user} : 給 jetty 用的 default 設定值，在這邊你可以修改 JAVA_OPTIONS 及 NO_START</li><li>src/main/unix/resources/etc/jetty.conf</li><li>src/main/unix/resources/etc/start.conf</li><li>src/main/unix/resources/scripts/${service.user} : 給 debian 用的 init script</li><li>src/main/unix/resources/scripts/post-install post-remove pre-install pre-remove : debian 在安裝及昇級 .deb 時會跑的 script</li></ul><br />將這些檔案設定好後，在 debian 的機器上打 mvn package deploy ,就可以自動生成 .deb 的檔案，並且上傳到你的 maven repository 上去，如果貴公司有架 debian package repository　的話，還可以加一段程式碼把 .deb 傳到 debian package repository 去。<br /><br />接著，打 dpkg -i xxxx.deb 就可以把你的 web application 當成一個 debian service 安裝到你的 debain machine 上去。<br /><br />查詢目前安裝的板本則是打 dpkg -l xxxx 即可<br /><br /><pre class="brush: shell;">||/ Name           Version        Description<br />+++-==============-==============-============================================<br />ii  backend       1.2.0-20120327.143115          backend<br /></pre><br /><br /><a name="appendix"><h3>附錄</h3></a><br /><br />把底下的這段，加入你的 pom.xml <br /><br /><pre class="brush: xml;"><project xmlns="http://maven.apache.org/POM/4.0.0" <br />         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" <br />         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0<br />         http://maven.apache.org/xsd/maven-4.0.0.xsd"><br />  <modelversion>4.0.0</modelVersion><br />  <groupid>com.locadz</groupId><br />  <artifactid>backend</artifactId><br />  <packaging>war</packaging><br />  <description>backend</description><br />  <version>1.2.0-SNAPSHOT</version><br />  <name>backend</name><br />  <properties><br />    <version.maven.unix.plugin>1.0-alpha-6.1</version.maven.unix.plugin><br />    <version.jetty>7.4.5.v20110725</version.jetty><br /><br />    <service.name>Locadz Backend</service.name><br />    <service.home>/var/lib/bluetang/locadz-backend</service.home><br />    <service.user>locadz-backend</service.user><br />    <service.port>9080</service.port><br />  </properties><br />  <profiles><br />    <profile><br />      <id>debian-package</id><br />      <activation><br />        <os><br />          <family>unix</family><br />          <name>linux</name><br />        </os><br />      </activation><br />      <build><br />        <plugins><br />          <plugin><br />            <artifactid>maven-resources-plugin</artifactId><br />            <version>2.5</version><br />            <executions><br />              <execution><br />                <id>copy-resources</id><br />                <!-- here the phase you need --><br />                <phase>process-resources</phase><br />                <goals><br />                  <goal>copy-resources</goal><br />                </goals><br />                <configuration><br />                  <outputdirectory>${basedir}/target</outputDirectory><br />                  <resources><br />                    <resource><br />                      <directory>src/main/unix</directory><br />                      <targetpath>unix</targetPath><br />                      <includes><br />                        <include>**/*</include><br />                      </includes><br />                      <filtering>true</filtering><br />                    </resource><br />                  </resources><br />                </configuration><br />              </execution><br />            </executions><br />          </plugin><br /><br />          <!-- build .deb --><br />          <plugin><br />            <groupid>org.mortbay.jetty.toolchain</groupId><br />            <artifactid>unix-maven-plugin</artifactId><br />            <version>${version.maven.unix.plugin}</version><br />            <extensions>true</extensions><br />            <executions><br />              <execution><br />                <phase>package</phase><br />                <goals><br />                  <goal>package-deb-attached</goal><br />                </goals><br />              </execution><br />            </executions><br />            <configuration><br />              <!-- debug mode should be always enable on this plugin. cause the info it<br />                  provided is not sufficient when things goes wrong. Also, it does not<br />                  take the maven standard debug flag '-X'.<br />              --><br />              <debug>true</debug><br />              <contact>yho@bluetangstudio.com</contact><br />              <contactemail>yho@bluetangstudio.com</contactEmail><br />              <defaults><br />                <fileattributes><br />                  <user>${service.user}</user><br />                  <group>adm</group><br />                </fileAttributes><br />                <directoryattributes><br />                  <user>${service.user}</user><br />                  <group>adm</group><br />                </directoryAttributes><br />              </defaults><br />              <deb><br />                <section>bluetang</section><br />                <priority>extra</priority><br />              </deb><br />              <assembly><br /><br />                <!-- extract jetty first --><br />                <extract-artifact><br />                  <artifact>org.eclipse.jetty:jetty-distribution:zip</artifact><br />                  <to>${service.home}</to><br />                  <pattern>/jetty-distribution-${version.jetty}(.*)</pattern><br />                  <replacement>$1</replacement><br />                  <excludes><br />                    <!-- Exclude all default contexts and web application, no need for them --><br />                    <exclude>*/contexts/**</exclude><br />                    <exclude>*/contexts-available/**</exclude><br />                    <exclude>*/webapps/**</exclude><br />                    <exclude>*/javadoc/**</exclude><br />                    <exclude>*/LICENSES/**</exclude><br />                    <exclude>*/logs/**</exclude><br />                    <exclude>**/win32/**</exclude><br />                  </excludes><br />                </extract-artifact><br />                <!-- put war file on the top of jetty --><br />                <copyfile><br />                  <path>${project.build.directory}/${project.build.finalName}.${project.packaging}<br />                  </path><br />                  <tofile>${service.home}/webapps/ROOT.war</toFile><br />                </copyFile><br />                <copyfile><br />                  <path>${basedir}/target/unix/resources/default/${service.user}</path><br />                  <todir>/etc/default</toDir><br />                </copyFile><br />                <copydirectory><br />                  <from>${basedir}/target/unix/resources/etc</from><br />                  <to>/etc/bluetang/${service.user}</to><br />                </copyDirectory><br />                <copyfile><br />                  <path>${basedir}/target/unix/scripts/${service.user}</path><br />                  <todir>/etc/init.d</toDir><br />                  <attributes><br />                    <mode>0754</mode><br />                    <user>${service.user}</user><br />                    <group>admin</group><br />                  </attributes><br />                </copyFile><br />              </assembly><br />            </configuration><br />          </plugin><br />        </plugins><br />      </build><br /><br />    </profile><br />  </profiles><br /><br />  <dependencies><br />    <!-- because of a bug in unix-maven-plugin, it can not pickup dependency from<br />                   plguin-dependencies. As a result, we put jetty-distribution here.<br />            --><br />    <dependency><br />      <groupid>org.eclipse.jetty</groupId><br />      <artifactid>jetty-distribution</artifactId><br />      <version>${version.jetty}</version><br />      <type>zip</type><br />      <!-- SC-57: dirty hack to excludes all child dependencies --><br />      <exclusions><br />        <exclusion><br />          <groupid>*</groupId><br />          <artifactid>*</artifactId><br />        </exclusion><br />      </exclusions><br />    </dependency><br />  </dependencies><br /></project><br /></pre><br />然後把下面這塊存成 src/main/unix/resources/default/${service.user}<br /><br /><pre class="brush: shell;"># Defaults for jetty see /etc/${service.user}/jetty for more<br /><br /># change to 0 to allow Jetty to start<br />NO_START=0<br /><br /># change to 'no' or uncomment to use the default setting in /etc/default/rcS<br />VERBOSE=yes<br /><br /># Run Jetty as this user ID (default: jetty)<br /># Set this to an empty string to prevent Jetty from starting automatically<br />JETTY_USER=${service.user}<br /><br /># Listen to connections from this network host<br /># Use 0.0.0.0 as host to accept all connections.<br /># Uncomment to restrict access to localhost<br />#JETTY_HOST=$(uname -n)<br />JETTY_HOST=0.0.0.0<br /><br /># The network port used by Jetty<br />JETTY_PORT=${service.port}<br /><br /># Timeout in seconds for the shutdown of all webapps<br />#JETTY_SHUTDOWN=30<br /><br /># Additional arguments to pass to Jetty<br />#JETTY_ARGS=<br /><br /># Extra options to pass to the JVM<br />JAVA_OPTIONS="-Xmx256m -Djava.awt.headless=true -Duser.timezone=UTC"<br /><br /># Home of Java installation.<br />#JAVA_HOME=<br /><br /># The first existing directory is used for JAVA_HOME (if JAVA_HOME is not<br /># defined in /etc/default/jetty). Should contain a list of space separated directories.<br />#JDK_DIRS="/usr/lib/jvm/default-java /usr/lib/jvm/java-6-sun"<br /><br /># Java compiler to use for translating JavaServer Pages (JSPs). You can use all<br /># compilers that are accepted by Ant's build.compiler property.<br />#JSP_COMPILER=jikes<br /><br /># Jetty uses a directory to store temporary files like unpacked webapps<br />JETTY_TMP=/var/cache/bluetang/jetty<br /><br /># Jetty uses a config file to setup its boot classpath<br />JETTY_START_CONFIG=/etc/bluetang/${service.user}/start.config<br /><br /># Default for number of days to keep old log files in /var/log/jetty/<br />#LOGFILE_DAYS=14<br /></pre><br /><br />然後把下面這塊存成 src/main/unix/resources/ect/jetty.conf<br /><br /><pre class="brush: shell;"># list of jetty configuration and property files<br />/var/lib/bluetang/${service.user}/etc/jetty-logging.xml<br /></pre><br /><br />然後把下面這塊存成 src/main/unix/resources/etc/start.conf<br /><br /><pre class="brush: shell;"># This file controls what file are to be put on classpath or command line.<br />#<br /># Format is as follows:<br /># Each line contains entry for one JAR file.<br /># Format of line:<br />#<br />#  SUBJECT [ [!] CONDITION [AND|OR] ]*<br />#<br /># where SUBJECT:<br />#   ends with ".class" is the Main class to run.<br />#   ends with ".xml" is a configuration file for the command line<br />#   ends with "/" is a directory from which to add all jar and zip files.<br />#   ends with "/*" is a directory from which to add all unconsidered jar and zip files.<br />#   ends with "/**" is a directory from which to recursively add all unconsidered jar and zip files.<br />#   Containing = are used to assign system properties.<br />#   all other subjects are treated as files to be added to the classpath.<br />#<br /># Subjects may include system properties with $(propertyname) syntax.<br />#<br /># Files starting with "/" are considered absolute, all others are relative to<br /># the home directory.<br />#<br /># CONDITION is one of:<br />#   always<br />#   never<br />#   available classname        # true if class on classpath<br />#   property name              # true of set<br />#   java OPERATOR version      # java version compared to literal<br />#   nargs OPERATOR number      # number of command line args compared to literal<br />#   OPERATOR := one of "<",">","<=",">=","==","!="<br />#<br /># CONDITIONS can be combined with AND OR or !, with AND being the assume<br /># operator for a list of CONDITIONS.<br /># Classpath operations are evaluated on the fly, so once a class or jar is<br /># added to the classpath, subsequent available conditions will see that class.<br />#<br /><br />$(jetty.class.path)                              always<br />$(jetty.lib)/**                                  exists $(jetty.lib)<br /><br />jetty.home=/var/lib/bluetang/${service.user}                      always<br /><br /># The main class to run<br />org.mortbay.xml.XmlConfiguration.class<br /><br /># The default configuration files<br />$(jetty.home)/etc/jetty.xml                      nargs == 0<br /><br />/usr/share/java/servlet-api-2.5.jar<br />/usr/share/java/slf4j-api.jar<br /><br /># Optional stuff for libjetty-extra-java<br />/usr/share/java/gnumail.jar<br />/usr/share/java/activation.jar<br />/usr/share/java/ant.jar<br /><br /># Set the jetty classpath<br />/usr/share/jetty/lib/**<br /><br /># Add a resources directory if it is there<br />$(jetty.home)/resources/<br /><br /></pre><br /><br /><br />然後把下面這塊存成 src/main/unix/scripts/${service.user}<br /><br /><pre class="brush: shell;">#!/bin/bash  <br />### BEGIN INIT INFO<br /># Provides:          ${service.user}<br /># Required-Start:<br /># Required-Stop:<br /># Default-Start:     2 3 4 5<br /># Default-Stop:      0 1 6<br /># Short-Description: Start daemon at boot time<br /># Description:       Enable service provided by daemon.<br />### END INIT INFO<br />#<br /># Startup script for jetty under *nix systems (it works under NT/cygwin too).<br />#<br /># Configuration files<br />#<br /># /etc/default/${service.user}<br />#   If it exists, this is read at the start of script. It may perform any <br />#   sequence of shell commands, like setting relevant environment variables.<br />#<br /># /etc/bluetang/${service.user}/jetty.conf<br />#   If found, and no configurations were given on the command line,<br />#   the file will be used as this script's configuration. <br />#   Each line in the file may contain:<br />#     - A comment denoted by the pound (#) sign as first non-blank character.<br />#     - The path to a regular file, which will be passed to jetty as a <br />#       config.xml file.<br />#     - The path to a directory. Each *.xml file in the directory will be<br />#       passed to jetty as a config.xml file.<br />#<br />#   The files will be checked for existence before being passed to jetty.<br />#<br /># $JETTY_HOME/etc/jetty.xml<br />#   If found, used as this script's configuration file, but only if<br />#   /etc/bluetang/${service.user}/jetty.conf was not present. See above.<br />#   <br /># Configuration variables<br />#<br /># JAVA<br />#   Command to invoke Java. If not set, java (from the PATH) will be used.<br />#<br /># JAVA_OPTIONS<br />#   Extra options to pass to the JVM<br />#<br /># JETTY_HOME<br />#   Where Jetty is installed. If not set, the script will try go<br />#   guess it by first looking at the invocation path for the script,<br />#   and then by looking in standard locations as $HOME/opt/jetty<br />#   and /opt/jetty. The java system property "jetty.home" will be<br />#   set to this value for use by configure.xml files, f.e.:<br />#<br />#    <arg><systemproperty name="jetty.home" default="."/>/webapps/jetty.war</Arg><br />#<br /># JETTY_PORT<br />#   Override the default port for Jetty servers. If not set then the<br />#   default value in the xml configuration file will be used. The java<br />#   system property "jetty.port" will be set to this value for use in<br />#   configure.xml files. For example, the following idiom is widely<br />#   used in the demo config files to respect this property in Listener<br />#   configuration elements:<br />#<br />#    <set name="Port"><systemproperty name="jetty.port" default="8080"/></Set><br />#<br />#   Note: that the config file could ignore this property simply by saying:<br />#<br />#    <set name="Port">8080</Set><br />#<br /># JETTY_RUN<br />#   Where the jetty.pid file should be stored. It defaults to the<br />#   first available of /var/run, /usr/var/run, and /tmp if not set.<br />#  <br /># JETTY_PID<br />#   The Jetty PID file, defaults to $JETTY_RUN/jetty.pid<br />#   <br /># JETTY_ARGS<br />#   The default arguments to pass to jetty.<br />#<br /># JETTY_USER<br />#   if set, then used as a username to run the server as<br />#<br />JETTY_HOME=${service.home}<br />JETTY_USER=${service.user}<br />JETTY_PID=$JETTY_RUN/${service.user}.pid<br />usage()<br />{<br />    echo "Usage: ${0##*/} [-d] {start|stop|run|restart|check|supervise} [ CONFIGS ... ] "<br />    exit 1<br />}<br /><br />[ $# -gt 0 ] || usage<br /><br /><br />##################################################<br /># Some utility functions<br />##################################################<br />findDirectory()<br />{<br />  local L OP=$1<br />  shift<br />  for L in "$@"; do<br />    [ "$OP" "$L" ] || continue<br />    printf %s "$L"<br />    break<br />  done<br />}<br /><br />running()<br />{<br />  local PID=$(cat "$1" 2>/dev/null) || return 1<br />  kill -0 "$PID" 2>/dev/null<br />}<br /><br />readConfig()<br />{<br />  (( DEBUG )) && echo "Reading $1.."<br />  source "$1"<br />}<br /><br /><br /><br />##################################################<br /># Get the action & configs<br />##################################################<br />CONFIGS=()<br />NO_START=0<br />DEBUG=0<br /><br />while [[ $1 = -* ]]; do<br />  case $1 in<br />    -d) DEBUG=1 ;;<br />  esac<br />  shift<br />done<br />ACTION=$1<br />shift<br /><br />##################################################<br /># See if there's a default configuration file<br />##################################################<br />if [ -f /etc/default/${service.user} ] ; then<br />  . /etc/default/${service.user}<br />fi<br /><br /><br />##################################################<br /># Set tmp if not already set.<br />##################################################<br />TMPDIR=${TMPDIR:-/tmp}<br /><br />##################################################<br /># Jetty's hallmark<br />##################################################<br />JETTY_INSTALL_TRACE_FILE="etc/jetty.xml"<br /><br /><br />##################################################<br /># Try to determine JETTY_HOME if not set<br />##################################################<br />if [ -z "$JETTY_HOME" ] <br />then<br />  JETTY_SH=$0<br />  case "$JETTY_SH" in<br />    /*)   ;;<br />    ./*)  ;;<br />    *)    JETTY_SH=./$JETTY_SH ;;<br />  esac<br />  JETTY_HOME=${JETTY_SH%/*/*}<br /><br />  if [ ! -f "${JETTY_SH%/*/*}/$JETTY_INSTALL_TRACE_FILE" ]<br />  then<br />    JETTY_HOME=<br />  fi<br />fi<br /><br /><br /><br />##################################################<br /># if no JETTY_HOME, search likely locations.<br />##################################################<br />if [ -z "$JETTY_HOME" ] ; then<br />  STANDARD_LOCATIONS=(<br />        "/usr/share"<br />        "/usr/share/java"<br />        "${HOME}"<br />        "${HOME}/src"<br />        "${HOME}/opt"<br />        "/opt"<br />        "/java"<br />        "/usr/local"<br />        "/usr/local/share"<br />        "/usr/local/share/java"<br />        "/home"<br />        )<br />  JETTY_DIR_NAMES=(<br />        "jetty-7"<br />        "jetty7"<br />        "jetty-7.*"<br />        "jetty"<br />        "Jetty-7"<br />        "Jetty7"<br />        "Jetty-7.*"<br />        "Jetty"<br />        )<br /><br />  for L in "${STANDARD_LOCATIONS[@]}"<br />  do<br />    for N in "${JETTY_DIR_NAMES[@]}"<br />    do<br />      POSSIBLE_JETTY_HOME=("$L/"$N)<br />      if [ ! -d "$POSSIBLE_JETTY_HOME" ]<br />      then<br />        # Not a directory. skip.<br />        unset POSSIBLE_JETTY_HOME<br />      elif [ ! -f "$POSSIBLE_JETTY_HOME/$JETTY_INSTALL_TRACE_FILE" ]<br />      then<br />        # Trace file not found. skip.<br />        unset POSSIBLE_JETTY_HOME<br />      else<br />        # Good hit, Use it<br />        JETTY_HOME=$POSSIBLE_JETTY_HOME<br />        # Break out of JETTY_DIR_NAMES loop<br />        break<br />      fi<br />    done<br />    if [ -n "$POSSIBLE_JETTY_HOME" ]<br />    then<br />      # We have found our JETTY_HOME<br />      # Break out of STANDARD_LOCATIONS loop<br />      break<br />    fi<br />  done<br />fi<br /><br /><br />##################################################<br /># No JETTY_HOME yet? We're out of luck!<br />##################################################<br />if [ -z "$JETTY_HOME" ]; then<br />  echo "** ERROR: JETTY_HOME not set, you need to set it or install in a standard location"<br />  exit 1<br />fi<br /><br />cd "$JETTY_HOME"<br />JETTY_HOME=$PWD<br /><br /><br />#####################################################<br /># Check that jetty is where we think it is<br />#####################################################<br />if [ ! -r "$JETTY_HOME/$JETTY_INSTALL_TRACE_FILE" ]<br />then<br />  echo "** ERROR: Oops! Jetty doesn't appear to be installed in $JETTY_HOME"<br />  echo "** ERROR:  $JETTY_HOME/$JETTY_INSTALL_TRACE_FILE is not readable!"<br />  exit 1<br />fi<br /><br />##################################################<br /># Try to find this script's configuration file,<br /># but only if no configurations were given on the<br /># command line.<br />##################################################<br />if [ -z "$JETTY_CONF" ] <br />then<br />  if [ -f /etc/bluetang/${service.user}/jetty.conf ]<br />  then<br />     JETTY_CONF=/etc/bluetang/${service.user}/jetty.conf<br />  elif [ -f "${JETTY_HOME}/etc/jetty.conf" ]<br />  then<br />     JETTY_CONF="${JETTY_HOME}/etc/jetty.conf"<br />  fi<br />fi<br /><br />##################################################<br /># Get the list of config.xml files from jetty.conf<br />##################################################<br />if [ -z "$CONFIGS" ] && [ -f "$JETTY_CONF" ] && [ -r "$JETTY_CONF" ]<br />then<br />  while read -r CONF<br />  do<br />    if expr "$CONF" : '#' >/dev/null ; then<br />      continue<br />    fi<br /><br />    if [ -d "$CONF" ]<br />    then<br />      # assume it's a directory with configure.xml files<br />      # for example: /etc/jetty.d/<br />      # sort the files before adding them to the list of CONFIGS<br />      for file in "$CONF/"*.xml<br />      do<br />        if [ -r "$FILE" ] && [ -f "$FILE" ]<br />        then<br />          CONFIGS+=("$FILE")<br />        else<br />          echo "** WARNING: Cannot read '$FILE' specified in '$JETTY_CONF'"<br />        fi<br />      done<br />    else<br />      # assume it's a command line parameter (let start.jar deal with its validity)<br />      CONFIGS+=("$CONF")<br />    fi<br />  done < "$JETTY_CONF"<br />fi<br /><br />#####################################################<br /># Find a location for the pid file<br />#####################################################<br />if [ -z "$JETTY_RUN" ]<br />then<br />  JETTY_RUN=$(findDirectory -w /var/run /usr/var/run /tmp)<br />fi<br /><br />#####################################################<br /># Find a PID for the pid file<br />#####################################################<br />if [ -z "$JETTY_PID" ]<br />then<br />  JETTY_PID="$JETTY_RUN/jetty.pid"<br />fi<br /><br />##################################################<br /># Setup JAVA if unset<br />##################################################<br />if [ -z "$JAVA" ]<br />then<br />  JAVA=$(which java)<br />fi<br /><br />if [ -z "$JAVA" ]<br />then<br />  echo "Cannot find a Java JDK. Please set either set JAVA or put java (>=1.5) in your PATH." 2>&2<br />  exit 1<br />fi<br /><br />#####################################################<br /># See if JETTY_PORT is defined<br />#####################################################<br />if [ "$JETTY_PORT" ]<br />then<br />  JAVA_OPTIONS+=("-Djetty.port=$JETTY_PORT")<br />fi<br /><br />#####################################################<br /># See if JETTY_LOGS is defined<br />#####################################################<br />if [ "$JETTY_LOGS" ]<br />then<br />  JAVA_OPTIONS+=("-Djetty.logs=$JETTY_LOGS")<br />fi<br /><br />#####################################################<br /># Are we running on Windows? Could be, with Cygwin/NT.<br />#####################################################<br />case "`uname`" in<br />CYGWIN*) PATH_SEPARATOR=";";;<br />*) PATH_SEPARATOR=":";;<br />esac<br /><br /><br />#####################################################<br /># Add jetty properties to Java VM options.<br />#####################################################<br />JAVA_OPTIONS+=("-Djetty.home=$JETTY_HOME" "-Djava.io.tmpdir=$TMPDIR")<br /><br />[ -f "$JETTY_HOME/etc/start.config" ] && JAVA_OPTIONS=("-DSTART=$JETTY_HOME/etc/start.config" "${JAVA_OPTIONS[@]}")<br /><br />#####################################################<br /># This is how the Jetty server will be started<br />#####################################################<br /><br />JETTY_START=$JETTY_HOME/start.jar<br />[ ! -f "$JETTY_START" ] && JETTY_START=$JETTY_HOME/lib/start.jar<br /><br />START_INI=$(dirname $JETTY_START)/start.ini<br />[ -r "$START_INI" ] || START_INI=""<br /><br />RUN_ARGS=(${JAVA_OPTIONS[@]} -jar "$JETTY_START" $JETTY_ARGS "${CONFIGS[@]}")<br />RUN_CMD=("$JAVA" ${RUN_ARGS[@]})<br /><br />#####################################################<br /># Comment these out after you're happy with what <br /># the script is doing.<br />#####################################################<br />if (( DEBUG ))<br />then<br />  echo "JETTY_HOME     =  $JETTY_HOME"<br />  echo "JETTY_CONF     =  $JETTY_CONF"<br />  echo "JETTY_RUN      =  $JETTY_RUN"<br />  echo "JETTY_PID      =  $JETTY_PID"<br />  echo "JETTY_ARGS     =  $JETTY_ARGS"<br />  echo "CONFIGS        =  ${CONFIGS[*]}"<br />  echo "JAVA_OPTIONS   =  ${JAVA_OPTIONS[*]}"<br />  echo "JAVA           =  $JAVA"<br />  echo "RUN_CMD        =  ${RUN_CMD}"<br />fi<br /><br />##################################################<br /># Do the action<br />##################################################<br />case "$ACTION" in<br />  start)<br />    echo -n "Starting ${service.name}: "<br /><br />    if (( NO_START )); then<br />      echo "Not starting ${service.user} - NO_START=1";<br />      exit<br />    fi<br /><br /><br />    if type start-stop-daemon > /dev/null 2>&1<br />    then<br />      unset CH_USER<br />      if [ -n "$JETTY_USER" ]<br />      then<br />        CH_USER="-c$JETTY_USER"<br />      fi<br />      if start-stop-daemon -S -p"$JETTY_PID" $CH_USER -d"$JETTY_HOME" -b -m -a "$JAVA" -- "${RUN_ARGS[@]}" --daemon<br />      then<br />        sleep 1<br />        if running "$JETTY_PID"<br />        then<br />          echo "OK"<br />        else<br />          echo "FAILED"<br />        fi<br />      fi<br /><br />    else<br /><br />      if [ -f "$JETTY_PID" ]<br />      then<br />        if running $JETTY_PID<br />        then<br />          echo "Already Running!"<br />          exit 1<br />        else<br />          # dead pid file - remove<br />          rm -f "$JETTY_PID"<br />        fi<br />      fi<br /><br />      if [ "$JETTY_USER" ]<br />      then<br />        touch "$JETTY_PID"<br />        chown "$JETTY_USER" "$JETTY_PID"<br />        # FIXME: Broken solution: wordsplitting, pathname expansion, arbitrary command execution, etc.<br />        su - "$JETTY_USER" -c "<br />          ${RUN_CMD[*]} --daemon &<br />          disown \$!<br />          echo \$! > '$JETTY_PID'"<br />      else<br />        "${RUN_CMD[@]}" &<br />        disown $!<br />        echo $! > "$JETTY_PID"<br />      fi<br /><br />      echo "STARTED ${service.name} `date`"<br />    fi<br /><br />    ;;<br /><br />  stop)<br />    echo -n "Stopping ${service.name}: "<br />    if type start-stop-daemon > /dev/null 2>&1; then<br />      start-stop-daemon -K -p"$JETTY_PID" -d"$JETTY_HOME" -a "$JAVA" -s HUP<br /><br />      TIMEOUT=30<br />      while running "$JETTY_PID"; do<br />        if (( TIMEOUT-- == 0 )); then<br />          start-stop-daemon -K -p"$JETTY_PID" -d"$JETTY_HOME" -a "$JAVA" -s KILL<br />        fi<br /><br />        sleep 1<br />      done<br /><br />      rm -f "$JETTY_PID"<br />      echo OK<br />    else<br />      PID=$(cat "$JETTY_PID" 2>/dev/null)<br />      kill "$PID" 2>/dev/null<br /><br />      TIMEOUT=30<br />      while running $JETTY_PID; do<br />        if (( TIMEOUT-- == 0 )); then<br />          kill -KILL "$PID" 2>/dev/null<br />        fi<br /><br />        sleep 1<br />      done<br /><br />      rm -f "$JETTY_PID"<br />      echo OK<br />    fi<br /><br />    ;;<br /><br />  restart)<br />    JETTY_SH=$0<br />    if [ ! -f $JETTY_SH ]; then<br />      if [ ! -f $JETTY_HOME/bin/jetty.sh ]; then<br />        echo "$JETTY_HOME/bin/jetty.sh does not exist."<br />        exit 1<br />      fi<br />      JETTY_SH=$JETTY_HOME/bin/jetty.sh<br />    fi<br /><br />    "$JETTY_SH" stop "$@"<br />    "$JETTY_SH" start "$@"<br /><br />    ;;<br /><br />  supervise)<br />    #<br />    # Under control of daemontools supervise monitor which<br />    # handles restarts and shutdowns via the svc program.<br />    #<br />    exec "${RUN_CMD[@]}"<br /><br />    ;;<br /><br />  run|demo)<br />    echo "Running Jetty: "<br /><br />    if [ -f "$JETTY_PID" ]<br />    then<br />      if running "$JETTY_PID"<br />      then<br />        echo "Already Running!"<br />        exit 1<br />      else<br />        # dead pid file - remove<br />        rm -f "$JETTY_PID"<br />      fi<br />    fi<br /><br />    exec "${RUN_CMD[@]}"<br /><br />    ;;<br /><br />  check)<br />    echo "Checking arguments to Jetty: "<br />    echo "JETTY_HOME     =  $JETTY_HOME"<br />    echo "JETTY_CONF     =  $JETTY_CONF"<br />    echo "JETTY_RUN      =  $JETTY_RUN"<br />    echo "JETTY_PID      =  $JETTY_PID"<br />    echo "JETTY_PORT     =  $JETTY_PORT"<br />    echo "JETTY_LOGS     =  $JETTY_LOGS"<br />    echo "START_INI      =  $START_INI"<br />    echo "CONFIGS        =  ${CONFIGS[*]}"<br />    echo "JAVA_OPTIONS   =  ${JAVA_OPTIONS[*]}"<br />    echo "JAVA           =  $JAVA"<br />    echo "CLASSPATH      =  $CLASSPATH"<br />    echo "RUN_CMD        =  ${RUN_CMD[*]}"<br />    echo<br /><br />    if [ -f "$JETTY_RUN/jetty.pid" ]<br />    then<br />      echo "Jetty running pid=$(< "$JETTY_RUN/jetty.pid")"<br />      exit 0<br />    fi<br />    exit 1<br /><br />    ;;<br /><br />  *)<br />    usage<br /><br />    ;;<br />esac<br /><br />exit 0<br /><br /></pre>然後把下面這塊存成 src/main/unix/scripts/post-install，並修改 USER=locadz-backend 這一行成跟你 ${service.user} 一樣的值<pre class="brush: shell;">#!/bin/sh<br />set -e<br /><br />USER=locadz-backend<br /><br />case "$1" in<br />    configure)<br />        if ! id $USER > /dev/null 2>&1 ; then<br />            adduser --system --home /var/lib/bluetang/$USER --no-create-home \<br />                --group --disabled-password --shell /bin/false \<br />                $USER<br />        fi<br /><br />        if [ ! -e /var/log/bluetang ]<br />        then<br />            mkdir -p /var/log/bluetang<br />        fi<br />        if [ ! -e /var/log/bluetang/$USER/ ]<br />        then<br />            ln -s /var/lib/bluetang/$USER/logs /var/log/bluetang/$USER<br />        fi<br />        if [ ! -e /var/cache/bluetang/$USER ]<br />        then<br />            mkdir -p /var/cache/bluetang/$USER<br />        fi<br /><br /><br />        chown -R $USER:adm /var/cache/bluetang/$USER /var/log/bluetang/$USER /var/lib/bluetang/$USER<br />        chmod 0744 /etc/init.d/$USER<br />        update-rc.d $USER defaults<br /><br />    ;;<br /><br />    abort-upgrade|abort-remove|abort-deconfigure)<br />    ;;<br /><br />    *)<br />        echo "$0 called with unknown argument \`$1'" >&2<br />        exit 1<br />    ;;<br />esac<br /><br /></pre>然後把下面這塊存成 src/main/unix/scripts/post-remove，並修改 USER=locadz-backend 這一行成跟你 ${service.user} 一樣的值<pre class="brush: shell;">#!/bin/sh<br />set -e<br /><br />USER=locadz-backend<br /><br />#DEBHELPER#<br /><br /># Remove cached files<br />rm -rf /var/cache/blutang/$USER/*<br /><br />case "$1" in<br />    remove)<br />        # Remove ROOT webapp if not modified<br />        RWLOC="/var/lib/bluetang/$USER/webapps/root"<br />        RWFILES="$RWLOC/index.html $RWLOC/jetty_banner.gif"<br />        if [ "`(cat $RWFILES | md5sum -) 2>/dev/null | cut -d ' ' -f 1`" \<br />                            = "12471c4b3020defb7ebd30ef84c0f9dd" ] ; then<br />            rm $RWFILES<br />            rmdir --ignore-fail-on-non-empty \<br />                /var/lib/bluetang/$USER/webapps/root \<br />                /var/lib/bluetang/$USER/webapps \<br />                /var/lib/bluetang/$USER || true<br />        fi<br />        if [ -d "/var/cache/bluetang/$USER" ] ; then<br />            rm -rf /var/cache/bluetang/$USER<br />        fi<br />    ;;<br /><br />    purge)<br />        # Remove user/group and log files (don't remove everything under<br />        # /var/lib/jetty because there might be user-installed webapps)<br />        deluser jetty || true<br />        rm -rf /var/log/bluetang/$USER<br />        if [ -d "/var/lib/bluetang/$USER" ] ; then<br />            rmdir --ignore-fail-on-non-empty /var/lib/bluetang/$USER || true<br />        fi<br />        rmdir --ignore-fail-on-non-empty /etc/bluetang/$USER/contexts /etc/bluetang/$USER || true<br />    ;;<br /><br />    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)<br />        # Nothing to do here<br />    ;;<br /><br />    *)<br />        echo "$0 called with unknown argument \`$1'" >&2<br />        exit 1<br />    ;;<br />esac<br /></pre>然後把下面這塊存成 src/main/unix/scripts/pre-install，並修改 USER=locadz-backend 這一行成跟你 ${service.user} 一樣的值<pre class="brush: shell;">#!/bin/sh<br />#<br /># This is the preinst script for the Blue Tang Servers<br />#<br /># Written by Yung-Lin Ho yho@bluetangstudio.com<br /><br />set -e<br />USER=locadz-backend<br />SCRIPT=/etc/init.d/$USER<br /><br /><br />case "$1" in<br />    upgrade|remove|purge)<br />        $SCRIPT stop<br />        ;;<br />    install|failed-upgrade|abort-install|abort-upgrade|disappear)<br />        ;;<br />    *)<br />        echo "preinst called with unknown argument \`$1'" >&2<br />        ;;<br />esac<br /><br />exit 0<br /></pre>下面這塊存成 src/main/unix/scripts/pre-remove，並修改 USER=locadz-backend 這一行成跟你 ${service.user} 一樣的值<pre class="brush: shell;">#!/bin/sh<br />#<br /># This is the prerm script for the Blue Tang Servers<br />#<br /># Written by Yung-Lin Ho yho@bluetangstudio.com<br /><br />set -e<br />USER=locadz-backend<br />SCRIPT=/etc/init.d/$USER<br /><br />case "$1" in<br />    upgrade)<br />        ;;<br />    remove|purge)<br />        $SCRIPT stop<br />        ;;<br />    failed-upgrade|abort-install|abort-upgrade|disappear)<br />        ;;<br />    *)<br />        echo "prerm called with unknown argument \`$1'" >&2<br />        ;;<br />esac<br /><br />exit 0<br /></pre></div>
</div>


  <footer>
    <p class="meta">
      
  



      








  


<time datetime="2012-03-27T23:19:00+08:00" pubdate data-updated="true">Mar 27<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.yunglinho.com/blog/2012/03/27/-service-how-to-debian-ize-your-web-application/" data-via="yunglinho" data-counturl="http://blog.yunglinho.com/blog/2012/03/27/-service-how-to-debian-ize-your-web-application/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/03/27/bravo-to-spotify-apps/" title="Previous Post: Bravo to Spotify Apps.">&laquo; Bravo to Spotify Apps.</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/04/18/" title="Next Post: 成本降就該降售價嗎？">成本降就該降售價嗎？ &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/05/23/slash-runtime-quality-metrics-series-3/">軟體品質指標系列(三)：軟體品質如何測量</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/22/runtime-quality-metrics-series-2/">軟體品質指標系列(二)：軟體品質指標有那些</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/17/runtime-quality-metrics-series-1/">軟體品質指標系列(一)：為什麼軟體開發者需要在意軟體品質指標</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/17/ridiculous-rule-change/">鬼島之鬼交通法規變革</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/08/shall-patent-apply-to-business-model/">Shall Patent Apply to Business Model</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("yunglinho", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/yunglinho" class="twitter-follow-button" data-show-count="false">Follow @yunglinho</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/101164690243066571931?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 -  -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
